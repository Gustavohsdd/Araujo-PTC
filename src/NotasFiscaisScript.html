<!-- NotasFiscaisScript.html -->
<script>
// Variáveis de UI globais
var modalEditarClassificacao, modalConfirmarDesfazer, modalEditarBoletos, btnBuscar, loader;

/**
 * Bootstrap seguro de inicialização
 */
function NotasFiscaisScript_safeReady() {
  try {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', NotasFiscaisScript_init);
    } else {
      NotasFiscaisScript_init();
    }
  } catch (e) {
    console.error('Falha ao iniciar Notas Fiscais:', e);
    alert('Erro ao iniciar a página de Notas Fiscais. Veja o console.');
  }
}

/**
 * Inicialização da página
 */
function NotasFiscaisScript_init() {
  try {
    // Referências de UI
    modalEditarClassificacao = document.getElementById('modalEditarClassificacao');
    modalConfirmarDesfazer   = document.getElementById('modalConfirmarDesfazer');
    modalEditarBoletos       = document.getElementById('modalEditarBoletos');
    btnBuscar                = document.getElementById('NotasFiscaisView_btnBuscar');
    loader                   = document.getElementById('loader');

    console.log('[NF] init: começando binding dos elementos.');

    // Botão Buscar (já existente)
    if (typeof NotasFiscaisScript_bindBuscarIfPresent === 'function') {
      NotasFiscaisScript_bindBuscarIfPresent();
    }

    // NOVO: botão "Conciliação NF"
    NotasFiscaisScript_bindBtnConciliacaoIfPresent();

    // >>> garanta a cor exata do botão (igual Cotações)
    NotasFiscaisScript_aplicarEstiloConciliacaoBtn();

    // Enter nos filtros dispara busca
    if (typeof NotasFiscaisScript_wireFiltersEnterKey === 'function') {
      NotasFiscaisScript_wireFiltersEnterKey();
    }

    // Barra de ações fixa (Classificar, Desfazer, Financeiro)
    if (typeof NotasFiscaisScript_bindActionBar === 'function') {
      NotasFiscaisScript_bindActionBar();
    }

    // Tema Produtos no cabeçalho da tabela
    if (typeof NotasFiscaisScript_aplicarTemaProdutosNoHead === 'function') {
      NotasFiscaisScript_aplicarTemaProdutosNoHead();
    }

    // Listeners dos modais — só liga se a função existir
    const elSalvarClass   = document.getElementById('btn-salvar-classificacao');
    const elConfirmarDesf = document.getElementById('btn-confirmar-desfazer');
    const elSalvarBoletos = document.getElementById('btn-salvar-boletos-contas');
    const elAddFatura     = document.getElementById('btn-add-fatura');
    const elAddConta      = document.getElementById('btn-add-conta');

    if (elSalvarClass && typeof NotasFiscaisScript_salvarClassificacao === 'function') {
      elSalvarClass.addEventListener('click', NotasFiscaisScript_salvarClassificacao);
    }
    if (elConfirmarDesf && typeof NotasFiscaisScript_confirmarDesfazer === 'function') {
      elConfirmarDesf.addEventListener('click', NotasFiscaisScript_confirmarDesfazer);
    }
    if (elSalvarBoletos && typeof NotasFiscaisScript_salvarFinanceiro === 'function') {
      elSalvarBoletos.addEventListener('click', NotasFiscaisScript_salvarFinanceiro);
    }
    if (elAddFatura) {
      elAddFatura.addEventListener('click', () => {
        if (typeof NotasFiscaisScript_adicionarLinhaTabela === 'function') {
          NotasFiscaisScript_adicionarLinhaTabela('tabela-faturas-body', true);
        } else {
          console.warn('[NF] Função NotasFiscaisScript_adicionarLinhaTabela não definida.');
        }
      });
    }
    if (elAddConta) {
      elAddConta.addEventListener('click', () => {
        if (typeof NotasFiscaisScript_adicionarLinhaTabela === 'function') {
          NotasFiscaisScript_adicionarLinhaTabela('tabela-contas-a-pagar-body', false);
        } else {
          console.warn('[NF] Função NotasFiscaisScript_adicionarLinhaTabela não definida.');
        }
      });
    }

    // Fechar modais (usa closeModal se existir; senão esconde via class)
    document.querySelectorAll('[data-modal-close]').forEach(button => {
      button.addEventListener('click', () => {
        const modal = button.closest('.fixed.inset-0');
        if (!modal) return;
        if (typeof NotasFiscaisScript_closeModal === 'function') {
          NotasFiscaisScript_closeModal(modal);
        } else {
          modal.classList.add('hidden');
        }
      });
    });

    // Estado inicial da barra (desabilita botões até haver seleção)
    if (typeof NotasFiscaisScript_updateToolbarState === 'function') {
      NotasFiscaisScript_updateToolbarState();
    }

    NotasFiscaisScript_fixZIndexModais();

    console.log('[NF] init: concluído.');
  } catch (e) {
    console.error('Falha ao iniciar Notas Fiscais:', e);
  }
}

// ======================
// RESTAURAÇÃO: EDIÇÃO REAL
// ======================

// Estado simples para passar dados entre ações
const NotasFiscaisScript_state = {
  chaveAcessoAtual: null,
  numeroNFAtual: null,
};

// Utilitários para abrir/fechar modal (usa closeModal se existir)
function NotasFiscaisScript_openModalById(id) {
  const el = document.getElementById(id);
  if (!el) return;

  // Garante o modal no topo absoluto
  NotasFiscaisScript_fixZIndexModais();

  // Exibe o modal
  el.classList.remove('hidden');

  // Evita scroll do body enquanto o modal está aberto
  document.body.classList.add('overflow-hidden');

  // Foco no painel para acessibilidade
  const painel = el.querySelector('.bg-white');
  if (painel && painel.focus) {
    painel.setAttribute('tabindex', '-1');
    painel.focus();
  }
}
function NotasFiscaisScript_closeModalById(id) {
  const el = document.getElementById(id);
  if (!el) return;

  // Usa closeModal se existir; senão, apenas oculta
  if (typeof NotasFiscaisScript_closeModal === 'function') {
    NotasFiscaisScript_closeModal(el);
  } else {
    el.classList.add('hidden');
  }

  // Se nenhum outro modal estiver aberto, libera o scroll do body
  setTimeout(() => {
    const algumAberto = document.querySelector('.fixed.inset-0:not(.hidden)');
    if (!algumAberto) document.body.classList.remove('overflow-hidden');
  }, 0);
}

// -----------------------------
// CLASSIFICAÇÃO (editar/salvar)
// -----------------------------
function NotasFiscaisScript_ensureClassificacaoUI() {
  try {
    const modal = document.getElementById('modalEditarClassificacao');
    if (!modal) return;

    // Corpo correto do modal (div .p-4 dentro do painel branco)
    const painel = modal.querySelector('.bg-white');
    const body = painel ? painel.querySelector('.p-4') : null;
    if (!body) {
      console.warn('[NF] Corpo do modal de Classificação não encontrado (.p-4).');
      return;
    }

    // Se por algum motivo existir um select solto fora do modal, remove
    document.querySelectorAll('#classificacao-status').forEach(el => {
      if (!modal.contains(el)) el.remove();
    });

    // Injeta o select de status se ainda não existir no corpo do modal
    if (!body.querySelector('#classificacao-status')) {
      const wrapper = document.createElement('div');
      wrapper.className = 'space-y-2 mt-2';
      wrapper.innerHTML = `
        <label class="block text-xs text-gray-600">Status da Conciliação</label>
        <select id="classificacao-status"
                class="w-full h-9 px-2 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
          <option value="Pendente">Pendente</option>
          <option value="Conciliada">Conciliada</option>
          <option value="Bonificação">Bonificação</option>
          <option value="NF Tipo B">NF Tipo B</option>
          <option value="Sem Pedido">Sem Pedido</option>
        </select>
      `;
      body.appendChild(wrapper);
    }

    // Garante que o modal está por cima de tudo
    NotasFiscaisScript_fixZIndexModais();
  } catch (e) {
    console.error('[NF] ensureClassificacaoUI:', e);
  }
}

/** Abre modal de Classificação */
function NotasFiscaisScript_abrirModalClassificacao(chaveAcesso, numeroNF) {
  NotasFiscaisScript_state.chaveAcessoAtual = chaveAcesso;
  NotasFiscaisScript_state.numeroNFAtual = numeroNF;
  NotasFiscaisScript_ensureClassificacaoUI();
  NotasFiscaisScript_openModalById('modalEditarClassificacao');
}

/** Salva a Classificação (status) via controller */
function NotasFiscaisScript_salvarClassificacao() {
  try {
    const chave = NotasFiscaisScript_state.chaveAcessoAtual;
    if (!chave) { alert('Chave da NF não definida.'); return; }
    const sel = document.getElementById('classificacao-status');
    if (!sel) { alert('Campo de status não encontrado.'); return; }
    const status = sel.value || 'Pendente';

    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      alert('Ambiente inválido. Abra pelo link do Web App.');
      return;
    }

    NotasFiscaisScript_toggleLoader(true);
    google.script.run
      .withSuccessHandler(resp => {
        NotasFiscaisScript_toggleLoader(false);
        if (resp && resp.success) {
          alert(resp.message || 'Classificação atualizada.');
          NotasFiscaisScript_closeModalById('modalEditarClassificacao');
          NotasFiscaisScript_buscar();
        } else {
          NotasFiscaisScript_handleFailure(resp || {message:'Falha ao atualizar classificação.'});
        }
      })
      .withFailureHandler(err => {
        NotasFiscaisScript_toggleLoader(false);
        NotasFiscaisScript_handleFailure(err);
      })
      .NotasFiscaisController_atualizarStatusNF(chave, status);

  } catch (e) {
    NotasFiscaisScript_toggleLoader(false);
    console.error('[NF] salvarClassificacao:', e);
    alert('Erro ao salvar classificação.');
  }
}

// -------------------------------------
// FINANCEIRO (faturas + contas a pagar)
// -------------------------------------

// helper para inputs
function NotasFiscaisScript_rowInput(name, value, attrs='') {
  value = (value == null ? '' : value);
  const isReadOnly = /\breadonly\b/i.test(attrs) || /\bdisabled\b/i.test(attrs);

  // Classe base + variação para bloqueado
  const cls = [
    'w-full', 'h-8', 'px-2', 'text-xs',
    'border', 'border-gray-300', 'rounded-md',
    'focus:outline-none'
  ];
  if (isReadOnly) {
    cls.push('bg-gray-100', 'text-gray-600', 'cursor-not-allowed'); // Aparência de bloqueado
  } else {
    cls.push('bg-white', 'focus:ring-1', 'focus:ring-blue-500');
  }

  return `<input name="${name}" value="${value}" ${attrs} class="${cls.join(' ')}">`;
}

function NotasFiscaisScript_parseNumeroFlex(v) {
  if (v == null) return NaN;
  let s = String(v).trim();
  if (s === '') return NaN;

  const hasComma = s.indexOf(',') !== -1;
  const hasDot   = s.indexOf('.') !== -1;

  if (hasComma && hasDot) {
    // Quando tem vírgula e ponto, o ÚLTIMO separador costuma ser o decimal.
    const lastComma = s.lastIndexOf(',');
    const lastDot   = s.lastIndexOf('.');
    const decimalSep = lastComma > lastDot ? ',' : '.';
    const thousandSep = decimalSep === ',' ? '.' : ',';
    s = s.split(thousandSep).join('');
    s = s.replace(decimalSep, '.');
  } else if (hasComma) {
    // Só vírgula: vírgula é decimal; pontos (se houver) são milhares.
    s = s.split('.').join('');
    s = s.replace(',', '.');
  } else if (hasDot) {
    // Só ponto: trata como decimal, mas se houver vários pontos, mantém só o último como decimal.
    const parts = s.split('.');
    if (parts.length > 2) {
      const frac = parts.pop();
      s = parts.join('') + '.' + frac;
    }
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

function NotasFiscaisScript_formatarDuasCasas(v) {
  const n = NotasFiscaisScript_parseNumeroFlex(v);
  if (isNaN(n)) return '';
  return n.toFixed(2);
}

/**
 * NotasFiscaisScript_abrirModalBoletos
 * Abre o modal e injeta placeholders com colspans corretos (Faturas=4, Contas=6)
 */
function NotasFiscaisScript_abrirModalBoletos(chaveAcesso, numeroNF) {
  NotasFiscaisScript_state.chaveAcessoAtual = chaveAcesso;
  NotasFiscaisScript_state.numeroNFAtual = numeroNF;

  NotasFiscaisScript_openModalById('modalEditarBoletos');

  // Placeholders enquanto busca (colspan: Faturas=4, Contas=6)
  const tFat = document.getElementById('tabela-faturas-body');
  const tCap = document.getElementById('tabela-contas-a-pagar-body');
  if (tFat) tFat.innerHTML = `<tr><td colspan="4" class="px-2 py-2 text-center text-xs text-gray-500">Carregando...</td></tr>`;
  if (tCap) tCap.innerHTML = `<tr><td colspan="6" class="px-2 py-2 text-center text-xs text-gray-500">Carregando...</td></tr>`;

  // Carrega dados financeiros (linhas do modal)
  NotasFiscaisScript_carregarResumoFinanceiro(chaveAcesso);

  // Carrega sugestões de Centro de Custo (datalist) e aplica nos campos
  NotasFiscaisScript_carregarSugestoesCentroCusto();
}

/** Busca faturas e contas no controller e renderiza inputs editáveis */
function NotasFiscaisScript_carregarResumoFinanceiro(chaveAcesso) {
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    alert('Ambiente inválido. Abra pelo link do Web App.');
    return;
  }
  NotasFiscaisScript_toggleLoader(true);

  google.script.run
    .withSuccessHandler(resp => {
      NotasFiscaisScript_toggleLoader(false);
      if (!resp || !resp.success) {
        NotasFiscaisScript_handleFailure(resp || {message:'Falha ao obter dados financeiros.'});
        return;
      }
      const { faturas, contasAPagar } = resp.dados || { faturas: [], contasAPagar: [] };
      NotasFiscaisScript_renderFaturas(faturas || []);
      NotasFiscaisScript_renderContasAPagar(contasAPagar || []);
    })
    .withFailureHandler(err => {
      NotasFiscaisScript_toggleLoader(false);
      NotasFiscaisScript_handleFailure(err);
    })
    .NotasFiscaisController_obterResumoFinanceiroDaNF(chaveAcesso);
}

/**
 * NotasFiscaisScript_renderFaturas
 * Mantém apenas: Chave de Acesso (bloqueada), Número da Parcela, Data de Vencimento, Valor da Parcela.
 * (Remove o antigo "Número da Fatura" que estava causando o desalinhamento.)
 */
function NotasFiscaisScript_renderFaturas(faturas) {
  const tbody = document.getElementById('tabela-faturas-body');
  if (!tbody) return;
  tbody.innerHTML = '';

  const chave = NotasFiscaisScript_state.chaveAcessoAtual || '';

  (faturas || []).forEach(f => {
    const numPar = f['Número da Parcela'] || f['Numero da Parcela'] || f['Parcela'] || '';
    const venc   = (f['Data de Vencimento'] || f['Vencimento'] || '');
    const val    = NotasFiscaisScript_formatarDuasCasas(f['Valor da Parcela'] || f['Valor'] || '');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Chave de Acesso', chave, 'readonly tabindex="-1"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Número da Parcela', numPar)}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Data de Vencimento', (venc||'').toString().slice(0,10), 'type="date"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Valor da Parcela', val, 'inputmode="decimal" onblur="this.value=NotasFiscaisScript_formatarDuasCasas(this.value)"')}
      </td>
    `;
    tbody.appendChild(tr);
  });

  if (!tbody.children.length) {
    NotasFiscaisScript_adicionarLinhaTabela('tabela-faturas-body', true);
  }
}

function NotasFiscaisScript_renderContasAPagar(linhas) {
  const tbody = document.getElementById('tabela-contas-a-pagar-body');
  if (!tbody) return;
  tbody.innerHTML = '';

  const chave = NotasFiscaisScript_state.chaveAcessoAtual || '';

  (linhas || []).forEach(l => {
    const resumo       = l['Resumo dos Itens'] || l['Título'] || l['Descricao'] || '';
    const venc         = (l['Data de Vencimento'] || l['Vencimento'] || '');
    const valorParcela = l['Valor da Parcela'] || l['Valor'] || '';
    const setor        = l['Setor'] || l['Empresa'] || '';
    const valorRateado = NotasFiscaisScript_formatarDuasCasas(l['Valor por Setor'] || l['Valor Rateado'] || '');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Chave de Acesso', chave, 'readonly tabindex="-1"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Resumo dos Itens', resumo)}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Data de Vencimento', (venc||'').toString().slice(0,10), 'type="date"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Valor da Parcela', NotasFiscaisScript_formatarDuasCasas(valorParcela), 'inputmode="decimal" onblur="this.value=NotasFiscaisScript_formatarDuasCasas(this.value)"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Setor', setor, 'list="NotasFiscaisView_datalistCentroCusto"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Valor por Setor', valorRateado, 'inputmode="decimal" onblur="this.value=NotasFiscaisScript_formatarDuasCasas(this.value)"')}
      </td>
    `;
    tbody.appendChild(tr);
  });

  if (!tbody.children.length) {
    NotasFiscaisScript_adicionarLinhaTabela('tabela-contas-a-pagar-body', false);
  }

  // Garante que todos inputs de Setor apontem para o datalist
  NotasFiscaisScript_aplicarDatalistNosCamposCentroCusto();
}

function NotasFiscaisScript_adicionarLinhaTabela(tbodyId, isFatura) {
  const tbody = document.getElementById(tbodyId);
  if (!tbody) return;

  const chave = NotasFiscaisScript_state.chaveAcessoAtual || '';
  const tr = document.createElement('tr');

  if (isFatura) {
    tr.innerHTML = `
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Chave de Acesso', chave, 'readonly tabindex="-1"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Número da Parcela','')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Data de Vencimento','', 'type="date"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Valor da Parcela','', 'inputmode="decimal" onblur="this.value=NotasFiscaisScript_formatarDuasCasas(this.value)"')}
      </td>
    `;
  } else {
    tr.innerHTML = `
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Chave de Acesso', chave, 'readonly tabindex="-1"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Resumo dos Itens','')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Data de Vencimento','', 'type="date"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Valor da Parcela','', 'inputmode="decimal" onblur="this.value=NotasFiscaisScript_formatarDuasCasas(this.value)"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Setor','', 'list="NotasFiscaisView_datalistCentroCusto"')}
      </td>
      <td class="px-2 py-1 text-xs">
        ${NotasFiscaisScript_rowInput('Valor por Setor','', 'inputmode="decimal" onblur="this.value=NotasFiscaisScript_formatarDuasCasas(this.value)"')}
      </td>
    `;
  }

  tbody.appendChild(tr);

  // Se for contas, aplica o datalist no novo campo Setor
  if (!isFatura) {
    NotasFiscaisScript_aplicarDatalistNosCamposCentroCusto();
  }
}

/** Salva faturas e contas (chama 2 endpoints em sequência) */
function NotasFiscaisScript_salvarFinanceiro() {
  try {
    const chave = NotasFiscaisScript_state.chaveAcessoAtual;
    if (!chave) { alert('Chave da NF não definida.'); return; }
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      alert('Ambiente inválido. Abra pelo link do Web App.');
      return;
    }

    // Coleta faturas
    const fatRows = Array.from(document.querySelectorAll('#tabela-faturas-body tr'));
    const faturas = fatRows.map(tr => {
      const o = {};
      tr.querySelectorAll('input').forEach(inp => { o[inp.name] = inp.value; });
      return o;
    }).filter(o => Object.values(o).some(v => String(v||'').trim() !== ''));

    // Coleta contas
    const capRows = Array.from(document.querySelectorAll('#tabela-contas-a-pagar-body tr'));
    const contas = capRows.map(tr => {
      const o = {};
      tr.querySelectorAll('input').forEach(inp => { o[inp.name] = inp.value; });
      return o;
    }).filter(o => Object.values(o).some(v => String(v||'').trim() !== ''));

    NotasFiscaisScript_toggleLoader(true);

    // 1º salva faturas
    google.script.run
      .withSuccessHandler(r1 => {
        // 2º salva contas
        google.script.run
          .withSuccessHandler(r2 => {
            NotasFiscaisScript_toggleLoader(false);
            if ((r1 && r1.success) && (r2 && r2.success)) {
              alert('Financeiro salvo com sucesso.');
              NotasFiscaisScript_closeModalById('modalEditarBoletos');
              NotasFiscaisScript_buscar();
            } else {
              const msg = (r1 && r1.message ? r1.message : '') + ' ' + (r2 && r2.message ? r2.message : '');
              NotasFiscaisScript_handleFailure({message: msg || 'Falha ao salvar financeiro.'});
            }
          })
          .withFailureHandler(err2 => {
            NotasFiscaisScript_toggleLoader(false);
            NotasFiscaisScript_handleFailure(err2);
          })
          .NotasFiscaisController_salvarContasAPagar(chave, contas);
      })
      .withFailureHandler(err1 => {
        NotasFiscaisScript_toggleLoader(false);
        NotasFiscaisScript_handleFailure(err1);
      })
      .NotasFiscaisController_salvarFaturas(chave, faturas);

  } catch (e) {
    NotasFiscaisScript_toggleLoader(false);
    console.error('[NF] salvarFinanceiro:', e);
    alert('Erro ao salvar financeiro.');
  }
}


function NotasFiscaisScript_bindBuscarIfPresent() {
  // (Re)captura a referência do botão
  btnBuscar = document.getElementById('NotasFiscaisView_btnBuscar');

  if (btnBuscar) {
    // Garante que não duplicamos listener
    btnBuscar.removeEventListener?.('click', NotasFiscaisScript_buscar);
    btnBuscar.addEventListener('click', NotasFiscaisScript_buscar);
    console.log('[NF] bindBuscar: botão encontrado e listener ligado.');
    return;
  }

  console.warn('[NF] bindBuscar: botão ainda não existe. Tentando novamente por até 5s...');
  let tentativas = 0;
  const maxTentativas = 25; // 25 * 200ms = 5s
  const timer = setInterval(() => {
    tentativas++;
    btnBuscar = document.getElementById('NotasFiscaisView_btnBuscar');
    if (btnBuscar) {
      btnBuscar.removeEventListener?.('click', NotasFiscaisScript_buscar);
      btnBuscar.addEventListener('click', NotasFiscaisScript_buscar);
      clearInterval(timer);
      console.log('[NF] bindBuscar: botão apareceu e listener foi ligado na tentativa', tentativas);
    } else if (tentativas >= maxTentativas) {
      clearInterval(timer);
      console.error('[NF] bindBuscar: não foi possível localizar o botão Buscar após 5s.');
      alert('Erro: botão "Buscar" não foi encontrado. Atualize a página. Se persistir, verifique o ID "NotasFiscaisView_btnBuscar" na View.');
    }
  }, 200);
}

/**
 * Coleta os valores dos filtros (tolerante)
 */
function NotasFiscaisScript_coletarFiltros() {
  return {
    busca: document.getElementById('filtro-busca')?.value || '',
    status: document.getElementById('filtro-status')?.value || '',
    fornecedor: document.getElementById('filtro-fornecedor')?.value || '',
    dataInicio: document.getElementById('filtro-data-inicio')?.value || '',
    dataFim: document.getElementById('filtro-data-fim')?.value || '',
  };
}

/**
 * Liga tecla Enter nos filtros
 */
function NotasFiscaisScript_wireFiltersEnterKey() {
  const ids = ['filtro-busca','filtro-status','filtro-fornecedor','filtro-data-inicio','filtro-data-fim'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        NotasFiscaisScript_buscar();
      }
    });
  });
}

/**
 * Executa a busca de notas fiscais
 */
function NotasFiscaisScript_buscar() {
  try {
    // Guarda: ambiente do HtmlService
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      console.error('[NF] buscar: google.script.run indisponível.');
      alert('Esta página não está rodando dentro do HtmlService do Apps Script (google.script.run indisponível). Abra pelo link publicado do Web App.');
      return;
    }

    const filtros = NotasFiscaisScript_coletarFiltros();
    console.log('[NF] buscar: filtros ->', filtros);

    NotasFiscaisScript_toggleLoader(true);
    if (btnBuscar) btnBuscar.disabled = true;

    google.script.run
      .withSuccessHandler(response => {
        try {
          console.log('[NF] listarNotas -> sucesso:', response);
          if (response && response.success) {
            NotasFiscaisScript_renderizarTabela(response.dados || []);
          } else {
            NotasFiscaisScript_handleFailure(response || {message:'Falha desconhecida.'});
          }
        } finally {
          NotasFiscaisScript_toggleLoader(false);
          if (btnBuscar) btnBuscar.disabled = false;
        }
      })
      .withFailureHandler(err => {
        try {
          console.error('[NF] listarNotas -> falha:', err);
          NotasFiscaisScript_handleFailure(err);
        } finally {
          NotasFiscaisScript_toggleLoader(false);
          if (btnBuscar) btnBuscar.disabled = false;
        }
      })
      .NotasFiscaisController_listarNotas(filtros);

  } catch (e) {
    console.error('[NF] buscar -> exceção:', e);
    NotasFiscaisScript_handleFailure(e);
    NotasFiscaisScript_toggleLoader(false);
    if (btnBuscar) btnBuscar.disabled = false;
  }
}

/**
 * Renderiza a tabela com layout compacto
 */
// === ESTADO GLOBAL DE SELEÇÃO (UMA NOTA POR VEZ) ===
let NotasFiscaisScript_notaSelecionada = null;

// === CLASSES PADRÃO VISUAL (alinhado ao módulo Produtos) ===
const NotasFiscaisScript_TD_CLASS = 'px-4 py-3 text-sm text-gray-700 border-b border-gray-200 align-middle';
const NotasFiscaisScript_TD_RIGHT_CLASS = 'px-4 py-3 text-sm text-gray-700 text-right border-b border-gray-200 align-middle';
const NotasFiscaisScript_TAG_STATUS_CLASS = 'text-[10px] font-medium px-2 py-0.5 rounded-full';

function NotasFiscaisScript_limparSelecaoVisual() {
  const tbody = document.getElementById('tabela-notas-fiscais-body');
  if (!tbody) return;
  tbody.querySelectorAll('tr.linha-selecionada').forEach(tr => tr.classList.remove('linha-selecionada'));
}

function NotasFiscaisScript_definirSelecao(nf, tr) {
  // Limpa seleção anterior
  NotasFiscaisScript_limparSelecaoVisual();

  // Define nova seleção (ou limpa, se clicar de novo)
  if (NotasFiscaisScript_notaSelecionada && NotasFiscaisScript_notaSelecionada.chaveAcesso === nf.chaveAcesso) {
    NotasFiscaisScript_notaSelecionada = null;
    NotasFiscaisScript_updateToolbarState();
    return;
  }

  NotasFiscaisScript_notaSelecionada = nf || null;
  if (tr) tr.classList.add('linha-selecionada');
  NotasFiscaisScript_updateToolbarState();
}

function NotasFiscaisScript_getNotaSelecionada() {
  return NotasFiscaisScript_notaSelecionada;
}

function NotasFiscaisScript_updateToolbarState() {
  const selecionada = NotasFiscaisScript_getNotaSelecionada();

  const btnClassificar = document.getElementById('NotasFiscaisView_btnClassificarSelecionada');
  const btnDesfazer = document.getElementById('NotasFiscaisView_btnDesfazerSelecionada');
  const btnFinanceiro = document.getElementById('NotasFiscaisView_btnFinanceiroSelecionada');
  const status = document.getElementById('NotasFiscaisView_statusSelecao');

  const habilitar = !!(selecionada && selecionada.chaveAcesso);

  [btnClassificar, btnDesfazer, btnFinanceiro].forEach(b => {
    if (!b) return;
    b.disabled = !habilitar;
  });

  if (status) {
    if (habilitar) {
      const numero = selecionada.numeroNF || '—';
      const emitente = selecionada.nomeEmitente || '—';
      status.textContent = `Selecionada: NF ${numero} — ${emitente}`;
    } else {
      status.textContent = 'Nenhuma nota selecionada';
    }
  }
}

/**
 * Faz o bind dos botões da Action Bar para usar a nota selecionada.
 * Reaproveita as funções já existentes de modais:
 * - NotasFiscaisScript_abrirModalClassificacao(chaveAcesso, numeroNF)
 * - NotasFiscaisScript_abrirModalDesfazer(chaveAcesso, numeroNF)
 * - NotasFiscaisScript_abrirModalBoletos(chaveAcesso, numeroNF)
 */
function NotasFiscaisScript_bindActionBar() {
  const btnClassificar = document.getElementById('NotasFiscaisView_btnClassificarSelecionada');
  const btnDesfazer = document.getElementById('NotasFiscaisView_btnDesfazerSelecionada');
  const btnFinanceiro = document.getElementById('NotasFiscaisView_btnFinanceiroSelecionada');

  if (btnClassificar) {
    btnClassificar.onclick = function () {
      const nf = NotasFiscaisScript_getNotaSelecionada();
      if (!nf) return;
      NotasFiscaisScript_abrirModalClassificacao(nf.chaveAcesso, nf.numeroNF);
    };
  }

  if (btnDesfazer) {
    btnDesfazer.onclick = function () {
      const nf = NotasFiscaisScript_getNotaSelecionada();
      if (!nf) return;
      NotasFiscaisScript_abrirModalDesfazer(nf.chaveAcesso, nf.numeroNF);
    };
  }

  if (btnFinanceiro) {
    btnFinanceiro.onclick = function () {
      const nf = NotasFiscaisScript_getNotaSelecionada();
      if (!nf) return;
      NotasFiscaisScript_abrirModalBoletos(nf.chaveAcesso, nf.numeroNF);
    };
  }

  // Estado inicial
  NotasFiscaisScript_updateToolbarState();
}

function NotasFiscaisScript_renderizarTabela(notas) {
  const tbody = document.getElementById('tabela-notas-fiscais-body');
  if (!tbody) return;
  tbody.innerHTML = '';

  // Guarda dados no dataset para usos futuros (paginações/exports)
  const tabela = document.getElementById('NotasFiscaisView_tabelaNotas');
  if (tabela) tabela.dataset.notasPaginadas = JSON.stringify(notas || []);

  if (!notas || notas.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 6; // agora são 6 colunas (sem Ações)
    td.className = 'px-4 py-8 text-md text-gray-500 text-center';
    td.textContent = 'Nenhuma nota fiscal encontrada para os filtros aplicados.';
    tr.appendChild(td);
    tbody.appendChild(tr);
    NotasFiscaisScript_toggleLoader(false);
    // Garante barra atualizada quando não há itens
    NotasFiscaisScript_notaSelecionada = null;
    NotasFiscaisScript_updateToolbarState();
    return;
  }

  // Garante que nenhuma seleção persistente confunda o usuário
  NotasFiscaisScript_notaSelecionada = null;
  NotasFiscaisScript_updateToolbarState();

  notas.forEach(nf => {
    const tr = document.createElement('tr');

    // dataset útil
    tr.dataset.chaveAcesso = nf.chaveAcesso || '';
    tr.dataset.numeroNF = nf.numeroNF || '';

    const status = (nf.statusConciliacao || '').toLowerCase();
    const statusClass =
      status.includes('conciliada') ? 'bg-green-100 text-green-700 border border-green-200' :
      status.includes('pendente')   ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' :
      status.includes('bonificação')? 'bg-purple-100 text-purple-700 border border-purple-200' :
      'bg-gray-100 text-gray-700 border border-gray-200';

    // Células (6 colunas)
    tr.innerHTML = `
      <td class="${NotasFiscaisScript_TD_CLASS} font-medium text-gray-900">${nf.numeroNF || ''}</td>
      <td class="${NotasFiscaisScript_TD_CLASS}">${nf.nomeEmitente || ''}</td>
      <td class="${NotasFiscaisScript_TD_CLASS}">${nf.cnpjEmitente || ''}</td>
      <td class="${NotasFiscaisScript_TD_CLASS}">${nf.dataEmissao || ''}</td>
      <td class="${NotasFiscaisScript_TD_CLASS}">
        <span class="${NotasFiscaisScript_TAG_STATUS_CLASS} ${statusClass}">${nf.statusConciliacao || ''}</span>
      </td>
      <td class="${NotasFiscaisScript_TD_RIGHT_CLASS}">
        ${(Number(nf.valorTotalNF) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
      </td>
    `;

    // Seleção de linha por clique
    tr.addEventListener('click', function () {
      NotasFiscaisScript_definirSelecao(nf, tr);
    });

    tbody.appendChild(tr);
  });

  NotasFiscaisScript_toggleLoader(false);
}

function NotasFiscaisScript_aplicarTemaProdutosNoHead() {
  const tabela = document.getElementById('NotasFiscaisView_tabelaNotas');
  if (!tabela) return;

  const thead = tabela.querySelector('thead');
  if (!thead) return;

  // Aplica o tema do módulo Produtos no cabeçalho
  thead.className = 'bg-blue-600 text-white uppercase text-sm leading-normal';

  // Garante classes padronizadas em cada TH
  thead.querySelectorAll('th').forEach(th => {
    const base = 'px-4 py-3 text-left text-xs font-semibold tracking-wider';
    if (!th.className || !th.className.includes('px-4')) {
      th.className = base + (th.className ? (' ' + th.className) : '');
    } else {
      // Se já tiver classes, apenas garante que as principais estão presentes
      const cls = new Set((th.className || '').split(/\s+/));
      base.split(/\s+/).forEach(c => cls.add(c));
      th.className = Array.from(cls).join(' ');
    }
  });
}

/**
 * Manipula falhas de execução
 */
function NotasFiscaisScript_handleFailure(error) {
  const msg = (error && error.message) ? error.message :
              (error && error.toString) ? error.toString() :
              'Ocorreu um erro. Verifique o console.';
  console.error('Erro na página Notas Fiscais:', error);
  alert('Erro: ' + msg);
}

/**
 * Exibe/oculta loader
 */
function NotasFiscaisScript_toggleLoader(show) {
  try {
    if (!loader) return;
    loader.classList.toggle('hidden', !show);
  } catch (e) {
    console.error('Falha ao alternar loader:', e);
  }
}

// Cache local de sugestões
let NotasFiscaisScript_cacheSetoresCentroCusto = [];

/**
 * NotasFiscaisScript_injetarDatalistCentroCusto
 * Garante a existência do <datalist id="NotasFiscaisView_datalistCentroCusto"> dentro do modal e popula as opções.
 */
function NotasFiscaisScript_injetarDatalistCentroCusto(opcoes) {
  const modal = document.getElementById('modalEditarBoletos');
  if (!modal) return;

  let dl = document.getElementById('NotasFiscaisView_datalistCentroCusto');
  if (!dl) {
    dl = document.createElement('datalist');
    dl.id = 'NotasFiscaisView_datalistCentroCusto';
    // insere no modal para ficar disponível aos inputs
    modal.appendChild(dl);
  }
  dl.innerHTML = '';
  (opcoes || []).forEach(txt => {
    const opt = document.createElement('option');
    opt.value = txt;
    dl.appendChild(opt);
  });
}

/**
 * NotasFiscaisScript_aplicarDatalistNosCamposCentroCusto
 * Aponta todos inputs name="Setor" para usar o datalist como sugestão (não obrigatório).
 */
function NotasFiscaisScript_aplicarDatalistNosCamposCentroCusto() {
  const modal = document.getElementById('modalEditarBoletos');
  if (!modal) return;
  const campos = modal.querySelectorAll('input[name="Setor"]');
  campos.forEach(inp => { inp.setAttribute('list', 'NotasFiscaisView_datalistCentroCusto'); });
}

/**
 * NotasFiscaisScript_carregarSugestoesCentroCusto
 * Chama o controller, popula o datalist e aplica nos campos "Setor".
 */
function NotasFiscaisScript_carregarSugestoesCentroCusto() {
  if (NotasFiscaisScript_cacheSetoresCentroCusto.length) {
    // já temos cache: só injeta e aplica
    NotasFiscaisScript_injetarDatalistCentroCusto(NotasFiscaisScript_cacheSetoresCentroCusto);
    NotasFiscaisScript_aplicarDatalistNosCamposCentroCusto();
    return;
  }

  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    console.warn('[NF] carregarSugestoesCentroCusto: ambiente inválido (google.script.run).');
    return;
  }

  google.script.run
    .withSuccessHandler(resp => {
      if (resp && resp.success && Array.isArray(resp.dados)) {
        NotasFiscaisScript_cacheSetoresCentroCusto = resp.dados.slice(0);
        NotasFiscaisScript_injetarDatalistCentroCusto(NotasFiscaisScript_cacheSetoresCentroCusto);
        NotasFiscaisScript_aplicarDatalistNosCamposCentroCusto();
      } else {
        console.warn('[NF] Sugestões centro de custo: resposta inválida.', resp);
      }
    })
    .withFailureHandler(err => {
      console.error('[NF] Falha ao carregar sugestões de centro de custo:', err);
    })
    .NotasFiscaisController_listarSetoresRegrasRateio();
}

function NotasFiscaisScript_abrirConciliacaoNF() {
  try {
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      alert('Esta página não está rodando dentro do HtmlService do Apps Script. Abra pelo link publicado do Web App.');
      return;
    }

    // Feedback simples no console (se quiser, posso integrar com seu loader)
    console.log('[NF] Abrindo página de conciliação de NF...');

    google.script.run
      .withSuccessHandler(function (response) {
        if (response && response.success && response.url) {
          window.open(response.url, '_blank');
        } else {
          const msg = (response && response.message) ? response.message : 'Erro ao gerar a URL da conciliação.';
          alert(msg);
        }
      })
      .withFailureHandler(function (err) {
        alert('Falha de comunicação ao tentar abrir a página de conciliação: ' + err.message);
      })
      .App_obterUrlWebApp({ view: 'conciliacaonf' });
  } catch (e) {
    console.error('[NF] abrirConciliacaoNF -> exceção:', e);
    alert('Erro ao abrir a conciliação.');
  }
}

function NotasFiscaisScript_bindBtnConciliacaoIfPresent() {
  try {
    const btnConciliar = document.getElementById('NotasFiscaisView_btnConciliacaoNF');
    if (!btnConciliar) {
      console.warn('[NF] Botão "NotasFiscaisView_btnConciliacaoNF" não encontrado na View.');
      return;
    }
    // Evita bind duplicado
    btnConciliar.replaceWith(btnConciliar.cloneNode(true));
    const btn = document.getElementById('NotasFiscaisView_btnConciliacaoNF');
    btn.addEventListener('click', NotasFiscaisScript_abrirConciliacaoNF);
  } catch (e) {
    console.error('[NF] bindBtnConciliacaoIfPresent -> erro:', e);
  }
}

function NotasFiscaisScript_aplicarEstiloConciliacaoBtn() {
  try {
    const btn = document.getElementById('NotasFiscaisView_btnConciliacaoNF');
    if (!btn) return;

    // Remove qualquer bg anterior que possa ter ficado
    const remover = ['bg-blue-600','bg-blue-700','hover:bg-blue-700','text-white'];
    remover.forEach(c => btn.classList.remove(c));

    // Garante nossa classe padrão
    btn.classList.add('NotasFiscaisView_btnConciliacaoNF');
  } catch (e) {
    console.warn('[NF] aplicarEstiloConciliacaoBtn:', e);
  }
}

function NotasFiscaisScript_fixZIndexModais() {
  try {
    const ids = ['modalEditarClassificacao', 'modalConfirmarDesfazer', 'modalEditarBoletos'];
    ids.forEach(id => {
      const modal = document.getElementById(id);
      if (!modal) return;

      // Overlay sempre acima de qualquer sticky/top
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.zIndex = '9999'; // topo absoluto
      // se houver classe tailwind z-*, mantenha; este inline ganha prioridade

      // Painel interno do modal
      const painel = modal.querySelector('.bg-white');
      if (painel) {
        painel.style.position = 'relative';
        painel.style.zIndex = '10000';
        // Evita qualquer corte de dropdowns em navegadores esquisitos
        painel.style.overflow = 'visible';
      }

      // Contêiner centralizador
      const center = modal.querySelector('.flex.items-center.justify-center');
      if (center) {
        center.style.position = 'absolute';
        center.style.inset = '0';
        center.style.zIndex = '9999';
      }
    });
  } catch (e) {
    console.warn('[NF] fixZIndexModais:', e);
  }
}

/**
 * NotasFiscaisScript_confirmarDesfazer
 * Chama o controller passando chave + número da nota, fecha o modal e recarrega a lista.
 */
function NotasFiscaisScript_confirmarDesfazer() {
  try {
    if (NotasFiscaisScript_desfazendo) return; // guard contra duplo clique rápido

    const chave    = (window.NotasFiscaisScript_state && window.NotasFiscaisScript_state.chaveAcessoAtual) || null;
    const numeroNF = (window.NotasFiscaisScript_state && window.NotasFiscaisScript_state.numeroNFAtual) || null;

    if (!chave) { alert('Chave da NF não definida. Selecione uma nota.'); return; }
    if (numeroNF == null || String(numeroNF).trim() === '') { alert('Número da Nota não definido.'); return; }

    // UI: trava modal + texto de processamento
    NotasFiscaisScript_setModalDesfazerBusy(true);

    // (opcional) liga loader global também
    if (typeof NotasFiscaisScript_toggleLoader === 'function') {
      NotasFiscaisScript_toggleLoader(true);
    }

    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      throw new Error('Ambiente inválido. Abra pelo link publicado do Web App.');
    }

    google.script.run
      .withSuccessHandler(resp => {
        if (typeof NotasFiscaisScript_toggleLoader === 'function') {
          NotasFiscaisScript_toggleLoader(false);
        }
        NotasFiscaisScript_setModalDesfazerBusy(false);

        if (resp && resp.success) {
          // Fecha modal e recarrega lista
          NotasFiscaisScript_closeModalById('modalConfirmarDesfazer');
          if (typeof NotasFiscaisScript_buscar === 'function') {
            NotasFiscaisScript_buscar();
          }
          // feedback
          alert(resp.message || 'Conciliação desfeita com sucesso.');
        } else {
          const msg = (resp && resp.message) ? resp.message : 'Falha ao desfazer.';
          alert(msg);
        }
      })
      .withFailureHandler(err => {
        if (typeof NotasFiscaisScript_toggleLoader === 'function') {
          NotasFiscaisScript_toggleLoader(false);
        }
        NotasFiscaisScript_setModalDesfazerBusy(false);
        alert('Erro ao desfazer conciliação: ' + (err && err.message ? err.message : err));
      })
      .NotasFiscaisController_desfazerConciliacao(chave, numeroNF);

  } catch (e) {
    if (typeof NotasFiscaisScript_toggleLoader === 'function') {
      NotasFiscaisScript_toggleLoader(false);
    }
    NotasFiscaisScript_setModalDesfazerBusy(false);
    console.error('[NF] confirmarDesfazer:', e);
    alert('Erro ao desfazer conciliação.');
  }
}

/**
 * NotasFiscaisScript_abrirModalDesfazer
 * Guarda chave/número no state e abre o modal de confirmação.
 */
function NotasFiscaisScript_abrirModalDesfazer(chaveAcesso, numeroNF) {
  if (!window.NotasFiscaisScript_state) window.NotasFiscaisScript_state = {};
  window.NotasFiscaisScript_state.chaveAcessoAtual = chaveAcesso || null;
  window.NotasFiscaisScript_state.numeroNFAtual    = numeroNF || null;

  // garante que o modal comece habilitado e com rótulo padrão
  NotasFiscaisScript_setModalDesfazerBusy(false);

  NotasFiscaisScript_openModalById('modalConfirmarDesfazer');
}

/**
 * NotasFiscaisScript_setModalDesfazerBusy
 * Controla estado de processamento do modal "Confirmar Desfazer":
 * - Desabilita/abilita botões
 * - Mostra texto "Desfazendo..." e um pequeno spinner no botão Confirmar
 * - Define aria-busy no modal
 */
let NotasFiscaisScript_desfazendo = false;

function NotasFiscaisScript_setModalDesfazerBusy(isBusy) {
  const modal   = document.getElementById('modalConfirmarDesfazer');
  const btnOk   = document.getElementById('btn-confirmar-desfazer');
  const btnClose = modal ? modal.querySelector('[data-modal-close]') : null;

  if (modal) modal.setAttribute('aria-busy', isBusy ? 'true' : 'false');

  if (btnOk) {
    if (!btnOk.dataset.originalLabel) {
      btnOk.dataset.originalLabel = btnOk.innerHTML;
    }
    btnOk.disabled = !!isBusy;

    if (isBusy) {
      btnOk.innerHTML = `
        <span class="inline-flex items-center gap-2">
          <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-opacity="0.25" stroke-width="4"></circle>
            <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="4"></path>
          </svg>
          Desfazendo...
        </span>`;
    } else {
      btnOk.innerHTML = btnOk.dataset.originalLabel || 'Confirmar';
    }
  }

  if (btnClose) btnClose.disabled = !!isBusy;

  NotasFiscaisScript_desfazendo = !!isBusy;
}

// Chamada inicial
NotasFiscaisScript_safeReady();
</script>
