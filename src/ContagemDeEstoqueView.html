<!-- ContagemDeEstoqueView.html -->
<?!= App_incluirHtml('CotacaoIndividualScript', true); ?>
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <!-- viewport otimizado para mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Contagem de Estoque Mobile</title>
  <style>
    /* =============================================
       Estilos Gerais
    ============================================= */
    body {
      margin: 0;
      background: #f3f4f6;
      font-family: 'Inter', sans-serif;
      color: #1f2937;
    }

    /* =============================================
       Search fixo no topo
    ============================================= */
    #ContagemDeEstoqueView_searchContainer {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 420px;
      padding: 0.5rem 1rem;
      background: #f3f4f6;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      z-index: 1000;
      box-sizing: border-box;
    }
    #ContagemDeEstoqueView_searchInput {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 1rem;
      box-sizing: border-box;
    }

    /* =============================================
       Container principal
    ============================================= */
    #appContainer {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      /* empurra o conte√∫do para baixo, evitando sobreposi√ß√£o do search */
      padding: calc(1rem + 2.5rem) 1rem 1rem;
      box-sizing: border-box;
    }

    /* =============================================
       Tipografias e Cores
    ============================================= */
    #title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #4f46e5;
    }
    h2 {
      margin: 1rem 0 0.5rem;
      font-size: 1.25rem;
      color: #374151;
    }
    h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.125rem;
      color: #111827;
    }

    /* =============================================
       Campos e Bot√£o
    ============================================= */
    .campo {
      margin-bottom: 0.75rem;
    }
    .campo label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .campo input,
    .campo select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .produto-bloco {
      background: #ffffff;
      border-radius: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    #btnSalvar {
      display: block;
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 0.375rem;
      background: #4f46e5;
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    #btnSalvar:hover {
      background: #4338ca;
    }

    /* =============================================
       Ajustes para telas muito pequenas (‚â§360px)
    ============================================= */
    @media (max-width: 360px) {
      #title { font-size: 1.25rem; }
      h2 { font-size: 1.1rem; }
      h3 { font-size: 1rem; }
      .campo input,
      .campo select,
      #ContagemDeEstoqueView_searchInput {
        padding: 0.4rem;
        font-size: 0.9rem;
      }
      #btnSalvar {
        padding: 0.6rem;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <div id="appContainer">
    <!-- search flutuante -->
    <div id="ContagemDeEstoqueView_searchContainer">
      <input
        type="search"
        id="ContagemDeEstoqueView_searchInput"
        placeholder="üîç Buscar produto..."
        autocomplete="off"
      />
    </div>

    <!-- t√≠tulo com ID da cota√ß√£o -->
    <div id="title">Contagem de Estoque</div>

    <!-- filtro de agrupamento -->
    <div class="campo">
      <label for="filtroAgrupamento">Organizar por:</label>
      <select id="filtroAgrupamento">
        <option value="produto">Produto</option>
        <option value="fornecedor">Fornecedor</option>
        <option value="categoria">Categoria</option>
      </select>
    </div>

    <!-- container de produtos -->
    <div id="produtosContainer">Carregando...</div>

    <!-- bot√£o salvar -->
    <button id="btnSalvar">Salvar Contagem</button>
  </div>

  <script>
    let idCotacao = null;
    let produtosOriginais = [];
    let ContagemDeEstoqueView_searchTerm = '';

    // 1) Pega idCotacao da URL e ajusta t√≠tulo
    google.script.url.getLocation(loc => {
      idCotacao = loc.parameter.idCotacao || '';
      document.getElementById('title').textContent =
        'Contagem de Estoque ‚Äì Cota√ß√£o ' + idCotacao;
      ContagemDeEstoqueView_carregarDados();
    });

    // 2) Carrega dados do servidor
    function ContagemDeEstoqueView_carregarDados() {
      document.getElementById('produtosContainer').textContent = 'Carregando...';
      google.script.run
        .withSuccessHandler(ContagemDeEstoqueView_renderizarProdutos)
        .withFailureHandler(err => {
          console.error(err);
          document.getElementById('produtosContainer').textContent =
            'Erro ao carregar dados.';
        })
        .CotacaoIndividualController_obterDetalhesDaCotacao(idCotacao);
    }

    // 3) Renderiza blocos por produto principal, aplicando busca e agrupamento
    function ContagemDeEstoqueView_renderizarProdutos(response) {
      if (!response.success) {
        document.getElementById('produtosContainer').textContent =
          'Erro: ' + response.message;
        return;
      }
      produtosOriginais = response.dados;
      const container = document.getElementById('produtosContainer');
      container.innerHTML = '';

      // 3.1) Extrai produtos principais
      const produtosPrincipais = [
        ...new Set(produtosOriginais.map(i => i.Produto))
      ];

      // 3.2) Monta dados de cada produto
      const produtosData = produtosPrincipais.map(prod => {
        const first = produtosOriginais.find(i => i.Produto === prod);
        const p = CotacaoIndividualScript_parsearStringEstoqueComprar(
          first['Estoque Atual']
        );
        return {
          Produto: prod,
          Fornecedor: first.Fornecedor || '',
          Categoria: first.Categoria || '',
          EstoqueMinimo: first.EstoqueMinimoProdutoPrincipal || null,
          estoqueAtual: p.estoqueAtual,
          comprarSug: p.comprar
        };
      });

      // 3.3) Aplica busca
      const filtrados = produtosData.filter(item =>
        item.Produto.toLowerCase().includes(ContagemDeEstoqueView_searchTerm)
      );

      // 3.4) Agrupa conforme filtro
      const agrup = document.getElementById('filtroAgrupamento').value;
      const grupos = {};
      filtrados.forEach(item => {
        let chave = item.Produto;
        if (agrup === 'fornecedor') chave = item.Fornecedor;
        if (agrup === 'categoria') chave = item.Categoria;
        grupos[chave] = grupos[chave] || [];
        grupos[chave].push(item);
      });

      // 3.5) Renderiza cada grupo
      Object.keys(grupos).forEach(grp => {
        const titleEl = document.createElement('h2');
        titleEl.textContent = grp;
        container.appendChild(titleEl);

        grupos[grp].forEach(item => {
          const bloco = document.createElement('div');
          bloco.className = 'produto-bloco';
          bloco.innerHTML = `
            <h3>${item.Produto}</h3>
            <div class="campo">
              <label>(Est. M√≠n. Atual: ${
                item.EstoqueMinimo !== null ? item.EstoqueMinimo : '-'
              })</label>
            </div>
            <div class="campo">
              <label>Novo Estoque M√≠nimo</label>
              <input
                type="number"
                class="input-est-min"
                data-produto="${item.Produto}"
                value="${
                  item.EstoqueMinimo !== null ? item.EstoqueMinimo : ''
                }"
              >
            </div>
            <div class="campo">
              <label>Estoque Contado</label>
              <input
                type="number"
                class="input-est-contado"
                data-produto="${item.Produto}"
                value="${
                  item.estoqueAtual !== null ? item.estoqueAtual : ''
                }"
              >
            </div>
            <div class="campo">
              <label>Comprar (Sugest√£o)</label>
              <input
                type="number"
                class="input-comprar"
                data-produto="${item.Produto}"
                value="${
                  item.comprarSug !== null ? item.comprarSug : ''
                }"
              >
            </div>
          `;
          container.appendChild(bloco);
        });
      });

      // 4) Tab/Enter navega entre inputs do mesmo tipo
      ['input-est-min', 'input-est-contado', 'input-comprar'].forEach(cls => {
        const arr = Array.from(document.getElementsByClassName(cls));
        arr.forEach((inp, i) => {
          inp.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === 'Tab') {
              e.preventDefault();
              const nxt = arr[i + 1];
              if (nxt) nxt.focus();
            }
          });
        });
      });
    }

    // 5) Eventos de UI
    document
      .getElementById('filtroAgrupamento')
      .addEventListener('change', () =>
        ContagemDeEstoqueView_renderizarProdutos({
          success: true,
          dados: produtosOriginais
        })
      );

    document
      .getElementById('ContagemDeEstoqueView_searchInput')
      .addEventListener('input', e => {
        ContagemDeEstoqueView_searchTerm = e.target.value.toLowerCase();
        ContagemDeEstoqueView_renderizarProdutos({
          success: true,
          dados: produtosOriginais
        });
      });

    document.getElementById('btnSalvar').addEventListener('click', () => {
      const dados = [];
      const produtosPrincipais = [
        ...new Set(produtosOriginais.map(i => i.Produto))
      ];
      produtosPrincipais.forEach(prod => {
        const estMin =
          parseFloat(
            document.querySelector(
              `.input-est-min[data-produto="${prod}"]`
            ).value
          ) || null;
        const estCnt =
          parseFloat(
            document.querySelector(
              `.input-est-contado[data-produto="${prod}"]`
            ).value
          ) || null;
        const cmp =
          parseFloat(
            document.querySelector(
              `.input-comprar[data-produto="${prod}"]`
            ).value
          ) || null;
        dados.push({
          nomeProdutoPrincipal: prod,
          novoEstoqueMinimoProdutoPrincipal: estMin,
          estoqueAtualContagem: estCnt,
          comprarSugestao: cmp
        });
      });
      google.script.run
        .withSuccessHandler(resp => {
          if (resp.success) {
            alert(resp.message);
            window.close();
          } else {
            alert('Erro: ' + resp.message);
          }
        })
        .withFailureHandler(err => {
          console.error(err);
          alert('Falha ao salvar contagem.');
        })
        .EtapasController_salvarContagemEstoque(idCotacao, dados);
    });
  </script>
</body>
</html>
