<script>
//####################################################################################################
// MÓDULO: COTACAO INDIVIDUAL (CLIENT-SIDE PRINCIPAL) - CotacaoIndividualScript.html
// Funções principais da página de Cotação Individual, excluindo lógicas de módulos específicos.
//####################################################################################################

//----------------------------------------------------------------------------------------------------
// DECLARAÇÕES GLOBAIS
//----------------------------------------------------------------------------------------------------

const CotacaoIndividualScript_ID_SEARCH_INPUT_TOP = 'CotacaoIndividualScript_searchInput_Top';
const CotacaoIndividualScript_ID_TITULO_PAGINA = 'CotacaoIndividualScript_tituloPagina';
const CotacaoIndividualScript_ID_COTACAO_EXIBIDO = 'CotacaoIndividualScript_idCotacaoExibido';
const CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA = 'CotacaoIndividualScript_dataAberturaExibida';
const CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK = 'CotacaoIndividualScript_mensagemFeedback';
const CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER = 'CotacaoIndividualScript_tableContainer';
const CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO = 'CotacaoIndividualScript_tabelaProdutosCotacao';
const CotacaoIndividualScript_ID_TABELA_LOADING_MSG_CELL = 'CotacaoIndividualScript_tabelaLoadingMsg';
const CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY = 'CotacaoIndividualScript_pageLoadingOverlay';
const CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER = 'CotacaoIndividualScript_retirarProdutosContainer';
const CotacaoIndividualScript_ID_ACORDEAO_CRIT1 = 'CotacaoIndividualScript_acordeaoCrit1';
const CotacaoIndividualScript_ID_ACORDEAO_CRIT2 = 'CotacaoIndividualScript_acordeaoCrit2';
const CotacaoIndividualScript_ID_ACORDEAO_CRIT3 = 'CotacaoIndividualScript_acordeaoCrit3';
const CotacaoIndividualScript_ID_BTN_EXCLUIR_SELECIONADOS_RETIRAR = 'CotacaoIndividualScript_btnExcluirSelecionados';
const CotacaoIndividualScript_ID_BTN_SALVAR_CONTAGEM_ESTOQUE = 'EtapasScript_btnSalvarContagemEstoque';
const CotacaoIndividualScript_ID_MENU_ETAPAS_BTN = 'CotacaoIndividualScript_menuEtapasBtn';
const CotacaoIndividualScript_ID_MENU_ETAPAS_DROPDOWN = 'CotacaoIndividualScript_menuEtapasDropdown';
const CotacaoIndividualScript_ID_MENU_RELATORIOS_BTN = 'CotacaoIndividualScript_menuRelatoriosBtn';
const CotacaoIndividualScript_ID_MENU_RELATORIOS_DROPDOWN = 'CotacaoIndividualScript_menuRelatoriosDropdown';
const CotacaoIndividualScript_ID_MENU_FUNCOES_BTN = 'CotacaoIndividualScript_menuFuncoesBtn';
const CotacaoIndividualScript_ID_MENU_FUNCOES_DROPDOWN = 'CotacaoIndividualScript_menuFuncoesDropdown';
const CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER = 'CotacaoIndividualScript_gerenciarCotacoesPortalContainer';
const CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_BODY = 'CotacaoIndividualScript_gerenciarCotacoesPortalBody';

let CotacaoIndividualScript_cotacaoIdAtual = null;
let CotacaoIndividualScript_modoPagina = 'editar';
let CotacaoIndividualScript_cabecalhosVisiveis = [];
let CABECALHOS_COTACOES_TODOS = [];
let CotacaoIndividualScript_dadosOriginaisCotacao = [];
let CotacaoIndividualScript_modoEtapaAtual = null;
let CotacaoIndividualScript_abaAtiva = 'categoria';

const CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO = [
  "SubProduto", "Fornecedor", "Tamanho", "UN", "Fator", 
  "Preço", "Preço por Fator", "Comprar", "Valor Total"
];
let CotacaoIndividualScript_COLUNAS_PARA_ABA_SUBPRODUTOS_CLIENTE = [];
const CotacaoIndividualScript_MAPA_CORES_COLUNAS = {
  "SubProduto": "bg-col-amarelo", "Categoria": "bg-col-amarelo", "Fornecedor": "bg-col-amarelo",
  "Tamanho": "bg-col-laranja", "UN": "bg-col-laranja", "Fator": "bg-col-laranja",
  "Preço": "bg-col-azul-cot", "Preço por Fator": "bg-col-azul-cot",
  "Comprar": "bg-col-verde", "Valor Total": "bg-col-verde", "Economia em Cotação": "bg-col-verde",
  "Empresa Faturada": "bg-col-roxo-leve", "Condição de Pagamento": "bg-col-roxo-leve"
};

//----------------------------------------------------------------------------------------------------
// FUNÇÕES UTILITÁRIAS GLOBAIS DA PÁGINA
//----------------------------------------------------------------------------------------------------
window.CotacaoIndividualScript_getClasseCorColuna = function(nomeCabecalho) {
  return CotacaoIndividualScript_MAPA_CORES_COLUNAS[nomeCabecalho] || "";
}

window.CotacaoIndividualScript_mostrarLoadingOverlay = function(mostrar = true, mensagem = "Processando...") {
  const overlay = document.getElementById(CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY);
  if (overlay) {
    overlay.classList.toggle('hidden', !mostrar);
    const msgElement = overlay.querySelector('.loading-message-text');
    if (msgElement) msgElement.textContent = mensagem;
  }
}

window.CotacaoIndividualScript_exibirFeedback = function(mensagem, isError = false, duracao = 5000) {
  const feedbackDiv = document.getElementById(CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK);
  if (feedbackDiv) {
    feedbackDiv.textContent = mensagem;
    feedbackDiv.className = `feedback-message ${isError ? 'feedback-error' : 'feedback-success'}`;
    feedbackDiv.classList.remove('hidden');
    if (duracao > 0) {
      setTimeout(() => {
        if (feedbackDiv.textContent === mensagem) {
          feedbackDiv.classList.add('hidden');
          feedbackDiv.textContent = '';
        }
      }, duracao);
    }
  }
}

window.CotacaoIndividualScript_ocultarFeedback = function() {
  const feedbackDiv = document.getElementById(CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK);
  if (feedbackDiv) {
    feedbackDiv.classList.add('hidden');
    feedbackDiv.textContent = '';
  }
}

window.CotacaoIndividualScript_obterParametrosUrl = function() {
  return new Promise((resolve, reject) => {
    try {
      google.script.url.getLocation(function(location) {
        const params = {};
        if (location) {
          if (location.parameter) Object.assign(params, location.parameter);
          if (location.parameters) {
            for (const key in location.parameters) {
              if (location.parameters[key] && location.parameters[key].length === 1) params[key] = location.parameters[key][0];
              else if (location.parameters[key]) params[key] = location.parameters[key];
            }
          }
          resolve(params);
        } else {
          console.error("CotacaoIndividualScript_obterParametrosUrl: Objeto location foi null ou undefined.");
          resolve({});
        }
      });
    } catch (e) {
      console.error("CotacaoIndividualScript_obterParametrosUrl: Erro ao chamar google.script.url.getLocation:", e);
      reject(e);
    }
  });
}

/**
 * FUNÇÃO ATUALIZADA E CORRIGIDA: Interpreta a string de "Estoque Atual / Comprar".
 * Agora lida com números simples ou com o texto complexo.
 */
window.CotacaoIndividualScript_parsearStringEstoqueComprar = function(textoEstoqueComprar) {
    const resultado = { estoqueAtual: null, comprar: null };
    // Garante que estamos trabalhando com uma string e remove espaços em branco
    const texto = String(textoEstoqueComprar).trim();

    // Se o texto estiver vazio, retorna o padrão (nulo)
    if (!texto) {
        return resultado;
    }

    // Tenta extrair "Estoque Atual" e "Comprar" usando a expressão regular
    const matchEstoque = texto.match(/Estoque Atual:\s*([0-9.,]+(?:[.,]\d+)?|N\/A)/i);
    const matchComprar = texto.match(/Comprar:\s*([0-9.,]+(?:[.,]\d+)?|N\/A)/i);

    // Processa o valor de "Estoque Atual" se encontrado
    if (matchEstoque && matchEstoque[1] && matchEstoque[1].toUpperCase() !== 'N/A') {
        resultado.estoqueAtual = parseFloat(String(matchEstoque[1]).replace(",", "."));
    }

    // Processa o valor de "Comprar" se encontrado
    if (matchComprar && matchComprar[1] && matchComprar[1].toUpperCase() !== 'N/A') {
        resultado.comprar = parseFloat(String(matchComprar[1]).replace(",", "."));
    }

    // ================== LÓGICA DE FALLBACK (A GRANDE MUDANÇA) ==================
    // Se nenhuma das expressões regulares encontrou um valor (o que acontece se o texto for só "1"),
    // verificamos se o texto original é, na verdade, um número simples.
    if (matchEstoque === null && matchComprar === null) {
        const num = parseFloat(texto.replace(",", "."));
        // Se a conversão para número for bem-sucedida, atribuímos ao estoque atual.
        if (!isNaN(num)) {
            resultado.estoqueAtual = num;
        }
    }
    // ================== FIM DA LÓGICA DE FALLBACK ==================
    
    return resultado;
}

function CotacaoIndividualScript_removerAcentos(text) {
  if (text === null || text === undefined) return "";
  return text.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function CotacaoIndividualScript_transformarCelulaEmSelect(event, opcoes) {
    const td = event.currentTarget;
    if (td.querySelector('select')) return;

    const valorOriginal = td.dataset.valorOriginal || '';
    const select = document.createElement('select');
    select.className = 'inline-edit-input';

    const optionVazia = document.createElement('option');
    optionVazia.value = "";
    optionVazia.textContent = "Selecione...";
    select.appendChild(optionVazia);

    opcoes.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        if (opt === valorOriginal) {
            option.selected = true;
        }
        select.appendChild(option);
    });

    td.innerHTML = '';
    td.appendChild(select);
    select.style.width = '98%';
    select.style.boxSizing = 'border-box';
    select.focus();

    const salvarAlteracao = () => {
         if (!document.body.contains(select)) return;
         CotacaoIndividualScript_salvarEdicaoInline(select);
    };

    select.addEventListener('blur', salvarAlteracao);

    select.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            e.preventDefault();
            select.removeEventListener('blur', salvarAlteracao);
            td.textContent = valorOriginal;
            td.focus();
        } else if (e.key === 'Enter' || e.key === 'Tab') {
            e.preventDefault();
            const parentTd = select.closest('td');
            select.blur();
            setTimeout(() => {
                if (e.key === 'Tab') {
                    CotacaoIndividualScript_focusNextCell(parentTd, e.shiftKey);
                } else {
                    const currentRow = parentTd.parentElement;
                    const cellIndex = Array.from(currentRow.children).indexOf(parentTd);
                    let nextRow = currentRow.nextElementSibling;
                    while (nextRow && !nextRow.matches('.sub-produto-row, .etapa5-content-row')) {
                        nextRow = nextRow.nextElementSibling;
                    }
                    if (nextRow) {
                        const nextCell = nextRow.children[cellIndex];
                        if (nextCell && nextCell.matches('.editable-price-cell, .editable-select-cell')) {
                            nextCell.focus();
                        }
                    }
                }
            }, 50);
        }
    });
}

//----------------------------------------------------------------------------------------------------
// LÓGICA DE EDIÇÃO INLINE, CÁLCULOS E RENDERIZAÇÃO
//----------------------------------------------------------------------------------------------------
function CotacaoIndividualScript_transformarCelulaEmInput(event) {
    const td = event.currentTarget;
    if (td.querySelector('input')) return;
    const valorOriginal = td.dataset.valorOriginal || '';
    const coluna = td.dataset.coluna;
    const tipoInput = ["Fator", "Preço", "Comprar"].includes(coluna) ? 'number' : 'text';
    td.innerHTML = `<input type="${tipoInput}" step="any" class="inline-edit-input" value="${valorOriginal}" />`;
    const input = td.querySelector('input');
    input.style.width = '95%';
    input.style.boxSizing = 'border-box';
    input.focus();
    input.select();
    input.addEventListener('blur', () => CotacaoIndividualScript_salvarEdicaoInline(input));
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const tdCell = input.parentElement;
            tdCell.textContent = tdCell.dataset.valorOriginal || '';
        }
    });
}

function CotacaoIndividualScript_salvarEdicaoInline(element) {
    const td = element.parentElement;
    let novoValorStr = element.value;
    const valorOriginalStr = td.dataset.valorOriginal || '';
    const coluna = td.dataset.coluna;
    const camposNumericos = ["Fator", "Preço", "Comprar"];
    if (camposNumericos.includes(coluna)) {
        novoValorStr = novoValorStr.replace(',', '.');
    }
    if (novoValorStr === valorOriginalStr.replace(',', '.')) {
        td.textContent = valorOriginalStr;
        return;
    }
    const tr = td.closest('tr');
    const identificadores = {
        Produto: tr.dataset.produto,
        SubProdutoChave: tr.dataset.subprodutoOriginalPersistido,
        Fornecedor: tr.dataset.fornecedor
    };
    let valorDisplay = novoValorStr;
    if (camposNumericos.includes(coluna) && !isNaN(parseFloat(novoValorStr))) {
        const fractionDigits = { 'Preço': 2, 'Comprar': 2, 'Fator': 4 };
        valorDisplay = parseFloat(novoValorStr).toLocaleString('pt-BR', {
            minimumFractionDigits: fractionDigits[coluna] || 2,
            maximumFractionDigits: fractionDigits[coluna] || 2,
        });
    }
    td.textContent = valorDisplay;
    td.dataset.valorOriginal = valorDisplay;
    if (["Fator", "Preço", "Comprar"].includes(coluna)) {
        CotacaoIndividualScript_atualizarGrupoDeCalculosCliente(tr);
    }
    if (CotacaoIndividualScript_modoEtapaAtual === 'definir_empresa') {
        if (typeof EtapasScript_atualizarDashboardFornecedor === 'function') {
            const fornecedor = tr.dataset.fornecedor;
            EtapasScript_atualizarDashboardFornecedor(fornecedor);
        }
        if (typeof EtapasScript_atualizarDashboardGlobal === 'function') {
            EtapasScript_atualizarDashboardGlobal();
        }
    }
    google.script.run
        .withSuccessHandler(response => {
            if (response && response.success) {
                console.log(`Salvo no servidor: ${coluna} = ${novoValorStr}`);
                const itemOriginal = CotacaoIndividualScript_dadosOriginaisCotacao.find(item =>
                    item.Produto === identificadores.Produto &&
                    item._subProdutoOriginalPersistido === identificadores.SubProdutoChave &&
                    item.Fornecedor === identificadores.Fornecedor
                );
                if (itemOriginal) {
                    let valorParaArmazenar = novoValorStr;
                    if (camposNumericos.includes(coluna)) {
                       const num = parseFloat(novoValorStr);
                       if (!isNaN(num)) {
                           valorParaArmazenar = num;
                       }
                    }
                    itemOriginal[coluna] = valorParaArmazenar;
                    console.log('Estado local (array de dados) atualizado para a coluna:', coluna, 'com o valor:', valorParaArmazenar);
                } else {
                    console.warn('Não foi possível encontrar o item no estado local para atualizar.');
                }
                if (response.novoSubProdutoNomeSeAlterado) {
                    tr.dataset.subprodutoOriginalPersistido = response.novoSubProdutoNomeSeAlterado;
                    if(itemOriginal) {
                       itemOriginal._subProdutoOriginalPersistido = response.novoSubProdutoNomeSeAlterado;
                       itemOriginal.SubProduto = response.novoSubProdutoNomeSeAlterado;
                    }
                }
                if (response.valoresCalculados) {
                    const celulaValorTotal = tr.querySelector('td[data-coluna="Valor Total"]');
                    if (celulaValorTotal) {
                        celulaValorTotal.textContent = response.valoresCalculados.valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        if(itemOriginal) itemOriginal['Valor Total'] = response.valoresCalculados.valorTotal;
                    }
                    const celulaPrecoFator = tr.querySelector('td[data-coluna="Preço por Fator"]');
                    if (celulaPrecoFator) {
                        celulaPrecoFator.textContent = response.valoresCalculados.precoPorFator.toLocaleString('pt-BR', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
                        if(itemOriginal) itemOriginal['Preço por Fator'] = response.valoresCalculados.precoPorFator;
                    }
                }
            } else {
                console.error("Falha ao salvar no servidor:", response.message);
                td.textContent = valorOriginalStr;
                td.dataset.valorOriginal = valorOriginalStr;
                td.classList.add('bg-col-vermelho-leve');
                setTimeout(() => td.classList.remove('bg-col-vermelho-leve'), 2000);
            }
        })
        .withFailureHandler(err => {
            console.error("Erro de comunicação com o servidor:", err);
            td.textContent = valorOriginalStr;
            td.dataset.valorOriginal = valorOriginalStr;
            td.classList.add('bg-col-vermelho-leve');
            setTimeout(() => td.classList.remove('bg-col-vermelho-leve'), 2000);
        })
        .CotacaoIndividualController_salvarEdicaoCelulaIndividual(CotacaoIndividualScript_cotacaoIdAtual, identificadores, coluna, novoValorStr);
}

function CotacaoIndividualScript_atualizarGrupoDeCalculosCliente(trEditada) {
    const nomeProdutoPrincipal = trEditada.dataset.produto;
    if (!nomeProdutoPrincipal) return;
    const tbody = trEditada.parentElement;
    const todasLinhasDoGrupo = tbody.querySelectorAll(`tr.sub-produto-row[data-produto="${nomeProdutoPrincipal}"]`);
    const lerValorDaLinha = (tr, coluna) => {
        const cell = tr.querySelector(`td[data-coluna="${coluna}"]`);
        const valorTexto = cell.querySelector('input')?.value || cell?.dataset.valorOriginal || cell?.textContent || '0';
        return parseFloat(String(valorTexto).replace(/\./g, '').replace(',', '.')) || 0;
    };
    const escreverValorNaLinha = (tr, coluna, valor, casasDecimais = 2) => {
        const cell = tr.querySelector(`td[data-coluna="${coluna}"]`);
        if (cell) {
             const valorFormatado = valor.toLocaleString('pt-BR', {
                minimumFractionDigits: casasDecimais,
                maximumFractionDigits: casasDecimais
            });
            cell.textContent = valorFormatado;
            cell.dataset.valorOriginal = valorFormatado;
        }
    };
    let maxPrecoPorFator = 0;
    todasLinhasDoGrupo.forEach(tr => {
        const preco = lerValorDaLinha(tr, "Preço");
        const fator = lerValorDaLinha(tr, "Fator");
        const precoPorFator = fator > 0 ? (preco / fator) : 0;
        if (precoPorFator > maxPrecoPorFator) {
            maxPrecoPorFator = precoPorFator;
        }
    });
    todasLinhasDoGrupo.forEach(tr => {
        const preco = lerValorDaLinha(tr, "Preço");
        const fator = lerValorDaLinha(tr, "Fator");
        const comprar = lerValorDaLinha(tr, "Comprar");
        const precoPorFator = fator > 0 ? (preco / fator) : 0;
        escreverValorNaLinha(tr, "Preço por Fator", precoPorFator, 4);
        const valorTotal = preco * comprar;
        escreverValorNaLinha(tr, "Valor Total", valorTotal, 2);
        let economia = 0;
        if (comprar > 0 && maxPrecoPorFator > 0 && todasLinhasDoGrupo.length > 1) {
            economia = (maxPrecoPorFator * fator * comprar) - (preco * comprar);
        }
        escreverValorNaLinha(tr, "Economia em Cotação", economia, 2);
    });
}

function CotacaoIndividualScript_forcarRecalculoTotalUI() {
    console.log("Forçando recálculo total da UI...");
    CotacaoIndividualScript_mostrarLoadingOverlay(true, "Recalculando valores...");
    const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
    if (!tbody) {
        console.error("Tbody não encontrado para o recálculo.");
        CotacaoIndividualScript_mostrarLoadingOverlay(false);
        return;
    }
    const todosOsGruposDeProdutos = new Set();
    tbody.querySelectorAll('tr.sub-produto-row[data-produto]').forEach(row => {
        todosOsGruposDeProdutos.add(row.dataset.produto);
    });
    todosOsGruposDeProdutos.forEach(nomeProduto => {
        const umaLinhaDoGrupo = tbody.querySelector(`tr.sub-produto-row[data-produto="${nomeProduto}"]`);
        if (umaLinhaDoGrupo) {
            CotacaoIndividualScript_atualizarGrupoDeCalculosCliente(umaLinhaDoGrupo);
        }
    });
    setTimeout(() => {
        CotacaoIndividualScript_mostrarLoadingOverlay(false);
        CotacaoIndividualScript_exibirFeedback('Cálculos da tela atualizados com sucesso!', false, 3000);
    }, 250);
}

function CotacaoIndividualScript_filtrarTabelaPrincipal() {
    const termoBusca = document.getElementById(CotacaoIndividualScript_ID_SEARCH_INPUT_TOP).value;
    const termoNormalizado = CotacaoIndividualScript_removerAcentos(termoBusca.toLowerCase());
    const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
    if (!tbody) return;
    const todasLinhasSubProduto = Array.from(tbody.querySelectorAll('.sub-produto-row'));
    todasLinhasSubProduto.forEach(row => {
        if (row.classList.contains('hidden-by-etapa')) {
            row.classList.remove('hidden-by-search');
            return;
        }
        let textoLinha = "";
        CotacaoIndividualScript_cabecalhosVisiveis.forEach(cabecalho => {
            const cell = row.querySelector(`td[data-coluna="${cabecalho}"]`);
            if (cell) textoLinha += (cell.textContent || "") + " ";
        });
        textoLinha += (row.dataset.produto || "") + " ";
        textoLinha += (row.dataset.categoria || "") + " ";
        textoLinha += (row.dataset.fornecedor || "") + " ";
        const textoLinhaNormalizado = CotacaoIndividualScript_removerAcentos(textoLinha.toLowerCase());
        const deveEsconder = !(termoNormalizado === "" || textoLinhaNormalizado.includes(termoNormalizado));
        row.classList.toggle('hidden-by-search', deveEsconder);
    });
    const cabecalhosDeGrupo = Array.from(tbody.querySelectorAll('.categoria-accordion-header-row'));
    cabecalhosDeGrupo.forEach(linhaGrupo => {
        const grupoTargetClass = linhaGrupo.dataset.targetClass;
        const subProdutosVisiveisNesteGrupo = todasLinhasSubProduto.some(subRow =>
            subRow.classList.contains(grupoTargetClass) &&
            !subRow.classList.contains('hidden-by-search')
        );
        let deveEsconderGrupo = !subProdutosVisiveisNesteGrupo;
        if (CotacaoIndividualScript_abaAtiva === 'categoria') {
            const produtosPrincipaisDoGrupo = tbody.querySelectorAll(`.produto-group-separator-row.${grupoTargetClass}`);
            let algumProdutoPrincipalVisivel = false;
            produtosPrincipaisDoGrupo.forEach(linhaProdutoPrincipal => {
                const nomeProduto = linhaProdutoPrincipal.dataset.produtoNome;
                const subProdutosVisiveisDestePrincipal = todasLinhasSubProduto.some(subRow =>
                    subRow.dataset.produto === nomeProduto &&
                    !subRow.classList.contains('hidden-by-search')
                );
                const deveEsconderProdutoPrincipal = !subProdutosVisiveisDestePrincipal;
                linhaProdutoPrincipal.classList.toggle('hidden-by-search', deveEsconderProdutoPrincipal);
                if (!deveEsconderProdutoPrincipal) {
                    algumProdutoPrincipalVisivel = true;
                }
            });
            deveEsconderGrupo = !algumProdutoPrincipalVisivel;
        }
        linhaGrupo.classList.toggle('hidden-by-search', deveEsconderGrupo);
        const icon = linhaGrupo.querySelector('.categoria-accordion-icon');
        if (termoNormalizado !== "" && !deveEsconderGrupo && !linhaGrupo.classList.contains('expanded')) {
            linhaGrupo.classList.add('expanded');
            if(icon) icon.style.transform = 'rotate(90deg)';
            tbody.querySelectorAll(`.${grupoTargetClass}`).forEach(itemRow => {
                if (!itemRow.classList.contains('hidden-by-search')) {
                    itemRow.classList.remove('hidden');
                }
            });
        }
    });
}

function renderizarCabecalhoTabelaPrincipalInterno() {
    const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
    if (!tabela) { console.error("Tabela principal não encontrada."); return; }
    const thead = tabela.querySelector('thead');
    if (!thead) { console.error("Thead da tabela principal não encontrado."); return; }
    thead.innerHTML = '';
    if (!CotacaoIndividualScript_cabecalhosVisiveis || CotacaoIndividualScript_cabecalhosVisiveis.length === 0) {
        const tr = thead.insertRow();
        const th = tr.insertCell();
        th.textContent = "Nenhuma coluna para exibir";
        return;
    }
    const tr = thead.insertRow();
    CotacaoIndividualScript_cabecalhosVisiveis.forEach(textoCabecalho => {
      const th = document.createElement('th');
      th.textContent = textoCabecalho;
      tr.appendChild(th);
    });
}

function agruparEClassificarProdutosInterno(todosOsProdutosDaCotacao) {
    if (!todosOsProdutosDaCotacao || todosOsProdutosDaCotacao.length === 0) return [];
    const gruposTemp = {};
    todosOsProdutosDaCotacao.forEach(linhaProduto => {
        const nomeProdutoPrincipal = linhaProduto["Produto"];
        const categoriaProduto = linhaProduto["Categoria"] || "Sem Categoria";
        const chaveGrupo = `${categoriaProduto}|${nomeProdutoPrincipal}`;
        if (!gruposTemp[chaveGrupo]) {
            gruposTemp[chaveGrupo] = {
                produtoNome: nomeProdutoPrincipal,
                categoria: categoriaProduto,
                subProdutos: [],
                estoqueMinimoProdutoPrincipal: linhaProduto.hasOwnProperty("EstoqueMinimoProdutoPrincipal") ? linhaProduto["EstoqueMinimoProdutoPrincipal"] : null
            };
        }
        gruposTemp[chaveGrupo].subProdutos.push(linhaProduto);
    });
    let arrayDeGrupos = Object.values(gruposTemp);
    arrayDeGrupos.sort((a, b) => {
        const catA = String(a.categoria).toLowerCase(); const catB = String(b.categoria).toLowerCase();
        if (catA < catB) return -1; if (catA > catB) return 1;
        const nomeA = String(a.produtoNome).toLowerCase(); const nomeB = String(b.produtoNome).toLowerCase();
        if (nomeA < nomeB) return -1; if (nomeA > nomeB) return 1;
        return 0;
    });
    arrayDeGrupos.forEach(grupo => {
        grupo.subProdutos.sort((a, b) => {
            const subNomeAOriginal = String(a["_subProdutoOriginalPersistido"] || a["SubProduto"] || "").toLowerCase();
            const subNomeBOriginal = String(b["_subProdutoOriginalPersistido"] || b["SubProduto"] || "").toLowerCase();
            if (subNomeAOriginal < subNomeBOriginal) return -1;
            if (subNomeAOriginal > subNomeBOriginal) return 1;
            return 0;
        });
    });
    return arrayDeGrupos;
}

/**
 * FUNÇÃO ATUALIZADA: Monta o corpo da tabela de produtos, agrupados por categoria.
 */
function renderizarGruposDeProdutosInterno(gruposDeProdutos) {
    const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
    if (!tabela) { console.error("Tabela não encontrada."); return; }
    const tbody = tabela.querySelector('tbody');
    if (!tbody) { console.error("Tbody não encontrado."); return; }
    tbody.innerHTML = '';
    if (!gruposDeProdutos || gruposDeProdutos.length === 0) {
        const tr = tbody.insertRow();
        const td = tr.insertCell();
        td.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length || 1;
        td.className = 'text-center p-8 text-gray-500';
        td.textContent = 'Nenhum produto agrupado para esta cotação.';
        return;
    }
    let categoriaAtualRenderizada = null;
    const colunasEditaveis = ["SubProduto", "Tamanho", "UN", "Fator", "Preço", "Comprar"];
    gruposDeProdutos.forEach(grupo => {
        const catSanit = String(grupo.categoria).replace(/[^a-zA-Z0-9-_]/g, '').toLowerCase() || 'sem-categoria';
        const catClass = `content-for-category-${catSanit}`;
        if (grupo.categoria !== categoriaAtualRenderizada) {
            const catRow = tbody.insertRow();
            catRow.className = 'categoria-accordion-header-row';
            catRow.dataset.targetClass = catClass;
            catRow.dataset.categoriaNome = grupo.categoria;
            const catCell = catRow.insertCell();
            catCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length || 1;
            const headerDiv = document.createElement('div');
            headerDiv.className = 'categoria-header-content';
            const icon = document.createElementNS("http://www.w3.org/2000/svg","svg");
            icon.setAttribute("class","categoria-accordion-icon");
            icon.setAttribute("viewBox","0 0 20 20");
            icon.setAttribute("fill","currentColor");
            icon.innerHTML = `<path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>`;
            headerDiv.appendChild(icon);
            const span = document.createElement('span');
            span.textContent = `Categoria: ${grupo.categoria}`;
            headerDiv.appendChild(span);
            catCell.appendChild(headerDiv);
            catRow.addEventListener('click', function() {
                this.classList.toggle('expanded');
                const exp = this.classList.contains('expanded');
                if (icon) icon.style.transform = exp ? 'rotate(90deg)' : 'rotate(0deg)';
                tbody.querySelectorAll(`.${this.dataset.targetClass}`).forEach(r => {
                    if (!r.classList.contains('hidden-by-search') &&
                        !r.classList.contains('hidden-by-etapa')) {
                        r.classList.toggle('hidden', !exp);
                    }
                });
            });
            categoriaAtualRenderizada = grupo.categoria;
        }
        const sepRow = tbody.insertRow();
        sepRow.className = `produto-group-separator-row category-content-row ${catClass} hidden`;
        sepRow.dataset.produtoNome = grupo.produtoNome;
        sepRow.dataset.categoria = grupo.categoria;
        const sepCell = sepRow.insertCell();
        sepCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length || 1;
        if (CotacaoIndividualScript_modoEtapaAtual !== 'contagem_estoque') {
            const min = grupo.estoqueMinimoProdutoPrincipal != null ? grupo.estoqueMinimoProdutoPrincipal : 'N/A';
            
            // ================= INÍCIO DA MUDANÇA =================
            // Pega o valor bruto do estoque atual do primeiro subproduto do grupo.
            const valorEstoqueBruto = grupo.subProdutos[0]["Estoque Atual"];
            // Formata para exibição, mostrando o valor bruto ou 'N/A' se for nulo/vazio.
            const estoqueParaExibir = (valorEstoqueBruto !== null && valorEstoqueBruto !== undefined && valorEstoqueBruto !== "") ? valorEstoqueBruto : 'N/A';
            // Monta o texto do separador usando o valor bruto.
            sepCell.textContent = `Produto: ${grupo.produtoNome} (Estoque Mínimo: ${min}) (Estoque Atual: ${estoqueParaExibir})`;
            // ================= FIM DA MUDANÇA =================
        }
        if (grupo.subProdutos && grupo.subProdutos.length > 0) {
            grupo.subProdutos.forEach(sub => {
                const subRow = tbody.insertRow();
                subRow.className = `sub-produto-row category-content-row ${catClass} hidden`;
                if (CotacaoIndividualScript_modoEtapaAtual === 'contagem_estoque') {
                    subRow.classList.add('hidden-by-etapa');
                }
                subRow.dataset.subprodutoOriginalPersistido = sub["_subProdutoOriginalPersistido"] || sub["SubProduto"];
                subRow.dataset.produto    = sub['Produto'];
                subRow.dataset.fornecedor = sub['Fornecedor'];
                subRow.dataset.subprodutoAtual = sub['SubProduto'];
                subRow.dataset.categoria = sub['Categoria'] || 'Sem Categoria';
                CotacaoIndividualScript_cabecalhosVisiveis.forEach(header => {
                    const td = subRow.insertCell();
                    const cor = CotacaoIndividualScript_getClasseCorColuna(header);
                    if (cor) td.classList.add(cor);
                    let val = sub[header];
                    let fmt;
                    const camposNumericos = ["Fator", "Preço", "Preço por Fator", "Comprar", "Valor Total", "Economia em Cotação"];
                    if (camposNumericos.includes(header) && typeof val === 'number') {
                        const fractionDigits = { 'Fator': 4, 'Preço por Fator': 4, 'Preço': 2, 'Comprar': 2, 'Valor Total': 2, 'Economia em Cotação': 2 };
                        fmt = val.toLocaleString('pt-BR', { minimumFractionDigits: fractionDigits[header] || 2, maximumFractionDigits: fractionDigits[header] || 2 });
                    } else {
                        fmt = val == null ? "" : String(val);
                    }
                    td.textContent = fmt;
                    td.dataset.coluna       = header;
                    td.dataset.valorOriginal = fmt;
                    if (colunasEditaveis.includes(header)) {
                        td.classList.add('editable-price-cell');
                        td.tabIndex = 0;
                        td.addEventListener('click', CotacaoIndividualScript_transformarCelulaEmInput);
                    }
                });
            });
        }
    });
}

function initDropdownsInterno() {
    const dropdowns = [
        { btnId: CotacaoIndividualScript_ID_MENU_ETAPAS_BTN, contentId: CotacaoIndividualScript_ID_MENU_ETAPAS_DROPDOWN },
        { btnId: CotacaoIndividualScript_ID_MENU_RELATORIOS_BTN, contentId: CotacaoIndividualScript_ID_MENU_RELATORIOS_DROPDOWN },
        { btnId: CotacaoIndividualScript_ID_MENU_FUNCOES_BTN, contentId: CotacaoIndividualScript_ID_MENU_FUNCOES_DROPDOWN }
    ];
    dropdowns.forEach(ddInfo => {
        const btn = document.getElementById(ddInfo.btnId);
        const content = document.getElementById(ddInfo.contentId);
        if (btn && content) {
            btn.addEventListener('click', function(event) {
                event.stopPropagation();
                document.querySelectorAll('.dropdown-menu-content.show').forEach(openDropdown => {
                    if (openDropdown !== content) {
                        openDropdown.classList.remove('show');
                        const otherBtnId = openDropdown.id.replace('Dropdown', 'Btn');
                        const otherBtn = document.getElementById(otherBtnId);
                        if(otherBtn) otherBtn.classList.remove('open');
                    }
                });
                content.classList.toggle('show');
                btn.classList.toggle('open');
                const icon = btn.querySelector('.dropdown-arrow');
                if (icon) icon.style.transform = content.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
            });
            content.querySelectorAll('a').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const action = this.dataset.action;
                    console.log("Menu item clicado:", action, "ID da Cotação:", CotacaoIndividualScript_cotacaoIdAtual);
                    content.classList.remove('show');
                    btn.classList.remove('open');
                    const icon = btn.querySelector('.dropdown-arrow');
                    if (icon) icon.style.transform = 'rotate(0deg)';
                    const modoAnterior = CotacaoIndividualScript_modoEtapaAtual;
                    const novoModoPotencial = action.startsWith('etapa_') ? action.substring(6) : (action.startsWith('funcao_') ? action.substring(7) : (action.startsWith('relatorio_') ? action.substring(10) : null));
                    if (modoAnterior && !action.startsWith('relatorio_')) {
                         if (novoModoPotencial && modoAnterior !== novoModoPotencial || !novoModoPotencial) {
                            if (modoAnterior === 'contagem_estoque' && typeof EtapasScript_fecharModalContagemEstoque === 'function') EtapasScript_fecharModalContagemEstoque();
                            else if (modoAnterior === 'retirar_produtos' && typeof EtapasScript_fecharModalRetirarProdutos === 'function') EtapasScript_fecharModalRetirarProdutos();
                            else if (modoAnterior === 'gerenciar_cotacoes_portal' && typeof FuncoesScript_fecharModalGerenciarCotacoes === 'function') FuncoesScript_fecharModalGerenciarCotacoes();
                            else if (modoAnterior === 'realizar_cotacao' && typeof EtapasScript_desativarModoRealizarCotacao === 'function') EtapasScript_desativarModoRealizarCotacao();
                            else if (modoAnterior === 'definir_empresa' && typeof EtapasScript_fecharModalDefinirEmpresa === 'function') EtapasScript_fecharModalDefinirEmpresa();
                            else if (modoAnterior === 'definir_condicoes_pagamento' && typeof EtapasScript_fecharModalCondicoesPagamento === 'function') EtapasScript_fecharModalCondicoesPagamento();
                        }
                    }
                    switch(action) {
                        case 'etapa_contagem_estoque': if (typeof EtapasScript_ativarModoContagemEstoque === 'function') EtapasScript_ativarModoContagemEstoque(); break;
                        case 'etapa_retirar_produtos': if (typeof EtapasScript_ativarModoRetirarProdutos === 'function') EtapasScript_ativarModoRetirarProdutos(); break;
                        case 'etapa_enviar_fornecedores': if (typeof EtapasScript_iniciarEnvioParaFornecedores === 'function') EtapasScript_iniciarEnvioParaFornecedores(); break;
                        case 'etapa_realizar_cotacao': if (typeof EtapasScript_ativarModoRealizarCotacao === 'function') EtapasScript_ativarModoRealizarCotacao(); break;
                        case 'etapa_definir_empresa': if (typeof EtapasScript_ativarModoDefinirEmpresa === 'function') EtapasScript_ativarModoDefinirEmpresa(); break;
                        case 'etapa_definir_condicoes_pagamento': if (typeof EtapasScript_ativarModoDefinirCondicoesPagamento === 'function') EtapasScript_ativarModoDefinirCondicoesPagamento(); break;
                        case 'etapa_imprimir_pedidos': if (typeof EtapasScript_abrirPaginaImpressao === 'function') EtapasScript_abrirPaginaImpressao(); break;
                        case 'funcao_gerenciar_cotacoes': if (typeof FuncoesScript_ativarModoGerenciarCotacoesPortal === 'function') FuncoesScript_ativarModoGerenciarCotacoesPortal(); break;
                        case 'funcao_acrescentar_itens': if (typeof FuncoesScript_ativarModoAcrescentarItens === 'function') FuncoesScript_ativarModoAcrescentarItens(); break;
                        case 'funcao_preencher_precos': if (typeof FuncoesScript_iniciarPreenchimentoUltimosPrecos === 'function') { FuncoesScript_iniciarPreenchimentoUltimosPrecos(); } else { console.error("Função FuncoesScript_iniciarPreenchimentoUltimosPrecos não definida."); } break;
                        case 'relatorio_analise_compra': if (typeof RelatoriosScript_abrirRelatorioAnaliseCompra === 'function') { RelatoriosScript_abrirRelatorioAnaliseCompra(CotacaoIndividualScript_cotacaoIdAtual); } else { console.error("Função RelatoriosScript_abrirRelatorioAnaliseCompra não definida."); } break;
                        default:
                            if (!action.startsWith('relatorio_')) {
                                CotacaoIndividualScript_renderizarVisualizacaoCategoria();
                                CotacaoIndividualScript_modoEtapaAtual = null;
                            }
                            CotacaoIndividualScript_exibirFeedback(`Ação do menu: ${this.textContent} (ID: ${action}) selecionada. Implementação pendente.`, false, 4000);
                    }
                });
            });
        }
    });
    window.addEventListener('click', function() {
        document.querySelectorAll('.dropdown-menu-content.show').forEach(openDropdown => {
            openDropdown.classList.remove('show');
            const btnId = openDropdown.id.replace('Dropdown', 'Btn');
            const btn = document.getElementById(btnId);
            if(btn) {
                btn.classList.remove('open');
                const icon = btn.querySelector('.dropdown-arrow');
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        });
    });
}

async function inicializarPaginaPrincipal() {
    console.log("CotacaoIndividualScript: Iniciando lógica principal da página...");
    CotacaoIndividualScript_ocultarFeedback();
    const searchInputTop = document.getElementById(CotacaoIndividualScript_ID_SEARCH_INPUT_TOP);
    if (searchInputTop) {
        searchInputTop.addEventListener('input', CotacaoIndividualScript_filtrarTabelaPrincipal);
    }
    const btnRecalcular = document.getElementById('CotacaoIndividualScript_btnRecalcularUI');
    if (btnRecalcular) {
        btnRecalcular.addEventListener('click', CotacaoIndividualScript_forcarRecalculoTotalUI);
    }
    const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
    if(tabela) {
        const tbody = tabela.querySelector('tbody');
        if (tbody) {
            tbody.addEventListener('keydown', CotacaoIndividualScript_handleTableNavigation);
        }
    }
    const btnAbaCategoria = document.getElementById('CotacaoIndividualScript_btnAbaCategoria');
    const btnAbaFornecedor = document.getElementById('CotacaoIndividualScript_btnAbaFornecedor');
    if (btnAbaCategoria) {
        btnAbaCategoria.addEventListener('click', CotacaoIndividualScript_renderizarVisualizacaoCategoria);
    }
    if (btnAbaFornecedor) {
        btnAbaFornecedor.addEventListener('click', CotacaoIndividualScript_renderizarVisualizacaoFornecedor);
    }
    let paramsUrl;
    try {
        paramsUrl = await CotacaoIndividualScript_obterParametrosUrl();
    } catch (error) {
        console.error("CotacaoIndividualScript_inicializarPagina: Erro ao obter parâmetros da URL:", error);
        CotacaoIndividualScript_exibirFeedback("Erro crítico ao carregar parâmetros da página.", true, 0);
        paramsUrl = {};
    }
    CotacaoIndividualScript_cotacaoIdAtual = paramsUrl && paramsUrl.idCotacao ? paramsUrl.idCotacao : null;
    CotacaoIndividualScript_modoPagina = paramsUrl && paramsUrl.modo ? paramsUrl.modo : 'editar';
    const spanIdCotacao = document.getElementById(CotacaoIndividualScript_ID_COTACAO_EXIBIDO);
    renderizarCabecalhoTabelaPrincipalInterno();
    if (CotacaoIndividualScript_modoPagina === 'novo') {
        if (spanIdCotacao) spanIdCotacao.textContent = "Nova Cotação";
        document.title = "Nova Cotação - CotaçãoPRO";
        const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
        if (tbody) tbody.innerHTML = `<tr><td colspan="${CotacaoIndividualScript_cabecalhosVisiveis.length || 1}" class="text-center p-8 text-gray-500">Adicione produtos à nova cotação. (Funcionalidade pendente)</td></tr>`;
        CotacaoIndividualScript_exibirFeedback("Modo 'Nova Cotação'. Adição de produtos pendente.", false, 6000);
    } else if (CotacaoIndividualScript_cotacaoIdAtual) {
        if (spanIdCotacao) spanIdCotacao.textContent = CotacaoIndividualScript_cotacaoIdAtual;
        document.title = `Cotação: ${CotacaoIndividualScript_cotacaoIdAtual}`;
        await window.CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
        CotacaoIndividualScript_renderizarVisualizacaoCategoria();
    } else {
        if (spanIdCotacao) spanIdCotacao.textContent = "Inválida";
        document.title = "Cotação Inválida - CotaçãoPRO";
        CotacaoIndividualScript_exibirFeedback("ID da Cotação não fornecido ou inválido.", true, 0);
        const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
        if (tbody) tbody.innerHTML = `<tr><td colspan="${CotacaoIndividualScript_cabecalhosVisiveis.length || 1}" class="text-center p-8 text-red-500">Erro: ID da Cotação não fornecido.</td></tr>`;
    }
    const btnFecharModalItens = document.getElementById('CotacaoIndividualScript_btnFecharModalAcrescentarItens');
    const btnCancelarModalItens = document.getElementById('CotacaoIndividualScript_btnCancelarModalAcrescentarItens');
    const btnAcrescentarModal = document.getElementById('CotacaoIndividualScript_btnAcrescentarItensModal');
    const selectTipoCriacaoItens = document.getElementById('CotacaoIndividualScript_selectTipoCriacaoItens');
    const modalOverlayItens = document.getElementById('CotacaoIndividualScript_modalAcrescentarItensOverlay');
    const buscaFornecedorInputItens = document.getElementById('CotacaoIndividualScript_inputBuscaFornecedorItens');
    const buscaProdutoInputItens = document.getElementById('CotacaoIndividualScript_inputBuscaProdutoItens');
    if(btnFecharModalItens) btnFecharModalItens.addEventListener('click', FuncoesScript_fecharModalAcrescentarItens);
    if(btnCancelarModalItens) btnCancelarModalItens.addEventListener('click', FuncoesScript_fecharModalAcrescentarItens);
    if(btnAcrescentarModal) btnAcrescentarModal.addEventListener('click', FuncoesScript_lidarComAcrescentarItens);
    if(selectTipoCriacaoItens) {
        selectTipoCriacaoItens.addEventListener('change', function() {
            if (typeof FuncoesScript_gerenciarVisibilidadeSecoesOpcoesItens === 'function') {
                FuncoesScript_gerenciarVisibilidadeSecoesOpcoesItens(this.value);
            }
        });
    }
    if(modalOverlayItens) {
        modalOverlayItens.addEventListener('click', function(event) {
            if (event.target === modalOverlayItens) {
                FuncoesScript_fecharModalAcrescentarItens();
            }
        });
    }
    if(buscaFornecedorInputItens){
        buscaFornecedorInputItens.addEventListener('keyup', function(){
            if(typeof FuncoesScript_filtrarCheckboxesItens === 'function') {
                FuncoesScript_filtrarCheckboxesItens('CotacaoIndividualScript_checkboxContainerFornecedoresItens', this.value);
            }
        });
    }
    if(buscaProdutoInputItens){
        buscaProdutoInputItens.addEventListener('keyup', function(){
            if(typeof FuncoesScript_filtrarCheckboxesItens === 'function') {
                FuncoesScript_filtrarCheckboxesItens('CotacaoIndividualScript_checkboxContainerProdutosItens', this.value);
            }
        });
    }
    initDropdownsInterno();
}

function CotacaoIndividualScript_getNavegaveis() {
    return Array.from(document.querySelectorAll('#' + CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO + ' .editable-price-cell, #' + CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO + ' .editable-select-cell'))
                .filter(cell => cell.offsetParent !== null);
}

function CotacaoIndividualScript_focusNextCell(currentCell, isPrevious = false) {
    const navegaveis = CotacaoIndividualScript_getNavegaveis();
    if (navegaveis.length === 0) return;
    const currentIndex = navegaveis.indexOf(currentCell);
    if (currentIndex === -1) {
        navegaveis[0].focus();
        return;
    }
    let nextIndex;
    if (isPrevious) {
        nextIndex = (currentIndex - 1 + navegaveis.length) % navegaveis.length;
    } else {
        nextIndex = (currentIndex + 1) % navegaveis.length;
    }
    navegaveis[nextIndex].focus();
}

function CotacaoIndividualScript_handleTableNavigation(e) {
    const activeElement = document.activeElement;
    if (!activeElement || !activeElement.matches('td, input, select')) return;
    const currentCell = activeElement.closest('td');
    if (!currentCell) return;
    const isInEditMode = activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT';
    if (isInEditMode) {
        if (e.key === 'Enter') {
            e.preventDefault();
            activeElement.blur();
            setTimeout(() => {
                const currentRow = currentCell.parentElement;
                const cellIndex = Array.from(currentRow.children).indexOf(currentCell);
                let nextRow = currentRow.nextElementSibling;
                while (nextRow && !nextRow.matches('.sub-produto-row, .etapa5-content-row')) {
                    nextRow = nextRow.nextElementSibling;
                }
                if (nextRow) {
                    const nextCell = nextRow.children[cellIndex];
                    if (nextCell) nextCell.focus();
                }
            }, 50);
        } else if (e.key === 'Tab') {
            e.preventDefault();
            activeElement.blur();
            setTimeout(() => CotacaoIndividualScript_focusNextCell(currentCell, e.shiftKey), 50);
        }
        return;
    }
    if (!isInEditMode) {
        switch (e.key) {
            case 'Enter':
                e.preventDefault();
                const clickEvent = new MouseEvent('click', { bubbles: true, cancelable: true });
                currentCell.dispatchEvent(clickEvent);
                break;
            case 'Tab':
                e.preventDefault();
                CotacaoIndividualScript_focusNextCell(currentCell, e.shiftKey);
                break;
            case 'ArrowRight': {
                e.preventDefault();
                let next = currentCell.nextElementSibling;
                while (next && !next.matches('.editable-price-cell, .editable-select-cell')) {
                    next = next.nextElementSibling;
                }
                if (next) next.focus();
                break;
            }
            case 'ArrowLeft': {
                e.preventDefault();
                let prev = currentCell.previousElementSibling;
                while (prev && !prev.matches('.editable-price-cell, .editable-select-cell')) {
                    prev = prev.previousElementSibling;
                }
                if (prev) prev.focus();
                break;
            }
            case 'ArrowDown': {
                e.preventDefault();
                const currentRow = currentCell.parentElement;
                const cellIndex = Array.from(currentRow.children).indexOf(currentCell);
                let nextRow = currentRow.nextElementSibling;
                while (nextRow && !nextRow.matches('.sub-produto-row, .etapa5-content-row')) {
                    nextRow = nextRow.nextElementSibling;
                }
                if (nextRow) {
                    const nextCell = nextRow.children[cellIndex];
                    if (nextCell) nextCell.focus();
                }
                break;
            }
            case 'ArrowUp': {
                e.preventDefault();
                const currentRow = currentCell.parentElement;
                const cellIndex = Array.from(currentRow.children).indexOf(currentCell);
                let prevRow = currentRow.previousElementSibling;
                while (prevRow && !prevRow.matches('.sub-produto-row, .etapa5-content-row')) {
                    prevRow = prevRow.previousElementSibling;
                }
                if (prevRow) {
                    const prevCell = prevRow.children[cellIndex];
                    if (prevCell) prevCell.focus();
                }
                break;
            }
        }
    }
}

function CotacaoIndividualScript_renderizarVisualizacaoCategoria() {
    console.log("Renderizando visualização por Categoria.");
    CotacaoIndividualScript_abaAtiva = 'categoria';
    document.getElementById('CotacaoIndividualScript_btnAbaCategoria').classList.add('active');
    document.getElementById('CotacaoIndividualScript_btnAbaFornecedor').classList.remove('active');
    document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.remove('hidden');
    document.getElementById(CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER).classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER).classList.add('hidden');
    CotacaoIndividualScript_cabecalhosVisiveis = CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO;
    renderizarCabecalhoTabelaPrincipalInterno();
    const gruposDeProdutos = agruparEClassificarProdutosInterno(CotacaoIndividualScript_dadosOriginaisCotacao);
    renderizarGruposDeProdutosInterno(gruposDeProdutos);
    CotacaoIndividualScript_filtrarTabelaPrincipal();
}

function CotacaoIndividualScript_renderizarVisualizacaoFornecedor() {
    console.log("Renderizando visualização por Fornecedor.");
    CotacaoIndividualScript_abaAtiva = 'fornecedor';
    document.getElementById('CotacaoIndividualScript_btnAbaFornecedor').classList.add('active');
    document.getElementById('CotacaoIndividualScript_btnAbaCategoria').classList.remove('active');
    document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.remove('hidden');
    document.getElementById(CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER).classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER).classList.add('hidden');
    if (typeof FuncoesScript_renderizarVisualizacaoFornecedor === 'function') {
        FuncoesScript_renderizarVisualizacaoFornecedor();
    } else {
        console.error("A função FuncoesScript_renderizarVisualizacaoFornecedor não foi encontrada.");
        CotacaoIndividualScript_exibirFeedback("Erro: Falha ao carregar o modo de visualização por fornecedor.", true);
    }
}

window.CotacaoIndividualScript_restaurarVisualizacaoPadrao = function(forcarRenderizacao = false) {
    CotacaoIndividualScript_modoEtapaAtual = null;
    CotacaoIndividualScript_cabecalhosVisiveis = CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO;
    renderizarCabecalhoTabelaPrincipalInterno();
    document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.remove('hidden');
    document.getElementById(CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER).classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER).classList.add('hidden');
    if (document.getElementById('EtapasScript_realizarCotacaoContainer')) {
      document.getElementById('EtapasScript_realizarCotacaoContainer').classList.add('hidden');
    }
    if (document.getElementById('EtapasScript_definirCondicoesPagamentoContainer')) {
      document.getElementById('EtapasScript_definirCondicoesPagamentoContainer').classList.add('hidden');
    }
    const btnSalvarContagem = document.getElementById(CotacaoIndividualScript_ID_BTN_SALVAR_CONTAGEM_ESTOQUE);
    if (btnSalvarContagem) btnSalvarContagem.classList.add('hidden');
    const searchInputTop = document.getElementById(CotacaoIndividualScript_ID_SEARCH_INPUT_TOP);
      if(searchInputTop && searchInputTop.value !== "") {
      searchInputTop.value = "";
    }
    const gruposDeProdutos = agruparEClassificarProdutosInterno(CotacaoIndividualScript_dadosOriginaisCotacao);
    renderizarGruposDeProdutosInterno(gruposDeProdutos);
    CotacaoIndividualScript_filtrarTabelaPrincipal();
}

window.CotacaoIndividualScript_carregarDadosCotacao = async function(idCotacao) {
    const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
    if (tbody) {
        tbody.innerHTML = `<tr><td id="${CotacaoIndividualScript_ID_TABELA_LOADING_MSG_CELL}" colspan="${CotacaoIndividualScript_cabecalhosVisiveis.length || 1}" class="text-center p-8 text-gray-500">
                                <div class="flex justify-center items-center">
                                    <svg class="custom-spinner" viewBox="0 0 50 50" style="width: 32px; height: 32px;"><circle cx="25" cy="25" r="20" fill="none" stroke="#D1D5DB" stroke-width="5"></circle><circle cx="25" cy="25" r="20" fill="none" stroke="#1D4ED8" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.41592653589793, 125.66370614359172" stroke-dashoffset="0"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 25 25;360 25 25" keyTimes="0;1"></animateTransform></circle></svg>
                                    <span class="ml-3 text-gray-700">Carregando dados da cotação...</span>
                                </div></td></tr>`;
    }
    return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(resposta) {
            if (resposta && resposta.success) {
              // ----- INÍCIO DA CORREÇÃO IMPORTANTE -----
              // Esta linha preenche a nossa variável global com todos os cabeçalhos vindos do servidor.
              CABECALHOS_COTACOES_TODOS = resposta.cabecalhos || [];
              // ----- FIM DA CORREÇÃO IMPORTANTE -----

              CotacaoIndividualScript_dadosOriginaisCotacao = (resposta.dados || []).map(item => {
                item._subProdutoOriginalPersistido = item.SubProduto;
                return item;
              });

              // Agora que os cabeçalhos estão definidos, o restante do código funcionará corretamente.
              const gruposDeProdutos = agruparEClassificarProdutosInterno(CotacaoIndividualScript_dadosOriginaisCotacao);
              renderizarGruposDeProdutosInterno(gruposDeProdutos);
              
              const spanIdCotacao = document.getElementById(CotacaoIndividualScript_ID_COTACAO_EXIBIDO);
              if (spanIdCotacao) spanIdCotacao.textContent = idCotacao;

              const dataAberturaContainer = document.getElementById(CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA);
              if (dataAberturaContainer && CotacaoIndividualScript_dadosOriginaisCotacao.length > 0) {
                  const primeiraLinha = CotacaoIndividualScript_dadosOriginaisCotacao[0];
                  if (primeiraLinha && primeiraLinha['Data Abertura']) {
                      try {
                          const dataObj = new Date(primeiraLinha['Data Abertura']);
                          if (!isNaN(dataObj.getTime())) {
                              dataAberturaContainer.textContent = `Data de Abertura: ${dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                          } else {
                              dataAberturaContainer.textContent = `Data de Abertura: ${primeiraLinha['Data Abertura']}`;
                          }
                      } catch (e) {
                          dataAberturaContainer.textContent = `Data de Abertura: ${primeiraLinha['Data Abertura']}`;
                      }
                  } else {
                      dataAberturaContainer.textContent = '';
                  }
              }
              resolve();
            } else {
              const msgErro = (resposta && resposta.message) ? resposta.message : "Falha ao carregar dados da cotação.";
              CotacaoIndividualScript_exibirFeedback(msgErro, true);
              if (tbody) tbody.innerHTML = `<tr><td colspan="${CotacaoIndividualScript_cabecalhosVisiveis.length || 1}" class="text-center p-8 text-red-500">${msgErro}</td></tr>`;
              reject(new Error(msgErro));
            }
          })
          .withFailureHandler(function(error) {
            CotacaoIndividualScript_exibirFeedback("Erro de comunicação ao carregar cotação: " + error.message, true);
            if (tbody) tbody.innerHTML = `<tr><td colspan="${CotacaoIndividualScript_cabecalhosVisiveis.length || 1}" class="text-center p-8 text-red-500">Erro de comunicação.</td></tr>`;
            reject(error);
          })
          .CotacaoIndividualController_obterDetalhesDaCotacao(idCotacao);
    });
}

//----------------------------------------------------------------------------------------------------
// FUNÇÃO DE INICIALIZAÇÃO PRINCIPAL
//----------------------------------------------------------------------------------------------------
function initCotacaoIndividualScript() {
    console.log("initCotacaoIndividualScript: Iniciando configuração da página.");
    // **A CORREÇÃO É CHAMAR A FUNÇÃO DE INICIALIZAÇÃO AQUI DENTRO**
    inicializarPaginaPrincipal();
}
</script>