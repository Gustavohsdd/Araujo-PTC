<script>
//####################################################################################################
// MÓDULO: ENVIAR MANUALMENTE (CLIENT-SIDE) - EnviarManualmenteScript.html
// Funções da página de envio manual de links de PDF.
//####################################################################################################

document.addEventListener('DOMContentLoaded', initEnviarManualmenteScript);

/**
 * Inicializa a página, busca os dados da URL e renderiza a lista de pedidos.
 */
function initEnviarManualmenteScript() {
    try {
        google.script.url.getLocation(function(location) {
            if (location.parameter && location.parameter.data) {
                const dadosCodificados = location.parameter.data;
                const dadosJson = decodeURIComponent(dadosCodificados);
                const dados = JSON.parse(dadosJson);
                renderizarListaDeEnvio(dados);
            } else {
                document.getElementById('pedidos-container').innerHTML = '<p style="color: red;">Erro: Nenhum dado de pedido foi recebido.</p>';
            }
        });
    } catch(e) {
        document.getElementById('pedidos-container').innerHTML = `<p style="color: red;">Erro ao processar dados: ${e.message}</p>`;
    }
}

/**
 * Renderiza a lista de pedidos na página com os botões para copiar.
 * @param {Array<object>} dados - O array com os dados dos pedidos gerados.
 */
function renderizarListaDeEnvio(dados) {
    const container = document.getElementById('pedidos-container');
    container.innerHTML = ''; // Limpa a mensagem de "Carregando..."

    if (!dados || dados.length === 0) {
        container.innerHTML = '<p>Nenhum link de pedido foi gerado.</p>';
        return;
    }

    dados.forEach(pedido => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'pedido-item';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'pedido-info';
        
        const fornecedorSpan = document.createElement('span');
        fornecedorSpan.className = 'fornecedor';
        fornecedorSpan.textContent = pedido.fornecedor;
        
        const empresaSpan = document.createElement('span');
        empresaSpan.className = 'empresa';
        empresaSpan.textContent = `Faturar para: ${pedido.empresaFaturada}`;

        infoDiv.appendChild(fornecedorSpan);
        infoDiv.appendChild(empresaSpan);

        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'Copiar Mensagem + Link';
        copyButton.dataset.linkPdf = pedido.linkPdf;

        copyButton.addEventListener('click', copiarParaAreaDeTransferencia);

        itemDiv.appendChild(infoDiv);
        itemDiv.appendChild(copyButton);
        container.appendChild(itemDiv);
    });
}

/**
 * Copia a mensagem personalizada e o link do PDF para a área de transferência.
 * @param {Event} event - O evento de clique do botão.
 */
function copiarParaAreaDeTransferencia(event) {
    const botao = event.currentTarget;
    const link = botao.dataset.linkPdf;
    const mensagem = document.getElementById('generic-message').value;

    const textoParaCopiar = `${mensagem}\n\nLink para o pedido: ${link}`;

    navigator.clipboard.writeText(textoParaCopiar).then(() => {
        const textoOriginal = botao.textContent;
        botao.textContent = 'Copiado!';
        botao.style.backgroundColor = '#16a34a'; // Verde sucesso

        setTimeout(() => {
            botao.textContent = textoOriginal;
            botao.style.backgroundColor = '#2563eb'; // Cor original
        }, 2000);
    }).catch(err => {
        console.error('Falha ao copiar texto: ', err);
        alert('Não foi possível copiar o texto. Por favor, copie manualmente.');
    });
}
</script>