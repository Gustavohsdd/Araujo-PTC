<script>
//####################################################################################################
// MÓDULO: IMPRIMIR PEDIDOS (CLIENT-SIDE) - ImprimirPedidosScript.html
// Funções da página de impressão de pedidos.
//####################################################################################################

let dadosImpressaoGlobais = null;
let ImprimirPedidosScript_idCotacaoAtual = null;

document.addEventListener('DOMContentLoaded', initImprimirPedidosScript);

function initImprimirPedidosScript() {
    console.log("ImprimirPedidosScript: Iniciando página de impressão.");
    const loadingOverlay = document.getElementById('ImprimirPedidosScript_loadingOverlay');
    const containerPrincipal = document.getElementById('ImprimirPedidosScript_containerPrincipal');
    
    // Seleciona os botões da barra de ações
    const printButton = document.getElementById('print-button');
    const checklistButton = document.getElementById('checklist-button');
    const manualSendButton = document.getElementById('manual-send-button');

    // Seleciona os elementos do novo modal
    const modalOverlay = document.getElementById('ImprimirPedidosScript_modalEnvioManualOverlay');
    const btnFecharModal = document.getElementById('ImprimirPedidosScript_btnFecharModalEnvioManual');

    // Adiciona os event listeners dos botões de ação
    if(printButton) {
        printButton.addEventListener('click', ImprimirPedidosScript_executarImpressao);
    }
    if(checklistButton) {
        checklistButton.addEventListener('click', ImprimirPedidosScript_executarImpressaoChecklist);
    }
    if(manualSendButton) {
        manualSendButton.addEventListener('click', ImprimirPedidosScript_iniciarGeracaoDeLinksManuais);
    }

    // Adiciona os event listeners do modal
    if(btnFecharModal) {
        btnFecharModal.addEventListener('click', ImprimirPedidosScript_fecharModalEnvioManual);
    }
    if(modalOverlay) {
        modalOverlay.addEventListener('click', function(event) {
            // Fecha o modal se o clique for no fundo escuro (overlay)
            if (event.target === modalOverlay) {
                ImprimirPedidosScript_fecharModalEnvioManual();
            }
        });
    }


    try {
        google.script.url.getLocation(function(location) {
            if (!location || !location.parameter || !location.parameter.idCotacao) {
                loadingOverlay.classList.add('hidden');
                containerPrincipal.innerHTML = '<h1>Erro Crítico</h1><p>O ID da Cotação não foi encontrado na URL.</p>';
                return;
            }

            ImprimirPedidosScript_idCotacaoAtual = location.parameter.idCotacao;
            console.log("ID da cotação encontrado com sucesso:", ImprimirPedidosScript_idCotacaoAtual);

            google.script.run
                .withSuccessHandler(response => {
                    loadingOverlay.classList.add('hidden');
                    if (response && response.success) {
                        dadosImpressaoGlobais = response.dados;
                        ImprimirPedidosScript_renderizarPedidos(dadosImpressaoGlobais);
                    } else {
                        containerPrincipal.innerHTML = `<h1>Erro ao Carregar Dados</h1><p>${response.message || 'Ocorreu um erro desconhecido.'}</p>`;
                    }
                })
                .withFailureHandler(error => {
                    loadingOverlay.classList.add('hidden');
                    containerPrincipal.innerHTML = `<h1>Erro de Comunicação</h1><p>${error.message}</p>`;
                })
                .EtapasController_obterDadosParaImpressao(ImprimirPedidosScript_idCotacaoAtual);
        });
    } catch (e) {
        loadingOverlay.classList.add('hidden');
        containerPrincipal.innerHTML = `<h1>Erro Inesperado</h1><p>${e.message}</p>`;
        console.error(e);
    }
}

function ImprimirPedidosScript_renderizarPedidos(dadosAgrupados) {
    const containerPrincipal = document.getElementById('ImprimirPedidosScript_containerPrincipal');
    containerPrincipal.innerHTML = '';

    if (!dadosAgrupados || Object.keys(dadosAgrupados).length === 0) {
        containerPrincipal.innerHTML = '<h1>Nenhum pedido para exibir</h1><p>Não há itens a comprar nesta cotação.</p>';
        return;
    }
    
    for (const nomeFornecedor in dadosAgrupados) {
        const pedidosDoFornecedor = dadosAgrupados[nomeFornecedor];
        pedidosDoFornecedor.forEach(pedido => {
            const pedidoContainer = document.createElement('div');
            pedidoContainer.className = 'pedido-container';
            
            pedidoContainer.innerHTML = `
                <div class="pedido-header-fornecedor">
                    <h2>${pedido.fornecedor}</h2>
                    <div class="info-grid">
                        <div>
                            <strong>EMPRESA PARA FATURAMENTO:</strong>
                            <span>${pedido.empresaFaturada}</span>
                        </div>
                        <div>
                            <strong>CNPJ:</strong>
                            <span>${pedido.cnpj || 'Não informado'}</span>
                        </div>
                        <div>
                            <strong>CONDIÇÃO DE PAGAMENTO:</strong>
                            <span>${pedido.condicaoPagamento || 'Não informada'}</span>
                        </div>
                    </div>
                </div>
            `;
            const tabela = document.createElement('table');
            tabela.className = 'itens-table';
            tabela.innerHTML = `
                <thead>
                    <tr>
                        <th>PRODUTO (SUBPRODUTO)</th>
                        <th class="col-un">UN</th>
                        <th class="col-qtd">QTD.</th>
                        <th class="col-valor">VALOR UNIT.</th>
                        <th class="col-valor">VALOR TOTAL</th>
                    </tr>
                </thead>
            `;
            const tbody = document.createElement('tbody');
            pedido.itens.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.subProduto}</td>
                    <td class="col-un">${item.un}</td>
                    <td class="col-qtd">${item.qtd}</td>
                    <td class="col-valor">${ImprimirPedidosScript_formatarMoeda(item.valorUnit)}</td>
                    <td class="col-valor">${ImprimirPedidosScript_formatarMoeda(item.valorTotal)}</td>
                `;
                tbody.appendChild(tr);
            });
            tabela.appendChild(tbody);
            pedidoContainer.appendChild(tabela);
            
            const footerTotal = document.createElement('div');
            footerTotal.className = 'total-pedido-footer';
            footerTotal.textContent = `TOTAL DO PEDIDO: ${ImprimirPedidosScript_formatarMoeda(pedido.totalPedido)}`;
            pedidoContainer.appendChild(footerTotal);

            containerPrincipal.appendChild(pedidoContainer);
        });
    }
}

/**
 * Função de impressão para o PEDIDO COMPLETO.
 */
function ImprimirPedidosScript_executarImpressao() {
    // CORREÇÃO: Busca o estilo pela ID da tag <style>
    const stylesHtml = document.getElementById('page-styles').outerHTML;
    const contentHtml = document.getElementById('ImprimirPedidosScript_containerPrincipal').innerHTML;
    
    const printWindow = window.open('', '', 'height=700,width=900');
    printWindow.document.write(`<!DOCTYPE html><html><head><title>Imprimir Pedidos</title>${stylesHtml}</head><body>${contentHtml}</body></html>`);
    printWindow.document.close();
    setTimeout(function() {
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }, 250);
}

/**
 * Função de impressão para o CHECKLIST.
 * MODIFICADO: Agora, primeiro atualiza o status da cotação para "Aguardando Faturamento"
 * e só então procede com a impressão.
 */
function ImprimirPedidosScript_executarImpressaoChecklist() {
    console.log("Checklist: Iniciando processo de atualização de status e impressão.");

    if (!ImprimirPedidosScript_idCotacaoAtual) {
        alert("Erro crítico: O ID da cotação não está disponível. Não é possível continuar.");
        return;
    }

    // Mostra um overlay para o usuário saber que algo está acontecendo
    const loadingOverlay = document.getElementById('ImprimirPedidosScript_loadingOverlay');
    if(loadingOverlay) {
        loadingOverlay.querySelector('p').textContent = "Atualizando status da cotação...";
        loadingOverlay.classList.remove('hidden');
    }

    // Chama a função do Controller para atualizar o status
    google.script.run
        .withSuccessHandler(response => {
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            
            if (response && response.success) {
                console.log("Status atualizado com sucesso. Prosseguindo para a impressão do checklist.");

                // A lógica de impressão original é executada aqui, dentro do success handler
                const stylesHtml = document.getElementById('page-styles').outerHTML;
                const checklistHtml = ImprimirPedidosScript_gerarHtmlParaChecklist(); 
                
                const printWindow = window.open('', '', 'height=700,width=900');
                printWindow.document.write(`<!DOCTYPE html><html><head><title>Imprimir Checklist de Separação</title>${stylesHtml}</head><body>${checklistHtml}</body></html>`);
                printWindow.document.close();
                setTimeout(function() {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                }, 250);

            } else {
                // Se a atualização do status falhar, exibe uma mensagem e não imprime
                const errorMessage = (response && response.message) ? response.message : "Ocorreu um erro desconhecido ao atualizar o status.";
                alert(`Falha ao atualizar o status da cotação:\n\n${errorMessage}\n\nA impressão foi cancelada.`);
            }
        })
        .withFailureHandler(error => {
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            // Se houver um erro de comunicação, exibe uma mensagem e não imprime
            alert(`Erro de comunicação com o servidor:\n\n${error.message}\n\nA impressão foi cancelada.`);
            console.error("Erro ao chamar EtapasController_atualizarStatusCotacao:", error);
        })
        .EtapasController_atualizarStatusCotacao(ImprimirPedidosScript_idCotacaoAtual, "Aguardando Faturamento");
}

/**
 * Gera uma string de HTML para a versão de checklist (lista única).
 */
function ImprimirPedidosScript_gerarHtmlParaChecklist() {
    if (!dadosImpressaoGlobais || Object.keys(dadosImpressaoGlobais).length === 0) {
        return "<h1>Nenhum item para o checklist.</h1>";
    }

    let htmlString = '<div class="page-container">';
    htmlString += '<h2>Checklist Geral de Separação</h2>';

    htmlString += `<table class="itens-table">
        <thead>
            <tr>
                <th style="width: 25%;">FORNECEDOR</th>
                <th>PRODUTO (SUBPRODUTO)</th>
                <th class="col-un">UN</th>
                <th class="col-qtd">QTD.</th>
                <th class="col-check">CONFERIDO</th>
            </tr>
        </thead>
        <tbody>`;

    for (const nomeFornecedor in dadosImpressaoGlobais) {
        const pedidosDoFornecedor = dadosImpressaoGlobais[nomeFornecedor];
        
        pedidosDoFornecedor.forEach(pedido => {
            pedido.itens.forEach(item => {
                htmlString += `
                    <tr>
                        <td>${pedido.fornecedor}</td>
                        <td>${item.subProduto}</td>
                        <td class="col-un">${item.un}</td>
                        <td class="col-qtd">${item.qtd}</td>
                        <td class="col-check" style="font-family: monospace;">[ &nbsp; ]</td>
                    </tr>
                `;
            });
        });
    }
    
    htmlString += '</tbody></table></div>';
    return htmlString;
}

/**
 * Formata um número como moeda BRL.
 */
function formatarMoeda(valor) {
    const numero = Number(valor) || 0;
    return numero.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
}

/**
 * Inicia o processo de gerar os dados no back-end e abrir o MODAL com os links.
 */
function ImprimirPedidosScript_iniciarGeracaoDeLinksManuais() {
    if (!ImprimirPedidosScript_idCotacaoAtual) {
        alert("Erro: ID da Cotação não encontrado.");
        return;
    }

    const loadingOverlay = document.getElementById('ImprimirPedidosScript_loadingOverlay');
    if(loadingOverlay) {
        loadingOverlay.querySelector('p').textContent = "Gerando dados para envio... Isso pode levar um momento.";
        loadingOverlay.classList.remove('hidden');
    }

    google.script.run
        .withSuccessHandler(response => {
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            
            if (response && response.success) {
                // Em vez de abrir uma nova URL, chamamos a função para abrir o modal
                ImprimirPedidosScript_abrirModalEnvioManual(response.dados);
            } else {
                alert(`Falha ao gerar os dados para envio: ${response.message || 'Erro desconhecido.'}`);
            }
        })
        .withFailureHandler(error => {
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            alert(`Erro de comunicação ao gerar dados para envio: ${error.message}`);
        })
        // Alterado para chamar a nova função do controller de Etapas
        .EtapasController_gerarDadosParaEnvioManual(ImprimirPedidosScript_idCotacaoAtual);
}

/**
 * Abre e popula o modal de envio manual com os dados recebidos do controller.
 * @param {Array<object>} dados - O array com os dados dos pedidos gerados.
 */
function ImprimirPedidosScript_abrirModalEnvioManual(dados) {
    const modalOverlay = document.getElementById('ImprimirPedidosScript_modalEnvioManualOverlay');
    if(modalOverlay) {
        ImprimirPedidosScript_renderizarListaDeEnvioManual(dados);
        modalOverlay.classList.remove('hidden');
    }
}

/**
 * Fecha o modal de envio manual.
 */
function ImprimirPedidosScript_fecharModalEnvioManual() {
    const modalOverlay = document.getElementById('ImprimirPedidosScript_modalEnvioManualOverlay');
    if(modalOverlay) {
        modalOverlay.classList.add('hidden');
    }
}

/**
 * Renderiza a lista de pedidos dentro do modal.
 * @param {Array<object>} dados - O array com os dados dos pedidos gerados.
 */
function ImprimirPedidosScript_renderizarListaDeEnvioManual(dados) {
    const container = document.getElementById('ImprimirPedidosScript_pedidosContainerModal');
    if (!container) return;
    
    container.innerHTML = ''; // Limpa a mensagem de "Carregando..."

    if (!dados || dados.length === 0) {
        container.innerHTML = '<p>Nenhum link de pedido foi gerado.</p>';
        return;
    }

    dados.forEach(pedido => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'pedido-item';
        itemDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid #e2e8f0;';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'pedido-info';
        infoDiv.style.cssText = 'display: flex; flex-direction: column;';
        
        const fornecedorSpan = document.createElement('span');
        fornecedorSpan.className = 'fornecedor';
        fornecedorSpan.textContent = pedido.fornecedor;
        fornecedorSpan.style.cssText = 'font-weight: 600; font-size: 1.1rem;';
        
        const empresaSpan = document.createElement('span');
        empresaSpan.className = 'empresa';
        empresaSpan.textContent = `Faturar para: ${pedido.empresaFaturada}`;
        empresaSpan.style.cssText = 'font-size: 0.9rem; color: #64748b;';

        infoDiv.appendChild(fornecedorSpan);
        infoDiv.appendChild(empresaSpan);

        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'Copiar Mensagem + Link';
        copyButton.style.cssText = "padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; color: #fff; background-color: #2563eb; border: none; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s;"
        
        // Adiciona todos os dados necessários ao dataset do botão
        copyButton.dataset.linkPdf = pedido.linkPdf;
        copyButton.dataset.fornecedor = pedido.fornecedor;
        copyButton.dataset.empresa = pedido.empresaFaturada;
        copyButton.dataset.condicao = pedido.condicaoPagamento;
        copyButton.dataset.total = pedido.totalPedido;
        copyButton.dataset.cotacao = pedido.numeroCotacao;


        copyButton.addEventListener('click', ImprimirPedidosScript_copiarParaAreaDeTransferencia);

        itemDiv.appendChild(infoDiv);
        itemDiv.appendChild(copyButton);
        container.appendChild(itemDiv);
    });
}

/**
 * Copia a mensagem personalizada e o link do PDF para a área de transferência.
 * @param {Event} event - O evento de clique do botão.
 */
function ImprimirPedidosScript_copiarParaAreaDeTransferencia(event) {
    const botao = event.currentTarget;
    const { linkPdf, fornecedor, empresa, condicao, total, cotacao } = botao.dataset;
    
    const totalFormatado = ImprimirPedidosScript_formatarMoeda(total);
    const condicaoPagamento = condicao || "Não informada";

    const textoParaCopiar = `Pedido ${cotacao} - ${fornecedor}
Faturar para: ${empresa}
Condição de Pagamento: ${condicaoPagamento}
Valor Total: ${totalFormatado}

*Atenção à forma de pagamento escolhida, qualquer coisa estou à disposição.*

Link para o pedido: ${linkPdf}`;

    navigator.clipboard.writeText(textoParaCopiar).then(() => {
        const textoOriginal = botao.textContent;
        botao.textContent = 'Copiado!';
        botao.style.backgroundColor = '#16a34a'; // Verde sucesso

        setTimeout(() => {
            botao.textContent = textoOriginal;
            botao.style.backgroundColor = '#2563eb'; // Cor original
        }, 2000);
    }).catch(err => {
        console.error('Falha ao copiar texto: ', err);
        alert('Não foi possível copiar o texto. Por favor, copie manualmente.');
    });
}

/**
 * Formata um número como moeda BRL.
 * Esta função substitui a 'formatarMoeda' genérica para seguir a convenção de nomenclatura.
 * @param {number|string} valor - O valor a ser formatado.
 * @returns {string} O valor formatado como moeda BRL (ex: "R$ 1.234,56").
 */
function ImprimirPedidosScript_formatarMoeda(valor) {
    const numero = Number(valor) || 0;
    return numero.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
}
</script>