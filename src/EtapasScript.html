<script>
console.log("CONFIRMADO: Arquivo EtapasScript.html carregado com sucesso - Versão 3 (Corrigida)");

//####################################################################################################
// MÓDULO: ETAPAS (CLIENT-SIDE)
// Funções relacionadas às etapas da cotação: Contagem de Estoque, Retirar Produtos, Enviar para Fornecedores.
//####################################################################################################

/**
 * @file EtapasScript.html
 * @description Lógica client-side para as funcionalidades do menu "Etapas".
 */

// ADIÇÃO DE NOVA CONSTANTE DE EXIBIÇÃO PARA A ETAPA 5
const EtapasScript_COLUNAS_A_EXIBIR_FATURAMENTO = [
  "SubProduto", "Preço", "Preço por Fator", "Comprar", "Valor Total", "Empresa Faturada"
];


//----------------------------------------------------------------------------------------------------
// ETAPA 1: CONTAGEM DE ESTOQUE (NOVA VERSÃO COM MODAL)
//----------------------------------------------------------------------------------------------------

/**
 * Ponto de entrada para a Etapa 1. Prepara e exibe o modal de Contagem de Estoque.
 * Esta função substitui a antiga que modificava a tabela principal.
 */
function EtapasScript_ativarModoContagemEstoque() {
    console.log("EtapasScript: Ativando modo Contagem de Estoque (Modal).");
    CotacaoIndividualScript_modoEtapaAtual = 'contagem_estoque';

    // Garante que os dados da cotação já foram carregados
    if (CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
        CotacaoIndividualScript_exibirFeedback("Dados da cotação ainda não carregados. Tente novamente.", true, 5000);
        CotacaoIndividualScript_modoEtapaAtual = null; // Reseta o modo
        return;
    }

    // Renderiza o conteúdo do modal com os dados atuais
    EtapasScript_renderizarConteudoModalContagem();

    // Abre o modal
    const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
    if (modalOverlay) {
        modalOverlay.classList.add('active');
    }

    // Configura os botões do modal
    const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalContagem');
    const btnCancelar = document.getElementById('EtapasScript_btnCancelarModalContagem');
    const btnFechar = document.getElementById('EtapasScript_btnFecharModalContagemEstoque');

    // Remove event listeners antigos para evitar duplicação
    btnSalvar.removeEventListener('click', EtapasScript_salvarContagemEstoqueEtapa);
    btnCancelar.removeEventListener('click', EtapasScript_fecharModalContagemEstoque);
    btnFechar.removeEventListener('click', EtapasScript_fecharModalContagemEstoque);

    // Adiciona os novos event listeners
    btnSalvar.addEventListener('click', EtapasScript_salvarContagemEstoqueEtapa);
    btnCancelar.addEventListener('click', EtapasScript_fecharModalContagemEstoque);
    btnFechar.addEventListener('click', EtapasScript_fecharModalContagemEstoque);
}

/**
 * Fecha o modal de contagem de estoque e restaura o estado da aplicação.
 */
function EtapasScript_fecharModalContagemEstoque() {
    console.log("EtapasScript: Fechando modal de Contagem de Estoque.");
    const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
    }
    CotacaoIndividualScript_modoEtapaAtual = null; // Limpa o modo de etapa
    
    // Limpa feedback dentro do modal para a próxima vez que for aberto
    const feedbackDiv = document.getElementById('EtapasScript_feedbackModalContagem');
    if(feedbackDiv) feedbackDiv.innerHTML = '';
}

/**
 * Renderiza o corpo da tabela dentro do modal de contagem de estoque.
 */
function EtapasScript_renderizarConteudoModalContagem() {
    const tbody = document.getElementById('EtapasScript_tbodyModalContagemEstoque');
    if (!tbody) {
        console.error("EtapasScript_renderizarConteudoModalContagem: Tbody do modal não encontrado.");
        return;
    }
    tbody.innerHTML = ''; // Limpa o conteúdo anterior

    // Agrupa os dados por Produto Principal para evitar duplicatas
    const produtosPrincipais = {};
    CotacaoIndividualScript_dadosOriginaisCotacao.forEach(item => {
        const nomeProduto = item.Produto;
        if (!produtosPrincipais[nomeProduto]) {
            produtosPrincipais[nomeProduto] = {
                nome: nomeProduto,
                estoqueMinimo: (item.EstoqueMinimoProdutoPrincipal !== null && item.EstoqueMinimoProdutoPrincipal !== undefined)
                    ? item.EstoqueMinimoProdutoPrincipal : '',
                dadosEstoqueCompra: CotacaoIndividualScript_parsearStringEstoqueComprar(item["Estoque Atual"])
            };
        }
    });

    const listaProdutos = Object.values(produtosPrincipais).sort((a, b) => a.nome.localeCompare(b.nome));

    if (listaProdutos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhum produto na cotação.</td></tr>';
        return;
    }

    listaProdutos.forEach(produto => {
        const tr = tbody.insertRow();
        tr.dataset.produtoNome = produto.nome;

        // Célula 1: Nome do Produto
        const tdProduto = tr.insertCell();
        tdProduto.textContent = produto.nome;

        // Célula 2: Input para Novo Estoque Mínimo
        const tdEstMin = tr.insertCell();
        const inputEstMin = document.createElement('input');
        inputEstMin.type = 'number';
        inputEstMin.className = 'input-contagem input-estoque-min-prod-principal';
        inputEstMin.placeholder = 'Ex: 10';
        inputEstMin.value = produto.estoqueMinimo;
        tdEstMin.appendChild(inputEstMin);

        // Célula 3: Input para Estoque Contado
        const tdEstContado = tr.insertCell();
        const inputEstContado = document.createElement('input');
        inputEstContado.type = 'number';
        inputEstContado.className = 'input-contagem input-estoque-contado-prod-principal';
        inputEstContado.placeholder = 'Ex: 15';
        inputEstContado.value = produto.dadosEstoqueCompra.estoqueAtual !== null ? produto.dadosEstoqueCompra.estoqueAtual : '';
        tdEstContado.appendChild(inputEstContado);

        // Célula 4: Input para Comprar (Sugestão)
        const tdComprar = tr.insertCell();
        const inputComprar = document.createElement('input');
        inputComprar.type = 'number';
        inputComprar.className = 'input-contagem input-comprar-sugestao-prod-principal';
        inputComprar.placeholder = 'Ex: 5';
        inputComprar.value = produto.dadosEstoqueCompra.comprar !== null ? produto.dadosEstoqueCompra.comprar : '';
        tdComprar.appendChild(inputComprar);
    });
}

/**
 * Coleta os dados dos inputs do modal e os envia para o servidor.
 * Esta função é chamada pelo botão "Salvar" do modal.
 */
function EtapasScript_salvarContagemEstoqueEtapa() {
    console.log("EtapasScript_salvarContagemEstoqueEtapa: Coletando dados do modal para salvar.");
    
    const dadosParaSalvar = [];
    const todasLinhasDoModal = document.querySelectorAll('#EtapasScript_tbodyModalContagemEstoque tr');

    todasLinhasDoModal.forEach(row => {
        const produtoNome = row.dataset.produtoNome;
        if (!produtoNome) return;

        const inputEstMinElem = row.querySelector('.input-estoque-min-prod-principal');
        const inputEstContadoElem = row.querySelector('.input-estoque-contado-prod-principal');
        const inputComprarSugElem = row.querySelector('.input-comprar-sugestao-prod-principal');

        const novoEstoqueMinimo = inputEstMinElem && inputEstMinElem.value !== '' ? parseFloat(inputEstMinElem.value.replace(',', '.')) : null;
        const estoqueContado = inputEstContadoElem && inputEstContadoElem.value !== '' ? parseFloat(inputEstContadoElem.value.replace(',', '.')) : null;
        const comprarSugestao = inputComprarSugElem && inputComprarSugElem.value !== '' ? parseFloat(inputComprarSugElem.value.replace(',', '.')) : null;

        // Adiciona à lista apenas se algum valor foi de fato inserido ou alterado
        if (novoEstoqueMinimo !== null || estoqueContado !== null || comprarSugestao !== null) {
            dadosParaSalvar.push({
                nomeProdutoPrincipal: produtoNome,
                novoEstoqueMinimoProdutoPrincipal: novoEstoqueMinimo,
                estoqueAtualContagem: estoqueContado,
                comprarSugestao: comprarSugestao
            });
        }
    });

    if (dadosParaSalvar.length === 0) {
        EtapasScript_exibirFeedbackModalContagem("Nenhum dado foi inserido ou alterado para salvar.", false, 4000);
        return;
    }

    console.log("EtapasScript_salvarContagemEstoqueEtapa: Dados da contagem para salvar:", dadosParaSalvar);
    const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalContagem');
    btnSalvar.disabled = true;
    btnSalvar.textContent = 'Salvando...';

    EtapasScript_exibirFeedbackModalContagem("Salvando contagem de estoque...", false, 0);

    // Primeiro, atualiza o status da cotação
    google.script.run
        .withSuccessHandler(statusResponse => {
            if (!statusResponse.success) {
                console.warn("Falha ao atualizar o status da cotação, mas prosseguindo com o salvamento dos dados.");
            }
            
            // Agora, salva os dados da contagem
            google.script.run
                .withSuccessHandler(function(response) {
                    btnSalvar.disabled = false;
                    btnSalvar.textContent = 'Salvar Contagem';

                    if (response && response.success) {
                        EtapasScript_fecharModalContagemEstoque();
                        CotacaoIndividualScript_exibirFeedback(response.message || "Contagem de estoque salva com sucesso! Atualizando dados...", false, 5000);

                        // Recarrega os dados da cotação principal para refletir as mudanças
                        CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
                    } else {
                        EtapasScript_exibirFeedbackModalContagem(response.message || "Falha ao salvar contagem de estoque.", true, 7000);
                    }
                })
                .withFailureHandler(function(error) {
                    btnSalvar.disabled = false;
                    btnSalvar.textContent = 'Salvar Contagem';
                    EtapasScript_exibirFeedbackModalContagem("Erro de comunicação ao salvar contagem: " + error.message, true, 7000);
                    console.error("EtapasScript_salvarContagemEstoqueEtapa: Erro ao salvar contagem:", error);
                })
                .EtapasController_salvarContagemEstoque(CotacaoIndividualScript_cotacaoIdAtual, dadosParaSalvar);
        })
        .withFailureHandler(err => {
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar Contagem';
            EtapasScript_exibirFeedbackModalContagem("Erro de comunicação ao atualizar status: " + err.message, true, 7000);
        })
        .EtapasController_atualizarStatusCotacao(CotacaoIndividualScript_cotacaoIdAtual, "Contagem de Estoque");
}

/**
 * Exibe feedback dentro do modal de Contagem de Estoque.
 * @param {string} mensagem O texto a ser exibido.
 * @param {boolean} isError Se a mensagem é um erro.
 * @param {number} duracao Duração em milissegundos para a mensagem desaparecer.
 */
function EtapasScript_exibirFeedbackModalContagem(mensagem, isError = false, duracao = 5000) {
    const feedbackDiv = document.getElementById('EtapasScript_feedbackModalContagem');
    if (feedbackDiv) {
        const innerDiv = document.createElement('div');
        innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
        innerDiv.textContent = mensagem;
        feedbackDiv.innerHTML = ''; // Limpa mensagens antigas
        feedbackDiv.appendChild(innerDiv);
        
        if (duracao > 0) {
            setTimeout(() => {
                if (feedbackDiv.contains(innerDiv)) {
                    feedbackDiv.innerHTML = '';
                }
            }, duracao);
        }
    }
}


//----------------------------------------------------------------------------------------------------
// ETAPA 2: RETIRAR PRODUTOS DESNECESSÁRIOS
//----------------------------------------------------------------------------------------------------

function EtapasScript_identificarProdutosParaRetirada() {
    const produtosParaRetirada = { crit1: [], crit2: [], crit3: [] };
    const produtosPrincipaisAdicionados = { crit1: new Set(), crit2: new Set(), crit3: new Set() };

    if (!CotacaoIndividualScript_dadosOriginaisCotacao || CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
        console.warn("EtapasScript_identificarProdutosParaRetirada: Nenhum dado original da cotação.");
        return produtosParaRetirada;
    }

    CotacaoIndividualScript_dadosOriginaisCotacao.forEach(subProduto => {
        const nomeProdutoPrincipal = subProduto.Produto;
        const estoqueMinProdutoPrincipal = (subProduto.EstoqueMinimoProdutoPrincipal !== null &&
            subProduto.EstoqueMinimoProdutoPrincipal !== undefined &&
            String(subProduto.EstoqueMinimoProdutoPrincipal).trim() !== "")
            ? parseFloat(String(subProduto.EstoqueMinimoProdutoPrincipal).replace(",", "."))
            : null;

        const dadosEstoqueCompra = CotacaoIndividualScript_parsearStringEstoqueComprar(subProduto["Estoque Atual"]);
        const estoqueAtualParseado = dadosEstoqueCompra.estoqueAtual;
        const comprarParseado = dadosEstoqueCompra.comprar;
        const rawEstoqueAtualString = subProduto["Estoque Atual"] ? String(subProduto["Estoque Atual"]).trim() : "";

        if (estoqueAtualParseado !== null && !isNaN(estoqueAtualParseado) &&
            estoqueMinProdutoPrincipal !== null && !isNaN(estoqueMinProdutoPrincipal) &&
            estoqueAtualParseado >= estoqueMinProdutoPrincipal) {
            if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal)) {
                produtosParaRetirada.crit1.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: `Est. Atual (${estoqueAtualParseado}) >= Est. Mín. Prod. (${estoqueMinProdutoPrincipal})`, subProdutoOriginal: subProduto });
                produtosPrincipaisAdicionados.crit1.add(nomeProdutoPrincipal);
            }
        }

        const celulaEstoqueAtualVazia = rawEstoqueAtualString === "";
        if (celulaEstoqueAtualVazia || (estoqueAtualParseado === null && comprarParseado === null)) {
            if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit2.has(nomeProdutoPrincipal)) {
                produtosParaRetirada.crit2.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: celulaEstoqueAtualVazia ? "Coluna 'Estoque Atual' vazia" : "Estoque Atual e Comprar são N/A", subProdutoOriginal: subProduto });
                produtosPrincipaisAdicionados.crit2.add(nomeProdutoPrincipal);
            }
        }

        const estMinPrincipalConsideradoVazioOuNA = (estoqueMinProdutoPrincipal === null || String(subProduto.EstoqueMinimoProdutoPrincipal).trim() === "" || String(subProduto.EstoqueMinimoProdutoPrincipal).toUpperCase() === "N/A");
        if (estMinPrincipalConsideradoVazioOuNA && (celulaEstoqueAtualVazia || (estoqueAtualParseado === null && comprarParseado === null))) {
            if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit2.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit3.has(nomeProdutoPrincipal)) {
                produtosParaRetirada.crit3.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: "Est.Mín(Prod.Principal) N/A/vazio E (Coluna Est.Atual vazia OU Est.Atual/Comprar N/A)", subProdutoOriginal: subProduto });
                produtosPrincipaisAdicionados.crit3.add(nomeProdutoPrincipal);
            }
        }
    });
    console.log("EtapasScript_identificarProdutosParaRetirada: Produtos para retirada (principais):", produtosParaRetirada);
    return produtosParaRetirada;
}

function EtapasScript_renderizarAcordeaoRetirarProdutos(containerId, titulo, produtosPrincipais, idSufixo) {
    const container = document.getElementById(containerId);
    if (!container) return;
    // Limpa o conteúdo anterior para garantir que a renderização seja sempre nova
    container.innerHTML = '';

    const headerId = `header-retirar-${idSufixo}`;
    const contentId = `content-retirar-${idSufixo}`;

    const header = document.createElement('div');
    header.className = 'retirar-accordion-header';
    header.id = headerId;
    header.innerHTML = `<span>${titulo} (${produtosPrincipais.length} Produtos Principais)</span>
                            <svg class="retirar-accordion-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                            </svg>`;

    const content = document.createElement('div');
    content.className = 'retirar-accordion-content';
    content.id = contentId;

    if (produtosPrincipais.length === 0) {
        content.innerHTML = `<div class="p-2 text-sm text-gray-500">Nenhum produto encontrado para este critério.</div>`;
    } else {
        const divSelecionarTodos = document.createElement('div');
        divSelecionarTodos.className = 'flex items-center p-2 border-b border-gray-200 mb-2';
        const checkboxTodos = document.createElement('input');
        checkboxTodos.type = 'checkbox';
        checkboxTodos.id = `select-all-retirar-${idSufixo}`;
        checkboxTodos.className = 'mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
        checkboxTodos.addEventListener('change', function() {
            content.querySelectorAll('.checkbox-retirar-item-principal').forEach(cb => cb.checked = this.checked);
        });
        const labelTodos = document.createElement('label');
        labelTodos.htmlFor = `select-all-retirar-${idSufixo}`;
        labelTodos.textContent = 'Selecionar Todos os Produtos Principais neste Grupo';
        labelTodos.className = 'font-medium text-sm text-gray-700';
        divSelecionarTodos.appendChild(checkboxTodos);
        divSelecionarTodos.appendChild(labelTodos);
        content.appendChild(divSelecionarTodos);

        produtosPrincipais.forEach((produtoPrincipalInfo) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'retirar-subproduto-item py-1';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'checkbox-retirar-item-principal';
            checkbox.dataset.produtoPrincipal = produtoPrincipalInfo.nomeProdutoPrincipal;

            const label = document.createElement('label');
            label.textContent = `${produtoPrincipalInfo.nomeProdutoPrincipal} - Motivo: ${produtoPrincipalInfo.motivo}`;

            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(label);
            content.appendChild(itemDiv);
        });
    }

    container.appendChild(header);
    container.appendChild(content);

    header.addEventListener('click', () => {
        header.classList.toggle('expanded');
        content.classList.toggle('expanded');
        const icon = header.querySelector('.retirar-accordion-icon');
        if (icon) {
            icon.style.transform = header.classList.contains('expanded') ? 'rotate(90deg)' : 'rotate(0deg)';
        }
    });
}

function EtapasScript_manipularExclusaoProdutosRetirar() {
    const produtosPrincipaisParaExcluir = [];
    // Busca os checkboxes dentro do novo modal
    document.querySelectorAll('#EtapasScript_modalRetirarProdutosOverlay .checkbox-retirar-item-principal:checked').forEach(cb => {
        if (!produtosPrincipaisParaExcluir.includes(cb.dataset.produtoPrincipal)) {
            produtosPrincipaisParaExcluir.push(cb.dataset.produtoPrincipal);
        }
    });

    if (produtosPrincipaisParaExcluir.length === 0) {
        EtapasScript_exibirFeedbackModalRetirarProdutos("Nenhum produto principal selecionado para exclusão.", true, 4000);
        return;
    }

    console.log("EtapasScript_manipularExclusaoProdutosRetirar: Produtos Principais para excluir:", produtosPrincipaisParaExcluir);
    
    const btnConfirmar = document.getElementById('EtapasScript_btnConfirmarRemocaoModal');
    btnConfirmar.disabled = true;
    btnConfirmar.textContent = 'Excluindo...';
    EtapasScript_exibirFeedbackModalRetirarProdutos(`Excluindo ${produtosPrincipaisParaExcluir.length} produto(s) principal(is)...`, false, 0);

    google.script.run
        .withSuccessHandler(function(response) {
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Remoção';

            if (response && response.success) {
                // Fecha o modal e exibe o feedback na página principal
                EtapasScript_fecharModalRetirarProdutos();
                CotacaoIndividualScript_exibirFeedback(response.message || "Produtos selecionados foram retirados com sucesso!", false, 5000);
                
                // Recarrega os dados da cotação para refletir as mudanças
                CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
            } else {
                EtapasScript_exibirFeedbackModalRetirarProdutos(response.message || "Falha ao retirar produtos da cotação.", true, 7000);
            }
        })
        .withFailureHandler(function(error) {
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Remoção';
            EtapasScript_exibirFeedbackModalRetirarProdutos("Erro de comunicação ao excluir produtos: " + error.message, true, 7000);
            console.error("EtapasScript_manipularExclusaoProdutosRetirar: Erro:", error);
        })
        .EtapasController_retirarProdutosCotacao(CotacaoIndividualScript_cotacaoIdAtual, produtosPrincipaisParaExcluir);
}


function EtapasScript_ativarModoRetirarProdutos() {
    console.log("EtapasScript: Ativando modo Retirar Produtos.");
    if (CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
        CotacaoIndividualScript_exibirFeedback("Dados da cotação ainda não carregados. Tente novamente.", true, 5000);
        return;
    }
    CotacaoIndividualScript_modoEtapaAtual = 'retirar_produtos';
    document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER).classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER).classList.remove('hidden');
    
    const btnSalvarContagem = document.getElementById(CotacaoIndividualScript_ID_BTN_SALVAR_CONTAGEM_ESTOQUE);
    if (btnSalvarContagem) btnSalvarContagem.classList.add('hidden');

    EtapasScript_renderizarSecaoRetirarProdutosCompleta();
    CotacaoIndividualScript_exibirFeedback("Modo 'Retirar Produtos Desnecessários' ativado. Selecione os produtos e clique em 'Confirmar Remoção e Voltar'.", false, 6000);
}

//----------------------------------------------------------------------------------------------------
// ETAPA 3: ENVIAR PARA FORNECEDORES
//----------------------------------------------------------------------------------------------------

function EtapasScript_iniciarEnvioParaFornecedores() {
    console.log("EtapasScript: Iniciando envio para fornecedores.");
    CotacaoIndividualScript_restaurarVisualizacaoPadrao(true); 
    CotacaoIndividualScript_modoEtapaAtual = null; 

    if (!CotacaoIndividualScript_cotacaoIdAtual) {
        CotacaoIndividualScript_exibirFeedback("ID da Cotação não definido. Não é possível enviar para fornecedores.", true, 5000);
        return;
    }
    CotacaoIndividualScript_mostrarLoadingOverlay(true, "Preparando envio para fornecedores...");

    google.script.run
        .withSuccessHandler(function(statusResponse) {
            if (statusResponse && statusResponse.success) {
                CotacaoIndividualScript_exibirFeedback("Status da cotação atualizado para 'Aguardando Preços'. Gerando links...", false, 0);

                google.script.run
                    .withSuccessHandler(function(linkResponse) {
                        CotacaoIndividualScript_mostrarLoadingOverlay(false);
                        if (linkResponse && linkResponse.success) {
                            CotacaoIndividualScript_exibirFeedback(linkResponse.message || "Links para fornecedores gerados/atualizados com sucesso!", false, 7000);
                            if (linkResponse.detalhesLinks && linkResponse.detalhesLinks.length > 0) {
                                console.log("EtapasScript_iniciarEnvioParaFornecedores: Detalhes dos Links Gerados:", linkResponse.detalhesLinks);
                            }
                        } else {
                            CotacaoIndividualScript_exibirFeedback(linkResponse.message || "Falha ao gerar/atualizar links para fornecedores.", true, 7000);
                        }
                    })
                    .withFailureHandler(function(linkError) {
                        CotacaoIndividualScript_mostrarLoadingOverlay(false);
                        CotacaoIndividualScript_exibirFeedback("Erro de comunicação ao gerar links: " + linkError.message, true, 7000);
                        console.error("EtapasScript_iniciarEnvioParaFornecedores: Erro ao gerar links:", linkError);
                    })
                    .EtapasController_gerarLinksParaFornecedoresParaEtapaEnvio(CotacaoIndividualScript_cotacaoIdAtual);

            } else {
                CotacaoIndividualScript_mostrarLoadingOverlay(false);
                CotacaoIndividualScript_exibirFeedback(statusResponse.message || "Falha ao atualizar status da cotação para 'Aguardando Preços'.", true, 7000);
            }
        })
        .withFailureHandler(function(statusError) {
            CotacaoIndividualScript_mostrarLoadingOverlay(false);
            CotacaoIndividualScript_exibirFeedback("Erro de comunicação ao atualizar status: " + statusError.message, true, 7000);
            console.error("EtapasScript_iniciarEnvioParaFornecedores: Erro ao atualizar status:", statusError);
        })
        .EtapasController_atualizarStatusCotacao(CotacaoIndividualScript_cotacaoIdAtual, "Aguardando Preços");
}


//================================================================================================
// ETAPA 4: REALIZAR COTAÇÃO
//================================================================================================

function EtapasScript_ativarModoRealizarCotacao() {
    console.log("EtapasScript: Ativando modo Realizar Cotação.");
    CotacaoIndividualScript_modoEtapaAtual = 'realizar_cotacao';

    document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER).classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER).classList.add('hidden');
    const realizarCotacaoContainer = document.getElementById('EtapasScript_realizarCotacaoContainer');
    realizarCotacaoContainer.classList.remove('hidden');

    document.getElementById('EtapasScript_btnVoltarEtapa4').addEventListener('click', EtapasScript_desativarModoRealizarCotacao);
    document.getElementById('EtapasScript_btnExcluirSubprodutosSemPreco').addEventListener('click', EtapasScript_manipularExclusaoSubprodutosSemPreco);

    const subprodutosSemPreco = EtapasScript_identificarSubprodutosSemPreco();
    EtapasScript_renderizarListaSubprodutosSemPreco(subprodutosSemPreco);

    CotacaoIndividualScript_mostrarLoadingOverlay(true, "Atualizando status...");
    google.script.run
        .withSuccessHandler(response => {
            CotacaoIndividualScript_mostrarLoadingOverlay(false);
            if (response && response.success) {
                CotacaoIndividualScript_exibirFeedback("Status atualizado para 'Realizando Cotação'.", false, 4000);
            } else {
                CotacaoIndividualScript_exibirFeedback(response.message || "Falha ao atualizar status.", true, 5000);
            }
        })
        .withFailureHandler(err => {
            CotacaoIndividualScript_mostrarLoadingOverlay(false);
            CotacaoIndividualScript_exibirFeedback("Erro de comunicação ao atualizar status: " + err.message, true);
        })
        .EtapasController_atualizarStatusCotacao(CotacaoIndividualScript_cotacaoIdAtual, "Realizando Cotação");
}

function EtapasScript_desativarModoRealizarCotacao() {
    console.log("EtapasScript: Desativando modo Realizar Cotação.");
    CotacaoIndividualScript_modoEtapaAtual = null;
    document.getElementById('EtapasScript_realizarCotacaoContainer').classList.add('hidden');
    CotacaoIndividualScript_restaurarVisualizacaoPadrao(true);
    CotacaoIndividualScript_exibirFeedback("Visualização padrão restaurada.", false, 3000);
}

function EtapasScript_identificarSubprodutosSemPreco() {
    if (!CotacaoIndividualScript_dadosOriginaisCotacao) return [];
    return CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => {
        const preco = item['Preço'];
        return preco === null || preco === undefined || String(preco).trim() === '' || parseFloat(String(preco).replace(',', '.')) === 0;
    });
}

function EtapasScript_renderizarListaSubprodutosSemPreco(subprodutos) {
    const container = document.getElementById('EtapasScript_listaSubprodutosSemPreco');
    container.innerHTML = '';

    if (subprodutos.length === 0) {
        container.innerHTML = `<div class="p-4 text-center text-gray-500">Ótimo! Nenhum subproduto sem preço foi encontrado.</div>`;
        document.getElementById('EtapasScript_btnExcluirSubprodutosSemPreco').textContent = "Iniciar Edição";
        return;
    }

    document.getElementById('EtapasScript_btnExcluirSubprodutosSemPreco').textContent = "Excluir Selecionados e Iniciar Edição";

    subprodutos.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'retirar-subproduto-item py-1';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox-retirar-subproduto-sem-preco';
        checkbox.dataset.produto = item.Produto;
        checkbox.dataset.subproduto = item.SubProduto;
        checkbox.dataset.fornecedor = item.Fornecedor;

        const label = document.createElement('label');
        label.textContent = ` ${item.Produto} -> ${item.SubProduto} (Fornecedor: ${item.Fornecedor})`;
        label.prepend(checkbox);

        itemDiv.appendChild(label);
        container.appendChild(itemDiv);
    });
}

function EtapasScript_manipularExclusaoSubprodutosSemPreco() {
    const subprodutosParaExcluir = [];
    document.querySelectorAll('.checkbox-retirar-subproduto-sem-preco:checked').forEach(cb => {
        subprodutosParaExcluir.push({
            Produto: cb.dataset.produto,
            SubProdutoChave: cb.dataset.subproduto,
            Fornecedor: cb.dataset.fornecedor
        });
    });

    if (subprodutosParaExcluir.length > 0) {
        CotacaoIndividualScript_mostrarLoadingOverlay(true, "Excluindo subprodutos...");
        google.script.run
            .withSuccessHandler(response => {
                if (response && response.success) {
                    CotacaoIndividualScript_exibirFeedback(response.message, false, 4000);
                    CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual)
                        .then(() => {
                            CotacaoIndividualScript_mostrarLoadingOverlay(false);
                            EtapasScript_iniciarEdicao();
                        });
                } else {
                    CotacaoIndividualScript_mostrarLoadingOverlay(false);
                    CotacaoIndividualScript_exibirFeedback(response.message || "Falha ao excluir.", true, 5000);
                }
            })
            .withFailureHandler(err => {
                CotacaoIndividualScript_mostrarLoadingOverlay(false);
                CotacaoIndividualScript_exibirFeedback("Erro de comunicação ao excluir: " + err.message, true);
            })
            .EtapasController_retirarSubProdutosCotacao(CotacaoIndividualScript_cotacaoIdAtual, subprodutosParaExcluir);
    } else {
        EtapasScript_iniciarEdicao();
    }
}

function EtapasScript_iniciarEdicao() {
    document.getElementById('EtapasScript_realizarCotacaoContainer').classList.add('hidden');
    document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.remove('hidden');
    CotacaoIndividualScript_restaurarVisualizacaoPadrao(true);
    CotacaoIndividualScript_exibirFeedback("Modo de edição ativado. Clique em uma célula para editar.", false, 6000);
}

//================================================================================================
// ETAPA 5: DEFINIR EMPRESA PARA FATURAMENTO
//================================================================================================

let EtapasScript_empresasParaFaturamento = [];
let EtapasScript_pedidosMinimosFornecedores = {};

function EtapasScript_formatarMoeda(numero) {
    if (typeof numero !== 'number') {
        numero = parseFloat(numero) || 0;
    }
    const formatado = numero.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return `R$ ${formatado}`;
}

/**
 * Ponto de entrada para a Etapa 5 (versão Modal). Prepara e exibe o modal.
 * SUBSTITUI a implementação antiga.
 * VERSÃO CORRIGIDA com tratamento de erro que fecha o modal e com salvamento em lote.
 */
function EtapasScript_ativarModoDefinirEmpresa() {
    console.log("EtapasScript: Ativando modo Definir Empresa para Faturamento (Modal).");
    CotacaoIndividualScript_modoEtapaAtual = 'definir_empresa';

    const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
    if (!modalOverlay) {
        console.error("EtapasScript: Overlay do modal da Etapa 5 não encontrado.");
        CotacaoIndividualScript_exibirFeedback("Erro crítico: Componente do modal não encontrado.", true, 0);
        return;
    }
    
    modalOverlay.classList.add('active'); 
    EtapasScript_exibirFeedbackModalDefinirEmpresa("Carregando dados para faturamento...", false, 0);

    google.script.run
        .withSuccessHandler(response => {
            if (response && response.success) {
                EtapasScript_empresasParaFaturamento = response.empresas || [];
                EtapasScript_pedidosMinimosFornecedores = response.pedidosMinimos || {};

                const itensParaComprar = CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => {
                    const comprarValor = parseFloat(String(item['Comprar'] || '0').replace(',', '.'));
                    return comprarValor > 0;
                });
                
                const dadosAgrupadosPorFornecedor = agruparPorChave(itensParaComprar, 'Fornecedor');
                
                EtapasScript_renderizarTabelaModoFaturamento(dadosAgrupadosPorFornecedor, 'EtapasScript_controlsContainer_Modal', 'EtapasScript_tabelaContainer_Modal');
                
                EtapasScript_exibirFeedbackModalDefinirEmpresa("Selecione a empresa para faturamento de cada item.", false, 8000);
            } else {
                EtapasScript_exibirFeedbackModalDefinirEmpresa(response.message || "Falha ao carregar dados da Etapa 5.", true, 5000);
                setTimeout(() => {
                    EtapasScript_fecharModalDefinirEmpresa();
                }, 5000);
            }
        })
        .withFailureHandler(err => {
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Erro de comunicação com o servidor: " + err.message, true, 5000);
            setTimeout(() => {
                EtapasScript_fecharModalDefinirEmpresa();
            }, 5000);
        })
        .EtapasController_obterDadosParaEtapaFaturamento();
    
    google.script.run.EtapasController_atualizarStatusCotacao(CotacaoIndividualScript_cotacaoIdAtual, "Definindo Empresa para Faturamento");


    // Configura os botões do modal
    const btnFechar = document.getElementById('EtapasScript_btnFecharModalDefinirEmpresa');
    const btnConcluir = document.getElementById('EtapasScript_btnConcluirModalDefinirEmpresa');
    const btnSalvar = document.getElementById('EtapasScript_btnSalvarFaturamento');
            if (btnSalvar) {
        btnSalvar.removeEventListener('click', EtapasScript_salvarFaturamentoEmLote);
        btnSalvar.addEventListener('click', EtapasScript_salvarFaturamentoEmLote);
        }
    
    btnFechar.removeEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
    btnConcluir.removeEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
    btnSalvar.removeEventListener('click', EtapasScript_salvarFaturamentoEmLote);
    
    btnFechar.addEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
    btnConcluir.addEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
    btnSalvar.addEventListener('click', EtapasScript_salvarFaturamentoEmLote);
}


/**
 * Atualiza o painel de totais global DENTRO DO MODAL.
 * SUBSTITUI a implementação antiga.
 */
// EtapasScript.html
function EtapasScript_atualizarDashboardGlobal() {
    const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
    if (!modalOverlay) return;

    const dashboardContainer = modalOverlay.querySelector('#etapa5-global-dashboard-modal');
    if (!dashboardContainer) return;

    const totaisGlobais = {};
    let grandeTotal = 0;
    const todasLinhasDeProduto = modalOverlay.querySelectorAll('tbody .sub-produto-row');

    todasLinhasDeProduto.forEach(row => {
        if (row.offsetParent === null || !row.closest('.etapa5-content-row')) return;

        const empresaCell = row.querySelector('td[data-coluna="Empresa Faturada"]');
        const valorTotalCell = row.querySelector('td[data-coluna="Valor Total"]');

        if (empresaCell && valorTotalCell) {
            const select = empresaCell.querySelector('select');
            const empresa = (select ? select.value : (empresaCell.textContent || '').trim()) || 'Não Definido';
            const valor = parseFloat(valorTotalCell.textContent.replace(/\./g, '').replace(',', '.')) || 0;

            if (!totaisGlobais[empresa]) totaisGlobais[empresa] = 0;
            totaisGlobais[empresa] += valor;
            grandeTotal += valor;
        }
    });

    let dashboardHTML = '<div class="global-dashboard-container">';
    dashboardHTML += '<h4 class="dashboard-title">Totais Gerais por Empresa</h4>';
    dashboardHTML += '<div class="dashboard-items-container">';

    if (Object.keys(totaisGlobais).length === 0) {
        dashboardHTML += '<div class="dashboard-empty-state">Nenhum item a ser faturado.</div>';
    } else {
        for (const empresa in totaisGlobais) {
            dashboardHTML += `<div class="global-total-item">
                                  <span>${empresa}:</span>
                                  <strong>${EtapasScript_formatarMoeda(totaisGlobais[empresa])}</strong>
                              </div>`;
        }
    }

    dashboardHTML += '</div>';
    if (grandeTotal > 0) {
        dashboardHTML += `<div class="dashboard-grand-total">
                            <span>Total Geral dos Pedidos:</span>
                            <strong>${EtapasScript_formatarMoeda(grandeTotal)}</strong>
                          </div>`;
    }
    dashboardHTML += '</div>';
    dashboardContainer.innerHTML = dashboardHTML;
}


/**
 * Renderiza a tabela e os controles do modo Faturamento DENTRO dos containers do modal.
 * SUBSTITUI a implementação antiga.
 * @param {object} dadosAgrupados - Dados agrupados por fornecedor.
 * @param {string} controlsContainerId - ID do container para o painel de controle global.
 * @param {string} tableContainerId - ID do container para a tabela.
 */
function EtapasScript_renderizarTabelaModoFaturamento(dadosAgrupados, controlsContainerId, tableContainerId) {
    const controlsContainer = document.getElementById(controlsContainerId);
    const tableContainer = document.getElementById(tableContainerId);

    if (!controlsContainer || !tableContainer) {
        console.error("Containers do modal para a Etapa 5 não encontrados.");
        return;
    }

    controlsContainer.innerHTML = '';
    tableContainer.innerHTML = '';

    const globalDashboard = document.createElement('div');
    globalDashboard.id = 'etapa5-global-dashboard-modal';
    globalDashboard.style.cssText = 'border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.375rem; min-width: 300px; float: right;';
    controlsContainer.appendChild(globalDashboard);

    const tabela = document.createElement('table');
    tabela.className = 'sticky-header-table';
    const thead = tabela.createTHead();
    const tbody = tabela.createTBody();
    tableContainer.appendChild(tabela);

    const cabecalhosVisiveis = EtapasScript_COLUNAS_A_EXIBIR_FATURAMENTO;

    const trHeader = thead.insertRow();
    cabecalhosVisiveis.forEach(texto => {
        const th = document.createElement('th');
        th.textContent = texto;
        trHeader.appendChild(th);
    });

    const todosOsCabecalhosDeFornecedor = [];

    for (const fornecedor in dadosAgrupados) {
        const subProdutos = dadosAgrupados[fornecedor];
        const fornecedorClass = `for-modal-${fornecedor.replace(/[^a-zA-Z0-9]/g, '')}`;
        
        const fornecedorRow = tbody.insertRow();
        fornecedorRow.className = 'categoria-accordion-header-row';
        fornecedorRow.id = `fornecedor-row-${fornecedorClass}`;
        fornecedorRow.dataset.targetClass = fornecedorClass;
        todosOsCabecalhosDeFornecedor.push(fornecedorRow);

        const fornecedorCell = fornecedorRow.insertCell();
        fornecedorCell.colSpan = cabecalhosVisiveis.length;
        
        // NOVO: Adiciona o select para aplicação em massa
        const selectMassa = document.createElement('select');
        selectMassa.className = 'aplicar-massa-empresa';
        selectMassa.innerHTML = `<option value="">Aplicar a todos...</option>` + EtapasScript_empresasParaFaturamento.map(e => `<option value="${e}">${e}</option>`).join('');
        selectMassa.onchange = (e) => { 
            e.stopPropagation(); 
            EtapasScript_aplicarEmpresaParaFornecedor(fornecedor, e.target.value); 
        };

        const headerContainer = document.createElement('div');
        headerContainer.style.cssText = 'display: flex; justify-content: space-between; width: 100%; align-items: center;';
        headerContainer.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <svg class="categoria-accordion-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                <span style="margin-left: 8px;">Fornecedor: <strong>${fornecedor}</strong></span>
            </div>
            <div id="total-header-${fornecedorClass}"></div>
        `;
        const selectContainer = document.createElement('div');
        selectContainer.style.marginLeft = '20px';
        selectContainer.appendChild(selectMassa);
        headerContainer.querySelector(`#total-header-${fornecedorClass}`).before(selectContainer);
        fornecedorCell.appendChild(headerContainer);

        const dashboardRow = tbody.insertRow();
        dashboardRow.className = `etapa5-content-row ${fornecedorClass} hidden`;
        const dashboardCell = dashboardRow.insertCell();
        dashboardCell.colSpan = cabecalhosVisiveis.length;
        dashboardCell.style.cssText = 'padding: 8px 25px; background-color: #f0f9ff;';
        dashboardCell.innerHTML = `<div class="mini-dashboard" data-fornecedor="${fornecedor}"></div>`;

        subProdutos.forEach(subProduto => {
            const subRow = tbody.insertRow();
            subRow.className = `sub-produto-row etapa5-content-row ${fornecedorClass} hidden`;
            subRow.dataset.produto = subProduto['Produto'];
            subRow.dataset.fornecedor = subProduto['Fornecedor'];
            subRow.dataset.subprodutoOriginalPersistido = subProduto['_subProdutoOriginalPersistido'];

            cabecalhosVisiveis.forEach(cabecalho => {
                const td = subRow.insertCell();
                td.dataset.coluna = cabecalho;
                const classeCor = window.CotacaoIndividualScript_getClasseCorColuna(cabecalho);
                if (classeCor) td.classList.add(classeCor);

                if (cabecalho === "Empresa Faturada") {
                    td.classList.add('editable-select-cell');
                    const select = document.createElement('select');
                    select.className = 'inline-edit-input';
                    select.innerHTML = `<option value="">Selecione...</option>` + EtapasScript_empresasParaFaturamento.map(e => 
                        `<option value="${e}" ${subProduto[cabecalho] === e ? 'selected' : ''}>${e}</option>`
                    ).join('');
                    select.addEventListener('change', () => {
                        EtapasScript_atualizarDashboardFornecedor(fornecedor);
                        EtapasScript_atualizarDashboardGlobal();
                    });
                    td.appendChild(select);
                } else {
                    let valor = subProduto[cabecalho];
                    let fmt;
                    if (typeof valor === 'number') {
                        const fractionDigits = { 'Preço por Fator': 4, 'Preço': 2, 'Comprar': 2, 'Valor Total': 2 };
                        fmt = valor.toLocaleString('pt-BR', { minimumFractionDigits: fractionDigits[cabecalho] || 2, maximumFractionDigits: fractionDigits[cabecalho] || 2 });
                    } else {
                        fmt = valor == null ? "" : String(valor);
                    }
                    td.textContent = fmt;
                }
            });
        });

        fornecedorRow.addEventListener('click', function() {
            this.classList.toggle('expanded');
            const isExpandedNow = this.classList.contains('expanded');
            this.closest('tbody').querySelectorAll(`tr.${this.dataset.targetClass}`).forEach(r => r.classList.toggle('hidden', !isExpandedNow));
            this.querySelector('.categoria-accordion-icon').style.transform = isExpandedNow ? 'rotate(90deg)' : 'rotate(0deg)';
            if (isExpandedNow) EtapasScript_atualizarDashboardFornecedor(fornecedor);
        });
    }
    
    EtapasScript_atualizarDashboardGlobal();
    todosOsCabecalhosDeFornecedor.forEach(headerRow => headerRow.click());
}

/**
 * NOVA FUNÇÃO: Aplica uma empresa de faturamento para todos os itens de um fornecedor no modal.
 * @param {string} fornecedor O nome do fornecedor.
 * @param {string} empresa A empresa selecionada para aplicar em massa.
 */
function EtapasScript_aplicarEmpresaParaFornecedor(fornecedor, empresa) {
    console.log(`Aplicando empresa '${empresa}' para todos os itens do fornecedor '${fornecedor}'.`);
    const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
    if (!modalOverlay) return;

    const linhasDoFornecedor = modalOverlay.querySelectorAll(`tr[data-fornecedor="${fornecedor}"].sub-produto-row`);
    
    linhasDoFornecedor.forEach(row => {
        const selectCell = row.querySelector('td[data-coluna="Empresa Faturada"] select');
        if (selectCell) {
            selectCell.value = empresa;
        }
    });

    // Atualiza os dashboards para refletir a mudança em massa
    EtapasScript_atualizarDashboardFornecedor(fornecedor);
    EtapasScript_atualizarDashboardGlobal();
}

/**
 * NOVA FUNÇÃO: Coleta apenas os itens que tiveram a "Empresa Faturada" alterada no modal.
 * @returns {Array<object>} Lista de objetos com os dados dos itens alterados.
 */
function EtapasScript_coletarAlteracoesFaturamento() {
    const alteracoes = [];
    const todasLinhasDoModal = document.querySelectorAll('#EtapasScript_modalDefinirEmpresaOverlay .sub-produto-row');

    todasLinhasDoModal.forEach(row => {
        const identificadores = {
            Produto: row.dataset.produto,
            SubProdutoChave: row.dataset.subprodutoOriginalPersistido,
            Fornecedor: row.dataset.fornecedor
        };

        const itemOriginal = CotacaoIndividualScript_dadosOriginaisCotacao.find(item => 
            item.Produto === identificadores.Produto &&
            item._subProdutoOriginalPersistido === identificadores.SubProdutoChave &&
            item.Fornecedor === identificadores.Fornecedor
        );

        const selectEmpresa = row.querySelector('td[data-coluna="Empresa Faturada"] select');
        if (selectEmpresa && itemOriginal) {
            const novaEmpresa = selectEmpresa.value;
            const empresaOriginal = itemOriginal["Empresa Faturada"] || "";
            
            if (novaEmpresa !== empresaOriginal) {
                alteracoes.push({
                    ...identificadores,
                    "Empresa Faturada": novaEmpresa
                });
            }
        }
    });

    console.log("Alterações de faturamento coletadas:", alteracoes);
    return alteracoes;
}

/**
 * NOVA FUNÇÃO: Envia as alterações de faturamento em lote para o servidor.
 */
function EtapasScript_salvarFaturamentoEmLote() {
    const alteracoes = EtapasScript_coletarAlteracoesFaturamento();

    if (alteracoes.length === 0) {
        EtapasScript_exibirFeedbackModalDefinirEmpresa("Nenhuma alteração foi feita para salvar.", false, 4000);
        return;
    }

    const btnSalvar = document.getElementById('EtapasScript_btnSalvarFaturamento');
    btnSalvar.disabled = true;
    btnSalvar.textContent = 'Salvando...';
    EtapasScript_exibirFeedbackModalDefinirEmpresa(`Salvando ${alteracoes.length} alteraçõe(s)...`, false, 0);

    google.script.run
        .withSuccessHandler(response => {
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar e Fechar';
            if (response && response.success) {
                EtapasScript_fecharModalDefinirEmpresa();
                CotacaoIndividualScript_exibirFeedback(response.message || "Faturamento salvo com sucesso! Atualizando dados...", false, 5000);
                CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
            } else {
                EtapasScript_exibirFeedbackModalDefinirEmpresa(response.message || "Falha ao salvar faturamento.", true, 7000);
            }
        })
        .withFailureHandler(error => {
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar e Fechar';
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Erro de comunicação ao salvar faturamento: " + error.message, true, 7000);
        })
        .EtapasController_salvarEmpresasFaturadasEmLote(CotacaoIndividualScript_cotacaoIdAtual, alteracoes);
}

function EtapasScript_atualizarDashboardFornecedor(fornecedor) {
    const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
    if (!modalOverlay) return;

    const fornecedorClass = `for-modal-${fornecedor.replace(/[^a-zA-Z0-9]/g, '')}`;
    const dashboardDiv = modalOverlay.querySelector(`.mini-dashboard[data-fornecedor="${fornecedor}"]`);
    const totalHeaderDiv = modalOverlay.querySelector(`#total-header-${fornecedorClass}`);
    const fornecedorRow = modalOverlay.querySelector(`#fornecedor-row-${fornecedorClass}`);

    if (!dashboardDiv || !totalHeaderDiv || !fornecedorRow) return;

    const totaisPorEmpresa = {};
    let valorTotalFornecedor = 0;
    const linhasFornecedor = modalOverlay.querySelectorAll(`tr[data-fornecedor="${fornecedor}"].sub-produto-row`);

    linhasFornecedor.forEach(row => {
        const empresaCell = row.querySelector('td[data-coluna="Empresa Faturada"]');
        const valorTotalCell = row.querySelector('td[data-coluna="Valor Total"]');
        if (!empresaCell || !valorTotalCell) return;

        const select = empresaCell.querySelector('select');
        const empresa = (select ? select.value : (empresaCell.textContent || '').trim()) || 'Não Definido';
        const valor = parseFloat(valorTotalCell.textContent.replace(/\./g, '').replace(',', '.')) || 0;

        if (!totaisPorEmpresa[empresa]) totaisPorEmpresa[empresa] = 0;
        totaisPorEmpresa[empresa] += valor;
        valorTotalFornecedor += valor;
    });

    const pedidoMinimo = EtapasScript_pedidosMinimosFornecedores[String(fornecedor).trim()] || 0;
    totalHeaderDiv.innerHTML = `
        <span>Total do Pedido: <strong>${EtapasScript_formatarMoeda(valorTotalFornecedor)}</strong></span>
        ${pedidoMinimo > 0 ? `<span style="margin-left: 15px;">(Mínimo por Empresa: ${EtapasScript_formatarMoeda(pedidoMinimo)})</span>` : ''}
    `;

    let dashboardHTML = '<strong>Totais por Empresa de Faturamento:</strong> ';
    let todosAtingiramMinimo = true;

    if (Object.keys(totaisPorEmpresa).length === 0 || (Object.keys(totaisPorEmpresa).length === 1 && totaisPorEmpresa['Não Definido'])) {
        dashboardHTML += '<span style="margin-left: 10px;">Nenhuma empresa definida para os itens.</span>';
        if (pedidoMinimo > 0) todosAtingiramMinimo = false;
    } else {
        for (const empresa in totaisPorEmpresa) {
            if (empresa === 'Não Definido') continue;
            const totalEmpresa = totaisPorEmpresa[empresa];
            const atingiuMinimoEmpresa = totalEmpresa >= pedidoMinimo;

            if (!atingiuMinimoEmpresa && pedidoMinimo > 0) {
                todosAtingiramMinimo = false;
                dashboardHTML += `<span style="margin-left: 15px; background-color: #fef2f2; padding: 2px 6px; border-radius: 4px; color: #b91c1c; font-weight: bold; border: 1px solid #fecaca;">
                                      ${empresa}: ${EtapasScript_formatarMoeda(totalEmpresa)} (Mínimo não atingido!)
                                  </span>`;
            } else {
                dashboardHTML += `<span style="margin-left: 15px; background-color: #e0e7ff; padding: 2px 6px; border-radius: 4px;">
                                      ${empresa}: ${EtapasScript_formatarMoeda(totalEmpresa)}
                                  </span>`;
            }
        }
    }
    dashboardDiv.innerHTML = dashboardHTML;

    fornecedorRow.style.backgroundColor = (!todosAtingiramMinimo && pedidoMinimo > 0) ? '#fff7ed' : 'transparent';
    fornecedorRow.style.borderLeft = (!todosAtingiramMinimo && pedidoMinimo > 0) ? '4px solid #f97316' : 'none';
}

function agruparPorChave(array, chave) {
    return array.reduce((resultado, item) => {
        (resultado[item[chave]] = resultado[item[chave]] || []).push(item);
        return resultado;
    }, {});
}

//================================================================================================
// ETAPA 6: DEFINIR CONDIÇÕES DE PAGAMENTO
//================================================================================================

let EtapasScript_debounceTimer = null;

/**
 * Ponto de entrada para a Etapa 6 (versão Modal). Prepara e exibe o modal.
 * ESTA É A VERSÃO CORRETA E FINAL. Substitua a sua função antiga por esta.
 */
function EtapasScript_ativarModoDefinirCondicoesPagamento() {
    console.log("EtapasScript: Ativando modo Definir Condições de Pagamento (Modal).");
    CotacaoIndividualScript_modoEtapaAtual = 'definir_condicoes_pagamento';

    const itensParaComprar = CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => 
        (parseFloat(String(item['Comprar'] || '0').replace(',', '.')) || 0) > 0
    );

    const itemSemEmpresa = itensParaComprar.find(item => !item['Empresa Faturada']);
    if (itemSemEmpresa) {
        CotacaoIndividualScript_exibirFeedback("Erro: Existem itens para comprar sem 'Empresa Faturada'. Complete a Etapa 5 primeiro.", true, 8000);
        CotacaoIndividualScript_modoEtapaAtual = null;
        return;
    }

    const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
    modalOverlay.classList.add('active');
    EtapasScript_exibirFeedbackModalCondicoes("Carregando dados de pagamento...", false, 0);
    document.getElementById('etapa6-pedidos-list-modal').innerHTML = '<p class="text-gray-500 text-center p-4">Carregando...</p>';

    document.getElementById('EtapasScript_btnFecharModalCondicoes').addEventListener('click', EtapasScript_fecharModalCondicoesPagamento);
    document.getElementById('EtapasScript_btnCancelarModalCondicoes').addEventListener('click', EtapasScript_fecharModalCondicoesPagamento);
    document.getElementById('EtapasScript_btnSalvarModalCondicoes').addEventListener('click', EtapasScript_salvarDadosCondicoesPagamento);

    google.script.run
        .withSuccessHandler(response => {
            if (response && response.success) {
                EtapasScript_renderizarInterfaceCondicoesPagamento(itensParaComprar, response.condicoes || {}, 'etapa6-pedidos-list-modal');
                google.script.run.EtapasController_atualizarStatusCotacao(CotacaoIndividualScript_cotacaoIdAtual, "Definindo Condições de Pagamento");
                EtapasScript_exibirFeedbackModalCondicoes("", false, 1); // Limpa o feedback de carregamento
            } else {
                // LÓGICA DE FALHA CORRIGIDA:
                EtapasScript_exibirFeedbackModalCondicoes(response.message || "Falha ao carregar dados.", true);
                // Chama a função para FECHAR O MODAL, e não a antiga para desativar a view.
                setTimeout(EtapasScript_fecharModalCondicoesPagamento, 3000);
            }
        })
        .withFailureHandler(err => {
            // LÓGICA DE FALHA CORRIGIDA:
            EtapasScript_exibirFeedbackModalCondicoes("Erro de comunicação: " + err.message, true);
            // Chama a função para FECHAR O MODAL, e não a antiga para desativar a view.
            setTimeout(EtapasScript_fecharModalCondicoesPagamento, 3000);
        })
        .EtapasController_obterDadosParaEtapaCondicoes();
}


/**
 * Renderiza a interface de condições de pagamento dentro do container do modal.
 * SUBSTITUI a implementação antiga.
 * @param {Array<object>} itensParaComprar - Itens filtrados que precisam de pagamento.
 * @param {object} condicoesFornecedores - Mapa de condições sugeridas.
 * @param {string} pedidosListContainerId - ID do elemento onde a lista será renderizada.
 */
function EtapasScript_renderizarInterfaceCondicoesPagamento(itensParaComprar, condicoesFornecedores, pedidosListContainerId) {
    const pedidosListContainer = document.getElementById(pedidosListContainerId);
    const template = document.getElementById('etapa6-pedido-item-template');
    
    if (!pedidosListContainer || !template) {
        console.error("Erro crítico: Container da lista de pedidos ou template não encontrado para a Etapa 6.");
        EtapasScript_exibirFeedbackModalCondicoes("Erro de interface. Recarregue a página.", true, 0);
        return;
    }

    pedidosListContainer.innerHTML = '';

    const agrupado = itensParaComprar.reduce((acc, item) => {
        const fornecedor = item['Fornecedor'];
        const empresa = item['Empresa Faturada'];
        const chave = `${fornecedor}__${empresa}`;
        if (!acc[chave]) {
            acc[chave] = { fornecedor, empresa, total: 0, condicaoSalva: item['Condição de Pagamento'] || '' };
        }
        acc[chave].total += (parseFloat(String(item['Preço'] || 0).replace(',', '.')) || 0) * (parseFloat(String(item['Comprar'] || 0).replace(',', '.')) || 0);
        return acc;
    }, {});

    const listaPedidos = Object.values(agrupado);
    if (listaPedidos.length === 0) {
        pedidosListContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">Nenhum item a ser pago nesta cotação.</p>';
        return;
    }

    listaPedidos.forEach((pedido, index) => {
        const clone = template.content.cloneNode(true);
        const uniqueId = `etapa6-pedido-modal-${index}`;
        const condicoesSugeridas = condicoesFornecedores[pedido.fornecedor] || 'N/A';
        
        clone.querySelector('.fornecedor-nome').textContent = pedido.fornecedor;
        clone.querySelector('.empresa-nome').textContent = pedido.empresa;
        clone.querySelector('.valor-total').textContent = EtapasScript_formatarMoeda(pedido.total);
        clone.querySelector('.condicoes-sugeridas').textContent = condicoesSugeridas.replace(/[,;]/g, ' / ');
        const inputCond = clone.querySelector('input[type="text"]');
        inputCond.id = `cond-pagto-${uniqueId}`;
        inputCond.value = pedido.condicaoSalva;
        
        const itemDiv = clone.querySelector('.etapa6-pedido-item');
        itemDiv.dataset.fornecedor = pedido.fornecedor;
        itemDiv.dataset.empresa = pedido.empresa;
        itemDiv.dataset.total = pedido.total;
        
        inputCond.addEventListener('input', () => {
            clearTimeout(EtapasScript_debounceTimer);
            EtapasScript_debounceTimer = setTimeout(EtapasScript_atualizarFluxoCaixaGeral, 300);
        });
        pedidosListContainer.appendChild(clone);
    });
    
    EtapasScript_atualizarFluxoCaixaGeral();
}

/**
 * Atualiza o fluxo de caixa no painel direito do modal.
 * SUBSTITUI a implementação antiga.
 */
function EtapasScript_atualizarFluxoCaixaGeral() {
    const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
    if (!modalOverlay || !modalOverlay.classList.contains('active')) return;

    const todosOsPedidos = modalOverlay.querySelectorAll('#etapa6-pedidos-list-modal .etapa6-pedido-item');
    const tbody = document.getElementById('etapa6-fluxo-preview-tbody-modal');
    
    if (!tbody) {
        console.error("Corpo da tabela de fluxo de caixa do modal não encontrado.");
        return;
    }

    const totaisDiarios = {};
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    todosOsPedidos.forEach(item => {
        const valorTotal = parseFloat(item.dataset.total);
        const condicao = item.querySelector('input[type="text"]').value;
        if (!condicao || isNaN(valorTotal) || valorTotal <= 0) return;

        const prazos = String(condicao).split(/[/,; ]+/).map(p => parseInt(p.trim(), 10)).filter(p => !isNaN(p) && p >= 0);
        if (prazos.length === 0) return;
        
        const valorParcela = valorTotal / prazos.length;

        prazos.forEach(dias => {
            const dataVencimento = new Date(hoje.getTime());
            dataVencimento.setDate(hoje.getDate() + dias);
            const chaveData = dataVencimento.toISOString().split('T')[0];
            totaisDiarios[chaveData] = (totaisDiarios[chaveData] || 0) + valorParcela;
        });
    });

    const chavesOrdenadas = Object.keys(totaisDiarios).sort();
    tbody.innerHTML = '';

    if (chavesOrdenadas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #6b7280;">Nenhuma condição de pagamento válida informada.</td></tr>';
        return;
    }

    chavesOrdenadas.forEach(chaveData => {
        const [ano, mes, dia] = chaveData.split('-');
        const dataLabel = `${dia}/${mes}/${ano}`;
        const valorDia = totaisDiarios[chaveData];
        const row = tbody.insertRow();
        row.insertCell().textContent = dataLabel;
        row.insertCell().textContent = EtapasScript_formatarMoeda(valorDia);
    });
}

/**
 * Coleta e salva os dados de condições de pagamento do modal.
 * SUBSTITUI a implementação antiga.
 */
function EtapasScript_salvarDadosCondicoesPagamento() {
    console.log("EtapasScript: Salvando condições de pagamento do modal...");
    const dadosParaSalvar = [];
    const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
    const todosOsPedidos = modalOverlay.querySelectorAll('#etapa6-pedidos-list-modal .etapa6-pedido-item');
    let primeiroCampoVazio = null;

    for (const item of todosOsPedidos) {
        const fornecedor = item.dataset.fornecedor;
        const empresa = item.dataset.empresa;
        const condicaoInput = item.querySelector('input[type="text"]');
        const condicao = condicaoInput.value.trim();

        if (condicao === '') {
            primeiroCampoVazio = condicaoInput;
            break; 
        }
        dadosParaSalvar.push({ fornecedor, empresa, condicao });
    }

    if (primeiroCampoVazio) {
        EtapasScript_exibirFeedbackModalCondicoes("Erro: Todas as condições de pagamento devem ser preenchidas antes de salvar.", true, 5000);
        primeiroCampoVazio.focus();
        primeiroCampoVazio.style.borderColor = 'red';
        setTimeout(() => { if (primeiroCampoVazio) primeiroCampoVazio.style.borderColor = '#d1d5db'; }, 3000);
        return;
    }

    if (dadosParaSalvar.length === 0) {
        EtapasScript_exibirFeedbackModalCondicoes("Não há pedidos para salvar.", false, 4000);
        return;
    }

    const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalCondicoes');
    btnSalvar.disabled = true;
    btnSalvar.textContent = "Salvando...";
    EtapasScript_exibirFeedbackModalCondicoes("Salvando condições de pagamento...", false, 0);

    google.script.run
        .withSuccessHandler(response => {
            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar Condições";
            if (response && response.success) {
                EtapasScript_fecharModalCondicoesPagamento();
                CotacaoIndividualScript_exibirFeedback(response.message, false, 6000);
                CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
            } else {
                EtapasScript_exibirFeedbackModalCondicoes(response.message || "Falha ao salvar condições de pagamento.", true, 8000);
            }
        })
        .withFailureHandler(err => {
            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar Condições";
            EtapasScript_exibirFeedbackModalCondicoes("Erro de comunicação ao salvar: " + err.message, true);
        })
        .EtapasController_salvarCondicoesPagamento(CotacaoIndividualScript_cotacaoIdAtual, dadosParaSalvar);
}

//================================================================================================
// ETAPA 7: IMPRIMIR PEDIDOS
//================================================================================================

/**
 * Solicita a URL da página de impressão e a abre em uma nova aba.
 */
function EtapasScript_abrirPaginaImpressao() {
    console.log("EtapasScript: Solicitando abertura da página de impressão.");
    
    if (!CotacaoIndividualScript_cotacaoIdAtual) {
        CotacaoIndividualScript_exibirFeedback("Erro: ID da Cotação não encontrado.", true, 5000);
        return;
    }
    
    CotacaoIndividualScript_mostrarLoadingOverlay(true, "Gerando link de impressão...");

    google.script.run
        .withSuccessHandler(response => {
            CotacaoIndividualScript_mostrarLoadingOverlay(false);
            if (response.success && response.url) {
                window.open(response.url, '_blank');
            } else {
                CotacaoIndividualScript_exibirFeedback(response.message || "Não foi possível gerar a URL para a página de impressão.", true, 7000);
            }
        })
        .withFailureHandler(error => {
            CotacaoIndividualScript_mostrarLoadingOverlay(false);
            CotacaoIndividualScript_exibirFeedback("Erro de comunicação ao gerar link: " + error.message, true);
        })
        .App_obterUrlWebApp({ view: 'ImprimirPedidosView', idCotacao: CotacaoIndividualScript_cotacaoIdAtual });
}

/**
 * Fecha o modal de Retirar Produtos e restaura o estado da aplicação.
 */
function EtapasScript_fecharModalRetirarProdutos() {
    console.log("EtapasScript: Fechando modal de Retirar Produtos.");
    const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
    }
    CotacaoIndividualScript_modoEtapaAtual = null; // Limpa o modo de etapa
    
    // Limpa feedback dentro do modal para a próxima vez que for aberto
    const feedbackDiv = document.getElementById('EtapasScript_feedbackModalRetirarProdutos');
    if(feedbackDiv) feedbackDiv.innerHTML = '';
}

/**
 * Renderiza o conteúdo (acordeões) dentro do modal de Retirar Produtos.
 */
function EtapasScript_renderizarConteudoModalRetirarProdutos() {
    console.log("EtapasScript: Renderizando conteúdo para o modal de Retirar Produtos.");
    const { crit1, crit2, crit3 } = EtapasScript_identificarProdutosParaRetirada();

    // Renderiza cada acordeão no seu respectivo container DENTRO do modal
    EtapasScript_renderizarAcordeaoRetirarProdutos('EtapasScript_acordeaoContainerCrit1_Modal', "Quantidade maior que o necessário.", crit1, "crit1_modal");
    EtapasScript_renderizarAcordeaoRetirarProdutos('EtapasScript_acordeaoContainerCrit2_Modal', "Não foi marcado para comprar.", crit2, "crit2_modal");
    EtapasScript_renderizarAcordeaoRetirarProdutos('EtapasScript_acordeaoContainerCrit3_Modal', "Produtos inativos ou sem dados.", crit3, "crit3_modal");
}

/**
 * Ponto de entrada para a Etapa 2 (versão Modal). Prepara e exibe o modal.
 * Esta função substitui a implementação antiga.
 */
function EtapasScript_ativarModoRetirarProdutos() {
    console.log("EtapasScript: Ativando modo Retirar Produtos (Modal).");
    CotacaoIndividualScript_modoEtapaAtual = 'retirar_produtos';

    if (CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
        CotacaoIndividualScript_exibirFeedback("Dados da cotação ainda não carregados. Tente novamente.", true, 5000);
        CotacaoIndividualScript_modoEtapaAtual = null;
        return;
    }

    // Renderiza o conteúdo do modal com os dados atuais
    EtapasScript_renderizarConteudoModalRetirarProdutos();

    // Abre o modal
    const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
    if (modalOverlay) {
        modalOverlay.classList.add('active');
    }

    // Configura os botões do modal
    const btnConfirmar = document.getElementById('EtapasScript_btnConfirmarRemocaoModal');
    const btnCancelar = document.getElementById('EtapasScript_btnCancelarModalRetirarProdutos');
    const btnFechar = document.getElementById('EtapasScript_btnFecharModalRetirarProdutos');

    // Remove event listeners antigos para evitar duplicação
    btnConfirmar.removeEventListener('click', EtapasScript_manipularExclusaoProdutosRetirar);
    btnCancelar.removeEventListener('click', EtapasScript_fecharModalRetirarProdutos);
    btnFechar.removeEventListener('click', EtapasScript_fecharModalRetirarProdutos);

    // Adiciona os novos event listeners
    btnConfirmar.addEventListener('click', EtapasScript_manipularExclusaoProdutosRetirar);
    btnCancelar.addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
    btnFechar.addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
}

/**
 * Exibe feedback dentro do modal de Retirar Produtos.
 * @param {string} mensagem O texto a ser exibido.
 * @param {boolean} isError Se a mensagem é um erro.
 * @param {number} duracao Duração em milissegundos para a mensagem desaparecer.
 */
function EtapasScript_exibirFeedbackModalRetirarProdutos(mensagem, isError = false, duracao = 5000) {
    const feedbackDiv = document.getElementById('EtapasScript_feedbackModalRetirarProdutos');
    if (feedbackDiv) {
        const innerDiv = document.createElement('div');
        innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
        innerDiv.textContent = mensagem;
        feedbackDiv.innerHTML = ''; // Limpa mensagens antigas
        feedbackDiv.appendChild(innerDiv);
        
        if (duracao > 0) {
            setTimeout(() => {
                if (feedbackDiv.contains(innerDiv)) {
                    feedbackDiv.innerHTML = '';
                }
            }, duracao);
        }
    }
}

/**
 * Fecha o modal de Definir Empresa para Faturamento e limpa o estado.
 */
function EtapasScript_fecharModalDefinirEmpresa() {
    console.log("EtapasScript: Fechando modal de Definir Empresa.");
    const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
    }
    CotacaoIndividualScript_modoEtapaAtual = null; // Limpa o modo de etapa

    // Limpa o conteúdo interno do modal para a próxima abertura
    const modalBody = document.getElementById('EtapasScript_modalBodyDefinirEmpresa');
    const controlsContainer = document.getElementById('EtapasScript_controlsContainer_Modal');
    const tableContainer = document.getElementById('EtapasScript_tabelaContainer_Modal');
    const feedbackDiv = document.getElementById('EtapasScript_feedbackModalDefinirEmpresa');

    if(controlsContainer) controlsContainer.innerHTML = '';
    if(tableContainer) tableContainer.innerHTML = '';
    if(feedbackDiv) feedbackDiv.innerHTML = '';
}

/**
 * Exibe feedback dentro do modal de Definir Empresa.
 * @param {string} mensagem O texto a ser exibido.
 * @param {boolean} isError Se a mensagem é um erro.
 * @param {number} duracao Duração em milissegundos.
 */
function EtapasScript_exibirFeedbackModalDefinirEmpresa(mensagem, isError = false, duracao = 5000) {
    const feedbackDiv = document.getElementById('EtapasScript_feedbackModalDefinirEmpresa');
    if (feedbackDiv) {
        const innerDiv = document.createElement('div');
        innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
        innerDiv.textContent = mensagem;
        feedbackDiv.innerHTML = '';
        feedbackDiv.appendChild(innerDiv);
        
        if (duracao > 0) {
            setTimeout(() => {
                if (feedbackDiv.contains(innerDiv)) {
                    feedbackDiv.innerHTML = '';
                }
            }, duracao);
        }
    }
}

/**
 * Fecha o modal de Condições de Pagamento, com verificação de dados não salvos.
 */
function EtapasScript_fecharModalCondicoesPagamento() {
    let todosPreenchidos = true;
    const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
    const todosOsInputs = modalOverlay.querySelectorAll('#etapa6-pedidos-list-modal .etapa6-pagamento-input');
    
    if (todosOsInputs.length > 0) {
        todosOsInputs.forEach(input => {
            if (input.value.trim() === '') {
                todosPreenchidos = false;
            }
        });
    }

    let procederFechamento = true;
    if (!todosPreenchidos) {
        procederFechamento = confirm("Atenção: Existem condições de pagamento não preenchidas. Deseja realmente fechar e descartar as alterações não salvas?");
    }

    if (procederFechamento) {
        console.log("EtapasScript: Fechando modal de Condições de Pagamento.");
        if (modalOverlay) {
            modalOverlay.classList.remove('active');
        }
        CotacaoIndividualScript_modoEtapaAtual = null; // Limpa o modo de etapa
        
        const feedbackDiv = document.getElementById('EtapasScript_feedbackModalCondicoes');
        if(feedbackDiv) feedbackDiv.innerHTML = '';
    } else {
        console.log("Fechamento do modal cancelado pelo usuário.");
    }
}

/**
 * Exibe feedback dentro do modal de Condições de Pagamento.
 */
function EtapasScript_exibirFeedbackModalCondicoes(mensagem, isError = false, duracao = 5000) {
    const feedbackDiv = document.getElementById('EtapasScript_feedbackModalCondicoes');
    if (feedbackDiv) {
        const innerDiv = document.createElement('div');
        innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
        innerDiv.textContent = mensagem;
        feedbackDiv.innerHTML = '';
        feedbackDiv.appendChild(innerDiv);
        
        if (duracao > 0) {
            setTimeout(() => {
                if (feedbackDiv.contains(innerDiv)) {
                    feedbackDiv.innerHTML = '';
                }
            }, duracao);
        }
    }
}

</script>