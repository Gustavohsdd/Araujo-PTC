<script>
// Variáveis globais de estado
let rateiosEmLote = [];
let todasAsNotas = [];
let dadosAtuaisNF = null; 

// ===== INICIALIZAÇÃO =====

document.addEventListener('DOMContentLoaded', function() {
    inicializarPagina();
    addEventListeners();
});

function inicializarPagina() {
    toggleLoader(true);
    google.script.run
        .withSuccessHandler(onDadosIniciaisSuccess)
        .withFailureHandler(onFailure)
        .RateioController_obterDadosParaPagina();
}

function addEventListeners() {
    $('#lista-de-notas').on('click', '.nota-list-item:not(.staged)', onNotaItemClick);
    $('#itens-manuais-container').on('click', '.btn-add-setor', onAdicionarSetorManualClick);
    $('#itens-manuais-container').on('click', '.btn-remove-setor', onRemoverSetorManualClick);
    $('#itens-manuais-container').on('input', '.input-porcentagem, .input-setor', onPorcentagemChange);
    $('#btn-preparar-rateio').on('click', onBtnPrepararRateioClick);
    $('#btn-salvar-lote').on('click', onBtnSalvarLoteClick);
    $('#btn-preparar-automaticos').on('click', onBtnPrepararAutomaticosClick);
}

// ===== LÓGICA DE LOTE =====

function atualizarBotaoSalvarLote() {
    const btn = $('#btn-salvar-lote');
    const count = rateiosEmLote.length;
    if (count > 0) {
        $('#save-batch-text').text(`Salvar ${count} Rateio(s)`);
        btn.removeClass('d-none');
    } else {
        btn.addClass('d-none');
    }
}

function resetarAplicacao() {
    toggleLoader(true);
    rateiosEmLote = [];
    atualizarBotaoSalvarLote();
    $('#workspace-rateio').addClass('d-none');
    $('#workspace-welcome').removeClass('d-none');
    inicializarPagina();
}

function onBtnPrepararAutomaticosClick() {
    const chavesAutomaticas = todasAsNotas
        .filter(n => n.isAutomatico && !$(`.nota-list-item[data-chave="${n.chaveAcesso}"]`).hasClass('staged'))
        .map(n => n.chaveAcesso);

    if (chavesAutomaticas.length === 0) {
        alert("Nenhuma nota 100% automática para preparar.");
        return;
    }
    
    toggleLoader(true);
    google.script.run
        .withSuccessHandler(response => {
            toggleLoader(false);
            if (response && response.success) {
                const payloads = response.payloads;
                payloads.forEach(payload => {
                    rateiosEmLote.push(payload);
                    marcarNotaComoPronta(payload.chaveAcesso);
                });
                alert(`${payloads.length} rateio(s) automáticos preparados para salvar.`);
                atualizarBotaoSalvarLote();
            } else {
                onFailure(response);
            }
        })
        .withFailureHandler(onFailure)
        .RateioController_prepararLoteAutomatico(chavesAutomaticas);
}

function marcarNotaComoPronta(chaveAcesso) {
     $(`.nota-list-item[data-chave="${chaveAcesso}"]`)
      .addClass('staged')
      .removeClass('active')
      .find('.status-icon')
      .removeClass('d-none');
}

// ===== CALLBACKS DO SERVIDOR E PROCESSAMENTO DE DADOS =====

function onDadosIniciaisSuccess(response) {
    toggleLoader(false);
    if (!response.success) {
        alert('Erro ao carregar dados iniciais: ' + response.message);
        return;
    }
    todasAsNotas = response.notas;
    renderizarListaDeNotas(todasAsNotas);

    const temAutomaticas = todasAsNotas.some(n => n.isAutomatico);
    $('#btn-preparar-automaticos').prop('disabled', !temAutomaticas);
}

function onFailure(error) {
    console.error('Erro detalhado da chamada ao servidor:', error);
    alert('Ocorreu um erro no servidor: ' + (error.message || 'Erro desconhecido. Verifique o console.'));
    toggleLoader(false);
    toggleLoader(false, '#panel-direito');
}

// ===== RENDERIZAÇÃO E LÓGICA DA UI =====

function renderizarListaDeNotas(notas) {
    const container = $('#lista-de-notas').empty();
    if (!notas || notas.length === 0) {
        container.html('<p class="p-3 text-muted text-center">Nenhuma nota fiscal pendente de rateio.</p>');
        return;
    }

    const listaHtml = notas.map(nota => {
        const classAutomatica = nota.isAutomatico ? 'automatico' : '';
        const titleAutomatico = nota.isAutomatico ? 'title="Rateio 100% automático disponível"' : '';
        return `
        <a href="#" class="list-group-item list-group-item-action nota-list-item ${classAutomatica}" data-chave="${nota.chaveAcesso}" ${titleAutomatico}>
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">
                    <span class="status-icon me-1 d-none"><i class="bi bi-check-circle-fill text-success"></i></span>
                    NF ${nota.numeroNF}
                </h6>
                <small>${nota.dataEmissao}</small>
            </div>
            <p class="mb-1 small text-muted">${nota.nomeEmitente}</p>
        </a>
    `}).join('');
    
    container.html(`<div class="list-group list-group-flush">${listaHtml}</div>`);
}

function onNotaItemClick(event) {
    event.preventDefault();
    const target = $(event.currentTarget);
    if (target.hasClass('active')) return;

    const chaveAcesso = target.data('chave');

    $('#lista-de-notas .list-group-item.active').removeClass('active');
    target.addClass('active');

    $('#workspace-welcome').addClass('d-none');
    $('#workspace-rateio').addClass('d-none');
    toggleLoader(true, '#panel-direito'); 
    
    const notaInfo = todasAsNotas.find(n => n.chaveAcesso === chaveAcesso);

    google.script.run
        .withSuccessHandler(response => {
            toggleLoader(false, '#panel-direito');
            if (response && response.success) {
                dadosAtuaisNF = { ...response.dados, ...notaInfo };
                renderizarDetalhesRateio(dadosAtuaisNF);
                $('#workspace-rateio').removeClass('d-none');
            } else {
                onFailure(response || { message: 'A resposta do servidor foi vazia ou inválida.' });
            }
        })
        .withFailureHandler(onFailure)
        .RateioController_analisarNFParaRateio(chaveAcesso);
}


function renderizarDetalhesRateio(dados) {
    $('#nf-selecionada-titulo').text(`Detalhes do Rateio - NF ${dados.numeroNF} (${dados.nomeEmitente})`);
    
    if(dados.rateioCompleto) {
        $('#badge-rateio-automatico').removeClass('d-none');
        $('#secao-rateio-manual').addClass('d-none');
    } else {
        $('#badge-rateio-automatico').addClass('d-none');
        $('#secao-rateio-manual').removeClass('d-none');
    }

    const containerAuto = $('#itens-rateados-container').empty();
    if (dados.itensRateados.length > 0) {
        const autoHtml = dados.itensRateados.map(item => `
            <div class="card card-body mb-2 shadow-sm">
                <strong>${item.descricao}</strong>
                <small class="text-info-emphasis">${item.itemCotacao || 'Sem item de cotação associado'}</small>
                <small class="text-muted">Custo Total do Item: ${formatarMoeda(item.custoTotal)}</small>
                <ul class="list-unstyled mt-2 small mb-0">
                    ${item.rateios.map(r => `<li>${r.setor}: <span class="float-end fw-bold">${formatarMoeda(r.valor)}</span></li>`).join('')}
                </ul>
            </div>
        `).join('');
        containerAuto.html(autoHtml);
    } else {
        containerAuto.html('<p class="text-muted small">Nenhum item com regra de rateio automática.</p>');
    }

    const containerManual = $('#itens-manuais-container').empty();
     if (dados.itensSemRegra.length > 0) {
        const manualHtml = dados.itensSemRegra.map(item => `
            <div class="card card-body mb-2 shadow-sm manual-rate-item" data-item-numero="${item.numeroItem}" data-item-cotacao="${item.itemCotacao || ''}">
                <strong>${item.descricao}</strong>
                <small class="text-info-emphasis">${item.itemCotacao || 'Sem item de cotação associado (não será salva nova regra)'}</small>
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Custo a Ratear: ${formatarMoeda(item.custoTotal)}</small>
                    <small class="fw-bold text-danger-emphasis total-percent-item">Total: 0%</small>
                </div>
                <div class="rateio-manual-linhas mt-2"></div>
                <button class="btn btn-outline-primary btn-sm mt-2 btn-add-setor" type="button"><i class="bi bi-plus-circle"></i> Adicionar Setor</button>
            </div>
        `).join('');
        containerManual.html(manualHtml);
    } else {
        containerManual.html('');
    }

    $('#faturas-container').empty(); 
    recalcularRateioTotal();
}

function onAdicionarSetorManualClick(event) {
    const linhasContainer = $(event.target).closest('.manual-rate-item').find('.rateio-manual-linhas');
    const novaLinha = `<div class="row gx-2 mb-1 align-items-center manual-rate-row"><div class="col-6"><input type="text" class="form-control form-control-sm input-setor" placeholder="Nome do Setor"></div><div class="col-4"><div class="input-group input-group-sm"><input type="number" class="form-control input-porcentagem" placeholder="%" min="0" max="100" step="0.01"><span class="input-group-text">%</span></div></div><div class="col-2 text-end"><button class="btn btn-sm btn-outline-danger btn-remove-setor py-0 px-1" type="button"><i class="bi bi-trash"></i></button></div></div>`;
    linhasContainer.append(novaLinha);
}

function onRemoverSetorManualClick(event) {
    $(event.target).closest('.manual-rate-row').remove();
    recalcularRateioTotal();
}

function onPorcentagemChange(event) {
    const itemCard = $(event.target).closest('.manual-rate-item');
    let totalPercent = 0;
    itemCard.find('.input-porcentagem').each(function() {
        totalPercent += parseFloat($(this).val()) || 0;
    });
    const totalEl = itemCard.find('.total-percent-item');
    totalEl.text(`Total: ${totalPercent.toFixed(2)}%`);
    totalEl.removeClass('text-danger-emphasis text-success-emphasis');
    if (Math.abs(totalPercent - 100) > 0.01) {
        totalEl.addClass('text-danger-emphasis');
    } else {
        totalEl.addClass('text-success-emphasis');
    }
    recalcularRateioTotal();
}

function recalcularRateioTotal() {
    if (!dadosAtuaisNF) return;
    
    const mapaSetorParaItens = {};
    const adicionarItemAoMapa = (setor, itemCotacao) => {
        if (!itemCotacao) return;
        if (!mapaSetorParaItens[setor]) mapaSetorParaItens[setor] = new Set();
        mapaSetorParaItens[setor].add(itemCotacao);
    };

    const totais = {};
    dadosAtuaisNF.itensRateados.forEach(item => {
        item.rateios.forEach(rateio => {
            totais[rateio.setor] = (totais[rateio.setor] || 0) + rateio.valor;
            adicionarItemAoMapa(rateio.setor, item.itemCotacao);
        });
    });

    $('.manual-rate-item').each(function() {
        const itemCard = $(this);
        const numeroItem = itemCard.data('item-numero');
        const itemData = dadosAtuaisNF.itensSemRegra.find(i => i.numeroItem == numeroItem);
        
        itemCard.find('.manual-rate-row').each(function() {
            const linha = $(this);
            const setor = linha.find('.input-setor').val().trim();
            const porcentagem = parseFloat(linha.find('.input-porcentagem').val()) || 0;
            
            if (setor && porcentagem > 0) {
                const valorRateado = itemData.custoTotal * (porcentagem / 100);
                totais[setor] = (totais[setor] || 0) + valorRateado;
                adicionarItemAoMapa(setor, itemData.itemCotacao);
            }
        });
    });

    const resumoContainer = $('#resumo-setor-container').empty();
    let totalCalculado = 0;
    Object.keys(totais).sort().forEach(setor => {
        totalCalculado += totais[setor];
    });

    const resumoHtml = Object.keys(totais).sort().map(setor => {
        const valor = totais[setor];
        return `<li class="list-group-item">${setor} <span class="float-end">${formatarMoeda(valor)}</span></li>`;
    }).join('');
    resumoContainer.html(`<ul class="list-group">${resumoHtml}</ul>`);

    $('#total-rateado').text(formatarMoeda(totalCalculado));
    $('#total-nf').text(formatarMoeda(dadosAtuaisNF.valorTotalNF));

    const faturasContainer = $('#faturas-container').empty();
    const numFaturasOriginais = dadosAtuaisNF.faturas.length > 0 ? dadosAtuaisNF.faturas.length : 1;
    const numSetores = Object.keys(totais).length;
    const totalNovosTitulos = numFaturasOriginais * numSetores;

    if (totalNovosTitulos > 0) {
      faturasContainer.append(`<h6>Serão criados ${totalNovosTitulos} novos títulos:</h6>`);
    }

    if(dadosAtuaisNF.faturas.length > 0 && totalCalculado > 0) {
        const porcentagensPorSetor = {};
        for(const setor in totais) {
            porcentagensPorSetor[setor] = totais[setor] / totalCalculado;
        }
        
        let novoNumeroParcela = 1;
        const faturasHtml = dadosAtuaisNF.faturas.map(f => {
            return Object.keys(porcentagensPorSetor).sort().map(setor => {
                const resumoItens = mapaSetorParaItens[setor] ? Array.from(mapaSetorParaItens[setor]).join(', ') : 'Rateio Manual';
                const numeroParcelaFormatado = `${novoNumeroParcela++}/${totalNovosTitulos}(${numFaturasOriginais})`;
                return `<li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <span>${setor} - Parcela ${numeroParcelaFormatado}</span>
                                <strong>${formatarMoeda(f.valorParcela * porcentagensPorSetor[setor])}</strong>
                            </div>
                            <div class="text-muted small ps-3">
                                Ref. Parcela ${f.numeroParcela} (${formatarMoeda(f.valorParcela)}) | Venc: ${new Date(f.dataVencimento).toLocaleDateString('pt-BR')}
                            </div>
                             <div class="text-muted small ps-3">Itens: ${resumoItens}</div>
                        </li>`;
            }).join('');
        }).join('');
        faturasContainer.append(`<ul class="list-group list-group-flush">${faturasHtml}</ul>`);
    } else {
       faturasContainer.append('<p class="text-muted small">Pagamento à vista ou dados de fatura não encontrados.</p>');
    }
}

function onBtnPrepararRateioClick() {
    if (!dadosAtuaisNF) return;
    let erroValidacao = false;
    $('.manual-rate-item').each(function() {
        let totalPercent = 0;
        $(this).find('.input-porcentagem').each(function() { totalPercent += parseFloat($(this).val()) || 0; });
        if (Math.abs(totalPercent - 100) > 0.01) {
            const descItem = $(this).find('strong').text();
            alert(`Erro de validação: A soma das porcentagens para o item "${descItem}" não é 100%.`);
            erroValidacao = true;
            return false;
        }
    });
    if (erroValidacao) return;

    const totaisFinais = {};
    const novasRegras = [];
    const mapaSetorParaItens = {};
    const adicionarItemAoMapa = (setor, itemCotacao) => { if (!itemCotacao) return; if (!mapaSetorParaItens[setor]) mapaSetorParaItens[setor] = new Set(); mapaSetorParaItens[setor].add(itemCotacao); };
    dadosAtuaisNF.itensRateados.forEach(item => item.rateios.forEach(r => { totaisFinais[r.setor] = (totaisFinais[r.setor] || 0) + r.valor; adicionarItemAoMapa(r.setor, item.itemCotacao); }));
    $('.manual-rate-item').each(function() {
        const itemCard = $(this); const itemCotacao = itemCard.data('item-cotacao'); const numeroItem = itemCard.data('item-numero');
        const itemData = dadosAtuaisNF.itensSemRegra.find(i => i.numeroItem == numeroItem);
        itemCard.find('.manual-rate-row').each(function() {
            const setor = $(this).find('.input-setor').val().trim();
            const porcentagem = parseFloat($(this).find('.input-porcentagem').val()) || 0;
            if (setor && porcentagem > 0) {
                if (itemCotacao) { novasRegras.push({ itemCotacao: itemCotacao, setor: setor, porcentagem: porcentagem }); }
                const valorRateado = itemData.custoTotal * (porcentagem / 100);
                totaisFinais[setor] = (totaisFinais[setor] || 0) + valorRateado;
                adicionarItemAoMapa(setor, itemData.itemCotacao);
            }
        });
    });
    for(const setor in mapaSetorParaItens){ mapaSetorParaItens[setor] = Array.from(mapaSetorParaItens[setor]); }
    const payload = {
        chaveAcesso: dadosAtuaisNF.chaveAcesso, faturas: dadosAtuaisNF.faturas, totaisPorSetor: totaisFinais, 
        novasRegras: novasRegras, mapaSetorParaItens: mapaSetorParaItens,
        numeroNF: dadosAtuaisNF.numeroNF, nomeEmitente: dadosAtuaisNF.nomeEmitente
    };
    rateiosEmLote.push(payload);
    marcarNotaComoPronta(payload.chaveAcesso);
    $('#workspace-rateio').addClass('d-none');
    $('#workspace-welcome').removeClass('d-none');
    atualizarBotaoSalvarLote();
}

function onBtnSalvarLoteClick() {
    if (rateiosEmLote.length === 0) { alert("Nenhum rateio preparado para salvar."); return; }
    toggleLoader(true);
    google.script.run
        .withSuccessHandler(response => {
            toggleLoader(false);
            if (response && response.success) {
                alert(response.message);
                resetarAplicacao();
            } else {
                onFailure(response || { message: 'A resposta do servidor ao salvar o lote foi vazia ou inválida.' });
            }
        })
        .withFailureHandler(onFailure)
        .RateioController_salvarRateioEmLote(rateiosEmLote);
}


function toggleLoader(show, containerSelector = 'body') {
    const loader = $('#loader');
    if (show) { if (containerSelector !== 'body') { $(containerSelector).css('opacity', '0.5'); } else { loader.removeClass('d-none'); } } else { if (containerSelector !== 'body') { $(containerSelector).css('opacity', '1'); } else { loader.addClass('d-none'); } }
}

function formatarMoeda(valor) {
    if (typeof valor !== 'number' || isNaN(valor)) return "R$ 0,00";
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}
</script>