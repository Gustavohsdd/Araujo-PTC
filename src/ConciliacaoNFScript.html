<script>
// Variáveis globais
let todasAsCotacoes = [];
let todasAsNFs = [];
let todosOsItensNF = [];
let todosOsItensCotacao = [];
let todosOsDadosGeraisNF = [];
let mapaConciliacao = [];
let regrasRateio = [];
let setoresUnicos = [];
let stagedPayloads = [];
let ajusteModalInstance = null;
let activeItemForAdjustment = null; 
let selectedCotacaoItem = null;
let modalFornecedorNFInstance = null;
let modalCadastroItensNFInstance = null;
let modalCadastroProdutoViaNFInstance = null;
let selectQueAbriuModalProduto = null; 

// ===== FUNÇÕES DE INICIALIZAÇÃO E SETUP =====
// SUBSTITUA A FUNÇÃO 'DOMContentLoaded' INTEIRA POR ESTA VERSÃO CORRIGIDA

document.addEventListener('DOMContentLoaded', function() {
    // Inicializa todos os modais da página
    ajusteModalInstance = new bootstrap.Modal(document.getElementById('ajusteManualModal'));
    modalFornecedorNFInstance = new bootstrap.Modal(document.getElementById('modalCadastroFornecedorNF'));
    modalCadastroItensNFInstance = new bootstrap.Modal(document.getElementById('modalCadastroItensNF'));
    modalCadastroProdutoViaNFInstance = new bootstrap.Modal(document.getElementById('modalCadastroProdutoViaNF'));

    // Mostra o loader e busca os dados iniciais
    toggleLoader(true);
    google.script.run
        .withSuccessHandler(onDadosIniciaisSuccess)
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_obterDadosParaPagina();
        
    // Anexa todos os event listeners da página
    addEventListeners();
});

function addEventListeners() {
    // Header
    $('#btn-upload-xml').on('click', () => $('#xml-upload-input').click());
    $('#xml-upload-input').on('change', onFileUpload);
    $('#btn-salvar-lote').on('click', onBtnSalvarLoteClick);
    $('#btn-abrir-relatorio-rateio').on('click', onAbrirRelatorioRateioClick); 
    // Painel Esquerdo
    $('#search-input').on('input', onSearchInputChange);

    $('#accordion-fornecedores').on('click', '.nf-list-item:not(.staged)', onNfListItemClick);

    // Painel Direito (Delegated events)
    const panelDireito = $('#panel-direito');
    panelDireito.on('change', '.select-cotacao-fornecedor', onSelectCotacaoChange);
    panelDireito.on('click', '#cotacao-items-list .list-group-item:not(.matched)', onCotacaoItemClick);
    panelDireito.on('click', '#nf-items-list .list-group-item:not(.matched)', onNfItemClick);
    panelDireito.on('click', '#btn-concluir-conciliacao', onBtnConcluirConciliacaoClick);
    panelDireito.on('click', '#btn-abrir-modal-fornecedor', onAbrirModalFornecedorClick);
    $('#form-cadastro-fornecedor-nf').on('submit', onSalvarFornecedorViaNFSubmit);
    panelDireito.on('click', '#btn-abrir-cadastro-itens', onAbrirCadastroItensClick);
    $('#modalCadastroItensNF').on('change', '.select-produto-vinculado', onProdutoVinculadoChange);
    $('#form-cadastro-produto-nf').on('submit', onSalvarProdutoViaNFSubmit);
    $('#btn-salvar-subprodutos-nf').on('click', onSalvarSubProdutosViaNFSubmit);

    // Listeners do modal de fornecedor via NF
    $('#cadastro-fornecedor-cnpj').on('input', function(e) { e.target.value = ConciliacaoNFScript_mascaraCnpj(e.target.value); });
    $('#cadastro-fornecedor-telefone').on('input', function(e) { e.target.value = ConciliacaoNFScript_mascaraTelefone(e.target.value); });
    const pedidoMinimoInput = $('#cadastro-fornecedor-pedido-minimo');
    pedidoMinimoInput.on('input', function(e) { ConciliacaoNFScript_formatarMoedaInput(e.target); });
    pedidoMinimoInput.on('blur', function(e) { ConciliacaoNFScript_formatarMoedaInput(e.target); });


    // Adiciona listeners para os novos botões de ação
    panelDireito.on('click', '#btn-marcar-bonificacao', onMarcarBonificacaoClick);
    panelDireito.on('click', '#btn-marcar-sem-pedido', onMarcarSemPedidoClick);
    panelDireito.on('click', '#btn-marcar-tipo-b', onMarcarTipoBClick);

    // Rateio
    panelDireito.on('click', '.btn-add-setor', onAdicionarSetorManualClick);
    panelDireito.on('click', '.btn-remove-setor', onRemoverSetorManualClick);
    panelDireito.on('input', '.input-porcentagem, .input-setor', onPorcentagemOuSetorChange);

    // Ajuste Manual
    panelDireito.on('click', '.btn-reajustar-item', onBtnReajustarItemClick);
    $('#btn-salvar-ajuste-manual').on('click', onBtnSalvarAjusteManualClick);
    $('#ajuste-fator').on('input', calcularVisualizacaoAjuste);
}

function resetApplication() {
    toggleLoader(true);
    stagedPayloads = [];
    atualizarBotaoSalvarLote();
    $('#workspace-content').addClass('d-none').empty();
    $('#workspace-welcome').removeClass('d-none');
    google.script.run
        .withSuccessHandler(onDadosIniciaisSuccess)
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_obterDadosParaPagina();
}

/**
 * [NOVO] Adiciona um payload para marcar a NF como 'NF Tipo B'.
 * Este é um estado final sem rateio.
 */
function onMarcarTipoBClick() {
    const nfInfo = $('#workspace-content').data('active-nf');
    if (!nfInfo || !confirm(`Tem certeza que deseja marcar a NF ${nfInfo.numeroNF} como 'NF Tipo B'? Esta ação não poderá ser desfeita após salvar.`)) {
        return;
    }
    
    stagedPayloads.push({
        statusUpdates: [{ chaveAcesso: nfInfo.chaveAcesso, novoStatus: 'NF Tipo B' }]
    });

    $(`.nf-list-item`).filter((i, el) => $(el).data('nf-info').chaveAcesso === nfInfo.chaveAcesso)
        .addClass('staged').removeClass('active').find('.status-icon').removeClass('d-none')
        .find('.staged-status-badge').text('Tipo B').removeClass('d-none'); // Atualiza o badge
        
    $('#workspace-content').addClass('d-none').empty();
    $('#workspace-welcome').removeClass('d-none');
    atualizarBotaoSalvarLote();
}

// ===== CALLBACKS DO SERVIDOR E PROCESSAMENTO DE DADOS =====
function onDadosIniciaisSuccess(response) {
    toggleLoader(false);
    if (!response.success) {
        alert('Erro ao carregar dados: ' + response.message);
        return;
    }
    todasAsNFs = response.dados.notasFiscais;
    todosOsItensNF = response.dados.itensNF;
    todosOsDadosGeraisNF = response.dados.dadosGeraisNF;
    todasAsCotacoes = response.dados.cotacoes;
    todosOsItensCotacao = response.dados.itensCotacao;
    mapaConciliacao = response.dados.mapeamentoConciliacao || [];
    regrasRateio = response.dados.regrasRateio || [];
    setoresUnicos = response.dados.setoresUnicos || []; // ADICIONADO

    // Cria a datalist de setores dinamicamente no body
    if ($('#datalist-setores').length === 0) {
        const datalist = $('<datalist id="datalist-setores"></datalist>');
        setoresUnicos.forEach(setor => {
            datalist.append(`<option value="${setor}">`);
        });
        $('body').append(datalist);
    }
    
    renderizarListaDeTrabalho();
}
function onFailure(error) {
    console.error('Erro na chamada ao servidor:', error);
    alert('Ocorreu um erro no servidor: ' + (error.message || 'Erro desconhecido.'));
    toggleLoader(false);
}

// ===== UPLOAD E PROCESSAMENTO DE XMLs =====
function onFileUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    toggleLoader(true);
    const filePromises = Array.from(files).map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve({ fileName: file.name, content: e.target.result.split(',')[1] });
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
    }));
    Promise.all(filePromises)
        .then(fileObjects => {
            google.script.run
                .withSuccessHandler(onUploadSuccess)
                .withFailureHandler(onFailure)
                .ConciliacaoNFController_uploadArquivos(fileObjects);
        })
        .catch(err => onFailure({ message: 'Erro ao ler arquivos: ' + err.message }));
    $(event.target).val('');
}
function onUploadSuccess(response) {
    alert(response.message);
    if (response.success) {
        resetApplication();
    } else {
        toggleLoader(false);
    }
}

// ===== PAINEL ESQUERDO (LISTA DE NFS) =====
function renderizarListaDeTrabalho() {
    const container = $('#accordion-fornecedores').empty();
    if (todasAsNFs.length === 0) {
        container.html('<p class="p-3 text-muted text-center">Nenhuma nota fiscal pendente.</p>');
        return;
    }

    // 1. Agrupar NFs por fornecedor
    const nfsPorFornecedor = todasAsNFs.reduce((acc, nf) => {
        const fornecedor = nf.nomeEmitente || 'Fornecedor Desconhecido';
        if (!acc[fornecedor]) {
            acc[fornecedor] = [];
        }
        acc[fornecedor].push(nf);
        return acc;
    }, {});

    // 2. Ordenar fornecedores alfabeticamente
    const fornecedoresOrdenados = Object.keys(nfsPorFornecedor).sort();

    // 3. Renderizar o accordion
    for (const fornecedor of fornecedoresOrdenados) {
        const nfsDoFornecedor = nfsPorFornecedor[fornecedor];
        const idAccordion = 'fornecedor-' + fornecedor.replace(/[^a-zA-Z0-9]/g, '');

        const accordionItem = $(`
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-${idAccordion}">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${idAccordion}" aria-expanded="true" aria-controls="collapse-${idAccordion}">
                        ${fornecedor}
                        <span class="badge bg-primary rounded-pill ms-2">${nfsDoFornecedor.length}</span>
                    </button>
                </h2>
                <div id="collapse-${idAccordion}" class="accordion-collapse collapse show" aria-labelledby="heading-${idAccordion}">
                    <div class="accordion-body p-0 list-group list-group-flush">
                        </div>
                </div>
            </div>
        `);

        const bodyAccordion = accordionItem.find('.accordion-body');
        nfsDoFornecedor.sort((a,b) => a.numeroNF - b.numeroNF);

        nfsDoFornecedor.forEach(nf => {
            const template = $('#template-nf-list-item').prop('content').cloneNode(true);
            const nfItem = $(template.querySelector('.nf-list-item'));
            nfItem.data('nf-info', nf);
            nfItem.find('.nf-title').text(`NF ${nf.numeroNF}`);
            nfItem.find('.nf-fornecedor').text(nf.nomeEmitente); // Mantido para dados internos
            nfItem.find('.nf-data').text(nf.dataEmissao);
            const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nf.chaveAcesso);
            nfItem.find('.nf-total').text(totaisNF ? formatarMoeda(totaisNF.valorTotalNf) : 'N/A');

            // Remove a classe de borda para um visual mais limpo dentro do accordion
            nfItem.removeClass('border-bottom');
            bodyAccordion.append(nfItem);
        });

        container.append(accordionItem);
    }
}
function onSearchInputChange() {
    const searchTerm = $(this).val().toLowerCase().trim();

    $('.accordion-item').each(function() {
        const accordionItem = $(this);
        let fornecedorVisivel = false;

        accordionItem.find('.nf-list-item').each(function() {
            const item = $(this);
            const nfInfo = item.data('nf-info');
            const fornecedorNome = nfInfo.nomeEmitente.toLowerCase();
            const nfNumero = String(nfInfo.numeroNF);

            const itemVisivel = fornecedorNome.includes(searchTerm) || nfNumero.includes(searchTerm);
            item.toggle(itemVisivel);

            if (itemVisivel) {
                fornecedorVisivel = true;
            }
        });

        accordionItem.toggle(fornecedorVisivel);

        // Garante que o accordion esteja aberto se a busca encontrar algo dentro dele
        if (fornecedorVisivel && searchTerm) {
            accordionItem.find('.accordion-collapse').addClass('show');
        }
    });
}

// ===== PAINEL DIREITO (WORKSPACE) =====
function onNfListItemClick() {
    const nfItem = $(this);
    if (nfItem.hasClass('staged')) return; 
    $('.nf-list-item.active').removeClass('active');
    nfItem.addClass('active');
    const nfInfo = nfItem.data('nf-info');
    const workspaceContent = $('#workspace-content');
    workspaceContent.data('active-nf', nfInfo);
    $('#workspace-welcome').addClass('d-none');
    const template = $('#template-workspace').prop('content').cloneNode(true);
    workspaceContent.empty().append(template).removeClass('d-none');
    
    // HABILITE O BOTÃO AQUI
    $('#btn-abrir-modal-fornecedor').prop('disabled', false);
    $('#btn-abrir-modal-fornecedor').prop('disabled', false);
    $('#btn-abrir-cadastro-itens').prop('disabled', false); //

    const selectCotacao = workspaceContent.find('.select-cotacao-fornecedor');
    const cnpjFornecedor = (nfInfo.cnpjEmitente || '').replace(/[^\d]/g, '');
    const cotacoesDoFornecedor = todasAsCotacoes.filter(c => (c.fornecedorCnpj || '').replace(/[^\d]/g, '') === cnpjFornecedor);
    if (cotacoesDoFornecedor.length > 0) {
        cotacoesDoFornecedor.forEach(c => selectCotacao.append(new Option(`ID ${c.idCotacao} - ${c.fornecedor} (${c.dataAbertura})`, c.compositeKey)));
        selectCotacao.prop('disabled', false);
    } else {
        selectCotacao.append(new Option('Nenhuma cotação aberta para este CNPJ', '', true, true));
    }
    selectCotacao.select2({ theme: "bootstrap-5", dropdownParent: workspaceContent, width: '100%' });
    recalcularErenderizarResumoRateio();
}
function onSelectCotacaoChange() {
    const compositeKey = $(this).val();
    if (!compositeKey) return;
    const parts = compositeKey.split('-');
    const idCotacao = parts.shift();
    const nomeFornecedor = parts.join('-');
    const nfInfo = $('#workspace-content').data('active-nf');
    const itensNFNesteGrupo = todosOsItensNF.filter(item => item.chaveAcesso === nfInfo.chaveAcesso);
    const itensCotacaoSelecionada = todosOsItensCotacao.filter(item => item.idCotacao == idCotacao && item.fornecedor == nomeFornecedor);
    construirListasDeComparacao(itensCotacaoSelecionada, itensNFNesteGrupo);
    $('.comparison-container, #rateio-summary-section').removeClass('d-none');
    $('#btn-concluir-conciliacao').prop('disabled', false);
    tentarConciliacaoAutomatica();
    recalcularErenderizarResumoRateio();
}
function construirListasDeComparacao(itensCotacao, itensNF) {
    const cotacaoList = $('#cotacao-items-list .list-group').empty();
    const nfList = $('#nf-items-list .list-group').empty();
    itensCotacao.forEach(item => {
        const itemHtml = `<a href="#" class="list-group-item list-group-item-action"><div class="item-description">${item.subProduto}</div><small>Qtd: <strong>${item.qtdComprar.toFixed(2)}</strong> | Preço: <strong>${formatarMoeda(item.preco)}</strong></small></a>`;
        cotacaoList.append($(itemHtml).data('item-info', item));
    });
    itensNF.forEach(item => {
        const template = $('#template-nf-item').prop('content').cloneNode(true);
        const itemEl = $(template.children[0]);
        itemEl.find('.item-description').text(item.descricaoNF);
        itemEl.find('.original-qtd').text(item.qtdNF.toFixed(2));
        itemEl.find('.original-preco').text(formatarMoeda(item.precoNF));
        itemEl.data('item-info', item);
        nfList.append(itemEl);
    });
}

// ===== LÓGICA DE CONCILIAÇÃO, AJUSTE E RATEIO =====
function onCotacaoItemClick(e) {
    e.preventDefault();
    const itemEl = $(this);
    if (selectedCotacaoItem && selectedCotacaoItem[0] === itemEl[0]) {
        itemEl.removeClass('selected-for-match');
        selectedCotacaoItem = null;
    } else {
        $('#cotacao-items-list .list-group-item').removeClass('selected-for-match');
        itemEl.addClass('selected-for-match');
        selectedCotacaoItem = itemEl;
    }
}

/**
 * [ALTERADO] Ponto de entrada quando um item da NF é clicado manualmente.
 */
function onNfItemClick(e) {
    e.preventDefault();
    // Impede a ação se o clique foi no botão de ajuste manual
    if ($(e.target).closest('.btn-ajuste-manual').length > 0) return;

    // Verifica se o usuário já selecionou um item da cotação
    if (!selectedCotacaoItem) {
        alert("Selecione primeiro um item da Cotação para ligar.");
        return;
    }

    // Chama a nova função de vinculação, passando o item de cotação selecionado
    // globalmente e o item da NF que foi clicado.
    _ConciliacaoNFScript_vincularItemNF(selectedCotacaoItem, $(this));

    // Propositalmente NÃO limpamos 'selectedCotacaoItem' aqui.
    // Isso permite que o usuário clique em múltiplos itens da NF para vincular
    // ao mesmo item de cotação que permanece selecionado.
}

/**
 * [NOVO] Calcula os valores agregados (soma de qtd, média ponderada de preço)
 * para um card de conciliação que pode conter múltiplos itens da NF.
 * @param {jQuery} card - O card de conciliação a ser atualizado.
 */
function _ConciliacaoNFScript_atualizarAgregadosDoCard(card) {
    const info = card.data('conciliacao-info');
    if (!info || !info.itensNF_Original || info.itensNF_Original.length === 0) return;

    let totalQtdAgregada = 0;
    let totalValorAgregado = 0;

    info.itensNF_Original.forEach(itemNF => {
        // Considera o ajuste de fator (caixa/fardo) se existir para o item
        const itemOriginalEl = $(`#nf-items-list .list-group-item`).filter((i, el) => $(el).data('item-info').numeroItem === itemNF.numeroItem);
        const ajuste = itemOriginalEl.data('ajuste-manual') || { fator: 1 };

        const qtdAjustada = itemNF.qtdNF * ajuste.fator;
        const precoAjustado = itemNF.precoNF / ajuste.fator;

        totalQtdAgregada += qtdAjustada;
        totalValorAgregado += qtdAjustada * precoAjustado;
    });

    const precoMedioPonderado = totalQtdAgregada > 0 ? totalValorAgregado / totalQtdAgregada : 0;

    // Atualiza a propriedade 'itemNF_Agregada' no data do card
    info.itemNF_Agregada = {
        qtdNF: totalQtdAgregada,
        precoNF: precoMedioPonderado
    };

    // Atualiza a exibição visual do card com os novos dados agregados
    _atualizarVisualMatchedCard(card);
}

/**
 * [NOVO] Função central e segura para vincular um item de cotação a um item de NF.
 * Previne a interferência entre a seleção manual e a automática e contém a lógica
 * para criar ou atualizar os cards de conciliação.
 * @param {jQuery} cotacaoItemEl - O elemento jQuery do item da cotação.
 * @param {jQuery} nfItemEl - O elemento jQuery do item da nota fiscal.
 */
function _ConciliacaoNFScript_vincularItemNF(cotacaoItemEl, nfItemEl) {
    // Guardas de segurança para garantir que ambos os itens são válidos
    if (!cotacaoItemEl || !nfItemEl || nfItemEl.hasClass('matched')) return;

    const itemCotInfo = cotacaoItemEl.data('item-info');
    const itemNfInfo = nfItemEl.data('item-info');

    // Procura se já existe um card de conciliação para este item da cotação
    let matchedCard = null;
    $('.matched-item-card').each(function() {
        const card = $(this);
        if (card.data('conciliacao-info').itemCot.subProduto === itemCotInfo.subProduto) {
            matchedCard = card;
            return false; // Sai do loop .each
        }
    });

    if (matchedCard) {
        // Se o card já existe, apenas adiciona o novo item da NF ao array
        const conciliacaoInfo = matchedCard.data('conciliacao-info');

        // [CORREÇÃO] Previne que o mesmo item da NF seja adicionado duas vezes ao mesmo card
        const isAlreadyAdded = conciliacaoInfo.itensNF_Original.some(item => item.numeroItem === itemNfInfo.numeroItem);
        if (isAlreadyAdded) {
            console.warn(`Item da NF ${itemNfInfo.numeroItem} já está no card. Ignorando.`);
            return;
        }

        conciliacaoInfo.itensNF_Original.push(itemNfInfo);
    } else {
        // Se não existe, cria um novo card do zero
        const template = $('#template-matched-item').prop('content').cloneNode(true);
        matchedCard = $(template.querySelector('.matched-item-card'));

        const novaConciliacaoInfo = {
            itemCot: itemCotInfo,
            itensNF_Original: [itemNfInfo], // Inicia como um array
            itemNF_Agregada: {} // Objeto para os valores consolidados
        };
        matchedCard.data('conciliacao-info', novaConciliacaoInfo);

        $('#matched-items-container').append(matchedCard);
        _popularRateioDoCard(matchedCard); // Popula o rateio apenas na criação do card
    }

    // Marca o item da NF como 'matched' para dar feedback visual e prevenir novos cliques
    nfItemEl.addClass('matched');

    // Atualiza os cálculos agregados e o visual do card
    _ConciliacaoNFScript_atualizarAgregadosDoCard(matchedCard);
    recalcularErenderizarResumoRateio();
}

/**
 * [ALTERADO] Tenta conciliar itens automaticamente com base no mapa de conciliação.
 * A função foi corrigida para não usar ou modificar a variável global 'selectedCotacaoItem',
 * evitando conflito com a seleção manual do usuário.
 */
function tentarConciliacaoAutomatica() {
    $('#cotacao-items-list .list-group-item:not(.matched)').each(function() {
        const cotItemEl = $(this); // O item da cotação a ser verificado
        const cotItem = cotItemEl.data('item-info');
        const mapeamentos = mapaConciliacao.filter(m => m.itemCotacao === cotItem.subProduto);

        if (mapeamentos.length > 0) {
            mapeamentos.forEach(mapeamento => {
                $('#nf-items-list .list-group-item:not(.matched)').each(function() {
                    const nfItemEl = $(this);
                    if (nfItemEl.data('item-info').descricaoNF === mapeamento.descricaoNF) {
                        // Passa explicitamente os dois itens para a função de vinculação,
                        // sem depender da variável global.
                        _ConciliacaoNFScript_vincularItemNF(cotItemEl, nfItemEl);
                    }
                });
            });
        }
    });
}

/**
 * [ALTERADO] Atualiza a exibição de um card de conciliação.
 * Agora desabilita o botão de ajuste se múltiplos itens da NF estiverem vinculados.
 * @param {jQuery} card - O card a ser atualizado.
 */
function _atualizarVisualMatchedCard(card) {
    const info = card.data('conciliacao-info');
    if (!info || !info.itemNF_Agregada) return;

    const descricoesNF = info.itensNF_Original.map(item => `(Item ${item.numeroItem}) ${item.descricaoNF}`).join('<br>');
    card.find('.item-cot-descricao').text(info.itemCot.subProduto);
    card.find('.item-nf-descricao').html(descricoesNF);

    const diffPreco = info.itemNF_Agregada.precoNF - info.itemCot.preco;
    const diffQtd = info.itemNF_Agregada.qtdNF - info.itemCot.qtdComprar;

    card.find('.divergencia-preco').html(Math.abs(diffPreco) < 0.01 ? `<span class="badge text-bg-success">OK</span>` : `<span class="badge text-bg-danger">${formatarMoeda(diffPreco)}</span>`);
    card.find('.divergencia-qtd').html(Math.abs(diffQtd) < 0.001 ? `<span class="badge text-bg-success">OK</span>` : `<span class="badge text-bg-warning">${diffQtd > 0 ? '+' : ''}${diffQtd.toFixed(2)}</span>`);

    const fatorInfoEl = card.find('.fator-info');
    const ajusteButton = card.find('.btn-reajustar-item');

    // [CORREÇÃO] A lógica de ajuste agora verifica se há múltiplos itens
    if (info.itensNF_Original.length > 1) {
        ajusteButton.prop('disabled', true).attr('title', 'Ajuste não disponível para múltiplos itens da NF vinculados.');
        fatorInfoEl.empty();
    } else {
        ajusteButton.prop('disabled', false).attr('title', 'Corrigir Fator de Conversão');
        const itemOriginalEl = $(`#nf-items-list .list-group-item`).filter((i, el) => $(el).data('item-info').numeroItem === info.itensNF_Original[0].numeroItem);
        const ajuste = itemOriginalEl.data('ajuste-manual');
        if (ajuste) {
            fatorInfoEl.html(`<i class="bi bi-box-seam"></i> Fator ${ajuste.fator} aplicado.`);
        } else {
            fatorInfoEl.empty();
        }
    }
}

function _popularRateioDoCard(card) {
    const info = card.data('conciliacao-info');
    if (!info) return;
    const uniqueId = "rateio-item-" + new Date().getTime() + Math.random();
    card.find('.collapse').attr('id', uniqueId);
    card.find('[data-bs-target^="#rateio-item-"]').attr('data-bs-target', '#' + uniqueId);
    const regrasDoItem = regrasRateio.filter(r => r.itemCotacao === info.itemCot.subProduto);
    const autoInfoContainer = card.find('.rateio-automatico-info');
    if (regrasDoItem.length > 0) {
        card.find('.btn-add-setor').hide();
        let infoText = '<strong>Rateio Automático:</strong> ';
        regrasDoItem.forEach(regra => { infoText += `${regra.porcentagem}% ${regra.setor}; `; });
        autoInfoContainer.html(infoText);
        card.data('rateio-info', { isAutomatico: true, regras: regrasDoItem });
    } else {
        card.data('rateio-info', { isAutomatico: false, regras: [] });
        onAdicionarSetorManualClick({ target: card.find('.btn-add-setor')[0] });
    }
    onPorcentagemOuSetorChange({ target: card.find('.rateio-section')[0] });
}

/**
 * [ALTERADO] Abre o modal de ajuste para um item conciliado.
 * Adaptado para a nova estrutura de dados (array de itens da NF).
 */
function onBtnReajustarItemClick(e) {
    e.preventDefault(); e.stopPropagation();
    activeItemForAdjustment = $(this).closest('.matched-item-card');
    const info = activeItemForAdjustment.data('conciliacao-info');

    // Como o botão só está habilitado para 1 item, podemos pegar o primeiro com segurança.
    const itemNF_Original = info.itensNF_Original[0];

    $('#ajuste-cot-descricao').text(info.itemCot.subProduto);
    $('#ajuste-cot-qtd').text(info.itemCot.qtdComprar.toFixed(2));
    $('#ajuste-cot-preco').text(formatarMoeda(info.itemCot.preco));

    $('#ajuste-nf-descricao').text(itemNF_Original.descricaoNF);
    $('#ajuste-nf-qtd').text(itemNF_Original.qtdNF.toFixed(2));
    $('#ajuste-nf-preco').text(formatarMoeda(itemNF_Original.precoNF));

    // Busca o fator de ajuste do item original na lista da NF
    const itemOriginalEl = $(`#nf-items-list .list-group-item`).filter((i, el) => $(el).data('item-info').numeroItem === itemNF_Original.numeroItem);
    const ajusteExistente = itemOriginalEl.data('ajuste-manual');

    $('#ajuste-fator').val(ajusteExistente ? ajusteExistente.fator : 1);

    calcularVisualizacaoAjuste();
    ajusteModalInstance.show();
}

/**
 * [ALTERADO] Calcula e exibe a pré-visualização do ajuste no modal.
 * A função foi corrigida para acessar o item da NF de dentro do array,
 * resolvendo o erro que impedia a abertura do modal.
 */
function calcularVisualizacaoAjuste() {
    // A função agora só precisa lidar com o 'activeItemForAdjustment' quando é um card.
    if (!activeItemForAdjustment || !activeItemForAdjustment.hasClass('matched-item-card')) return;

    // Obtém o array de itens da NF a partir dos dados do card.
    const itensNF_Original_Array = activeItemForAdjustment.data('conciliacao-info').itensNF_Original;

    // Como o botão de ajuste só é habilitado quando há um único item vinculado,
    // podemos pegar o primeiro elemento do array com segurança.
    const itemNF_Original = itensNF_Original_Array[0];

    // Se por algum motivo o item não for encontrado, interrompe a execução.
    if (!itemNF_Original) return;

    const fator = parseFloat($('#ajuste-fator').val()) || 1;
    if (fator <= 0) return;

    const novaQtd = itemNF_Original.qtdNF * fator;
    const novoPreco = itemNF_Original.precoNF / fator;
    
    $('#ajuste-nova-qtd').text(novaQtd.toFixed(4));
    $('#ajuste-novo-preco').text(formatarMoeda(novoPreco));
}

/**
 * [ALTERADO] Salva o fator de ajuste do modal.
 * A lógica agora atualiza a fonte da verdade (o item na lista da NF) e
 * força a re-sincronização do card agregado.
 */
function onBtnSalvarAjusteManualClick() {
    const fator = parseFloat($('#ajuste-fator').val());
    if (!fator || fator <= 0) {
        alert("Insira um fator válido (número maior que zero).");
        return;
    }

    if (activeItemForAdjustment && activeItemForAdjustment.hasClass('matched-item-card')) {
        const info = activeItemForAdjustment.data('conciliacao-info');
        const itemNF_Original_Info = info.itensNF_Original[0];

        // Encontra o elemento correspondente na lista de "Itens da NF"
        const itemOriginalEl = $(`#nf-items-list .list-group-item`).filter((i, el) => $(el).data('item-info').numeroItem === itemNF_Original_Info.numeroItem);

        if(itemOriginalEl.length > 0) {
             // Salva o fator de ajuste no próprio elemento da lista da NF
            const dadosAjustados = { fator: fator };
            itemOriginalEl.data('ajuste-manual', dadosAjustados);

            // Força a re-sincronização do card para recalcular os agregados
            _ConciliacaoNFScript_atualizarAgregadosDoCard(activeItemForAdjustment);
            recalcularErenderizarResumoRateio();
        }
    }

    ajusteModalInstance.hide();
}

function onAdicionarSetorManualClick(event) {
    const card = $(event.target).closest('.matched-item-card');
    if (card.data('rateio-info').isAutomatico) return;
    const linhasContainer = card.find('.rateio-manual-linhas');
    const template = $('#template-rateio-row').prop('content').cloneNode(true);
    linhasContainer.append(template);
}
function onRemoverSetorManualClick(event) {
    $(event.target).closest('.manual-rate-row').remove();
    onPorcentagemOuSetorChange(event);
}
function onPorcentagemOuSetorChange(event) {
    const card = $(event.target).closest('.matched-item-card');
    let totalPercent = 0;
    if (card.data('rateio-info').isAutomatico) {
        totalPercent = card.data('rateio-info').regras.reduce((sum, r) => sum + r.porcentagem, 0);
    } else {
        card.find('.input-porcentagem').each(function() {
            totalPercent += parseFloat($(this).val()) || 0;
        });
    }
    const totalEl = card.find('.total-percent-item');
    totalEl.text(`Total: ${totalPercent.toFixed(2)}%`).removeClass('is-invalid is-valid');
    if (Math.abs(totalPercent - 100) > 0.01) {
        totalEl.addClass('is-invalid');
    } else {
        totalEl.addClass('is-valid');
    }
    recalcularErenderizarResumoRateio();
}

function recalcularErenderizarResumoRateio() {
    const nfInfo = $('#workspace-content').data('active-nf');
    if (!nfInfo) return;
    const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nfInfo.chaveAcesso);
    if (!totaisNF) return;

    // --- INÍCIO DA MODIFICAÇÃO: Cálculo e Exibição dos Totais Detalhados ---

    // 1. Calcula o total de impostos somando os campos individuais
    const totalImpostos = (totaisNF.totalValorIcms || 0) +
                          (totaisNF.totalValorIcmsSt || 0) +
                          (totaisNF.totalValorIpi || 0) +
                          (totaisNF.totalValorPis || 0) +
                          (totaisNF.totalValorCofins || 0);

    // 2. Preenche os novos campos no painel de resumo financeiro
    $('.total-produtos-valor').text(formatarMoeda(totaisNF.totalValorProdutos || 0));
    $('.total-impostos-valor').text(formatarMoeda(totalImpostos));
    $('.total-outras-despesas-valor').text(formatarMoeda(totaisNF.totalOutrasDespesas || 0));
    $('.total-desconto-valor').text(formatarMoeda(totaisNF.totalValorDesconto || 0));
    $('.total-notas-valor').text(formatarMoeda(totaisNF.valorTotalNf));

    // --- FIM DA MODIFICAÇÃO ---

    // Cálculos Gerais (Lógica existente mantida)
    let totalConciliadoBruto = 0;
    const mapaSetorParaItens = {};
    $('.matched-item-card').each(function() {
        const info = $(this).data('conciliacao-info');
        if (info && info.itemNF_Agregada) {
          totalConciliadoBruto += info.itemNF_Agregada.qtdNF * info.itemNF_Agregada.precoNF;
        }
    });
    
    $('.total-conciliado-valor').text(formatarMoeda(totalConciliadoBruto));
    $('.diferenca-totais-valor').text(formatarMoeda(totaisNF.valorTotalNf - totalConciliadoBruto));

    // Cálculos de Rateio (Lógica existente mantida)
    const totaisPorSetor = {};
    const custosAdicionais = totaisNF.valorTotalNf - totalConciliadoBruto;
    $('.matched-item-card').each(function() {
        const card = $(this);
        const concInfo = card.data('conciliacao-info');
        const rateioInfo = card.data('rateio-info');

        if (!concInfo || !concInfo.itemNF_Agregada || !rateioInfo) return;

        const valorBrutoItem = concInfo.itemNF_Agregada.qtdNF * concInfo.itemNF_Agregada.precoNF;
        const proporcaoItem = totalConciliadoBruto > 0.01 ? valorBrutoItem / totalConciliadoBruto : 0;
        const custoEfetivoItem = valorBrutoItem + (custosAdicionais * proporcaoItem);
        const aplicarRateio = (setor, porcentagem) => {
            if (!setor || !porcentagem) return;
            setor = setor.trim();
            totaisPorSetor[setor] = (totaisPorSetor[setor] || 0) + (custoEfetivoItem * (porcentagem / 100));
            if (!mapaSetorParaItens[setor]) mapaSetorParaItens[setor] = new Set();
            mapaSetorParaItens[setor].add(concInfo.itemCot.subProduto);
        };
        if (rateioInfo.isAutomatico) {
            rateioInfo.regras.forEach(regra => aplicarRateio(regra.setor, regra.porcentagem));
        } else {
            card.find('.manual-rate-row').each(function() {
                aplicarRateio($(this).find('.input-setor').val(), parseFloat($(this).find('.input-porcentagem').val()) || 0);
            });
        }
    });

    // Renderiza Resumo do Rateio (Lógica existente mantida)
    const resumoContainer = $('#resumo-setor-container').empty();
    let totalCalculado = Object.values(totaisPorSetor).reduce((s, v) => s + v, 0);
    let resumoHtml = '<ul class="list-group list-group-flush">';
    Object.keys(totaisPorSetor).sort().forEach(setor => {
        resumoHtml += `<li class="list-group-item d-flex justify-content-between"><span>${setor}</span> <strong>${formatarMoeda(totaisPorSetor[setor])}</strong></li>`;
    });
    resumoHtml += '</ul>';
    resumoContainer.html(resumoHtml);
    $('#total-rateado').text(formatarMoeda(totalCalculado));

    // Renderiza a Pré-visualização do Contas a Pagar (Lógica existente mantida)
    const faturasContainer = $('#faturas-preview-container').empty();
    const faturas = totaisNF.faturas || [];
    const numFaturasOriginais = faturas.length > 0 ? faturas.length : 1;
    const numSetores = Object.keys(totaisPorSetor).length;
    const totalNovosTitulos = numFaturasOriginais * numSetores;

    if (totalNovosTitulos > 0 && totalCalculado > 0.001) {
        faturasContainer.append(`<h6>Serão criados ${totalNovosTitulos} novo(s) título(s):</h6>`);
        let faturasHtml = '<ul class="list-group list-group-flush small">';
        if (faturas.length > 0) {
            let novoNumeroParcela = 1;
            faturas.forEach(fatura => {
                Object.keys(totaisPorSetor).sort().forEach(setor => {
                    const valorRateadoParcela = (totaisPorSetor[setor] / totalCalculado) * fatura.valorParcela;
                    const numeroParcelaFormatado = `${novoNumeroParcela++}/${totalNovosTitulos} (Ref: ${fatura.numeroParcela})`;
                    const vencimento = new Date(fatura.dataVencimento).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    faturasHtml += `<li class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <span>${setor} - Parc. ${numeroParcelaFormatado}</span>
                            <strong>${formatarMoeda(valorRateadoParcela)}</strong>
                        </div>
                        <div class="text-muted">Venc: ${vencimento}</div>
                    </li>`;
                });
            });
        } else { // Pagamento à vista
            Object.keys(totaisPorSetor).sort().forEach(setor => {
                const valorRateado = totaisPorSetor[setor];
                faturasHtml += `<li class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <span>${setor}</span>
                        <strong>${formatarMoeda(valorRateado)}</strong>
                    </div>
                    <div class="text-muted">Pagamento à Vista</div>
                </li>`;
            });
        } 
        faturasHtml += '</ul>';
        faturasContainer.html(faturasHtml);
    } else {
        faturasContainer.html('<p class="text-muted small">Nenhuma pré-visualização disponível.</p>');
    }
}

/**
 * [ALTERADO] Coleta os dados da tela para preparar o payload para o salvamento em lote.
 * Contém a correção de um erro de digitação ('conciliaacao-info').
 */
function onBtnConcluirConciliacaoClick() {
    let erroValidacao = false;
    $('.matched-item-card').each(function() {
        if ($(this).find('.total-percent-item').hasClass('is-invalid')) {
            alert(`Erro: O rateio do item "${$(this).find('.item-cot-descricao').text()}" não soma 100%.`);
            erroValidacao = true; return false;
        }
    });
    if (erroValidacao) return;

    const workspace = $('#workspace-content');
    const nfInfo = workspace.data('active-nf');
    const compositeKey = workspace.find('.select-cotacao-fornecedor').val();
    const [idCotacao, ...nomeFornecedorParts] = compositeKey.split('-');
    const nomeFornecedor = nomeFornecedorParts.join('-');

    const conciliacaoPayload = { idCotacao, nomeFornecedor, numeroNF: nfInfo.numeroNF, chavesAcessoNF: [nfInfo.chaveAcesso], itensConciliados: [], novosMapeamentos: [] };
    const itensCortados = [];

    $('.matched-item-card').each(function() {
        const info = $(this).data('conciliacao-info');
        conciliacaoPayload.itensConciliados.push({
            subProduto: info.itemCot.subProduto, 
            quantidadeNota: info.itemNF_Agregada.qtdNF,
            precoNota: info.itemNF_Agregada.precoNF,
            divergenciaNota: formatarMoeda(info.itemNF_Agregada.precoNF - info.itemCot.preco)
        });
        info.itensNF_Original.forEach(itemNF => {
            conciliacaoPayload.novosMapeamentos.push({
                itemCotacao: info.itemCot.subProduto, 
                descricaoNF: itemNF.descricaoNF,
                gtin: itemNF.gtin || ''
            });
        });
    });

    $('#cotacao-items-list .list-group-item:not(.matched)').each(function() {
        itensCortados.push({ idCotacao, nomeFornecedor, subProduto: $(this).data('item-info').subProduto });
    });

    const totaisPorSetor = {};
    const novasRegras = [];
    const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nfInfo.chaveAcesso);
    const totalConciliadoBruto = conciliacaoPayload.itensConciliados.reduce((sum, item) => sum + (item.quantidadeNota * item.precoNota), 0);
    const custosAdicionais = totaisNF.valorTotalNf - totalConciliadoBruto;
    const mapaSetorParaItens = {};

    $('.matched-item-card').each(function() {
        const card = $(this);
        // [CORREÇÃO] Corrigido o erro de digitação de 'conciliaacao-info' para 'conciliacao-info'
        const concInfo = card.data('conciliacao-info');
        const rateioInfo = card.data('rateio-info');
        const valorBrutoItem = concInfo.itemNF_Agregada.qtdNF * concInfo.itemNF_Agregada.precoNF;
        const proporcaoItem = totalConciliadoBruto > 0.01 ? valorBrutoItem / totalConciliadoBruto : 0;
        const custoEfetivoItem = valorBrutoItem + (custosAdicionais * proporcaoItem);

        const aplicarRateio = (setor, porcentagem) => {
            if (!setor || !porcentagem) return;
            setor = setor.trim();
            totaisPorSetor[setor] = (totaisPorSetor[setor] || 0) + (custoEfetivoItem * (porcentagem / 100));
            if (!mapaSetorParaItens[setor]) mapaSetorParaItens[setor] = new Set();
            mapaSetorParaItens[setor].add(concInfo.itemCot.subProduto);
        };

        if (rateioInfo.isAutomatico) {
            rateioInfo.regras.forEach(regra => aplicarRateio(regra.setor, regra.porcentagem));
        } else {
            card.find('.manual-rate-row').each(function() {
                const setor = $(this).find('.input-setor').val().trim();
                const porcentagem = parseFloat($(this).find('.input-porcentagem').val()) || 0;
                aplicarRateio(setor, porcentagem);
                if(setor && porcentagem > 0) novasRegras.push({ itemCotacao: concInfo.itemCot.subProduto, setor, porcentagem });
            });
        }
    });

    for(const setor in mapaSetorParaItens){
      mapaSetorParaItens[setor] = Array.from(mapaSetorParaItens[setor]);
    }

    const rateioPayload = { 
        chaveAcesso: nfInfo.chaveAcesso, 
        totaisPorSetor, 
        novasRegras, 
        numeroNF: nfInfo.numeroNF,
        mapaSetorParaItens: mapaSetorParaItens
    };

    stagedPayloads.push({
        conciliacoes: [conciliacaoPayload], 
        itensCortados, 
        novosMapeamentos: conciliacaoPayload.novosMapeamentos,
        rateios: [rateioPayload], 
        statusUpdates: []
    });

    $(`.nf-list-item`).filter((i, el) => $(el).data('nf-info').chaveAcesso === nfInfo.chaveAcesso)
        .addClass('staged').removeClass('active').find('.status-icon').removeClass('d-none');
    workspace.addClass('d-none').empty();
    $('#workspace-welcome').removeClass('d-none');
    atualizarBotaoSalvarLote();
}

function onBtnSalvarLoteClick() {
    if (stagedPayloads.length === 0) return;
    toggleLoader(true);
    const payloadFinal = stagedPayloads.reduce((acc, current) => {
        acc.conciliacoes.push(...(current.conciliacoes || []));
        acc.itensCortados.push(...(current.itensCortados || []));
        acc.novosMapeamentos.push(...(current.novosMapeamentos || []));
        acc.statusUpdates.push(...(current.statusUpdates || []));
        acc.rateios.push(...(current.rateios || []));
        return acc;
    }, { conciliacoes: [], itensCortados: [], novosMapeamentos: [], statusUpdates: [], rateios: [] });
    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                alert(response.message);
                resetApplication();
            } else { onFailure(response); }
        })
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_salvarLoteUnificado(payloadFinal);
}
function atualizarBotaoSalvarLote() {
    const btn = $('#btn-salvar-lote');
    const count = stagedPayloads.length;
    if (count > 0) {
        btn.find('#save-batch-text').text(`Salvar ${count} Alteração(ões)`);
        btn.removeClass('d-none');
    } else {
        btn.addClass('d-none');
    }
}

// ===== FUNÇÕES UTILITÁRIAS =====
function toggleLoader(show) {
    $('#loader').toggleClass('d-none', !show);
}
function formatarMoeda(valor) {
    if (typeof valor !== 'number' || isNaN(valor)) return "R$ 0,00";
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

/**
 * Abre a página do Relatório de Rateio em uma nova aba.
 */
function onAbrirRelatorioRateioClick() {
    toggleLoader(true);
    // Esta função já existe no seu App.js e é perfeita para isso.
    google.script.run
        .withSuccessHandler(response => {
            toggleLoader(false);
            if (response.success && response.url) {
                window.open(response.url, '_blank');
            } else {
                onFailure({ message: response.message || 'Não foi possível obter a URL do relatório.' });
            }
        })
        .withFailureHandler(onFailure)
        .App_obterUrlWebApp({ view: 'relatoriorateio' });
}

/**
 * Adiciona um payload para marcar a NF como 'Bonificação' e atualiza a UI.
 * Este é um estado final sem rateio.
 */
function onMarcarBonificacaoClick() {
    const nfInfo = $('#workspace-content').data('active-nf');
    if (!nfInfo || !confirm(`Tem certeza que deseja marcar a NF ${nfInfo.numeroNF} como 'Bonificação'? Esta ação não poderá ser desfeita após salvar.`)) {
        return;
    }
    
    stagedPayloads.push({
        statusUpdates: [{ chaveAcesso: nfInfo.chaveAcesso, novoStatus: 'Bonificação' }]
    });

    $(`.nf-list-item`).filter((i, el) => $(el).data('nf-info').chaveAcesso === nfInfo.chaveAcesso)
        .addClass('staged').removeClass('active').find('.status-icon').removeClass('d-none');
    $('#workspace-content').addClass('d-none').empty();
    $('#workspace-welcome').removeClass('d-none');
    atualizarBotaoSalvarLote();
}

/**
 * [ALTERADO] Inicia o fluxo de rateio para notas sem pedido de compra.
 * Corrigido para usar a nova estrutura de dados e não criar cards em branco.
 */
function onMarcarSemPedidoClick() {
    const nfInfo = $('#workspace-content').data('active-nf');
    const dadosGerais = todosOsDadosGeraisNF.find(d => d.chaveAcesso === nfInfo.chaveAcesso);

    if (!confirm(`A NF ${nfInfo.numeroNF} será preparada para o rateio direto. Deseja continuar?`)) return;

    $('.select-cotacao-fornecedor').closest('.col-md-5').hide();
    $('#cotacao-items-list').closest('.col-md-6').hide();
    $('#nf-items-list').closest('.col-md-6').removeClass('col-md-6').addClass('col-md-12');
    $('.comparison-container').removeClass('d-none');

    const itensNestaNF = todosOsItensNF.filter(item => item.chaveAcesso === nfInfo.chaveAcesso);

    itensNestaNF.forEach(itemNF => {
        const itemCotSintetico = {
            subProduto: itemNF.descricaoNF,
            qtdComprar: itemNF.qtdNF,
            preco: itemNF.precoNF
        };

        const cardTemplate = $('#template-matched-item').prop('content').cloneNode(true);
        const card = $(cardTemplate.querySelector('.matched-item-card'));

        // [CORREÇÃO] Criando a estrutura de dados correta para o card
        card.data('conciliacao-info', {
            itemCot: itemCotSintetico,
            itensNF_Original: [itemNF], // Usa array
            itemNF_Agregada: { // Usa a nova propriedade agregada
                qtdNF: itemNF.qtdNF,
                precoNF: itemNF.precoNF
            }
        });

        $('#matched-items-container').append(card);
        _atualizarVisualMatchedCard(card); // Agora esta função irá funcionar corretamente
        _popularRateioDoCard(card);
    });

    recalcularErenderizarResumoRateio();
    $('#rateio-summary-section').removeClass('d-none');

    const btnConcluir = $('#btn-concluir-conciliacao');
    btnConcluir.text('Concluir Rateio Direto').prop('disabled', false)
               .off('click').on('click', onBtnConcluirRateioSemPedidoClick);
}


/**
 * Função específica para concluir e preparar o payload de um rateio sem pedido.
 */
function onBtnConcluirRateioSemPedidoClick() {
    let erroValidacao = false;
    $('.matched-item-card').each(function() {
        if ($(this).find('.total-percent-item').hasClass('is-invalid')) {
            alert(`Erro: O rateio do item "${$(this).find('.item-nf-descricao').text()}" não soma 100%.`);
            erroValidacao = true; return false;
        }
    });
    if (erroValidacao) return;

    const workspace = $('#workspace-content');
    const nfInfo = workspace.data('active-nf');
    
    const totaisPorSetor = {};
    const novasRegras = [];
    const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nfInfo.chaveAcesso);

    // [CORREÇÃO] Calcula o total bruto com base nos itens na tela e na propriedade correta 'itemNF_Agregada'
    const totalItensBruto = $('.matched-item-card').toArray().reduce((sum, el) => {
        const info = $(el).data('conciliacao-info');
        // Usa a propriedade correta: 'itemNF_Agregada'
        return sum + (info.itemNF_Agregada.qtdNF * info.itemNF_Agregada.precoNF);
    }, 0);
    
    const custosAdicionais = totaisNF.valorTotalNf - totalItensBruto;
    const mapaSetorParaItens = {};

    $('.matched-item-card').each(function() {
        const card = $(this);
        const concInfo = card.data('conciliacao-info');
        const rateioInfo = card.data('rateio-info');
        
        // [CORREÇÃO] Usa a propriedade correta: 'itemNF_Agregada'
        const valorBrutoItem = concInfo.itemNF_Agregada.qtdNF * concInfo.itemNF_Agregada.precoNF;
        const proporcaoItem = totalItensBruto > 0.01 ? valorBrutoItem / totalItensBruto : 0;
        const custoEfetivoItem = valorBrutoItem + (custosAdicionais * proporcaoItem);
        
        const aplicarRateio = (setor, porcentagem) => {
            if (!setor || !porcentagem) return;
            setor = setor.trim();
            totaisPorSetor[setor] = (totaisPorSetor[setor] || 0) + (custoEfetivoItem * (porcentagem / 100));
            if (!mapaSetorParaItens[setor]) mapaSetorParaItens[setor] = new Set();
            mapaSetorParaItens[setor].add(concInfo.itemNF_Original.descricaoNF); // Usa a descrição da NF
        };

        if (rateioInfo.isAutomatico) {
            rateioInfo.regras.forEach(regra => aplicarRateio(regra.setor, regra.porcentagem));
        } else {
            card.find('.manual-rate-row').each(function() {
                const setor = $(this).find('.input-setor').val().trim();
                const porcentagem = parseFloat($(this).find('.input-porcentagem').val()) || 0;
                aplicarRateio(setor, porcentagem);
                if(setor && porcentagem > 0) novasRegras.push({ itemCotacao: concInfo.itemNF_Original.descricaoNF, setor, porcentagem });
            });
        }
    });

    for(const setor in mapaSetorParaItens){
      mapaSetorParaItens[setor] = Array.from(mapaSetorParaItens[setor]);
    }

    const rateioPayload = { 
        chaveAcesso: nfInfo.chaveAcesso, 
        totaisPorSetor, 
        novasRegras, 
        numeroNF: nfInfo.numeroNF,
        mapaSetorParaItens: mapaSetorParaItens
    };
    
    stagedPayloads.push({
        rateios: [rateioPayload],
        statusUpdates: [{ chaveAcesso: nfInfo.chaveAcesso, novoStatus: 'Conciliada (Sem Pedido)' }]
    });

    $(`.nf-list-item`).filter((i, el) => $(el).data('nf-info').chaveAcesso === nfInfo.chaveAcesso)
        .addClass('staged').removeClass('active').find('.status-icon').removeClass('d-none');
    workspace.addClass('d-none').empty();
    $('#workspace-welcome').removeClass('d-none');
    atualizarBotaoSalvarLote();
}

// SUBSTITUA ESTA FUNÇÃO: onAbrirModalFornecedorClick
/**
 * Acionado ao clicar no botão "Cadastrar / Editar Fornecedor".
 * Busca o fornecedor pelo CNPJ da NF e abre o modal em modo de criação ou edição,
 * populando todos os campos necessários.
 */
function onAbrirModalFornecedorClick() {
    const nfInfo = $('#workspace-content').data('active-nf');
    if (!nfInfo || !nfInfo.cnpjEmitente) {
        alert("Não foi possível obter o CNPJ do fornecedor da nota fiscal selecionada.");
        return;
    }

    const btn = $('#btn-abrir-modal-fornecedor');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Buscando...');

    google.script.run
        .withSuccessHandler(function(fornecedorExistente) {
            btn.prop('disabled', false).html('<i class="bi bi-person-plus-fill"></i> Cadastrar / Editar Fornecedor da NF');
            const form = $('#form-cadastro-fornecedor-nf')[0];
            form.reset();
            $('#modal-fornecedor-nf-feedback').addClass('d-none').text('');

            if (fornecedorExistente) {
                // MODO EDIÇÃO: Preenche o formulário com dados existentes do fornecedor
                $('#modalCadastroFornecedorNFLabel').text('Editar Fornecedor');
                $('#cadastro-fornecedor-id').val(fornecedorExistente.ID || '');
                $('#cadastro-fornecedor-nome').val(fornecedorExistente.Fornecedor || '');
                $('#cadastro-fornecedor-cnpj').val(ConciliacaoNFScript_mascaraCnpj(fornecedorExistente.CNPJ || ''));
                $('#cadastro-fornecedor-categoria').val(fornecedorExistente.Categoria || '');
                $('#cadastro-fornecedor-vendedor').val(fornecedorExistente.Vendedor || '');
                $('#cadastro-fornecedor-telefone').val(ConciliacaoNFScript_mascaraTelefone(fornecedorExistente.Telefone || ''));
                $('#cadastro-fornecedor-email').val(fornecedorExistente.Email || '');
                $('#cadastro-fornecedor-dias-pedido').val(fornecedorExistente['Dias de Pedido'] || '');
                $('#cadastro-fornecedor-dias-entrega').val(fornecedorExistente['Dias de Entrega'] || '');
                $('#cadastro-fornecedor-dia-faturamento').val(fornecedorExistente['Dia de Faturamento'] || '');
                $('#cadastro-fornecedor-condicoes').val(fornecedorExistente['Condições de Pagamento'] || '');
                
                const pedidoMinimoInput = document.getElementById('cadastro-fornecedor-pedido-minimo');
                pedidoMinimoInput.value = fornecedorExistente['Pedido Mínimo (R$)'] || '';
                ConciliacaoNFScript_formatarMoedaInput(pedidoMinimoInput); // Formata o valor

                $('#cadastro-fornecedor-regime').val(fornecedorExistente['Regime Tributário'] || '');
                $('#cadastro-fornecedor-financeiro').val(fornecedorExistente['Contato Financeiro'] || '');

            } else {
                // MODO CRIAÇÃO: Pré-popula apenas nome e CNPJ com dados da NF
                $('#modalCadastroFornecedorNFLabel').text('Cadastrar Novo Fornecedor');
                $('#cadastro-fornecedor-id').val(''); // Garante que o ID está vazio
                $('#cadastro-fornecedor-nome').val(nfInfo.nomeEmitente || '');
                $('#cadastro-fornecedor-cnpj').val(ConciliacaoNFScript_mascaraCnpj(nfInfo.cnpjEmitente || ''));
            }
            modalFornecedorNFInstance.show();
        })
        .withFailureHandler(function(error) {
            btn.prop('disabled', false).html('<i class="bi bi-person-plus-fill"></i> Cadastrar / Editar Fornecedor da NF');
            alert(`Erro ao buscar dados do fornecedor: ${error.message}`);
        })
        .ConciliacaoNFController_buscarFornecedorPorCnpj(nfInfo.cnpjEmitente);
}

// SUBSTITUA ESTA FUNÇÃO: onSalvarFornecedorViaNFSubmit
/**
 * Lida com o submit do formulário de cadastro/edição de fornecedor via NF.
 * Converte o campo de moeda para um formato numérico antes de enviar ao backend.
 * @param {Event} event O evento de submit do formulário.
 */
function onSalvarFornecedorViaNFSubmit(event) {
    event.preventDefault();
    const btnSalvar = $('#btn-salvar-fornecedor-nf');
    const spinner = btnSalvar.find('.spinner-border');
    
    btnSalvar.prop('disabled', true);
    spinner.removeClass('d-none');

    const feedbackDiv = $('#modal-fornecedor-nf-feedback');
    feedbackDiv.removeClass('d-none alert-danger alert-success').addClass('alert-info').text('Salvando...');

    const form = $(this);
    const dadosFornecedor = {};
    form.serializeArray().forEach(item => {
        // Trata o campo de Pedido Mínimo para enviar um valor numérico cru
        if (item.name === 'Pedido Mínimo (R$)') {
            dadosFornecedor[item.name] = ConciliacaoNFScript_obterValorMoedaCru(item.value);
        } else {
            dadosFornecedor[item.name] = item.value;
        }
    });

    // A função de backend chamada (ConciliacaoNFController_salvarFornecedorViaNF) já roteia
    // para as funções corretas de criar/atualizar que fazem a checagem de duplicidade
    // e propagação de alteração de nome.
    google.script.run
        .withSuccessHandler(function(response) {
            btnSalvar.prop('disabled', false);
            spinner.addClass('d-none');

            if (response.success) {
                modalFornecedorNFInstance.hide();
                alert(response.message || "Fornecedor salvo com sucesso!");
                resetApplication(); 
            } else {
                feedbackDiv.removeClass('alert-info').addClass('alert-danger').text(response.message || "Ocorreu um erro desconhecido.");
            }
        })
        .withFailureHandler(function(error) {
            btnSalvar.prop('disabled', false);
            spinner.addClass('d-none');
            feedbackDiv.removeClass('alert-info').addClass('alert-danger').text(`Erro de comunicação: ${error.message}`);
        })
        .ConciliacaoNFController_salvarFornecedorViaNF(dadosFornecedor);
}

/**
 * Aplica máscara de CNPJ (00.000.000/0000-00) a um valor.
 * @param {string} value O valor a ser formatado.
 * @returns {string} O valor com a máscara aplicada.
 */
function ConciliacaoNFScript_mascaraCnpj(value) {
  if (!value) return "";
  return value.replace(/\D/g, '')
    .replace(/^(\d{2})(\d)/, '$1.$2')
    .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
    .replace(/\.(\d{3})(\d)/, '.$1/$2')
    .replace(/(\d{4})(\d)/, '$1-$2')
    .slice(0, 18);
}

/**
 * Aplica máscara de Telefone ((00) 00000-0000) a um valor.
 * @param {string} value O valor a ser formatado.
 * @returns {string} O valor com a máscara aplicada.
 */
function ConciliacaoNFScript_mascaraTelefone(value) {
  if (!value) return "";
  value = value.replace(/\D/g, '');
  if (value.length > 11) value = value.slice(0, 11);
  if (value.length > 10) {
    value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
  } else if (value.length > 6) {
    value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
  } else if (value.length > 2) {
    value = value.replace(/^(\d{2})(\d*)/, '($1) $2');
  } else if (value.length > 0) {
    value = value.replace(/^(\d*)/, '($1');
  }
  return value;
}

/**
 * Formata o valor de um campo de input para o formato de moeda BRL (R$).
 * @param {HTMLInputElement} inputElement O elemento do input a ser formatado.
 */
function ConciliacaoNFScript_formatarMoedaInput(inputElement) {
    let value = inputElement.value.replace(/\D/g, '');
    if (value === '') {
        inputElement.value = '';
        return;
    }
    const numero = parseInt(value, 10) / 100;
    inputElement.value = numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

/**
 * Converte um valor de moeda formatado (ex: "R$ 1.234,56") para um formato numérico cru (ex: "1234.56").
 * @param {string} formattedValue O valor formatado a ser convertido.
 * @returns {string} O valor numérico como string.
 */
function ConciliacaoNFScript_obterValorMoedaCru(formattedValue) {
    if (!formattedValue) return '';
    return formattedValue.replace('R$', '').replace(/\s/g, '').replace(/\./g, '').replace(',', '.');
}

/**
 * Acionado ao clicar em "Cadastrar Itens da NF". Busca os dados e abre o modal principal.
 */
function onAbrirCadastroItensClick() {
    const nfInfo = $('#workspace-content').data('active-nf');
    if (!nfInfo) return;

    toggleLoader(true);
    google.script.run
        .withSuccessHandler(function(response) {
            toggleLoader(false);
            if (!response.success) {
                alert("Erro ao buscar dados para cadastro: " + response.message);
                return;
            }
            
            const { itensNF, fornecedor, produtos } = response.dados;
            const container = $('#container-itens-para-cadastro').empty();
            $('#cadastro-itens-nf-numero').text(nfInfo.numeroNF);
            $('#cadastro-itens-fornecedor-nome').text(fornecedor.Fornecedor).data('fornecedor-id', fornecedor.ID);

            // Filtra apenas os itens da NF que AINDA NÃO foram conciliados
            const itensConciliadosDescricoes = new Set();
            $('.matched-item-card').each(function() {
                const info = $(this).data('conciliacao-info');
                info.itensNF_Original.forEach(item => itensConciliadosDescricoes.add(item.descricaoNF));
            });

            const itensNaoConciliados = itensNF.filter(item => !itensConciliadosDescricoes.has(item.descricaoNF));

            if (itensNaoConciliados.length === 0) {
                 container.html('<div class="alert alert-warning">Todos os itens desta NF já foram conciliados ou estão em processo de rateio direto. Não há itens para cadastrar.</div>');
            } else {
                itensNaoConciliados.forEach(item => {
                    const template = $('#template-item-cadastro-nf').prop('content').cloneNode(true);
                    const itemRow = $(template.children[0]);
                    itemRow.find('.original-nf-description').text(item.descricaoNF);
                    itemRow.find('input[name="SubProduto"]').val(item.descricaoNF);
                    itemRow.find('input[name="UN"]').val(item.unidadeComercial);

                    const selectProduto = itemRow.find('.select-produto-vinculado');
                    selectProduto.empty().append('<option value="" selected>Selecione...</option>');
                    produtos.forEach(p => selectProduto.append(`<option value="${p.ID}">${p.Produto}</option>`));
                    selectProduto.append('<option value="--CADASTRAR-NOVO--" class="fw-bold text-primary">Cadastrar Novo Produto...</option>');
                    
                    container.append(itemRow);
                });
            }
            modalCadastroItensNFInstance.show();
        })
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_obterDadosParaCadastroItens(nfInfo.chaveAcesso);
}

/**
 * Controla a seleção no dropdown de "Produto Vinculado".
 * Se o usuário escolher "Cadastrar Novo...", abre o mini-modal de cadastro de produto.
 */
function onProdutoVinculadoChange() {
    if ($(this).val() === '--CADASTRAR-NOVO--') {
        selectQueAbriuModalProduto = $(this); // Salva a referência do select que disparou a ação
        $('#form-cadastro-produto-nf')[0].reset(); // Limpa o formulário do mini-modal
        $('#feedback-cadastro-produto-nf').addClass('d-none').text('');
        modalCadastroProdutoViaNFInstance.show();
    }
}

/**
 * Lida com o salvamento de um novo Produto Principal a partir do mini-modal.
 */
function onSalvarProdutoViaNFSubmit(event) {
    event.preventDefault();
    const btnSalvar = $('#btn-salvar-produto-nf');
    const spinner = btnSalvar.find('.spinner-border');
    btnSalvar.prop('disabled', true);
    spinner.removeClass('d-none');

    const feedbackDiv = $('#feedback-cadastro-produto-nf');
    feedbackDiv.removeClass('d-none alert-danger alert-success').addClass('alert-info').text('Salvando...');

    const dadosProduto = {};
    $(this).serializeArray().forEach(item => { dadosProduto[item.name] = item.value; });

    google.script.run
        .withSuccessHandler(function(response) {
            btnSalvar.prop('disabled', false);
            spinner.addClass('d-none');
            if (response.success) {
                const novoProduto = response.produto; // Assumindo que o backend retorna o obj do produto
                const novaOpcao = `<option value="${novoProduto.ID}">${novoProduto.Produto}</option>`;
                // Adiciona a nova opção a TODOS os selects de produto no modal principal
                $('.select-produto-vinculado').each(function() {
                    $(this).find('option[value="--CADASTRAR-NOVO--"]').before(novaOpcao);
                });
                // Seleciona a nova opção no select que originou a ação
                if (selectQueAbriuModalProduto) {
                    selectQueAbriuModalProduto.val(novoProduto.ID);
                    selectQueAbriuModalProduto = null; // Limpa a referência
                }
                modalCadastroProdutoViaNFInstance.hide();
            } else {
                feedbackDiv.removeClass('alert-info').addClass('alert-danger').text(response.message);
            }
        })
        .withFailureHandler(function(err) {
            btnSalvar.prop('disabled', false);
            spinner.addClass('d-none');
            feedbackDiv.removeClass('alert-info').addClass('alert-danger').text(err.message);
        })
        .ConciliacaoNFController_salvarProdutoViaNF(dadosProduto);
}

/**
 * Lida com o salvamento em lote de todos os novos subprodutos definidos no modal.
 */
function onSalvarSubProdutosViaNFSubmit() {
    const btnSalvar = $('#btn-salvar-subprodutos-nf');
    const spinner = btnSalvar.find('.spinner-border');
    btnSalvar.prop('disabled', true);
    spinner.removeClass('d-none');

    const feedbackDiv = $('#feedback-cadastro-itens-nf');
    feedbackDiv.removeClass('d-none alert-danger alert-success').addClass('alert-info').text('Salvando...');

    const dadosLote = {
        fornecedorId: $('#cadastro-itens-fornecedor-nome').data('fornecedor-id'),
        subProdutos: []
    };
    
    let formValido = true;
    $('.item-cadastro-row').each(function() {
        const row = $(this);
        const subProdutoNome = row.find('input[name="SubProduto"]').val();
        const produtoVinculadoId = row.find('select[name="Produto Vinculado"]').val();
        
        // Processa apenas linhas onde o usuário de fato preencheu os campos chave
        if (subProdutoNome && produtoVinculadoId && produtoVinculadoId !== '--CADASTRAR-NOVO--') {
            const subProdutoData = {};
            row.find('input, select').each(function() {
                if ($(this).attr('name')) {
                    subProdutoData[$(this).attr('name')] = $(this).val();
                }
            });
            dadosLote.subProdutos.push(subProdutoData);
        } else if (subProdutoNome || (produtoVinculadoId && produtoVinculadoId !== '--CADASTRAR-NOVO--')) {
            // Se um campo chave foi preenchido mas o outro não, marca como erro
            formValido = false;
        }
    });

    if (!formValido) {
        btnSalvar.prop('disabled', false);
        spinner.addClass('d-none');
        feedbackDiv.removeClass('alert-info').addClass('alert-danger').text('Erro: Para cada item a ser cadastrado, tanto o nome do SubProduto quanto o Produto Vinculado são obrigatórios.');
        return;
    }
    
    if (dadosLote.subProdutos.length === 0) {
        btnSalvar.prop('disabled', false);
        spinner.addClass('d-none');
        feedbackDiv.removeClass('alert-info').addClass('alert-warning').text('Nenhum item foi preenchido para cadastro.');
        return;
    }

    google.script.run
        .withSuccessHandler(function(response) {
            btnSalvar.prop('disabled', false);
            spinner.addClass('d-none');
            if (response.success) {
                alert(response.message);
                modalCadastroItensNFInstance.hide();
                // Não há necessidade de recarregar a página, conforme solicitado.
                // O usuário pode continuar seu trabalho de conciliação.
            } else {
                feedbackDiv.removeClass('alert-info').addClass('alert-danger').text('Falha ao salvar: ' + response.message);
            }
        })
        .withFailureHandler(function(err) {
            btnSalvar.prop('disabled', false);
            spinner.addClass('d-none');
            feedbackDiv.removeClass('alert-info').addClass('alert-danger').text('Erro de comunicação: ' + err.message);
        })
        .ConciliacaoNFController_salvarSubProdutosViaNF(dadosLote);
}

</script>