<script>
  // Funções iniciais (normalizarCNPJ, formatarMoeda, toggleLoader, etc.) permanecem as mesmas
  let todasAsCotacoes = [];
  let todasAsNFs = [];
  let dadosComparacao = {};

  function normalizarCNPJ(cnpj) {
    return cnpj ? String(cnpj).replace(/[^\d]/g, '') : '';
  }
  
  function formatarMoeda(valor) {
    if (typeof valor !== 'number' || isNaN(valor)) {
      return "R$ 0,00";
    }
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }
  
  function toggleLoader(show) {
    document.getElementById('loader').classList.toggle('d-none', !show);
  }

  document.addEventListener('DOMContentLoaded', function() {
    toggleLoader(true);
    $('#cotacao-select, #nf-select').select2({ theme: "bootstrap-5" });
    
    google.script.run
      .withSuccessHandler(onDadosIniciaisSuccess)
      .withFailureHandler(onFailure)
      .ConciliacaoNFController_obterDadosParaPagina();
      
    addEventListeners();
  });
  
  function addEventListeners() {
    $('#nf-select').on('change', onNfSelectChange);
    $('#cotacao-select').on('change', onCotacaoSelectChange);
    $('#btn-comparar').on('click', onBtnCompararClick);
    $('#btn-voltar').on('click', resetarPagina);
    $('#btn-salvar').on('click', onBtnSalvarClick);
  }

  function onDadosIniciaisSuccess(response) {
    if (response.success) {
      todasAsCotacoes = response.dados.cotacoes;
      todasAsNFs = response.dados.notasFiscais;

      const nfSelect = $('#nf-select');
      nfSelect.empty();
      todasAsNFs.forEach(nf => {
        const displayText = `NF ${nf.numeroNF} - ${nf.nomeEmitente} (${nf.dataEmissao})`;
        const option = new Option(displayText, nf.chaveAcesso);
        $(option).data('nf', nf);
        nfSelect.append(option);
      });
      nfSelect.val(null).trigger('change');
    } else {
      alert('Erro ao carregar dados: ' + response.message);
    }
    toggleLoader(false);
  }

  function onFailure(error) {
    console.error('Erro na chamada ao servidor:', error);
    alert('Ocorreu um erro: ' + error.message);
    toggleLoader(false);
  }

  function onNfSelectChange() {
    const selectedOptions = $('#nf-select').find('option:selected');
    const cotacaoSelect = $('#cotacao-select');
    
    cotacaoSelect.empty();
    $('#btn-comparar').prop('disabled', true);
    
    if (selectedOptions.length > 0) {
      const primeiraNfData = $(selectedOptions[0]).data('nf');
      const cnpjDaNfNormalizado = normalizarCNPJ(primeiraNfData.cnpjEmitente);

      if (cnpjDaNfNormalizado) {
        const cotacoesFiltradas = todasAsCotacoes.filter(c => {
          const cnpjDaCotacaoNormalizado = normalizarCNPJ(c.fornecedorCnpj);
          return cnpjDaCotacaoNormalizado === cnpjDaNfNormalizado;
        });
        
        if(cotacoesFiltradas.length > 0) {
          cotacaoSelect.append(new Option('Selecione uma cotação', '', true, true));
          cotacoesFiltradas.forEach(c => {
            const displayText = `ID ${c.idCotacao} - ${c.fornecedor} (${c.dataAbertura})`;
            cotacaoSelect.append(new Option(displayText, c.compositeKey));
          });
          cotacaoSelect.prop('disabled', false);
        } else {
          cotacaoSelect.append(new Option('Nenhuma cotação aberta encontrada para este fornecedor', '', true, true)).prop('disabled', true);
        }
      }
    } else {
       cotacaoSelect.append(new Option('Selecione uma NF primeiro', '', true, true)).prop('disabled', true);
    }
    cotacaoSelect.val('').trigger('change');
  }
  
  function onCotacaoSelectChange(){
    const cotacaoKey = $('#cotacao-select').val();
    const nfKeys = $('#nf-select').val();
    $('#btn-comparar').prop('disabled', !(cotacaoKey && nfKeys && nfKeys.length > 0));
  }

  function onBtnCompararClick() {
    toggleLoader(true);
    const cotacaoKey = $('#cotacao-select').val();
    const chavesNf = $('#nf-select').val();
    
    google.script.run
      .withSuccessHandler(onComparacaoSuccess)
      .withFailureHandler(onFailure)
      .ConciliacaoNFController_realizarComparacao(cotacaoKey, chavesNf);
  }
  
  function onComparacaoSuccess(response) {
    if (response.success) {
      dadosComparacao = response.dados;
      
      const resumo = response.dados.dadosGeraisNF;
      const totaisTributos = (resumo.totalValorIcms || 0) + (resumo.totalValorIcmsSt || 0) + (resumo.totalValorPis || 0) + (resumo.totalValorCofins || 0);
      
      $('#header-resumo').text(`Resumo da Conciliação: Cotação ${dadosComparacao.idCotacao} vs NFs`);
      $('#total-produtos-nf').text(formatarMoeda(resumo.totalValorProdutos));
      $('#total-frete-nf').text(formatarMoeda(resumo.totalValorFrete));
      $('#total-ipi-nf').text(formatarMoeda(resumo.totalValorIpi));
      $('#total-outras-nf').text(formatarMoeda(resumo.totalOutrasDespesas));
      $('#total-desconto-nf').text(formatarMoeda(resumo.totalValorDesconto));
      $('#total-impostos-nf').text(formatarMoeda(totaisTributos));
      $('#valor-total-nf').text(formatarMoeda(resumo.valorTotalNf));

      construirTabelaComparacao();
      
      $('#card-selecao').addClass('d-none');
      $('#etapa-comparacao').removeClass('d-none');
      
    } else {
      alert('Erro na comparação: ' + response.message);
    }
    toggleLoader(false);
  }

  /**
   * NOVA VERSÃO: Constrói dinamicamente as linhas da tabela com colunas condensadas.
   */
  function construirTabelaComparacao() {
      const tbody = $('#comparison-table-body');
      tbody.empty();
      dadosComparacao.itensNF.forEach((itemNF, index) => {
        const subtotalNF = itemNF.qtdNF * itemNF.precoNF;
        const row = `
          <tr data-item-nf-index="${index}">
            <td>${itemNF.descricaoNF}</td>
            
            <td class="dados-condensados text-end">
              <div><small>Qtd:</small> <span>${itemNF.qtdNF.toFixed(2)}</span></div>
              <div><small>Preço:</small> <span>${formatarMoeda(itemNF.precoNF)}</span></div>
              <div><small>Subtotal:</small> <strong class="text-primary">${formatarMoeda(subtotalNF)}</strong></div>
            </td>
            
            <td>
              <select class="form-select select-cotacao-item" data-placeholder="Escolha o item correspondente..."></select>
            </td>
            
            <td class="dados-condensados text-end">
              <div><small>Qtd Pedida:</small> <span class="cot-qtd"></span></div>
              <div><small>Preço Unit.:</small> <span class="cot-preco"></span></div>
              <div><small>Preço Fator:</small> <span class="cot-preco-fator"></span></div>
            </td>

            <td class="dados-condensados text-center">
              <div><small>Div. Preço:</small> <span class="divergencia-preco fw-bold"></span></div>
              <div><small>Div. Qtd:</small> <span class="divergencia-qtd fw-bold"></span></div>
            </td>
          </tr>
        `;
        tbody.append(row);
      });
      
      popularSelectsItensCotacao();
  }

  /**
   * Popula cada dropdown na tabela de comparação com os itens da cotação.
   * (Função inalterada)
   */
  function popularSelectsItensCotacao() {
      const selects = $('.select-cotacao-item');
      selects.each(function() {
        const select = $(this);
        select.empty().append(new Option('', '', true, true));
        dadosComparacao.itensCotacao.forEach((itemCot, index) => {
            const displayText = `${itemCot.subProduto} (Qtd: ${itemCot.qtdComprar})`;
            const option = new Option(displayText, index);
            select.append(option);
        });
      });

      selects.select2({ 
        theme: "bootstrap-5",
        placeholder: $(this).data('placeholder'),
        allowClear: true
      }).on('change', onMatchItem);
  }

  /**
   * NOVA VERSÃO: Preenche os dados e divergências nas células condensadas.
   */
  function onMatchItem() {
    const select = $(this);
    const selectedCotacaoIndex = select.val();
    const row = select.closest('tr');
    const itemNFIndex = row.data('item-nf-index');
    const itemNF = dadosComparacao.itensNF[itemNFIndex];
    
    const cotQtdEl = row.find('.cot-qtd');
    const cotPrecoEl = row.find('.cot-preco');
    const cotPrecoFatorEl = row.find('.cot-preco-fator');
    const divPrecoEl = row.find('.divergencia-preco');
    const divQtdEl = row.find('.divergencia-qtd');

    // Limpa as células de resultado se a seleção for limpa
    if (!selectedCotacaoIndex) {
        cotQtdEl.empty();
        cotPrecoEl.empty();
        cotPrecoFatorEl.empty();
        divPrecoEl.empty().removeClass('text-success text-danger');
        divQtdEl.empty().removeClass('text-success text-danger text-warning');
        return;
    }

    const itemCotacao = dadosComparacao.itensCotacao[selectedCotacaoIndex];
    
    // Preenche os dados da cotação
    cotQtdEl.text(itemCotacao.qtdComprar.toFixed(2));
    cotPrecoEl.text(formatarMoeda(itemCotacao.preco));
    cotPrecoFatorEl.text(formatarMoeda(itemCotacao.precoPorFator));

    // Compara PREÇO
    const precoNF = itemNF.precoNF;
    const diffPreco = precoNF - itemCotacao.preco;
    const diffPrecoFator = precoNF - itemCotacao.precoPorFator;
    
    if (Math.abs(diffPreco) < 0.01 || Math.abs(diffPrecoFator) < 0.01) {
        divPrecoEl.text('OK').removeClass('text-danger').addClass('text-success');
    } else {
        const menorDivergencia = Math.abs(diffPreco) < Math.abs(diffPrecoFator) ? diffPreco : diffPrecoFator;
        divPrecoEl.text(formatarMoeda(menorDivergencia)).removeClass('text-success').addClass('text-danger');
    }

    // Compara QUANTIDADE
    const qtdNF = itemNF.qtdNF;
    const qtdComprar = itemCotacao.qtdComprar;
    const diffQtd = qtdNF - qtdComprar;

    if (Math.abs(diffQtd) < 0.001) {
        divQtdEl.text('OK').removeClass('text-warning text-danger').addClass('text-success');
    } else if (diffQtd < 0) {
        divQtdEl.text(`${diffQtd.toFixed(2)}`).removeClass('text-success text-warning').addClass('text-danger');
    } else {
        divQtdEl.text(`+${diffQtd.toFixed(2)}`).removeClass('text-success text-danger').addClass('text-warning');
    }
  }
  
  function onBtnSalvarClick() {
    toggleLoader(true);
    
    const resultado = {
      idCotacao: dadosComparacao.idCotacao,
      nomeFornecedor: dadosComparacao.nomeFornecedor,
      chavesAcessoNF: dadosComparacao.chavesAcessoNF,
      itensConciliados: [],
      itensSomenteCotacao: []
    };
    
    const cotacaoItensUtilizados = new Set();
    
    $('#comparison-table-body tr').each(function() {
      const row = $(this);
      const itemNFIndex = row.data('item-nf-index');
      const itemNF = dadosComparacao.itensNF[itemNFIndex];
      const selectedCotacaoIndex = row.find('.select-cotacao-item').val();
      
      if (selectedCotacaoIndex) {
        cotacaoItensUtilizados.add(parseInt(selectedCotacaoIndex));
        const itemCotacao = dadosComparacao.itensCotacao[selectedCotacaoIndex];
        const diffPreco = itemNF.precoNF - itemCotacao.preco;
        
        resultado.itensConciliados.push({
          subProduto: itemCotacao.subProduto,
          divergenciaNota: formatarMoeda(diffPreco),
          quantidadeNota: itemNF.qtdNF,
          precoNota: itemNF.precoNF
        });
      }
    });
    
    dadosComparacao.itensCotacao.forEach((item, index) => {
        if (!cotacaoItensUtilizados.has(index)) {
            resultado.itensSomenteCotacao.push(item);
        }
    });

    google.script.run
        .withSuccessHandler(function(res) {
            toggleLoader(false);
            if(res.success) {
                alert(res.message);
                resetarPagina();
            } else {
                onFailure(res);
            }
        })
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_salvarConciliacao(resultado);
  }

  function resetarPagina() {
      $('#etapa-comparacao').addClass('d-none');
      $('#card-selecao').removeClass('d-none');
      
      $('#nf-select').val(null).trigger('change');
      $('#cotacao-select').empty().append(new Option('Aguardando seleção da NF...', '', true, true)).prop('disabled', true).val('').trigger('change');
      $('#btn-comparar').prop('disabled', true);
      
      $('#comparison-table-body').empty();
      dadosComparacao = {};
  }

</script>