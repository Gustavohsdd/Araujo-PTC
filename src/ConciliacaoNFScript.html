<script>
// Variáveis globais
let todasAsCotacoes = [];
let todasAsNFs = [];
let todosOsItensNF = [];
let todosOsItensCotacao = [];
let todosOsDadosGeraisNF = [];
let mapaConciliacao = [];
let regrasRateio = [];
let stagedPayloads = [];
let ajusteModalInstance = null;
let activeItemForAdjustment = null; 
let selectedCotacaoItem = null; 

// ===== FUNÇÕES DE INICIALIZAÇÃO E SETUP =====
document.addEventListener('DOMContentLoaded', function() {
    ajusteModalInstance = new bootstrap.Modal(document.getElementById('ajusteManualModal'));
    toggleLoader(true);
    google.script.run
        .withSuccessHandler(onDadosIniciaisSuccess)
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_obterDadosParaPagina();
    addEventListeners();
});
function addEventListeners() {
    // Header
    $('#btn-upload-xml').on('click', () => $('#xml-upload-input').click());
    $('#xml-upload-input').on('change', onFileUpload);
    $('#btn-salvar-lote').on('click', onBtnSalvarLoteClick);
    $('#btn-abrir-relatorio-rateio').on('click', onAbrirRelatorioRateioClick); 
    // Painel Esquerdo
    $('#search-input').on('input', onSearchInputChange);
    $('#nf-list-container').on('click', '.nf-list-item:not(.staged)', onNfListItemClick);
    // Painel Direito
    $('#panel-direito').on('change', '.select-cotacao-fornecedor', onSelectCotacaoChange);
    $('#panel-direito').on('click', '#cotacao-items-list .list-group-item:not(.matched)', onCotacaoItemClick);
    $('#panel-direito').on('click', '#nf-items-list .list-group-item:not(.matched)', onNfItemClick);
    $('#panel-direito').on('click', '#btn-concluir-conciliacao', onBtnConcluirConciliacaoClick);
    // Rateio
    $('#panel-direito').on('click', '.btn-add-setor', onAdicionarSetorManualClick);
    $('#panel-direito').on('click', '.btn-remove-setor', onRemoverSetorManualClick);
    $('#panel-direito').on('input', '.input-porcentagem, .input-setor', onPorcentagemOuSetorChange);
    // Ajuste Manual
    $('#panel-direito').on('click', '.btn-ajuste-manual', onBtnAjusteManualClick);
    $('#panel-direito').on('click', '.btn-reajustar-item', onBtnReajustarItemClick);
    $('#btn-salvar-ajuste-manual').on('click', onBtnSalvarAjusteManualClick);
    $('#ajuste-fator').on('input', calcularVisualizacaoAjuste);
}
function resetApplication() {
    toggleLoader(true);
    stagedPayloads = [];
    atualizarBotaoSalvarLote();
    $('#workspace-content').addClass('d-none').empty();
    $('#workspace-welcome').removeClass('d-none');
    google.script.run
        .withSuccessHandler(onDadosIniciaisSuccess)
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_obterDadosParaPagina();
}

// ===== CALLBACKS DO SERVIDOR E PROCESSAMENTO DE DADOS =====
function onDadosIniciaisSuccess(response) {
    toggleLoader(false);
    if (!response.success) {
        alert('Erro ao carregar dados: ' + response.message);
        return;
    }
    todasAsNFs = response.dados.notasFiscais;
    todosOsItensNF = response.dados.itensNF;
    todosOsDadosGeraisNF = response.dados.dadosGeraisNF;
    todasAsCotacoes = response.dados.cotacoes;
    todosOsItensCotacao = response.dados.itensCotacao;
    mapaConciliacao = response.dados.mapeamentoConciliacao || [];
    regrasRateio = response.dados.regrasRateio || [];
    renderizarListaDeTrabalho();
}
function onFailure(error) {
    console.error('Erro na chamada ao servidor:', error);
    alert('Ocorreu um erro no servidor: ' + (error.message || 'Erro desconhecido.'));
    toggleLoader(false);
}

// ===== UPLOAD E PROCESSAMENTO DE XMLs =====
function onFileUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    toggleLoader(true);
    const filePromises = Array.from(files).map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve({ fileName: file.name, content: e.target.result.split(',')[1] });
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
    }));
    Promise.all(filePromises)
        .then(fileObjects => {
            google.script.run
                .withSuccessHandler(onUploadSuccess)
                .withFailureHandler(onFailure)
                .ConciliacaoNFController_uploadArquivos(fileObjects);
        })
        .catch(err => onFailure({ message: 'Erro ao ler arquivos: ' + err.message }));
    $(event.target).val('');
}
function onUploadSuccess(response) {
    alert(response.message);
    if (response.success) {
        resetApplication();
    } else {
        toggleLoader(false);
    }
}

// ===== PAINEL ESQUERDO (LISTA DE NFS) =====
function renderizarListaDeTrabalho() {
    const container = $('#nf-list-container').empty();
    if (todasAsNFs.length === 0) {
        container.html('<p class="p-3 text-muted text-center">Nenhuma nota fiscal pendente.</p>');
        return;
    }
    todasAsNFs.sort((a,b) => a.nomeEmitente.localeCompare(b.nomeEmitente) || a.numeroNF - b.numeroNF);
    todasAsNFs.forEach(nf => {
        const template = $('#template-nf-list-item').prop('content').cloneNode(true);
        const nfItem = $(template.querySelector('.nf-list-item'));
        nfItem.data('nf-info', nf);
        nfItem.find('.nf-title').text(`NF ${nf.numeroNF}`);
        nfItem.find('.nf-fornecedor').text(nf.nomeEmitente);
        nfItem.find('.nf-data').text(nf.dataEmissao);
        const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nf.chaveAcesso);
        nfItem.find('.nf-total').text(totaisNF ? formatarMoeda(totaisNF.valorTotalNf) : 'N/A');
        container.append(nfItem);
    });
}
function onSearchInputChange() {
    const searchTerm = $(this).val().toLowerCase().trim();
    $('#nf-list-container .nf-list-item').each(function() {
        const item = $(this);
        const nfInfo = item.data('nf-info');
        const textToSearch = `${nfInfo.nomeEmitente.toLowerCase()} ${nfInfo.numeroNF}`;
        item.toggle(textToSearch.includes(searchTerm));
    });
}

// ===== PAINEL DIREITO (WORKSPACE) =====
function onNfListItemClick() {
    const nfItem = $(this);
    if (nfItem.hasClass('staged')) return; 
    $('.nf-list-item.active').removeClass('active');
    nfItem.addClass('active');
    const nfInfo = nfItem.data('nf-info');
    const workspaceContent = $('#workspace-content');
    workspaceContent.data('active-nf', nfInfo);
    $('#workspace-welcome').addClass('d-none');
    const template = $('#template-workspace').prop('content').cloneNode(true);
    workspaceContent.empty().append(template).removeClass('d-none');
    const selectCotacao = workspaceContent.find('.select-cotacao-fornecedor');
    const cnpjFornecedor = (nfInfo.cnpjEmitente || '').replace(/[^\d]/g, '');
    const cotacoesDoFornecedor = todasAsCotacoes.filter(c => (c.fornecedorCnpj || '').replace(/[^\d]/g, '') === cnpjFornecedor);
    if (cotacoesDoFornecedor.length > 0) {
        cotacoesDoFornecedor.forEach(c => selectCotacao.append(new Option(`ID ${c.idCotacao} - ${c.fornecedor} (${c.dataAbertura})`, c.compositeKey)));
        selectCotacao.prop('disabled', false);
    } else {
        selectCotacao.append(new Option('Nenhuma cotação aberta para este CNPJ', '', true, true));
    }
    selectCotacao.select2({ theme: "bootstrap-5", dropdownParent: workspaceContent, width: '100%' });
    recalcularErenderizarResumoRateio();
}
function onSelectCotacaoChange() {
    const compositeKey = $(this).val();
    if (!compositeKey) return;
    const parts = compositeKey.split('-');
    const idCotacao = parts.shift();
    const nomeFornecedor = parts.join('-');
    const nfInfo = $('#workspace-content').data('active-nf');
    const itensNFNesteGrupo = todosOsItensNF.filter(item => item.chaveAcesso === nfInfo.chaveAcesso);
    const itensCotacaoSelecionada = todosOsItensCotacao.filter(item => item.idCotacao == idCotacao && item.fornecedor == nomeFornecedor);
    construirListasDeComparacao(itensCotacaoSelecionada, itensNFNesteGrupo);
    $('.comparison-container, #rateio-summary-section').removeClass('d-none');
    $('#btn-concluir-conciliacao').prop('disabled', false);
    tentarConciliacaoAutomatica();
    recalcularErenderizarResumoRateio();
}
function construirListasDeComparacao(itensCotacao, itensNF) {
    const cotacaoList = $('#cotacao-items-list .list-group').empty();
    const nfList = $('#nf-items-list .list-group').empty();
    itensCotacao.forEach(item => {
        const itemHtml = `<a href="#" class="list-group-item list-group-item-action"><div class="item-description">${item.subProduto}</div><small>Qtd: <strong>${item.qtdComprar.toFixed(2)}</strong> | Preço: <strong>${formatarMoeda(item.preco)}</strong></small></a>`;
        cotacaoList.append($(itemHtml).data('item-info', item));
    });
    itensNF.forEach(item => {
        const template = $('#template-nf-item').prop('content').cloneNode(true);
        const itemEl = $(template.children[0]);
        itemEl.find('.item-description').text(item.descricaoNF);
        itemEl.find('.original-qtd').text(item.qtdNF.toFixed(2));
        itemEl.find('.original-preco').text(formatarMoeda(item.precoNF));
        itemEl.data('item-info', item);
        nfList.append(itemEl);
    });
}

// ===== LÓGICA DE CONCILIAÇÃO, AJUSTE E RATEIO =====
function onCotacaoItemClick(e) {
    e.preventDefault();
    const itemEl = $(this);
    if (selectedCotacaoItem && selectedCotacaoItem[0] === itemEl[0]) {
        itemEl.removeClass('selected-for-match');
        selectedCotacaoItem = null;
    } else {
        $('#cotacao-items-list .list-group-item').removeClass('selected-for-match');
        itemEl.addClass('selected-for-match');
        selectedCotacaoItem = itemEl;
    }
}
function onNfItemClick(e) {
    e.preventDefault();
    if ($(e.target).closest('.btn-ajuste-manual').length > 0) return;
    if (!selectedCotacaoItem) {
        alert("Selecione primeiro um item da Cotação para ligar.");
        return;
    }
    conciliarItens(selectedCotacaoItem, $(this));
    selectedCotacaoItem.removeClass('selected-for-match');
    selectedCotacaoItem = null;
}
function tentarConciliacaoAutomatica() {
    $('#cotacao-items-list .list-group-item').each(function() {
        const cotItemEl = $(this);
        const cotItem = cotItemEl.data('item-info');
        const mapeamento = mapaConciliacao.find(m => m.itemCotacao === cotItem.subProduto);
        if (mapeamento) {
            $('#nf-items-list .list-group-item:not(.matched)').each(function() {
                const nfItemEl = $(this);
                if (nfItemEl.data('item-info').descricaoNF === mapeamento.descricaoNF) {
                    conciliarItens(cotItemEl, nfItemEl);
                    return false;
                }
            });
        }
    });
}
function conciliarItens(cotacaoItemEl, nfItemEl) {
    cotacaoItemEl.addClass('matched');
    nfItemEl.addClass('matched');
    const itemCot = cotacaoItemEl.data('item-info');
    const itemNF_Original = nfItemEl.data('item-info');
    const ajusteManual = nfItemEl.data('ajuste-manual');
    const itemNF_ParaComparar = ajusteManual ? { ...itemNF_Original, ...ajusteManual } : { ...itemNF_Original };
    const template = $('#template-matched-item').prop('content').cloneNode(true);
    const card = $(template.querySelector('.matched-item-card'));
    card.data('conciliacao-info', {
        itemCot: itemCot,
        itemNF_Original: itemNF_Original,
        itemNF_Ajustada: itemNF_ParaComparar,
        fator: ajusteManual ? ajusteManual.fator : 1
    });
    $('#matched-items-container').append(card);
    _atualizarVisualMatchedCard(card);
    _popularRateioDoCard(card);
    recalcularErenderizarResumoRateio();
}
function _atualizarVisualMatchedCard(card) {
    const info = card.data('conciliacao-info');
    if (!info) return;
    card.find('.item-cot-descricao').text(info.itemCot.subProduto);
    card.find('.item-nf-descricao').text(info.itemNF_Original.descricaoNF);
    const diffPreco = info.itemNF_Ajustada.precoNF - info.itemCot.preco;
    const diffQtd = info.itemNF_Ajustada.qtdNF - info.itemCot.qtdComprar;
    card.find('.divergencia-preco').html(Math.abs(diffPreco) < 0.01 ? `<span class="badge text-bg-success">OK</span>` : `<span class="badge text-bg-danger">${formatarMoeda(diffPreco)}</span>`);
    card.find('.divergencia-qtd').html(Math.abs(diffQtd) < 0.001 ? `<span class="badge text-bg-success">OK</span>` : `<span class="badge text-bg-warning">${diffQtd > 0 ? '+' : ''}${diffQtd.toFixed(2)}</span>`);
    const fatorInfoEl = card.find('.fator-info');
    if (info.fator !== 1) {
        fatorInfoEl.html(`<i class="bi bi-box-seam"></i> Fator: ${info.fator} | Qtd: ${info.itemNF_Ajustada.qtdNF.toFixed(2)}, Preço: ${formatarMoeda(info.itemNF_Ajustada.precoNF)}`);
    } else {
        fatorInfoEl.empty();
    }
}
function _popularRateioDoCard(card) {
    const info = card.data('conciliacao-info');
    if (!info) return;
    const uniqueId = "rateio-item-" + new Date().getTime() + Math.random();
    card.find('.collapse').attr('id', uniqueId);
    card.find('[data-bs-target^="#rateio-item-"]').attr('data-bs-target', '#' + uniqueId);
    const regrasDoItem = regrasRateio.filter(r => r.itemCotacao === info.itemCot.subProduto);
    const autoInfoContainer = card.find('.rateio-automatico-info');
    if (regrasDoItem.length > 0) {
        card.find('.btn-add-setor').hide();
        let infoText = '<strong>Rateio Automático:</strong> ';
        regrasDoItem.forEach(regra => { infoText += `${regra.porcentagem}% ${regra.setor}; `; });
        autoInfoContainer.html(infoText);
        card.data('rateio-info', { isAutomatico: true, regras: regrasDoItem });
    } else {
        card.data('rateio-info', { isAutomatico: false, regras: [] });
        onAdicionarSetorManualClick({ target: card.find('.btn-add-setor')[0] });
    }
    onPorcentagemOuSetorChange({ target: card.find('.rateio-section')[0] });
}
function onBtnAjusteManualClick(e) {
    e.preventDefault(); e.stopPropagation();
    activeItemForAdjustment = $(this).closest('.list-group-item');
    const itemNF_Original = activeItemForAdjustment.data('item-info');
    const itemCot = selectedCotacaoItem ? selectedCotacaoItem.data('item-info') : { subProduto: 'Nenhum item selecionado', qtdComprar: 0, preco: 0 };
    $('#ajuste-cot-descricao').text(itemCot.subProduto);
    $('#ajuste-cot-qtd').text(itemCot.qtdComprar.toFixed(2));
    $('#ajuste-cot-preco').text(formatarMoeda(itemCot.preco));
    $('#ajuste-nf-descricao').text(itemNF_Original.descricaoNF);
    $('#ajuste-nf-qtd').text(itemNF_Original.qtdNF.toFixed(2));
    $('#ajuste-nf-preco').text(formatarMoeda(itemNF_Original.precoNF));
    const ajusteExistente = activeItemForAdjustment.data('ajuste-manual');
    $('#ajuste-fator').val(ajusteExistente ? ajusteExistente.fator : 1);
    calcularVisualizacaoAjuste();
    ajusteModalInstance.show();
}
function onBtnReajustarItemClick(e) {
    e.preventDefault(); e.stopPropagation();
    activeItemForAdjustment = $(this).closest('.matched-item-card');
    const info = activeItemForAdjustment.data('conciliacao-info');
    $('#ajuste-cot-descricao').text(info.itemCot.subProduto);
    $('#ajuste-cot-qtd').text(info.itemCot.qtdComprar.toFixed(2));
    $('#ajuste-cot-preco').text(formatarMoeda(info.itemCot.preco));
    $('#ajuste-nf-descricao').text(info.itemNF_Original.descricaoNF);
    $('#ajuste-nf-qtd').text(info.itemNF_Original.qtdNF.toFixed(2));
    $('#ajuste-nf-preco').text(formatarMoeda(info.itemNF_Original.precoNF));
    $('#ajuste-fator').val(info.fator);
    calcularVisualizacaoAjuste();
    ajusteModalInstance.show();
}
function calcularVisualizacaoAjuste() {
    let itemNF_Original;
    if (activeItemForAdjustment.hasClass('matched-item-card')) {
        itemNF_Original = activeItemForAdjustment.data('conciliacao-info').itemNF_Original;
    } else {
        itemNF_Original = activeItemForAdjustment.data('item-info');
    }
    if (!itemNF_Original) return;
    const fator = parseFloat($('#ajuste-fator').val()) || 1;
    if (fator <= 0) return;
    const novaQtd = itemNF_Original.qtdNF * fator;
    const novoPreco = itemNF_Original.precoNF / fator;
    $('#ajuste-nova-qtd').text(novaQtd.toFixed(4));
    $('#ajuste-novo-preco').text(formatarMoeda(novoPreco));
}
function onBtnSalvarAjusteManualClick() {
    const fator = parseFloat($('#ajuste-fator').val());
    if (!fator || fator <= 0) {
        alert("Insira um fator válido (número maior que zero).");
        return;
    }
    if (activeItemForAdjustment.hasClass('matched-item-card')) {
        const info = activeItemForAdjustment.data('conciliacao-info');
        info.fator = fator;
        info.itemNF_Ajustada.qtdNF = info.itemNF_Original.qtdNF * fator;
        info.itemNF_Ajustada.precoNF = info.itemNF_Original.precoNF / fator;
        activeItemForAdjustment.data('conciliacao-info', info);
        _atualizarVisualMatchedCard(activeItemForAdjustment);
        recalcularErenderizarResumoRateio();
    } else {
        const itemNF_Original = activeItemForAdjustment.data('item-info');
        const dadosAjustados = {
            fator: fator,
            qtdNF: itemNF_Original.qtdNF * fator,
            precoNF: itemNF_Original.precoNF / fator
        };
        activeItemForAdjustment.data('ajuste-manual', dadosAjustados);
        activeItemForAdjustment.find('.ajuste-info').html(`<i class="bi bi-box-seam"></i> Fator ${fator} aplicado`);
    }
    ajusteModalInstance.hide();
}
function onAdicionarSetorManualClick(event) {
    const card = $(event.target).closest('.matched-item-card');
    if (card.data('rateio-info').isAutomatico) return;
    const linhasContainer = card.find('.rateio-manual-linhas');
    const template = $('#template-rateio-row').prop('content').cloneNode(true);
    linhasContainer.append(template);
}
function onRemoverSetorManualClick(event) {
    $(event.target).closest('.manual-rate-row').remove();
    onPorcentagemOuSetorChange(event);
}
function onPorcentagemOuSetorChange(event) {
    const card = $(event.target).closest('.matched-item-card');
    let totalPercent = 0;
    if (card.data('rateio-info').isAutomatico) {
        totalPercent = card.data('rateio-info').regras.reduce((sum, r) => sum + r.porcentagem, 0);
    } else {
        card.find('.input-porcentagem').each(function() {
            totalPercent += parseFloat($(this).val()) || 0;
        });
    }
    const totalEl = card.find('.total-percent-item');
    totalEl.text(`Total: ${totalPercent.toFixed(2)}%`).removeClass('is-invalid is-valid');
    if (Math.abs(totalPercent - 100) > 0.01) {
        totalEl.addClass('is-invalid');
    } else {
        totalEl.addClass('is-valid');
    }
    recalcularErenderizarResumoRateio();
}

// [ALTERADO] Função corrigida para incluir a pré-visualização do Contas a Pagar
function recalcularErenderizarResumoRateio() {
    const nfInfo = $('#workspace-content').data('active-nf');
    if (!nfInfo) return;
    const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nfInfo.chaveAcesso);
    if (!totaisNF) return;
    
    // Cálculos Gerais
    let totalConciliadoBruto = 0;
    const mapaSetorParaItens = {};
    $('.matched-item-card').each(function() {
        const info = $(this).data('conciliacao-info');
        totalConciliadoBruto += info.itemNF_Ajustada.qtdNF * info.itemNF_Ajustada.precoNF;
    });
    $('.total-notas-valor').text(formatarMoeda(totaisNF.valorTotalNf));
    $('.total-conciliado-valor').text(formatarMoeda(totalConciliadoBruto));
    $('.diferenca-totais-valor').text(formatarMoeda(totaisNF.valorTotalNf - totalConciliadoBruto));

    // Cálculos de Rateio
    const totaisPorSetor = {};
    const custosAdicionais = totaisNF.valorTotalNf - totalConciliadoBruto;
    $('.matched-item-card').each(function() {
        const card = $(this);
        const concInfo = card.data('conciliacao-info');
        const rateioInfo = card.data('rateio-info');
        const valorBrutoItem = concInfo.itemNF_Ajustada.qtdNF * concInfo.itemNF_Ajustada.precoNF;
        const proporcaoItem = totalConciliadoBruto > 0.01 ? valorBrutoItem / totalConciliadoBruto : 0;
        const custoEfetivoItem = valorBrutoItem + (custosAdicionais * proporcaoItem);
        const aplicarRateio = (setor, porcentagem) => {
            if (!setor || !porcentagem) return;
            setor = setor.trim();
            totaisPorSetor[setor] = (totaisPorSetor[setor] || 0) + (custoEfetivoItem * (porcentagem / 100));
            if (!mapaSetorParaItens[setor]) mapaSetorParaItens[setor] = new Set();
            mapaSetorParaItens[setor].add(concInfo.itemCot.subProduto);
        };
        if (rateioInfo.isAutomatico) {
            rateioInfo.regras.forEach(regra => aplicarRateio(regra.setor, regra.porcentagem));
        } else {
            card.find('.manual-rate-row').each(function() {
                aplicarRateio($(this).find('.input-setor').val(), parseFloat($(this).find('.input-porcentagem').val()) || 0);
            });
        }
    });

    // Renderiza Resumo do Rateio
    const resumoContainer = $('#resumo-setor-container').empty();
    let totalCalculado = Object.values(totaisPorSetor).reduce((s, v) => s + v, 0);
    let resumoHtml = '<ul class="list-group list-group-flush">';
    Object.keys(totaisPorSetor).sort().forEach(setor => {
        resumoHtml += `<li class="list-group-item d-flex justify-content-between"><span>${setor}</span> <strong>${formatarMoeda(totaisPorSetor[setor])}</strong></li>`;
    });
    resumoHtml += '</ul>';
    resumoContainer.html(resumoHtml);
    $('#total-rateado').text(formatarMoeda(totalCalculado));

    // ***** INÍCIO DA CORREÇÃO *****
    // Renderiza a Pré-visualização do Contas a Pagar
    const faturasContainer = $('#faturas-preview-container').empty();
    const faturas = totaisNF.faturas || [];
    const numFaturasOriginais = faturas.length > 0 ? faturas.length : 1;
    const numSetores = Object.keys(totaisPorSetor).length;
    const totalNovosTitulos = numFaturasOriginais * numSetores;

    if (totalNovosTitulos > 0) {
        faturasContainer.append(`<h6>Serão criados ${totalNovosTitulos} novo(s) título(s):</h6>`);
        let faturasHtml = '<ul class="list-group list-group-flush small">';
        if (faturas.length > 0 && totalCalculado > 0) {
            let novoNumeroParcela = 1;
            faturas.forEach(fatura => {
                Object.keys(totaisPorSetor).sort().forEach(setor => {
                    const valorRateadoParcela = (totaisPorSetor[setor] / totalCalculado) * fatura.valorParcela;
                    const numeroParcelaFormatado = `${novoNumeroParcela++}/${totalNovosTitulos} (Ref: ${fatura.numeroParcela})`;
                    const vencimento = new Date(fatura.dataVencimento).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    faturasHtml += `<li class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <span>${setor} - Parc. ${numeroParcelaFormatado}</span>
                            <strong>${formatarMoeda(valorRateadoParcela)}</strong>
                        </div>
                        <div class="text-muted">Venc: ${vencimento}</div>
                    </li>`;
                });
            });
        } else if (totalCalculado > 0) { // Pagamento à vista
            Object.keys(totaisPorSetor).sort().forEach(setor => {
                const valorRateado = totaisPorSetor[setor];
                faturasHtml += `<li class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <span>${setor}</span>
                        <strong>${formatarMoeda(valorRateado)}</strong>
                    </div>
                    <div class="text-muted">Pagamento à Vista</div>
                </li>`;
            });
        } else {
             faturasHtml += '<li class="list-group-item text-muted">Nenhum valor a ser rateado.</li>';
        }
        faturasHtml += '</ul>';
        faturasContainer.html(faturasHtml);
    } else {
        faturasContainer.html('<p class="text-muted small">Nenhuma pré-visualização disponível.</p>');
    }
    // ***** FIM DA CORREÇÃO *****
}

// ===== SALVAMENTO EM LOTE =====
function onBtnConcluirConciliacaoClick() {
    let erroValidacao = false;
    $('.matched-item-card').each(function() {
        if ($(this).find('.total-percent-item').hasClass('is-invalid')) {
            alert(`Erro: O rateio do item "${$(this).find('.item-cot-descricao').text()}" não soma 100%.`);
            erroValidacao = true; return false;
        }
    });
    if (erroValidacao) return;

    const workspace = $('#workspace-content');
    const nfInfo = workspace.data('active-nf');
    const compositeKey = workspace.find('.select-cotacao-fornecedor').val();
    const [idCotacao, ...nomeFornecedorParts] = compositeKey.split('-');
    const nomeFornecedor = nomeFornecedorParts.join('-');

    // 1. Payload da Conciliação
    const conciliacaoPayload = { idCotacao, nomeFornecedor, numeroNF: nfInfo.numeroNF, chavesAcessoNF: [nfInfo.chaveAcesso], itensConciliados: [], novosMapeamentos: [] };
    const itensCortados = [];
    $('.matched-item-card').each(function() {
        const info = $(this).data('conciliacao-info');
        conciliacaoPayload.itensConciliados.push({
            subProduto: info.itemCot.subProduto, 
            quantidadeNota: info.itemNF_Ajustada.qtdNF,
            precoNota: info.itemNF_Ajustada.precoNF,
            divergenciaNota: formatarMoeda(info.itemNF_Ajustada.precoNF - info.itemCot.preco)
        });
        conciliacaoPayload.novosMapeamentos.push({
            itemCotacao: info.itemCot.subProduto, 
            descricaoNF: info.itemNF_Original.descricaoNF,
            gtin: info.itemNF_Original.gtin || ''
        });
    });
    $('#cotacao-items-list .list-group-item:not(.matched)').each(function() {
        itensCortados.push({ idCotacao, nomeFornecedor, subProduto: $(this).data('item-info').subProduto });
    });

    // 2. Payload do Rateio
    const totaisPorSetor = {};
    const novasRegras = [];
    const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nfInfo.chaveAcesso);
    const totalConciliadoBruto = conciliacaoPayload.itensConciliados.reduce((sum, item) => sum + (item.quantidadeNota * item.precoNota), 0);
    const custosAdicionais = totaisNF.valorTotalNf - totalConciliadoBruto;
    
    // [NOVO] Cria o mapa de Setor -> Itens para enviar ao backend
    const mapaSetorParaItens = {};

    $('.matched-item-card').each(function() {
        const card = $(this);
        const concInfo = card.data('conciliacao-info');
        const rateioInfo = card.data('rateio-info');
        const valorBrutoItem = concInfo.itemNF_Ajustada.qtdNF * concInfo.itemNF_Ajustada.precoNF;
        const proporcaoItem = totalConciliadoBruto > 0.01 ? valorBrutoItem / totalConciliadoBruto : 0;
        const custoEfetivoItem = valorBrutoItem + (custosAdicionais * proporcaoItem);
        
        const aplicarRateio = (setor, porcentagem) => {
            if (!setor || !porcentagem) return;
            setor = setor.trim();
            totaisPorSetor[setor] = (totaisPorSetor[setor] || 0) + (custoEfetivoItem * (porcentagem / 100));
            // Adiciona o item da cotação ao mapa do setor
            if (!mapaSetorParaItens[setor]) mapaSetorParaItens[setor] = new Set();
            mapaSetorParaItens[setor].add(concInfo.itemCot.subProduto);
        };

        if (rateioInfo.isAutomatico) {
            rateioInfo.regras.forEach(regra => aplicarRateio(regra.setor, regra.porcentagem));
        } else {
            card.find('.manual-rate-row').each(function() {
                const setor = $(this).find('.input-setor').val().trim();
                const porcentagem = parseFloat($(this).find('.input-porcentagem').val()) || 0;
                aplicarRateio(setor, porcentagem);
                if(setor && porcentagem > 0) novasRegras.push({ itemCotacao: concInfo.itemCot.subProduto, setor, porcentagem });
            });
        }
    });

    // Converte os Sets em Arrays para o JSON
    for(const setor in mapaSetorParaItens){
      mapaSetorParaItens[setor] = Array.from(mapaSetorParaItens[setor]);
    }

    const rateioPayload = { 
        chaveAcesso: nfInfo.chaveAcesso, 
        totaisPorSetor, 
        novasRegras, 
        numeroNF: nfInfo.numeroNF,
        mapaSetorParaItens: mapaSetorParaItens // [NOVO] Adiciona o mapa ao payload
    };

    // 3. Adicionar ao Lote
    stagedPayloads.push({
        conciliacoes: [conciliacaoPayload], 
        itensCortados, 
        novosMapeamentos: conciliacaoPayload.novosMapeamentos,
        rateios: [rateioPayload], 
        statusUpdates: []
    });

    // 4. Atualizar UI
    $(`.nf-list-item`).filter((i, el) => $(el).data('nf-info').chaveAcesso === nfInfo.chaveAcesso)
        .addClass('staged').removeClass('active').find('.status-icon').removeClass('d-none');
    workspace.addClass('d-none').empty();
    $('#workspace-welcome').removeClass('d-none');
    atualizarBotaoSalvarLote();
}

function onBtnSalvarLoteClick() {
    if (stagedPayloads.length === 0) return;
    toggleLoader(true);
    const payloadFinal = stagedPayloads.reduce((acc, current) => {
        acc.conciliacoes.push(...(current.conciliacoes || []));
        acc.itensCortados.push(...(current.itensCortados || []));
        acc.novosMapeamentos.push(...(current.novosMapeamentos || []));
        acc.statusUpdates.push(...(current.statusUpdates || []));
        acc.rateios.push(...(current.rateios || []));
        return acc;
    }, { conciliacoes: [], itensCortados: [], novosMapeamentos: [], statusUpdates: [], rateios: [] });
    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                alert(response.message);
                resetApplication();
            } else { onFailure(response); }
        })
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_salvarLoteUnificado(payloadFinal);
}
function atualizarBotaoSalvarLote() {
    const btn = $('#btn-salvar-lote');
    const count = stagedPayloads.length;
    if (count > 0) {
        btn.find('#save-batch-text').text(`Salvar ${count} Alteração(ões)`);
        btn.removeClass('d-none');
    } else {
        btn.addClass('d-none');
    }
}

// ===== FUNÇÕES UTILITÁRIAS =====
function toggleLoader(show) {
    $('#loader').toggleClass('d-none', !show);
}
function formatarMoeda(valor) {
    if (typeof valor !== 'number' || isNaN(valor)) return "R$ 0,00";
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

/**
 * Abre a página do Relatório de Rateio em uma nova aba.
 */
function onAbrirRelatorioRateioClick() {
    toggleLoader(true);
    // Esta função já existe no seu App.js e é perfeita para isso.
    google.script.run
        .withSuccessHandler(response => {
            toggleLoader(false);
            if (response.success && response.url) {
                window.open(response.url, '_blank');
            } else {
                onFailure({ message: response.message || 'Não foi possível obter a URL do relatório.' });
            }
        })
        .withFailureHandler(onFailure)
        .App_obterUrlWebApp({ view: 'relatoriorateio' });
}
</script>