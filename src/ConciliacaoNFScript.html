<script>
  let todasAsCotacoes = [];
  let todasAsNFs = [];
  let todosOsItensNF = [];
  let todosOsItensCotacao = [];
  let todosOsDadosGeraisNF = [];

  function normalizarCNPJ(cnpj) {
    return cnpj ? String(cnpj).replace(/[^\d]/g, '') : '';
  }
  
  function formatarMoeda(valor) {
    if (typeof valor !== 'number' || isNaN(valor)) {
      return "R$ 0,00";
    }
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }
  
  function toggleLoader(show) {
    document.getElementById('loader').classList.toggle('d-none', !show);
  }

  document.addEventListener('DOMContentLoaded', function() {
    toggleLoader(true);
    google.script.run
      .withSuccessHandler(onDadosIniciaisSuccess)
      .withFailureHandler(onFailure)
      .ConciliacaoNFController_obterDadosParaPagina();
      
    addEventListeners();
  });
  
  function addEventListeners() {
    $('#btn-processar-xml').on('click', onBtnProcessarXmlClick);
    $('#search-input').on('input', onSearchInputChange);
    $('#card-selecao').on('change', '.nf-select-checkbox', onNfCardSelectionChange);
    $('#btn-processar-selecao').on('click', onBtnProcessarClick);
    $('#accordion-container').on('show.bs.collapse', onAccordionOpen);
    $('#accordion-container').on('change', '.select-cotacao-item', onAccordionCotacaoChange);
    $('#accordion-container').on('click', '.btn-save', onBtnSaveAccordionClick);
    $('#accordion-container').on('click', '.btn-cancel', onBtnCancelAccordionClick);
  }

  function onBtnProcessarXmlClick() {
    const btn = $('#btn-processar-xml');
    const originalContent = btn.html();
    
    btn.prop('disabled', true).html(`<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span><span>Processando...</span>`);

    google.script.run
        .withSuccessHandler(function() {
            alert('Processamento de novos arquivos XML concluído. A página será atualizada para exibir as novas notas.');
            location.reload();
        })
        .withFailureHandler(function(error) {
            btn.prop('disabled', false).html(originalContent);
            onFailure(error);
        })
        .ConciliacaoNFController_processarXmlsDaPasta();
  }

  function onSearchInputChange() {
      const searchTerm = $(this).val().toLowerCase().trim();
      $('#nf-cards-container > div').each(function() {
        const cardContainer = $(this);
        const card = cardContainer.find('.card');
        const nfInfo = card.data('nf-info');
        let cardText = '';

        if (nfInfo) {
          cardText += `${nfInfo.numeroNF} ${nfInfo.nomeEmitente}`.toLowerCase();
        }

        card.find('.nf-items-body tr').each(function() {
          cardText += $(this).find('td:first').text().toLowerCase();
        });

        const isMatch = cardText.includes(searchTerm);
        cardContainer.toggle(isMatch);
      });
  }

  function onDadosIniciaisSuccess(response) {
    toggleLoader(false);
    if (!response.success) {
      alert('Erro ao carregar dados: ' + response.message);
      return;
    }
    todasAsNFs = response.dados.notasFiscais;
    todosOsItensNF = response.dados.itensNF;
    todosOsDadosGeraisNF = response.dados.dadosGeraisNF;
    todasAsCotacoes = response.dados.cotacoes;
    todosOsItensCotacao = response.dados.itensCotacao;

    const cardsContainer = $('#nf-cards-container');
    cardsContainer.empty();

    if (todasAsNFs.length === 0) {
        cardsContainer.html('<div class="col-12"><p class="text-center text-muted mt-3">Nenhuma nota fiscal pendente de conciliação foi encontrada.</p></div>');
        return;
    }

    todasAsNFs.forEach(nf => {
      const template = document.getElementById('template-nf-card').content.cloneNode(true);
      const cardContainer = $(template.querySelector('div')); 
      const card = cardContainer.find('.card');

      card.data('nf-info', nf);
      card.find('.nf-title').text(`NF ${nf.numeroNF} - ${nf.nomeEmitente}`);
      card.find('.nf-data').text(nf.dataEmissao);
      const totaisNF = todosOsDadosGeraisNF.find(t => t.chaveAcesso === nf.chaveAcesso);
      card.find('.nf-total').text(totaisNF ? formatarMoeda(totaisNF.valorTotalNf) : 'N/A');

      const itemsBody = card.find('.nf-items-body');
      const itensDaNF = todosOsItensNF.filter(i => i.chaveAcesso === nf.chaveAcesso);
      itensDaNF.forEach(item => {
        itemsBody.append(`<tr><td>${item.descricaoNF}</td><td class="text-end">${item.qtdNF.toFixed(2)}</td><td class="text-end">${formatarMoeda(item.precoNF)}</td></tr>`);
      });
      cardsContainer.append(cardContainer);
    });
  }
  
  function onNfCardSelectionChange() {
    const anySelected = $('#nf-cards-container .nf-select-checkbox:checked').length > 0;
    $('#btn-processar-selecao').prop('disabled', !anySelected);
  }
  
  function onBtnProcessarClick() {
    const nfsParaConciliar = [];
    const chavesNfsSemPedido = [];

    $('#nf-cards-container .nf-select-checkbox:checked').each(function() {
      const card = $(this).closest('.card');
      const nfInfo = card.data('nf-info');
      const isSemPedido = card.find('.nf-sem-pedido-checkbox').is(':checked');

      if (isSemPedido) {
        chavesNfsSemPedido.push(nfInfo.chaveAcesso);
      } else {
        nfsParaConciliar.push(nfInfo);
      }
    });

    toggleLoader(true);

    if (chavesNfsSemPedido.length > 0) {
      google.script.run
        .withSuccessHandler(response => {
          onMarcarSemPedidoSuccess(response, chavesNfsSemPedido);
          prepararConciliacaoNormal(nfsParaConciliar);
        })
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_marcarNFsSemPedido(chavesNfsSemPedido);
    } else {
      prepararConciliacaoNormal(nfsParaConciliar);
    }
  }

  function onMarcarSemPedidoSuccess(response, chavesProcessadas) {
    if (response.success) {
      console.log(response.message);
      chavesProcessadas.forEach(chave => {
        $(`.card`).filter(function() {
            return $(this).data('nf-info').chaveAcesso === chave;
        }).closest('.col-xl-4').remove();
      });
    } else {
      alert('Erro ao marcar NFs como "Sem Pedido": ' + response.message);
    }
    onNfCardSelectionChange();
  }

  function prepararConciliacaoNormal(nfsParaConciliar) {
    const accordionContainer = $('#accordion-container');
    accordionContainer.empty();

    if (nfsParaConciliar.length === 0) {
      toggleLoader(false);
      if ($('#nf-cards-container > div').length === 0) {
        $('#card-selecao').hide();
        accordionContainer.html('<div class="alert alert-success text-center">Todas as operações foram concluídas com sucesso.</div>');
      }
      return;
    }
    
    nfsParaConciliar.forEach((nfInfo, index) => {
      const template = document.getElementById('template-accordion-item').content.cloneNode(true);
      const accordionItem = $(template.querySelector('.accordion-item'));

      accordionItem.find('.accordion-button').attr('data-bs-target', `#collapse-${index}`).attr('aria-controls', `collapse-${index}`);
      accordionItem.find('.accordion-collapse').attr('id', `collapse-${index}`);
      accordionItem.data('chave-acesso', nfInfo.chaveAcesso);
      accordionItem.data('nf-info', nfInfo);
      accordionItem.find('.header-text').text(`NF ${nfInfo.numeroNF} - ${nfInfo.nomeEmitente}`);
      accordionContainer.append(accordionItem);
    });

    $('#card-selecao').addClass('d-none');
    toggleLoader(false);
    
    if (nfsParaConciliar.length > 0) {
      new bootstrap.Collapse(accordionContainer.find('.accordion-collapse').first(), { toggle: true });
    }
  }

  function onFailure(error) {
    console.error('Erro na chamada ao servidor:', error);
    alert('Ocorreu um erro: ' + error.message);
    toggleLoader(false);
  }
  
  function onAccordionOpen(event) {
      const accordionItem = $(event.target).closest('.accordion-item');
      if (accordionItem.data('loaded')) return;

      const nfInfo = accordionItem.data('nf-info');
      const selectCotacao = accordionItem.find('.select-cotacao-item');
      const cnpjNormalizadoNF = normalizarCNPJ(nfInfo.cnpjEmitente);
      const cotacoesFiltradas = todasAsCotacoes.filter(c => normalizarCNPJ(c.fornecedorCnpj) === cnpjNormalizadoNF);
      
      selectCotacao.empty().append(new Option('Selecione a cotação...', '', true, true));
      if(cotacoesFiltradas.length > 0) {
          cotacoesFiltradas.forEach(c => {
              selectCotacao.append(new Option(`ID ${c.idCotacao} - ${c.fornecedor} (${c.dataAbertura})`, c.compositeKey));
          });
          selectCotacao.prop('disabled', false);
      } else {
          selectCotacao.append(new Option('Nenhuma cotação aberta para este fornecedor', '', true, true)).prop('disabled', true);
      }
      
      selectCotacao.select2({ theme: "bootstrap-5", dropdownParent: accordionItem });
      accordionItem.data('loaded', true);
  }

  function onAccordionCotacaoChange(event) {
    const select = $(event.target);
    const accordionItem = select.closest('.accordion-item');
    const comparisonContainer = accordionItem.find('.comparison-container');
    const totaisContainer = accordionItem.find('.totais-nf-container');
    const compositeKey = select.val();
    const chaveAcesso = accordionItem.data('chave-acesso');

    if (!compositeKey) {
        comparisonContainer.addClass('d-none');
        totaisContainer.addClass('d-none');
        return;
    }
    
    toggleLoader(true);
    
    const parts = compositeKey.split('-');
    const idCotacao = parts.shift();
    const nomeFornecedor = parts.join('-');
    
    const itensNFFiltrados = todosOsItensNF.filter(item => item.chaveAcesso === chaveAcesso);
    const itensCotacaoFiltrados = todosOsItensCotacao.filter(item => item.idCotacao == idCotacao && item.fornecedor == nomeFornecedor);
    const dadosGeraisNFFiltrados = todosOsDadosGeraisNF.filter(total => total.chaveAcesso === chaveAcesso);

    const dadosParaPagina = {
      idCotacao: idCotacao,
      nomeFornecedor: nomeFornecedor,
      chavesAcessoNF: [chaveAcesso],
      itensCotacao: itensCotacaoFiltrados,
      itensNF: itensNFFiltrados,
      dadosGeraisNF: dadosGeraisNFFiltrados,
      analisePrazo: {}
    };

    onCompareSuccess({ success: true, dados: dadosParaPagina }, accordionItem);
  }

  function onCompareSuccess(response, accordionItem) {
      toggleLoader(false);
      if (!response.success) {
          onFailure(response);
          return;
      }
      const dados = response.dados;
      accordionItem.data('dados-comparacao', dados);

      const totaisContainer = accordionItem.find('.totais-nf-container');
      const totaisNF = dados.dadosGeraisNF && dados.dadosGeraisNF[0] ? dados.dadosGeraisNF[0] : null;

      if (totaisNF) {
        const impostosSum = (totaisNF.totalValorIcms || 0) + (totaisNF.totalValorIcmsSt || 0) + (totaisNF.totalValorPis || 0) + (totaisNF.totalValorCofins || 0);
        totaisContainer.find('.total-produtos').text(formatarMoeda(totaisNF.totalValorProdutos));
        totaisContainer.find('.total-frete').text(formatarMoeda(totaisNF.totalValorFrete));
        totaisContainer.find('.total-ipi').text(formatarMoeda(totaisNF.totalValorIpi));
        totaisContainer.find('.total-outras').text(formatarMoeda(totaisNF.totalOutrasDespesas));
        totaisContainer.find('.total-desconto').text(formatarMoeda(totaisNF.totalValorDesconto));
        totaisContainer.find('.total-impostos').text(formatarMoeda(impostosSum));
        totaisContainer.find('.valor-total').text(formatarMoeda(totaisNF.valorTotalNf));
        totaisContainer.removeClass('d-none');
      }

      construirTabelaComparacao(accordionItem, dados.itensNF, dados.itensCotacao);
      accordionItem.find('.comparison-container').removeClass('d-one');
  }

  function construirTabelaComparacao(accordionItem, itensNF, itensCotacao) {
      const tbody = accordionItem.find('.comparison-table-body');
      tbody.empty();
      
      itensNF.forEach((itemNF, index) => {
        const subtotalNF = itemNF.qtdNF * itemNF.precoNF;
        const rowHTML = `
          <tr data-item-nf-index="${index}">
            <td>${itemNF.descricaoNF}</td>
            <td class="dados-condensados text-end">
              <div><small>Qtd:</small> <span>${itemNF.qtdNF.toFixed(2)}</span></div>
              <div><small>Preço:</small> <span>${formatarMoeda(itemNF.precoNF)}</span></div>
              <div><small>Subtotal:</small> <strong class="text-primary">${formatarMoeda(subtotalNF)}</strong></div>
            </td>
            <td><select class="form-select select-item-match"></select></td>
            <td class="dados-condensados text-end">
              <div><small>Qtd Pedida:</small> <span class="cot-qtd"></span></div>
              <div><small>Preço Unit.:</small> <span class="cot-preco"></span></div>
              <div><small>Preço Fator:</small> <span class="cot-preco-fator"></span></div>
            </td>
            <td class="dados-condensados text-center">
              <div><small>Div. Preço:</small> <span class="divergencia-preco fw-bold"></span></div>
              <div><small>Div. Qtd:</small> <span class="divergencia-qtd fw-bold"></span></div>
            </td>
          </tr>
        `;
        const row = $(rowHTML);
        
        const selectMatch = row.find('.select-item-match');
        selectMatch.append(new Option('Escolha o item...', '', true, true));
        itensCotacao.forEach((itemCot, cotIndex) => {
            const option = new Option(`${itemCot.subProduto} (Qtd: ${itemCot.qtdComprar})`, cotIndex);
            $(option).data('item-cot', itemCot);
            selectMatch.append(option);
        });
        
        tbody.append(row);
      });

      tbody.find('.select-item-match').select2({ theme: "bootstrap-5", allowClear: true, dropdownParent: accordionItem })
        .on('change', onMatchItem);
  }

  function onMatchItem(event) {
    const select = $(event.target);
    const selectedOption = select.find('option:selected');
    const row = select.closest('tr');
    
    row.find('.cot-qtd, .cot-preco, .cot-preco-fator, .divergencia-preco, .divergencia-qtd').empty().removeClass('text-success text-danger text-warning');

    if (!select.val()) return;
    
    const itemCotacao = $(selectedOption).data('item-cot');
    const accordionItem = row.closest('.accordion-item');
    const dadosComparacao = accordionItem.data('dados-comparacao');
    const itemNFIndex = row.data('item-nf-index');
    const itemNF = dadosComparacao.itensNF[itemNFIndex];
    
    row.find('.cot-qtd').text(itemCotacao.qtdComprar.toFixed(2));
    row.find('.cot-preco').text(formatarMoeda(itemCotacao.preco));
    row.find('.cot-preco-fator').text(formatarMoeda(itemCotacao.precoPorFator));

    const diffPreco = itemNF.precoNF - itemCotacao.preco;
    const diffPrecoFator = itemNF.precoNF - itemCotacao.precoPorFator;
    const elDivPreco = row.find('.divergencia-preco');
    if (Math.abs(diffPreco) < 0.01 || Math.abs(diffPrecoFator) < 0.01) {
        elDivPreco.text('OK').addClass('text-success');
    } else {
        elDivPreco.text(formatarMoeda(Math.abs(diffPreco) < Math.abs(diffPrecoFator) ? diffPreco : diffPrecoFator)).addClass('text-danger');
    }

    const diffQtd = itemNF.qtdNF - itemCotacao.qtdComprar;
    const elDivQtd = row.find('.divergencia-qtd');
    if (Math.abs(diffQtd) < 0.001) {
        elDivQtd.text('OK').addClass('text-success');
    } else if (diffQtd < 0) {
        elDivQtd.text(`${diffQtd.toFixed(2)}`).addClass('text-danger');
    } else {
        elDivQtd.text(`+${diffQtd.toFixed(2)}`).addClass('text-warning');
    }
  }

  function onBtnSaveAccordionClick(event) {
    const accordionItem = $(event.target).closest('.accordion-item');
    const dadosComparacao = accordionItem.data('dados-comparacao');
    if (!dadosComparacao) return;

    toggleLoader(true);
    const resultado = {
      idCotacao: dadosComparacao.idCotacao,
      nomeFornecedor: dadosComparacao.nomeFornecedor,
      chavesAcessoNF: dadosComparacao.chavesAcessoNF,
      itensConciliados: [],
      itensSomenteCotacao: []
    };
    
    const itensCotacaoConciliados = new Set();
    accordionItem.find('.comparison-table-body tr').each(function() {
      const row = $(this);
      const selectedMatch = row.find('.select-item-match option:selected');
      if (selectedMatch.val()) {
          const itemCot = $(selectedMatch).data('item-cot');
          const itemNF = dadosComparacao.itensNF[row.data('item-nf-index')];
          itensCotacaoConciliados.add(itemCot.subProduto);
          resultado.itensConciliados.push({
            subProduto: itemCot.subProduto,
            divergenciaNota: formatarMoeda(itemNF.precoNF - itemCot.preco),
            quantidadeNota: itemNF.qtdNF,
            precoNota: itemNF.precoNF
          });
      }
    });

    resultado.itensSomenteCotacao = dadosComparacao.itensCotacao.filter(item => !itensCotacaoConciliados.has(item.subProduto));

    google.script.run
        .withSuccessHandler(res => onSaveSuccess(res, accordionItem))
        .withFailureHandler(onFailure)
        .ConciliacaoNFController_salvarConciliacao(resultado);
  }

  function onSaveSuccess(response, accordionItem) {
    toggleLoader(false);
    if (response.success) {
        accordionItem.find('.accordion-button').addClass('bg-success-subtle');
        accordionItem.find('.status-badge').text('Conciliado').removeClass('d-none text-bg-light').addClass('text-bg-success');
        accordionItem.find('.accordion-body').empty().html(`<div class="p-3 text-center text-success fw-bold">${response.message}</div>`);
        const collapse = bootstrap.Collapse.getInstance(accordionItem.find('.accordion-collapse'));
        if (collapse) collapse.hide();
    } else {
        onFailure(response);
    }
  }
  
  function onBtnCancelAccordionClick(event) {
    const accordionItem = $(event.target).closest('.accordion-item');
    accordionItem.find('.select-cotacao-item').val('').trigger('change');
    accordionItem.find('.comparison-container').addClass('d-none');
    accordionItem.find('.totais-nf-container').addClass('d-none');
    accordionItem.find('.comparison-table-body').empty();
  }
</script>