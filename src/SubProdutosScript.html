<script>
function initSubProdutosScript() {
  // IDs dos Elementos do DOM (Principais e Modais)
  const SubProdutosScript_ID_TABELA_SUBPRODUTOS = 'SubProdutosScript_tabelaSubProdutos';
  const SubProdutosScript_ID_MENSAGEM_FEEDBACK_GLOBAL = 'SubProdutosScript_mensagemFeedbackGlobal';
  const SubProdutosScript_ID_CONTROLES_PAGINACAO = 'SubProdutosScript_controlesPaginacao';
  const SubProdutosScript_ID_CAMPO_BUSCA = 'SubProdutosScript_campoBusca';

  // IDs do Painel de Ações Global
  const SubProdutosScript_ID_BTN_NOVO_SUBPRODUTO_GLOBAL = 'SubProdutosScript_btnNovoSubProdutoGlobal';
  const SubProdutosScript_ID_BTN_CADASTRAR_MULTIPLOS_GLOBAL = 'SubProdutosScript_btnCadastrarMultiplosGlobal';
  const SubProdutosScript_ID_BTN_EDITAR_GLOBAL = 'SubProdutosScript_btnEditarGlobal';
  const SubProdutosScript_ID_BTN_EXCLUIR_GLOBAL = 'SubProdutosScript_btnExcluirGlobal';

  // IDs do Modal Principal de SubProduto (Individual)
  const SubProdutosScript_ID_MODAL_SUBPRODUTO = 'SubProdutosScript_modalSubProduto';
  const SubProdutosScript_ID_TITULO_MODAL_SUBPRODUTO = 'SubProdutosScript_tituloModalSubProduto';
  const SubProdutosScript_ID_FORM_SUBPRODUTO = 'SubProdutosScript_formSubProduto';
  const SubProdutosScript_ID_DIV_ID_EXIBICAO_MODAL_SUBPRODUTO = 'SubProdutosScript_divIdExibicaoModalSubProduto';
  const SubProdutosScript_ID_CAMPO_ID_EXIBICAO_MODAL_SUBPRODUTO = 'SubProdutosScript_campoIdExibicaoModalSubProduto';
  const SubProdutosScript_ID_CAMPO_ID_FORM_MODAL_SUBPRODUTO = 'SubProdutosScript_campoIdFormModalSubProduto';
  const SubProdutosScript_ID_BTN_FECHAR_MODAL_SUBPRODUTO = 'SubProdutosScript_btnFecharModalSubProduto';
  const SubProdutosScript_ID_BTN_CANCELAR_MODAL_SUBPRODUTO = 'SubProdutosScript_btnCancelarModalSubProduto';
  const SubProdutosScript_ID_BTN_SALVAR_MODAL_SUBPRODUTO = 'SubProdutosScript_btnSalvarModalSubProduto';
  const SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO = 'SubProdutosScript_mensagemErroModalSubProduto';
  const SubProdutosScript_ID_INPUT_NOME_SUBPRODUTO = 'SubProdutosScript_inputNomeSubProduto';
  const SubProdutosScript_ID_SELECT_PRODUTO_VINCULADO_SUBPRODUTO = 'SubProdutosScript_selectProdutoVinculadoSubProduto';
  const SubProdutosScript_ID_SELECT_FORNECEDOR_SUBPRODUTO = 'SubProdutosScript_selectFornecedorSubProduto';


  // IDs do Modal de Confirmação de Exclusão de SubProduto
  const SubProdutosScript_ID_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO = 'SubProdutosScript_modalConfirmarExclusaoSubProduto';
  const SubProdutosScript_ID_NOME_SUBPRODUTO_EXCLUIR_MODAL = 'SubProdutosScript_nomeSubProdutoParaExcluirModal';
  const SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO = 'SubProdutosScript_mensagemErroModalConfirmarExclusaoSubProduto';
  const SubProdutosScript_ID_BTN_FECHAR_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO = 'SubProdutosScript_btnFecharModalConfirmarExclusaoSubProduto';
  const SubProdutosScript_ID_BTN_CANCELAR_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO = 'SubProdutosScript_btnCancelarModalConfirmarExclusaoSubProduto';
  const SubProdutosScript_ID_BTN_CONFIRMAR_EXCLUSAO_DEFINITIVA_SUBPRODUTO = 'SubProdutosScript_btnConfirmarExclusaoDefinitivaSubProduto';

  // IDs do Modal de Cadastrar Múltiplos SubProdutos
  const SubProdutosScript_ID_MODAL_CADASTRAR_MULTIPLOS_SUBPRODUTOS = 'SubProdutosScript_modalCadastrarMultiplosSubProdutos';
  const SubProdutosScript_ID_FORM_CADASTRAR_MULTIPLOS_SUBPRODUTOS = 'SubProdutosScript_formCadastrarMultiplosSubProdutos';
  const SubProdutosScript_ID_BTN_FECHAR_MODAL_CADASTRAR_MULTIPLOS_SUBPRODUTOS = 'SubProdutosScript_btnFecharModalCadastrarMultiplosSubProdutos';
  const SubProdutosScript_ID_BTN_CANCELAR_MODAL_MULTIPLOS_SUBPRODUTOS = 'SubProdutosScript_btnCancelarModalMultiplosSubProdutos';
  const SubProdutosScript_ID_BTN_SALVAR_MODAL_MULTIPLOS_SUBPRODUTOS = 'SubProdutosScript_btnSalvarModalMultiplosSubProdutos';
  const SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS = 'SubProdutosScript_mensagemErroModalMultiplosSubProdutos';
  // const SubProdutosScript_ID_MULTI_SELECT_PRODUTO_VINCULADO = 'SubProdutosScript_multiSelectProdutoVinculado'; // Removido - agora é por linha
  const SubProdutosScript_ID_MULTI_SELECT_FORNECEDOR = 'SubProdutosScript_multiSelectFornecedor';
  const SubProdutosScript_ID_CONTAINER_LINHAS_MULTIPLOS_SUBPRODUTOS = 'SubProdutosScript_containerLinhasMultiplosSubProdutos';
  const SubProdutosScript_ID_BTN_ADICIONAR_LINHA_MULTIPLOS = 'SubProdutosScript_btnAdicionarLinhaMultiplos';


  // Variáveis de estado
  let SubProdutosScript_paginaAtual = 1;
  const SUBPRODUTOS_SCRIPT_ITENS_POR_PAGINA = 10;
  let SubProdutosScript_termoBuscaAtual = "";
  let SubProdutosScript_debounceTimerBusca;
  let SubProdutosScript_cabecalhosParaExibicaoGlobal = []; 
  let SubProdutosScript_modoModalSubProduto = 'criar'; 
  let SubProdutosScript_subProdutoParaExcluirTemp = { id: null, nome: null };
  let SubProdutosScript_contadorLinhasMultiplos = 0;

  // Variáveis para controle de seleção na tabela
  let SubProdutosScript_subProdutoSelecionadoId = null;
  let SubProdutosScript_subProdutoSelecionadoNome = null;
  let SubProdutosScript_subProdutoSelecionadoObjeto = null;
  let SubProdutosScript_linhaSelecionadaAnterior = null;

  // Cache para dropdowns
  let SubProdutosScript_listaProdutosCache = [];
  let SubProdutosScript_listaFornecedoresCache = [];


  // --- Funções Utilitárias de UI ---
  function SubProdutosScript_exibirFeedbackGlobal(mensagem, isError = false, duracao = 7000) {
    const feedbackDiv = document.getElementById(SubProdutosScript_ID_MENSAGEM_FEEDBACK_GLOBAL);
    if (feedbackDiv) {
      const innerDiv = document.createElement('div');
      innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
      innerDiv.textContent = mensagem;
      feedbackDiv.innerHTML = '';
      feedbackDiv.appendChild(innerDiv);
      if (duracao > 0) setTimeout(() => { if (feedbackDiv.contains(innerDiv)) feedbackDiv.innerHTML = ''; }, duracao);
    } else console.warn("Feedback global não encontrado:", SubProdutosScript_ID_MENSAGEM_FEEDBACK_GLOBAL);
  }

  function SubProdutosScript_exibirMensagemEmModal(modalMsgId, mensagem, isError = false) {
    const mensagemDiv = document.getElementById(modalMsgId);
    if (mensagemDiv) {
      mensagemDiv.textContent = mensagem;
      mensagemDiv.className = `text-sm my-3 min-h-[20px] ${isError ? 'text-red-600 font-medium' : 'text-green-600 font-medium'}`;
    } else console.warn("Elemento de mensagem do modal não encontrado:", modalMsgId);
  }

  function SubProdutosScript_mostrarLoadingBotao(botao, textoLoading = "Processando...") {
    if (!botao) return;
    if (!botao.dataset.originalContent) {
      botao.dataset.originalContent = botao.innerHTML;
    }
    botao.disabled = true;
    botao.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${textoLoading}`;
  }

  function SubProdutosScript_restaurarBotao(botao) {
    if (!botao) return;
    if (botao.dataset.originalContent) {
      botao.innerHTML = botao.dataset.originalContent;
      delete botao.dataset.originalContent;
    }
    botao.disabled = false;
  }

  // --- Funções do Painel de Ações Global ---
  function SubProdutosScript_atualizarEstadoBotoesPainelAcoes() {
    const btnEditar = document.getElementById(SubProdutosScript_ID_BTN_EDITAR_GLOBAL);
    const btnExcluir = document.getElementById(SubProdutosScript_ID_BTN_EXCLUIR_GLOBAL);
    const habilitar = SubProdutosScript_subProdutoSelecionadoId !== null;

    if (btnEditar) btnEditar.disabled = !habilitar;
    if (btnExcluir) btnExcluir.disabled = !habilitar;
  }

  // --- Funções para popular Dropdowns ---
  async function SubProdutosScript_carregarProdutosParaDropdown(selectElementId, valorSelecionado = null, isMulti = false) {
    const selectEl = document.getElementById(selectElementId);
    if (!selectEl && !isMulti) return; 
    
    if (isMulti) { 
         // Não desabilita nada aqui
    } else if (selectEl) {
        selectEl.innerHTML = '<option value="">Carregando...</option>';
        selectEl.disabled = true;
    }

    if (SubProdutosScript_listaProdutosCache.length > 0) {
        if (!isMulti && selectEl) {
            SubProdutosScript_popularDropdown(selectEl, SubProdutosScript_listaProdutosCache, 'Selecione um Produto Vinculado*', valorSelecionado, 'ID', 'Produto');
            selectEl.disabled = false;
        }
        return Promise.resolve(SubProdutosScript_listaProdutosCache); 
    }
    
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(function(produtos) {
                SubProdutosScript_listaProdutosCache = produtos || [];
                if (!isMulti && selectEl) {
                    SubProdutosScript_popularDropdown(selectEl, SubProdutosScript_listaProdutosCache, 'Selecione um Produto Vinculado*', valorSelecionado, 'ID', 'Produto');
                    selectEl.disabled = false;
                }
                resolve(SubProdutosScript_listaProdutosCache);
            })
            .withFailureHandler(function(error) {
                console.error("Erro ao carregar produtos para dropdown:", error);
                if (!isMulti && selectEl) {
                    selectEl.innerHTML = '<option value="">Erro ao carregar</option>';
                    selectEl.disabled = false;
                }
                reject(error);
            })
            .SubProdutosController_obterTodosProdutosParaDropdown();
    });
  }

  async function SubProdutosScript_carregarFornecedoresParaDropdown(selectElementId, valorSelecionado = null) {
    const selectEl = document.getElementById(selectElementId);
    if (!selectEl) return;
    selectEl.innerHTML = '<option value="">Carregando...</option>';
    selectEl.disabled = true;

    if (SubProdutosScript_listaFornecedoresCache.length > 0) {
        SubProdutosScript_popularDropdown(selectEl, SubProdutosScript_listaFornecedoresCache, 'Selecione um Fornecedor (Opcional)', valorSelecionado, 'ID', 'Fornecedor');
        selectEl.disabled = false;
        return Promise.resolve(SubProdutosScript_listaFornecedoresCache);
    }

    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(function(fornecedores) {
                SubProdutosScript_listaFornecedoresCache = fornecedores || [];
                SubProdutosScript_popularDropdown(selectEl, SubProdutosScript_listaFornecedoresCache, 'Selecione um Fornecedor (Opcional)', valorSelecionado, 'ID', 'Fornecedor');
                selectEl.disabled = false;
                resolve(SubProdutosScript_listaFornecedoresCache);
            })
            .withFailureHandler(function(error) {
                console.error("Erro ao carregar fornecedores para dropdown:", error);
                selectEl.innerHTML = '<option value="">Erro ao carregar</option>';
                selectEl.disabled = false;
                reject(error);
            })
            .SubProdutosController_obterTodosFornecedoresParaDropdown();
    });
  }
  
  function SubProdutosScript_popularDropdown(selectElement, dados, placeholderText, valorSelecionado, valorKey = 'ID', textoKey = 'Nome') {
      if (!selectElement) return;
      selectElement.innerHTML = '';
      const placeholderOption = document.createElement('option');
      placeholderOption.value = "";
      placeholderOption.textContent = placeholderText;
      selectElement.appendChild(placeholderOption);

      if (dados && dados.length > 0) {
          dados.forEach(item => {
              const option = document.createElement('option');
              option.value = item[valorKey]; 
              option.textContent = item[textoKey]; 
              if (valorSelecionado && String(item[valorKey]) === String(valorSelecionado)) {
                  option.selected = true;
              }
              selectElement.appendChild(option);
          });
      } else {
          const noDataOption = document.createElement('option');
          noDataOption.value = "";
          noDataOption.textContent = "Nenhum item encontrado";
          noDataOption.disabled = true;
          selectElement.appendChild(noDataOption);
      }
  }


  // --- Funções do Modal Principal de SubProduto (Individual) ---
  function SubProdutosScript_fecharModalSubProduto() {
    const modal = document.getElementById(SubProdutosScript_ID_MODAL_SUBPRODUTO);
    if (modal) modal.classList.add('hidden');
    const form = document.getElementById(SubProdutosScript_ID_FORM_SUBPRODUTO);
    if (form) form.reset();
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, '', false);
    const btnSalvar = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_SUBPRODUTO);
    if (btnSalvar) {
      SubProdutosScript_restaurarBotao(btnSalvar);
      if (!btnSalvar.dataset.originalContent && btnSalvar.textContent.includes("Processando")) {
         btnSalvar.innerHTML = SubProdutosScript_modoModalSubProduto === 'criar' ? 'Criar SubProduto' : 'Salvar Alterações';
      }
      btnSalvar.disabled = false;
    }
  }

  function SubProdutosScript_abrirModalParaCriarSubProduto() {
    SubProdutosScript_modoModalSubProduto = 'criar';
    const tituloModal = document.getElementById(SubProdutosScript_ID_TITULO_MODAL_SUBPRODUTO);
    if (tituloModal) tituloModal.textContent = 'Novo SubProduto';
    const divIdExibicao = document.getElementById(SubProdutosScript_ID_DIV_ID_EXIBICAO_MODAL_SUBPRODUTO);
    if (divIdExibicao) divIdExibicao.classList.add('hidden');
    const form = document.getElementById(SubProdutosScript_ID_FORM_SUBPRODUTO);
    if (form) form.reset();
    const campoIdForm = document.getElementById(SubProdutosScript_ID_CAMPO_ID_FORM_MODAL_SUBPRODUTO);
    if (campoIdForm) campoIdForm.value = '';

    SubProdutosScript_carregarProdutosParaDropdown(SubProdutosScript_ID_SELECT_PRODUTO_VINCULADO_SUBPRODUTO);
    SubProdutosScript_carregarFornecedoresParaDropdown(SubProdutosScript_ID_SELECT_FORNECEDOR_SUBPRODUTO);

    const btnSalvar = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_SUBPRODUTO);
    if (btnSalvar) {
      btnSalvar.innerHTML = 'Criar SubProduto';
      btnSalvar.disabled = false;
      delete btnSalvar.dataset.originalContent;
    }
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, '', false);
    const modal = document.getElementById(SubProdutosScript_ID_MODAL_SUBPRODUTO);
    if (modal) modal.classList.remove('hidden');
    const inputNomeSubProduto = document.getElementById(SubProdutosScript_ID_INPUT_NOME_SUBPRODUTO);
    if (inputNomeSubProduto) inputNomeSubProduto.focus();
  }

  function SubProdutosScript_abrirModalParaEditarSubProduto(subProdutoId, subProdutoObj) {
    SubProdutosScript_modoModalSubProduto = 'editar';
    const form = document.getElementById(SubProdutosScript_ID_FORM_SUBPRODUTO);
    if (form) form.reset();

    if (!subProdutoObj) { 
      const tabelaSubProdutosEl = document.getElementById(SubProdutosScript_ID_TABELA_SUBPRODUTOS);
      if (tabelaSubProdutosEl && tabelaSubProdutosEl.dataset.subProdutosPaginados) {
        try {
          const subProdutosDaPagina = JSON.parse(tabelaSubProdutosEl.dataset.subProdutosPaginados);
          subProdutoObj = subProdutosDaPagina.find(sp => String(sp.ID) === String(subProdutoId));
        } catch (e) { console.error("Erro ao parsear dataset:", e); subProdutoObj = null; }
      }
    }

    if (!subProdutoObj) {
      SubProdutosScript_exibirFeedbackGlobal("Erro: Dados do subproduto não encontrados para edição. Tente recarregar.", true);
      return;
    }

    const tituloModal = document.getElementById(SubProdutosScript_ID_TITULO_MODAL_SUBPRODUTO);
    if (tituloModal) tituloModal.textContent = 'Editar SubProduto';
    const divIdExibicao = document.getElementById(SubProdutosScript_ID_DIV_ID_EXIBICAO_MODAL_SUBPRODUTO);
    if (divIdExibicao) divIdExibicao.classList.remove('hidden');
    const campoIdExibicao = document.getElementById(SubProdutosScript_ID_CAMPO_ID_EXIBICAO_MODAL_SUBPRODUTO);
    if (campoIdExibicao) campoIdExibicao.value = subProdutoId;
    const campoIdForm = document.getElementById(SubProdutosScript_ID_CAMPO_ID_FORM_MODAL_SUBPRODUTO);
    if (campoIdForm) campoIdForm.value = subProdutoId;
    
    let produtoVinculadoIdParaSelecionar = null;
    if (subProdutoObj['Produto Vinculado']) { // O objeto da tabela tem o NOME
        const produtoEncontrado = SubProdutosScript_listaProdutosCache.find(p => p.Produto === subProdutoObj['Produto Vinculado']);
        if (produtoEncontrado) produtoVinculadoIdParaSelecionar = produtoEncontrado.ID;
    }

    let fornecedorIdParaSelecionar = null;
    if (subProdutoObj['Fornecedor']) { // O objeto da tabela tem o NOME
        const fornecedorEncontrado = SubProdutosScript_listaFornecedoresCache.find(f => f.Fornecedor === subProdutoObj['Fornecedor']);
        if (fornecedorEncontrado) fornecedorIdParaSelecionar = fornecedorEncontrado.ID;
    }

    Promise.all([
        SubProdutosScript_carregarProdutosParaDropdown(SubProdutosScript_ID_SELECT_PRODUTO_VINCULADO_SUBPRODUTO, produtoVinculadoIdParaSelecionar),
        SubProdutosScript_carregarFornecedoresParaDropdown(SubProdutosScript_ID_SELECT_FORNECEDOR_SUBPRODUTO, fornecedorIdParaSelecionar)
    ]).then(() => {
        if (form && subProdutoObj) {
            for (const key in subProdutoObj) {
                if (form.elements[key] && key !== "Produto Vinculado" && key !== "Fornecedor") { 
                    form.elements[key].value = subProdutoObj[key] !== null && subProdutoObj[key] !== undefined ? String(subProdutoObj[key]) : "";
                }
            }
        }
    });

    const btnSalvar = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_SUBPRODUTO);
    if (btnSalvar) {
      btnSalvar.innerHTML = 'Salvar Alterações';
      btnSalvar.disabled = false;
      delete btnSalvar.dataset.originalContent;
    }
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, '', false);
    const modal = document.getElementById(SubProdutosScript_ID_MODAL_SUBPRODUTO);
    if (modal) modal.classList.remove('hidden');
    const inputNomeSubProduto = document.getElementById(SubProdutosScript_ID_INPUT_NOME_SUBPRODUTO);
    if (inputNomeSubProduto) inputNomeSubProduto.focus();
  }

  function SubProdutosScript_submeterFormularioSubProduto(event) {
    event.preventDefault();
    const btnSalvar = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_SUBPRODUTO);
    SubProdutosScript_mostrarLoadingBotao(btnSalvar, SubProdutosScript_modoModalSubProduto === 'criar' ? "Criando..." : "Salvando...");
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, 'Processando...', false);
    const form = document.getElementById(SubProdutosScript_ID_FORM_SUBPRODUTO);
    const formData = new FormData(form);
    const dadosSubProduto = {};
    for (let [key, value] of formData.entries()) dadosSubProduto[key] = value;

    if (SubProdutosScript_modoModalSubProduto === 'criar') {
      google.script.run
        .withSuccessHandler(function(resposta) {
          SubProdutosScript_restaurarBotao(btnSalvar);
          if (resposta.success) { SubProdutosScript_fecharModalSubProduto(); SubProdutosScript_exibirFeedbackGlobal(resposta.message || "Criado!", false); SubProdutosScript_carregarListaSubProdutos(1, ""); }
          else SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, resposta.message || "Falha.", true);
        })
        .withFailureHandler(function(error) { SubProdutosScript_restaurarBotao(btnSalvar); SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, "Erro: " + error.message, true); console.error("Erro SubProdutosCRUD_criarNovoSubProduto:", error); })
        .SubProdutosCRUD_criarNovoSubProduto(dadosSubProduto);
    } else if (SubProdutosScript_modoModalSubProduto === 'editar') {
      google.script.run
        .withSuccessHandler(function(resposta) {
          SubProdutosScript_restaurarBotao(btnSalvar);
          if (resposta.success) { SubProdutosScript_fecharModalSubProduto(); SubProdutosScript_exibirFeedbackGlobal(resposta.message || "Atualizado!", false); SubProdutosScript_carregarListaSubProdutos(SubProdutosScript_paginaAtual, SubProdutosScript_termoBuscaAtual); }
          else SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, resposta.message || "Falha.", true);
        })
        .withFailureHandler(function(error) { SubProdutosScript_restaurarBotao(btnSalvar); SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_SUBPRODUTO, "Erro: " + error.message, true); console.error("Erro SubProdutosCRUD_atualizarSubProduto:", error); })
        .SubProdutosCRUD_atualizarSubProduto(dadosSubProduto);
    }
  }

  // --- Funções do Modal de Exclusão de SubProduto ---
  function SubProdutosScript_fecharModalConfirmarExclusaoSubProduto() {
    const modal = document.getElementById(SubProdutosScript_ID_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO);
    if (modal) modal.classList.add('hidden');
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO, '', false);
    const btnConfirmar = document.getElementById(SubProdutosScript_ID_BTN_CONFIRMAR_EXCLUSAO_DEFINITIVA_SUBPRODUTO);
    if(btnConfirmar) SubProdutosScript_restaurarBotao(btnConfirmar);
  }

  function SubProdutosScript_iniciarConfirmacaoExclusaoSubProduto(subProdutoId, nomeSubProduto) {
    SubProdutosScript_subProdutoParaExcluirTemp = { id: subProdutoId, nome: nomeSubProduto };
    const modal = document.getElementById(SubProdutosScript_ID_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO);
    if (!modal) return;
    const nomeSubProdutoEl = document.getElementById(SubProdutosScript_ID_NOME_SUBPRODUTO_EXCLUIR_MODAL);
    if (nomeSubProdutoEl) nomeSubProdutoEl.textContent = nomeSubProduto;
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO, '', false);
    modal.classList.remove('hidden');
  }

  function SubProdutosScript_executarExclusaoSubProduto() {
    const { id } = SubProdutosScript_subProdutoParaExcluirTemp;
    const btnConfirmar = document.getElementById(SubProdutosScript_ID_BTN_CONFIRMAR_EXCLUSAO_DEFINITIVA_SUBPRODUTO);
    if (btnConfirmar) SubProdutosScript_mostrarLoadingBotao(btnConfirmar, "Excluindo...");
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO, 'Processando exclusão...', false);

    google.script.run
      .withSuccessHandler(function(response) {
        if (btnConfirmar) SubProdutosScript_restaurarBotao(btnConfirmar);
        if (response && response.success) {
          SubProdutosScript_fecharModalConfirmarExclusaoSubProduto();
          SubProdutosScript_exibirFeedbackGlobal(response.message || "Subproduto excluído!", false);
          SubProdutosScript_carregarListaSubProdutos(1, ""); 
        } else {
          SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO, (response ? response.message : "Erro desconhecido."), true);
        }
      })
      .withFailureHandler(function(error) {
        if (btnConfirmar) SubProdutosScript_restaurarBotao(btnConfirmar);
        SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO, "Erro de comunicação: " + error.message, true);
        console.error("Erro ao chamar SubProdutosCRUD_excluirSubProduto:", error);
      })
      .SubProdutosCRUD_excluirSubProduto(id); 
  }

  // --- Funções do Modal de Cadastrar Múltiplos SubProdutos ---
  function SubProdutosScript_fecharModalCadastrarMultiplosSubProdutos() {
    const modal = document.getElementById(SubProdutosScript_ID_MODAL_CADASTRAR_MULTIPLOS_SUBPRODUTOS);
    if (modal) modal.classList.add('hidden');
    const form = document.getElementById(SubProdutosScript_ID_FORM_CADASTRAR_MULTIPLOS_SUBPRODUTOS);
    if (form) form.reset(); 
    const containerLinhas = document.getElementById(SubProdutosScript_ID_CONTAINER_LINHAS_MULTIPLOS_SUBPRODUTOS);
    if(containerLinhas) containerLinhas.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Clique em "Adicionar SubProduto" para começar.</p>'; 
    SubProdutosScript_contadorLinhasMultiplos = 0;
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS, '', false);
    const btnSalvar = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_MULTIPLOS_SUBPRODUTOS);
    if (btnSalvar) {
        SubProdutosScript_restaurarBotao(btnSalvar);
        btnSalvar.disabled = true; 
    }
  }

  function SubProdutosScript_abrirModalCadastrarMultiplosSubProdutos() {
    const modal = document.getElementById(SubProdutosScript_ID_MODAL_CADASTRAR_MULTIPLOS_SUBPRODUTOS);
    if (!modal) return;
    
    SubProdutosScript_carregarFornecedoresParaDropdown(SubProdutosScript_ID_MULTI_SELECT_FORNECEDOR);
    SubProdutosScript_carregarProdutosParaDropdown(null, null, true); // true para popular apenas o cache

    const containerLinhas = document.getElementById(SubProdutosScript_ID_CONTAINER_LINHAS_MULTIPLOS_SUBPRODUTOS);
    if(containerLinhas) containerLinhas.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Clique em "Adicionar SubProduto" para começar.</p>';
    SubProdutosScript_contadorLinhasMultiplos = 0;
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS, '', false);
    const btnSalvar = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_MULTIPLOS_SUBPRODUTOS);
    if(btnSalvar) btnSalvar.disabled = true; 

    modal.classList.remove('hidden');
    const selectFornecedor = document.getElementById(SubProdutosScript_ID_MULTI_SELECT_FORNECEDOR);
    if(selectFornecedor) selectFornecedor.focus();
  }

  function SubProdutosScript_adicionarLinhaMultiplosSubProdutos() {
    SubProdutosScript_contadorLinhasMultiplos++;
    const container = document.getElementById(SubProdutosScript_ID_CONTAINER_LINHAS_MULTIPLOS_SUBPRODUTOS);
    if (!container) return;

    if (SubProdutosScript_contadorLinhasMultiplos === 1 && container.querySelector('p.text-gray-500')) {
        container.innerHTML = '';
    }

    const divLinha = document.createElement('div');
    divLinha.className = 'p-3 border rounded-md bg-gray-50 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-x-3 gap-y-2 items-end relative'; // Ajustado para mais colunas
    divLinha.id = `SubProdutosScript_linhaMultiplos_${SubProdutosScript_contadorLinhasMultiplos}`;

    let linhaHTML = `
      <div class="md:col-span-2 lg:col-span-2 xl:col-span-2"> <label for="SubProdutosScript_multiProdutoVinculado_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">Produto Vinculado*</label>
        <select id="SubProdutosScript_multiProdutoVinculado_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][ProdutoVinculadoID]" required class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="lg:col-span-2 xl:col-span-2"> <label for="SubProdutosScript_multiNome_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">SubProduto*</label>
        <input type="text" id="SubProdutosScript_multiNome_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][SubProduto]" required class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div> <label for="SubProdutosScript_multiCategoria_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">Categoria</label>
        <input type="text" id="SubProdutosScript_multiCategoria_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][Categoria]" class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div> <label for="SubProdutosScript_multiTamanho_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">Tamanho</label>
        <input type="text" id="SubProdutosScript_multiTamanho_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][Tamanho]" class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div> <label for="SubProdutosScript_multiUN_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">UN*</label>
        <input type="text" id="SubProdutosScript_multiUN_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][UN]" required class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="mt-2 md:mt-0"> <label for="SubProdutosScript_multiFator_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">Fator</label>
        <input type="number" id="SubProdutosScript_multiFator_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][Fator]" class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500" step="any">
      </div>
      <div class="mt-2 md:mt-0"> <label for="SubProdutosScript_multiNCM_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">NCM</label>
        <input type="text" id="SubProdutosScript_multiNCM_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][NCM]" class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="mt-2 md:mt-0"> <label for="SubProdutosScript_multiCST_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">CST</label>
        <input type="text" id="SubProdutosScript_multiCST_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][CST]" class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="mt-2 md:mt-0"> <label for="SubProdutosScript_multiCFOP_${SubProdutosScript_contadorLinhasMultiplos}" class="block text-xs font-medium text-gray-600 mb-1">CFOP</label>
        <input type="text" id="SubProdutosScript_multiCFOP_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][CFOP]" class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="flex items-end mt-2 md:mt-0"> <select id="SubProdutosScript_multiStatus_${SubProdutosScript_contadorLinhasMultiplos}" name="multiSubProdutos[${SubProdutosScript_contadorLinhasMultiplos}][Status]" class="w-full p-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
          <option value="Ativo" selected>Ativo</option>
          <option value="Inativo">Inativo</option>
          <option value="Bloqueado">Bloqueado</option>
        </select>
      </div>
    `;
    divLinha.innerHTML = linhaHTML;
    
    const btnRemover = document.createElement('button');
    btnRemover.type = 'button';
    btnRemover.innerHTML = '&times;';
    btnRemover.className = 'absolute top-1 right-1 text-red-500 hover:text-red-700 font-bold text-lg p-1 leading-none';
    btnRemover.title = 'Remover esta linha';
    btnRemover.onclick = function() { SubProdutosScript_removerLinhaMultiplosSubProdutos(divLinha.id); };
    divLinha.appendChild(btnRemover);

    container.appendChild(divLinha);

    const selectProdutoLinha = document.getElementById(`SubProdutosScript_multiProdutoVinculado_${SubProdutosScript_contadorLinhasMultiplos}`);
    if (selectProdutoLinha) {
        SubProdutosScript_popularDropdown(selectProdutoLinha, SubProdutosScript_listaProdutosCache, 'Selecione Produto*', null, 'ID', 'Produto');
    }

    const btnSalvarMultiplos = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_MULTIPLOS_SUBPRODUTOS);
    if(btnSalvarMultiplos) btnSalvarMultiplos.disabled = false;

    const primeiroInputDaLinha = divLinha.querySelector('select, input[type="text"]'); 
    if(primeiroInputDaLinha) primeiroInputDaLinha.focus();
  }

  function SubProdutosScript_removerLinhaMultiplosSubProdutos(linhaId) {
    const linhaParaRemover = document.getElementById(linhaId);
    if (linhaParaRemover) {
      linhaParaRemover.remove();
    }
    const containerLinhas = document.getElementById(SubProdutosScript_ID_CONTAINER_LINHAS_MULTIPLOS_SUBPRODUTOS);
    if (containerLinhas && containerLinhas.children.length === 0) {
        containerLinhas.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Clique em "Adicionar SubProduto" para começar.</p>';
        const btnSalvarMultiplos = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_MULTIPLOS_SUBPRODUTOS);
        if(btnSalvarMultiplos) btnSalvarMultiplos.disabled = true;
    }
  }

  function SubProdutosScript_submeterFormularioMultiplosSubProdutos(event) {
    event.preventDefault();
    const btnSalvar = document.getElementById(SubProdutosScript_ID_BTN_SALVAR_MODAL_MULTIPLOS_SUBPRODUTOS);
    SubProdutosScript_mostrarLoadingBotao(btnSalvar, "Salvando Todos...");
    SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS, 'Processando...', false);

    const form = document.getElementById(SubProdutosScript_ID_FORM_CADASTRAR_MULTIPLOS_SUBPRODUTOS);
    const formData = new FormData(form);
    const dadosParaEnvio = {
      fornecedorGlobal: formData.get('FornecedorGlobal'), 
      subProdutos: []
    };

    const linhas = document.querySelectorAll(`#${SubProdutosScript_ID_CONTAINER_LINHAS_MULTIPLOS_SUBPRODUTOS} > div[id^="SubProdutosScript_linhaMultiplos_"]`);
    if (linhas.length === 0) {
        SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS, 'Adicione pelo menos um subproduto.', true);
        SubProdutosScript_restaurarBotao(btnSalvar);
        return;
    }
    
    let formValido = true;
    linhas.forEach(linha => {
      const subProduto = {};
      const inputs = linha.querySelectorAll('input, select');
      inputs.forEach(input => {
        const nameAttr = input.name;
        if (nameAttr) {
            const match = nameAttr.match(/\[([^\]]+)\]$/); 
            if (match && match[1]) {
                const propName = match[1];
                subProduto[propName] = input.value; 
                if(input.required && !input.value) {
                    formValido = false;
                    input.classList.add('border-red-500');
                    let errorSpan = input.nextElementSibling;
                    if (!errorSpan || !errorSpan.classList.contains('text-red-500')) {
                        errorSpan = document.createElement('span');
                        errorSpan.className = 'text-red-500 text-xs block';
                        input.parentNode.appendChild(errorSpan);
                    }
                    errorSpan.textContent = 'Campo obrigatório';
                } else {
                    input.classList.remove('border-red-500');
                    let errorSpan = input.nextElementSibling;
                    if (errorSpan && errorSpan.classList.contains('text-red-500')) {
                         errorSpan.textContent = ''; 
                    }
                }
            }
        }
      });
      if (Object.keys(subProduto).length > 0) { 
        dadosParaEnvio.subProdutos.push(subProduto);
      }
    });

    if (!formValido) {
        SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS, 'Preencha todos os campos obrigatórios (*).', true);
        SubProdutosScript_restaurarBotao(btnSalvar);
        return;
    }
    
    google.script.run
      .withSuccessHandler(function(resposta) {
        SubProdutosScript_restaurarBotao(btnSalvar);
        if (resposta.success) {
          SubProdutosScript_fecharModalCadastrarMultiplosSubProdutos();
          SubProdutosScript_exibirFeedbackGlobal(resposta.message || "Subprodutos cadastrados em lote!", false);
          SubProdutosScript_carregarListaSubProdutos(1, "");
        } else {
          SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS, resposta.message || "Falha ao cadastrar em lote.", true);
        }
      })
      .withFailureHandler(function(error) {
        SubProdutosScript_restaurarBotao(btnSalvar);
        SubProdutosScript_exibirMensagemEmModal(SubProdutosScript_ID_MENSAGEM_ERRO_MODAL_MULTIPLOS_SUBPRODUTOS, "Erro de comunicação: " + error.message, true);
        console.error("Erro SubProdutosCRUD_cadastrarMultiplosSubProdutos:", error);
      })
      .SubProdutosCRUD_cadastrarMultiplosSubProdutos(dadosParaEnvio);
  }


  // --- Funções de Renderização da Tabela e Paginação ---
  function SubProdutosScript_renderizarControlesPaginacao(totalItens, paginaAtual, totalPaginas) {
    const controlesDiv = document.getElementById(SubProdutosScript_ID_CONTROLES_PAGINACAO);
    if (!controlesDiv) { console.error("Controles de paginação não encontrados."); return; }
    controlesDiv.innerHTML = '';
    if (totalItens === 0 && SubProdutosScript_termoBuscaAtual) { const span = document.createElement('span'); span.className = 'text-sm text-gray-500'; span.textContent = `0 resultados para "${SubProdutosScript_termoBuscaAtual}"`; controlesDiv.appendChild(span); return; }
    if (totalItens === 0 && !SubProdutosScript_termoBuscaAtual) { const span = document.createElement('span'); span.className = 'text-sm text-gray-500'; span.textContent = 'Nenhum subproduto.'; controlesDiv.appendChild(span); return; }
    if (totalPaginas <= 1 && totalItens <= SUBPRODUTOS_SCRIPT_ITENS_POR_PAGINA && !SubProdutosScript_termoBuscaAtual) { const span = document.createElement('span'); span.className = 'text-sm text-gray-500'; span.textContent = `Total: ${totalItens} subproduto(s).`; controlesDiv.appendChild(span); return; }
    if (totalPaginas < 1) totalPaginas = 1;
    const inicio = totalItens > 0 ? Math.min((paginaAtual - 1) * SUBPRODUTOS_SCRIPT_ITENS_POR_PAGINA + 1, totalItens) : 0;
    const fim = totalItens > 0 ? Math.min(paginaAtual * SUBPRODUTOS_SCRIPT_ITENS_POR_PAGINA, totalItens) : 0;
    const infoPaginacao = document.createElement('div'); infoPaginacao.className = 'text-sm text-gray-700'; infoPaginacao.textContent = `Mostrando `;
    const spanInicio = document.createElement('span'); spanInicio.className = 'font-medium'; spanInicio.textContent = inicio; infoPaginacao.appendChild(spanInicio); infoPaginacao.append('-');
    const spanFim = document.createElement('span'); spanFim.className = 'font-medium'; spanFim.textContent = fim; infoPaginacao.appendChild(spanFim); infoPaginacao.append(` de `);
    const spanTotal = document.createElement('span'); spanTotal.className = 'font-medium'; spanTotal.textContent = totalItens; infoPaginacao.appendChild(spanTotal);
    const botoesPaginacao = document.createElement('div'); botoesPaginacao.className = 'inline-flex items-center gap-x-1 sm:gap-x-2 mt-2 sm:mt-0';
    const btnAnterior = document.createElement('button'); btnAnterior.textContent = 'Anterior'; btnAnterior.className = 'btn-paginacao'; btnAnterior.disabled = paginaAtual <= 1;
    btnAnterior.onclick = () => { if (paginaAtual > 1) SubProdutosScript_carregarListaSubProdutos(paginaAtual - 1, SubProdutosScript_termoBuscaAtual); };
    const btnProximo = document.createElement('button'); btnProximo.textContent = 'Próximo'; btnProximo.className = 'btn-paginacao'; btnProximo.disabled = paginaAtual >= totalPaginas;
    btnProximo.onclick = () => { if (paginaAtual < totalPaginas) SubProdutosScript_carregarListaSubProdutos(paginaAtual + 1, SubProdutosScript_termoBuscaAtual); };
    const infoPaginaNumero = document.createElement('span'); infoPaginaNumero.className = 'text-sm px-2 py-1'; infoPaginaNumero.textContent = `Pág ${paginaAtual} de ${totalPaginas}`;
    botoesPaginacao.appendChild(btnAnterior); botoesPaginacao.appendChild(infoPaginaNumero); botoesPaginacao.appendChild(btnProximo);
    controlesDiv.appendChild(infoPaginacao); controlesDiv.appendChild(botoesPaginacao);
  }

  function SubProdutosScript_processarDadosServidor(resultadoServidor) {
    const tabelaSubProdutosEl = document.getElementById(SubProdutosScript_ID_TABELA_SUBPRODUTOS);
    if (!tabelaSubProdutosEl) { console.error("Tabela não encontrada."); SubProdutosScript_exibirFeedbackGlobal("Erro: Tabela não encontrada.", true); return; }
    const thead = tabelaSubProdutosEl.querySelector('thead');
    const tbody = tabelaSubProdutosEl.querySelector('tbody');
    if (!thead || !tbody) { console.error("thead/tbody não encontrado."); SubProdutosScript_exibirFeedbackGlobal("Erro: Estrutura da tabela incompleta.", true); return; }
    thead.innerHTML = ''; tbody.innerHTML = '';
    const controlesPaginacaoEl = document.getElementById(SubProdutosScript_ID_CONTROLES_PAGINACAO);
    if (controlesPaginacaoEl) controlesPaginacaoEl.innerHTML = '';

    if (!resultadoServidor || resultadoServidor.error) {
      let errorMsg = "Falha ao carregar dados.";
      if (resultadoServidor && resultadoServidor.message) errorMsg = resultadoServidor.message;
      else if (resultadoServidor && resultadoServidor.error) errorMsg = resultadoServidor.error;
      console.error("Erro do servidor:", errorMsg);
      SubProdutosScript_exibirFeedbackGlobal(`Erro: ${errorMsg}`, true);
      const tr = tbody.insertRow(); const td = tr.insertCell();
      td.colSpan = (SubProdutosScript_cabecalhosParaExibicaoGlobal.length > 0 ? SubProdutosScript_cabecalhosParaExibicaoGlobal.length : 1);
      td.className = "text-center p-8 text-red-500"; td.textContent = `Erro: ${errorMsg}`;
      if(resultadoServidor) SubProdutosScript_renderizarControlesPaginacao(resultadoServidor.totalItens || 0, resultadoServidor.paginaAtual || 1, resultadoServidor.totalPaginas || 1); return;
    }

    SubProdutosScript_cabecalhosParaExibicaoGlobal = resultadoServidor.cabecalhosParaExibicao || [];
    const subProdutosDaPagina = resultadoServidor.subProdutosPaginados || [];
    tabelaSubProdutosEl.dataset.subProdutosPaginados = JSON.stringify(subProdutosDaPagina);

    if (SubProdutosScript_cabecalhosParaExibicaoGlobal.length > 0) {
      const cabecalhoRow = thead.insertRow();
      SubProdutosScript_cabecalhosParaExibicaoGlobal.forEach(textoCabecalho => {
        const th = document.createElement('th');
        th.className = 'px-4 py-3 text-left text-xs font-semibold tracking-wider whitespace-normal';
        th.textContent = textoCabecalho; cabecalhoRow.appendChild(th);
      });
    } else {
      const cabecalhoRow = thead.insertRow();
      const th = document.createElement('th');
      th.className = 'px-4 py-3 text-left text-xs font-semibold tracking-wider';
      th.textContent = "SubProdutos"; cabecalhoRow.appendChild(th);
    }

    if (subProdutosDaPagina.length > 0) {
      subProdutosDaPagina.forEach(subProdutoObj => {
        const tr = tbody.insertRow();
        tr.addEventListener('click', function() {
          if (SubProdutosScript_linhaSelecionadaAnterior && SubProdutosScript_linhaSelecionadaAnterior !== this) {
            SubProdutosScript_linhaSelecionadaAnterior.classList.remove('linha-selecionada');
          }
          if (SubProdutosScript_subProdutoSelecionadoId === subProdutoObj.ID && this.classList.contains('linha-selecionada')) {
            this.classList.remove('linha-selecionada');
            SubProdutosScript_subProdutoSelecionadoId = null;
            SubProdutosScript_subProdutoSelecionadoNome = null;
            SubProdutosScript_subProdutoSelecionadoObjeto = null;
            SubProdutosScript_linhaSelecionadaAnterior = null;
          } else {
            this.classList.add('linha-selecionada');
            SubProdutosScript_subProdutoSelecionadoId = subProdutoObj.ID;
            SubProdutosScript_subProdutoSelecionadoNome = subProdutoObj.SubProduto; 
            SubProdutosScript_subProdutoSelecionadoObjeto = subProdutoObj;
            SubProdutosScript_linhaSelecionadaAnterior = this;
          }
          SubProdutosScript_atualizarEstadoBotoesPainelAcoes();
        });

        SubProdutosScript_cabecalhosParaExibicaoGlobal.forEach(nomeCabecalho => {
          const td = tr.insertCell();
          td.className = 'px-4 py-3 text-sm text-gray-700 border-b border-gray-200 whitespace-normal break-words';
          td.textContent = subProdutoObj[nomeCabecalho] !== undefined && subProdutoObj[nomeCabecalho] !== null ? String(subProdutoObj[nomeCabecalho]) : '';
        });
      });
    } else {
      const tr = tbody.insertRow(); const td = tr.insertCell();
      td.colSpan = (SubProdutosScript_cabecalhosParaExibicaoGlobal.length > 0 ? SubProdutosScript_cabecalhosParaExibicaoGlobal.length : 1);
      td.className = 'px-4 py-8 text-md text-gray-500 text-center';
      if (SubProdutosScript_termoBuscaAtual) { td.textContent = `Nenhum subproduto para "${SubProdutosScript_termoBuscaAtual}".`; }
      else { td.textContent = (resultadoServidor.totalItens > 0) ? 'Nenhum subproduto nesta página.' : 'Nenhum subproduto cadastrado.'; }
    }
    SubProdutosScript_paginaAtual = resultadoServidor.paginaAtual;
    SubProdutosScript_renderizarControlesPaginacao(resultadoServidor.totalItens, resultadoServidor.paginaAtual, resultadoServidor.totalPaginas);

    SubProdutosScript_subProdutoSelecionadoId = null;
    SubProdutosScript_subProdutoSelecionadoNome = null;
    SubProdutosScript_subProdutoSelecionadoObjeto = null;
    if(SubProdutosScript_linhaSelecionadaAnterior) {
      SubProdutosScript_linhaSelecionadaAnterior.classList.remove('linha-selecionada');
      SubProdutosScript_linhaSelecionadaAnterior = null;
    }
    SubProdutosScript_atualizarEstadoBotoesPainelAcoes();

    SubProdutosScript_configurarListenersModalSubProduto();
    SubProdutosScript_configurarListenersModalExclusao();
    SubProdutosScript_configurarListenersModalMultiplos();
  }

  function SubProdutosScript_configurarListenersModalSubProduto() {
    const btnFechar = document.getElementById(SubProdutosScript_ID_BTN_FECHAR_MODAL_SUBPRODUTO); if (btnFechar && !btnFechar.dataset.listener) { btnFechar.onclick = SubProdutosScript_fecharModalSubProduto; btnFechar.dataset.listener = 'true'; }
    const btnCancelar = document.getElementById(SubProdutosScript_ID_BTN_CANCELAR_MODAL_SUBPRODUTO); if (btnCancelar && !btnCancelar.dataset.listener) { btnCancelar.onclick = SubProdutosScript_fecharModalSubProduto; btnCancelar.dataset.listener = 'true'; }
    const formSubProduto = document.getElementById(SubProdutosScript_ID_FORM_SUBPRODUTO); if (formSubProduto && !formSubProduto.dataset.listener) { formSubProduto.addEventListener('submit', SubProdutosScript_submeterFormularioSubProduto); formSubProduto.dataset.listener = 'true'; }
  }

  function SubProdutosScript_configurarListenersModalExclusao() {
    const btnFecharConfirmar = document.getElementById(SubProdutosScript_ID_BTN_FECHAR_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO); if(btnFecharConfirmar && !btnFecharConfirmar.dataset.listener) { btnFecharConfirmar.onclick = SubProdutosScript_fecharModalConfirmarExclusaoSubProduto; btnFecharConfirmar.dataset.listener = 'true'; }
    const btnCancelarConfirmar = document.getElementById(SubProdutosScript_ID_BTN_CANCELAR_MODAL_CONFIRMAR_EXCLUSAO_SUBPRODUTO); if(btnCancelarConfirmar && !btnCancelarConfirmar.dataset.listener) { btnCancelarConfirmar.onclick = SubProdutosScript_fecharModalConfirmarExclusaoSubProduto; btnCancelarConfirmar.dataset.listener = 'true'; }
    const btnConfirmarExclusao = document.getElementById(SubProdutosScript_ID_BTN_CONFIRMAR_EXCLUSAO_DEFINITIVA_SUBPRODUTO); if(btnConfirmarExclusao && !btnConfirmarExclusao.dataset.listener) { btnConfirmarExclusao.onclick = SubProdutosScript_executarExclusaoSubProduto; btnConfirmarExclusao.dataset.listener = 'true'; }
  }

  function SubProdutosScript_configurarListenersModalMultiplos() {
    const btnFechar = document.getElementById(SubProdutosScript_ID_BTN_FECHAR_MODAL_CADASTRAR_MULTIPLOS_SUBPRODUTOS); if(btnFechar && !btnFechar.dataset.listener) { btnFechar.onclick = SubProdutosScript_fecharModalCadastrarMultiplosSubProdutos; btnFechar.dataset.listener = 'true'; }
    const btnCancelar = document.getElementById(SubProdutosScript_ID_BTN_CANCELAR_MODAL_MULTIPLOS_SUBPRODUTOS); if(btnCancelar && !btnCancelar.dataset.listener) { btnCancelar.onclick = SubProdutosScript_fecharModalCadastrarMultiplosSubProdutos; btnCancelar.dataset.listener = 'true'; }
    const formMultiplos = document.getElementById(SubProdutosScript_ID_FORM_CADASTRAR_MULTIPLOS_SUBPRODUTOS); if(formMultiplos && !formMultiplos.dataset.listener) { formMultiplos.addEventListener('submit', SubProdutosScript_submeterFormularioMultiplosSubProdutos); formMultiplos.dataset.listener = 'true'; }
    const btnAdicionarLinha = document.getElementById(SubProdutosScript_ID_BTN_ADICIONAR_LINHA_MULTIPLOS); if(btnAdicionarLinha && !btnAdicionarLinha.dataset.listener) { btnAdicionarLinha.onclick = SubProdutosScript_adicionarLinhaMultiplosSubProdutos; btnAdicionarLinha.dataset.listener = 'true'; }
  }

  function SubProdutosScript_carregarListaSubProdutos(pagina = 1, termoBusca = SubProdutosScript_termoBuscaAtual) {
    console.log(`Carregando subprodutos: Pág ${pagina}, Busca: "${termoBusca}"`);
    SubProdutosScript_paginaAtual = pagina; SubProdutosScript_termoBuscaAtual = termoBusca;
    const feedbackGlobalEl = document.getElementById(SubProdutosScript_ID_MENSAGEM_FEEDBACK_GLOBAL); if (feedbackGlobalEl) feedbackGlobalEl.innerHTML = '';
    const tabelaSubProdutosEl = document.getElementById(SubProdutosScript_ID_TABELA_SUBPRODUTOS);
    const numColCarregamento = (SubProdutosScript_cabecalhosParaExibicaoGlobal.length > 0 ? SubProdutosScript_cabecalhosParaExibicaoGlobal.length : 1);
    if (tabelaSubProdutosEl) {
      const thead = tabelaSubProdutosEl.querySelector('thead'); if (thead) { thead.innerHTML = `<tr><th colspan="${numColCarregamento}" class="px-4 py-3 text-left text-xs font-semibold tracking-wider">Carregando Cabeçalhos...</th></tr>`; }
      const tbody = tabelaSubProdutosEl.querySelector('tbody'); if (tbody) { tbody.innerHTML = `<tr><td colspan="${numColCarregamento}" class="text-center p-8 text-gray-500"><svg class="animate-spin h-6 w-6 text-blue-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Carregando dados...</td></tr>`; }
    }
    const controlesPaginacaoEl = document.getElementById(SubProdutosScript_ID_CONTROLES_PAGINACAO); if (controlesPaginacaoEl) controlesPaginacaoEl.innerHTML = '<div class="text-sm text-gray-500">Carregando paginação...</div>';
    const options = { pagina: SubProdutosScript_paginaAtual, itensPorPagina: SUBPRODUTOS_SCRIPT_ITENS_POR_PAGINA, termoBusca: SubProdutosScript_termoBuscaAtual };
    google.script.run
      .withSuccessHandler(SubProdutosScript_processarDadosServidor)
      .withFailureHandler(function(error) {
        console.error("Falha SubProdutosController_obterListaSubProdutosPaginada:", error);
        let mensagemErro = "Erro de comunicação."; if (error && error.message) { mensagemErro = String(error.message).includes("Exception:") ? String(error.message).split("Exception:")[1].trim() : String(error.message); }
        SubProdutosScript_exibirFeedbackGlobal(mensagemErro, true);
        if (tabelaSubProdutosEl) { const tbody = tabelaSubProdutosEl.querySelector('tbody'); if (tbody) tbody.innerHTML = `<tr><td colspan="${numColCarregamento}" class="text-center p-8 text-red-700 bg-red-50"><strong>Erro:</strong> ${mensagemErro}</td></tr>`; }
        if (controlesPaginacaoEl) controlesPaginacaoEl.innerHTML = '';
        SubProdutosScript_subProdutoSelecionadoId = null;
        SubProdutosScript_subProdutoSelecionadoNome = null;
        SubProdutosScript_subProdutoSelecionadoObjeto = null;
        if(SubProdutosScript_linhaSelecionadaAnterior) {
          SubProdutosScript_linhaSelecionadaAnterior.classList.remove('linha-selecionada');
          SubProdutosScript_linhaSelecionadaAnterior = null;
        }
        SubProdutosScript_atualizarEstadoBotoesPainelAcoes();
      })
      .SubProdutosController_obterListaSubProdutosPaginada(options); 
  }

  // --- Inicialização e Listeners Globais ---
  const campoBuscaSubProdutosEl = document.getElementById(SubProdutosScript_ID_CAMPO_BUSCA);
  if (campoBuscaSubProdutosEl && !campoBuscaSubProdutosEl.dataset.listenerAttached) {
    campoBuscaSubProdutosEl.addEventListener('input', function() {
      clearTimeout(SubProdutosScript_debounceTimerBusca);
      const termo = this.value;
      SubProdutosScript_debounceTimerBusca = setTimeout(() => { SubProdutosScript_carregarListaSubProdutos(1, termo); }, 500);
    });
    campoBuscaSubProdutosEl.dataset.listenerAttached = 'true';
  }

  const btnNovoGlobal = document.getElementById(SubProdutosScript_ID_BTN_NOVO_SUBPRODUTO_GLOBAL);
  if (btnNovoGlobal && !btnNovoGlobal.dataset.listenerAttached) {
    btnNovoGlobal.onclick = SubProdutosScript_abrirModalParaCriarSubProduto;
    btnNovoGlobal.dataset.listenerAttached = 'true';
  }
  
  const btnCadastrarMultiplosGlobal = document.getElementById(SubProdutosScript_ID_BTN_CADASTRAR_MULTIPLOS_GLOBAL);
  if (btnCadastrarMultiplosGlobal && !btnCadastrarMultiplosGlobal.dataset.listenerAttached) {
    btnCadastrarMultiplosGlobal.onclick = SubProdutosScript_abrirModalCadastrarMultiplosSubProdutos;
    btnCadastrarMultiplosGlobal.dataset.listenerAttached = 'true';
  }

  const btnEditarGlobal = document.getElementById(SubProdutosScript_ID_BTN_EDITAR_GLOBAL);
  if (btnEditarGlobal && !btnEditarGlobal.dataset.listenerAttached) {
    btnEditarGlobal.onclick = () => {
      if (SubProdutosScript_subProdutoSelecionadoId && SubProdutosScript_subProdutoSelecionadoObjeto) {
        SubProdutosScript_abrirModalParaEditarSubProduto(SubProdutosScript_subProdutoSelecionadoId, SubProdutosScript_subProdutoSelecionadoObjeto);
      } else {
        SubProdutosScript_exibirFeedbackGlobal("Nenhum subproduto selecionado para editar.", true);
      }
    };
    btnEditarGlobal.dataset.listenerAttached = 'true';
  }

  const btnExcluirGlobal = document.getElementById(SubProdutosScript_ID_BTN_EXCLUIR_GLOBAL);
  if (btnExcluirGlobal && !btnExcluirGlobal.dataset.listenerAttached) {
    btnExcluirGlobal.onclick = () => {
      if (SubProdutosScript_subProdutoSelecionadoId && SubProdutosScript_subProdutoSelecionadoNome) {
        SubProdutosScript_iniciarConfirmacaoExclusaoSubProduto(SubProdutosScript_subProdutoSelecionadoId, SubProdutosScript_subProdutoSelecionadoNome);
      } else {
        SubProdutosScript_exibirFeedbackGlobal("Nenhum subproduto selecionado para excluir.", true);
      }
    };
    btnExcluirGlobal.dataset.listenerAttached = 'true';
  }

  // Carregamento inicial
  SubProdutosScript_carregarListaSubProdutos(1);
  SubProdutosScript_atualizarEstadoBotoesPainelAcoes();
  
  // Pré-carrega os dados dos produtos e fornecedores para os dropdowns.
  // O terceiro parâmetro 'true' em carregarProdutosParaDropdown indica que é para o modo de múltiplos (apenas cache).
  SubProdutosScript_carregarProdutosParaDropdown(null, null, true); 
  SubProdutosScript_carregarFornecedoresParaDropdown(null, null); // Para fornecedores, o comportamento é o mesmo (cache).


  console.log("SubProdutosScript inicializado.");
}
</script>
