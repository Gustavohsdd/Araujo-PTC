<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
  <style>
    body { background-color: #f8f9fa; }
    .container-main { max-width: 1800px; }
    .card { margin-top: 20px; }
    .loading-spinner { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .table-responsive { max-height: 60vh; }
    .nf-card-items-table { font-size: 0.8rem; max-height: 150px; overflow-y: auto; }
    .accordion-button:not(.collapsed) { background-color: #e7f1ff; }
    .status-badge { font-size: 0.9rem; margin-left: 15px; }
    .card-header .form-check { margin-bottom: 0; }
    .card-header-main { display: flex; justify-content: space-between; align-items: center; }
    .nf-title { font-size: 0.9rem; font-weight: bold; }
    .card .card-header { padding: 0.5rem 1rem; }
    .nf-card-items-table th, .nf-card-items-table td { padding: 0.3rem 0.4rem; }
    .card-body { padding: 0.75rem; }
    .card-header .form-check-label { line-height: 1.2; }
    .card-header .form-switch .form-check-label { font-size: 0.8rem; }

    /* Estilos copiados de CotacoesView para consistência */
    .btn-painel-acao {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      transition: background-color 0.15s ease-in-out, opacity 0.15s ease-in-out;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      color: white;
      border: none;
    }
    .btn-painel-acao svg {
      width: 1rem;
      height: 1rem;
    }
    .btn-painel-acao:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-painel-laranja { background-color: #f59e0b; }
    .btn-painel-laranja:hover:not(:disabled) { background-color: #d97706; }
  </style>
</head>
<body>
  <div id="loader" class="loading-spinner d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>

  <div class="container-main mt-4">
    <div class="card shadow-sm" id="card-selecao">
      <div class="card-header bg-primary text-white card-header-main">
        <h3 class="mb-0">Central de Conciliação</h3>
        <div class="d-flex align-items-center">
          <div class="col-auto" style="width: 350px;">
            <input type="text" id="search-input" class="form-control" placeholder="Buscar por Fornecedor, Nº da NF ou Item...">
          </div>
          <div class="col-auto ps-2">
              <button id="btn-processar-xml" class="btn-painel-acao btn-painel-laranja" type="button" title="Busca e processa novos arquivos XML da pasta do Google Drive.">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                      <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                  </svg>
                  <span>Processar XMLs</span>
              </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div id="etapa-selecao">
          <label class="form-label fw-bold pt-3">1. Selecione as Notas Fiscais a serem processadas</label>
          <div id="nf-cards-container" class="row">
            </div>
          <div class="text-center mt-4">
            <button id="btn-processar-selecao" class="btn btn-primary btn-lg" disabled>Processar Seleção</button>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion" id="accordion-container">
      </div>
  </div>

  <template id="template-nf-card">
    <div class="col-xl-4 col-lg-6 mb-4">
      <div class="card h-100" data-chave-acesso="">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="form-check">
            <input class="form-check-input nf-select-checkbox" type="checkbox">
            <label class="form-check-label nf-title">NF 00000 - Fornecedor</label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input nf-sem-pedido-checkbox" type="checkbox" role="switch">
            <label class="form-check-label">Sem Pedido</label>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-5"><strong>Data Emissão:</strong> <span class="nf-data"></span></div>
            <div class="col-md-7"><strong>Valor Total:</strong> <span class="nf-total fw-bold text-success"></span></div>
          </div>
          <hr class="my-2">
          <p class="mb-1 fw-bold" style="font-size: 0.9rem;">Itens da Nota Fiscal:</p>
          <div class="table-responsive nf-card-items-table">
            <table class="table table-sm table-striped">
              <thead>
                <tr><th>Descrição</th><th class="text-end">Qtd</th><th class="text-end">Preço Unit.</th></tr>
              </thead>
              <tbody class="nf-items-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </template>
  
  <template id="template-accordion-item">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button" type="button" data-bs-toggle="collapse">
          <span class="header-text"></span>
          <span class="badge rounded-pill text-bg-light status-badge d-none"></span>
        </button>
      </h2>
      <div class="accordion-collapse collapse">
        <div class="accordion-body">
          <div class="mb-3">
              <label class="form-label fw-bold">2. Selecione a Cotação correspondente para esta NF</label>
              <select class="form-select select-cotacao-item" disabled>
                <option selected disabled>Carregando cotações...</option>
              </select>
          </div>
          <hr>
          <div class="row g-3 mb-4 p-3 bg-light border rounded totais-nf-container d-none">
            <h5><strong class="text-primary">Totais da Nota Fiscal</strong></h5>
            <div class="col-md-3"><strong>Produtos:</strong> <span class="total-produtos"></span></div>
            <div class="col-md-3"><strong>Frete:</strong> <span class="total-frete"></span></div>
            <div class="col-md-3"><strong>IPI:</strong> <span class="total-ipi"></span></div>
            <div class="col-md-3"><strong>Outras Desp.:</strong> <span class="total-outras"></span></div>
            <div class="col-md-3"><strong>Desconto:</strong> <span class="total-desconto text-danger"></span></div>
            <div class="col-md-3"><strong>Impostos (ICMS/ST/PIS/COFINS):</strong> <span class="total-impostos"></span></div>
            <hr class="my-2">
            <div class="col-md-12 fs-5"><strong>VALOR TOTAL DA NF:</strong> <strong class="valor-total text-success"></strong></div>
          </div>
          <div class="comparison-container d-none">
            <h5><strong class="text-primary">Itens da Nota Fiscal vs. Itens da Cotação</strong></h5>
            <div class="table-responsive">
              <table class="table table-bordered table-striped table-hover align-middle">
                <thead class="table-dark text-center">
                  <tr>
                    <th rowspan="2" class="align-middle">Descrição na NF</th>
                    <th rowspan="2" class="align-middle">Dados da NF</th>
                    <th rowspan="2" class="align-middle" style="min-width: 300px;">Associar ao Item da Cotação</th>
                    <th colspan="2">Comparativo com Cotação</th>
                  </tr>
                  <tr><th>Dados da Cotação</th><th>Divergências</th></tr>
                </thead>
                <tbody class="comparison-table-body"></tbody>
              </table>
            </div>
            <div class="text-center mt-4 action-buttons">
              <button class="btn btn-secondary btn-cancel">Cancelar</button>
              <button class="btn btn-success btn-save">Salvar Conciliação desta Nota</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <?!= App_incluirHtml('ConciliacaoNFScript', true); ?>
</body>
</html>